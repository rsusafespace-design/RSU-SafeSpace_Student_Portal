<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SafeSpace Student Portal - Messages</title>
  <!-- Inline SVG favicon to avoid 404 for /favicon.ico when running locally -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Crect width='100%25' height='100%25' fill='%230f7a34'/%3E%3Ctext x='50%25' y='50%25' font-size='10' fill='white' text-anchor='middle' dominant-baseline='central'%3ES%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />
  <style>
    /* ===== Sidebar (admin-like style) ===== */
    .sidebar {
      position:fixed; top:0; left:0;
      width:250px; height:100%;
      background:#f0f3f6; color:#1f2937;
      padding:12px;
      border-right:1px solid rgba(0,0,0,0.06);
      display:flex; flex-direction:column;
      transition:width 0.3s ease, transform 0.3s ease;
      z-index:1200;
    }

    .sidebar .brand {
      display:flex; align-items:center; gap:0.6rem;
      margin-bottom:1rem; padding:8px 4px;
    }

    .sidebar .logo {
      width:40px; height:40px; background:transparent;
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      color:#10b981; font-weight:700; font-size:0.95rem;
      flex-shrink:0; box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }

    .sidebar .brand span { font-weight:700; font-size:1rem; color:#374151; }

    /* collapsed (narrow) sidebar */
    .sidebar.shrink { width:80px; padding:12px 8px; }
    .sidebar.shrink .brand span { display:none; }
    .sidebar.shrink a { text-align:center; font-size:1.1rem; }
    .sidebar.shrink a span { display:none; }

    /* nav items (anchors) styled similar to admin .nav-item */
    .sidebar a {
      display:flex; align-items:center; gap:12px; color:#1f2937;
      text-decoration:none; margin:8px 0; font-size:15px;
      padding:12px 10px; border-radius:8px; background:transparent;
      transition:background 0.18s ease, color 0.18s ease;
    }

  .sidebar a .fa,
  .sidebar a i { width:28px; text-align:center; font-size:18px; color:#1f2937; background:transparent; }

    .sidebar a span { color:inherit; display:inline-block; white-space:nowrap; overflow:hidden; }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(15,122,52,0.08); color:#0f7a34; font-weight:600;
    }

    /* Admin-like header & sidebar overrides (no HTML changes) */
    .header-and-sidebar-top {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      background-color: #1e8e3e;
      color: white;
      height: 60px;
      transition: left 0.3s ease;
    }

    .sidebar-top {
      width: 250px;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      box-sizing: border-box;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      height: 60px;
      transition: width 0.3s ease;
    }

    .sidebar {
      position: fixed; /* ensure sidebar spans full height and brand sits at top */
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      background: #f0f3f6;
      border-right: none; /* remove full-height border so brand can appear flush */
      z-index: 1002; /* sit above topbar so brand overlays header area */
      overflow: auto;
    }

    /* Hide the native scrollbar for the sidebar while keeping content scrollable */
    .sidebar {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }
    .sidebar::-webkit-scrollbar {
      width: 0px;
      height: 0px;
      background: transparent;
    }

    /* vertical divider only below the brand area */
    .sidebar::after {
      content: ''; 
      position: absolute;
      left: 249px; /* 1px inside right edge */
      top: 60px; /* start after brand/topbar */
      width: 1px;
      height: calc(100vh - 60px);
      background: rgba(0,0,0,0.06);
      z-index: 1001;
    }

    .nav-item, .sidebar a {
      color: #1f2937;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 10px;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 400;
      font-size: 15px;
      transition: background 0.2s, color 0.2s;
    }

    .nav-item:hover, .sidebar a:hover {
      background: rgba(15,122,52,0.08) !important;
      color: #0f7a34 !important;
      font-weight: 400 !important;
    }

    .nav-item.active {
      background: rgba(15,122,52,0.12) !important;
      color: #0f7a34 !important;
      font-weight: 600 !important;
    }

    /* adjust content to sit below the fixed topbar and to the right of the sidebar */
    .content { margin-top: 60px; margin-left: 250px; }
    .content.shrink { margin-left: 80px; }

    /* Logo and brand name styling to mirror admin */
    .sidebar .logo {
      background: transparent url("../Admin_side/safespace.png") center center / contain no-repeat;
      width:44px; height:44px; border-radius:6px; box-shadow:none; color:transparent;
    }

    /* keep brand/logo aligned with topbar height (60px) */
    .sidebar .brand {
      height: 60px;
      align-items: center;
      padding: 0 12px;
      background: #1e8e3e; /* match topbar background for a seamless look */
      color: white;
      gap: 12px;
    }

    .sidebar .brand span { color: white; font-weight:700; margin-left:4px; }

    /* push nav content below the brand area */
    #nav { padding-top: 12px; margin-top: 60px; }

    /* make the small top-area logo visible in header-like layout */
    .header-and-sidebar-top .sidebar-logo span { color: white; font-weight:700; font-size:1.1rem; }

    /* ===== Topbar (admin-like appearance) ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 250px; /* sit to the right of the fixed sidebar */
      right: 0;
      height: 60px;
      background-color: #1e8e3e;
      color: white;
      padding: 10px 30px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 1001;
      transition: left 0.3s ease, margin-left 0.3s ease;
    }
    .topbar.shrink { left: 80px; }

    .topbar-left { display:flex; align-items:center; gap:0.6rem; }
    .hamburger {
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
    .portal-title { display:flex; flex-direction:column; line-height:1.2; }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
    .portal-title strong span.safespace { display:none; margin-right:0.3rem; }
    .portal-title small { font-size:0.75rem; opacity:0.9; }

    /* Show SafeSpace text when sidebar is shrunk */
    .topbar.shrink .portal-title strong span.safespace { display: inline; }

    /* Mobile logo styling */
    .mobile-logo {
      display: none;
      width: 28px;
      height: 28px;
      background: white;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      color: #00723f;
      font-weight: bold;
      font-size: 0.8rem;
      margin-right: 0.5rem;
    }

    /* Profile + Notifications */
    .profile { width:38px; height:38px; border-radius:50%; background:#004c27;
      display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; }
    .notif-wrapper { position:relative; cursor:pointer; font-size:1.3rem; color:white; }
    .notif-badge {
      position:absolute; bottom:0; right:0;
      width:10px; height:10px; background:red;
      border-radius:50%; border:2px solid #00723f;
    }
    .notif-badge.hidden { display:none; }

    .notif-dropdown {
      position:absolute; top:48px; right:0;
      background:white; color:#333;
      width:260px; border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      display:none; flex-direction:column;
      overflow:hidden; z-index:2000;
    }
    .notif-dropdown.active { display:flex; }
    .notif-header { background:#00723f; color:white; padding:0.6rem; font-weight:bold; }
    .notif-list { max-height:220px; overflow-y:auto; }
    .notif-item {
      padding:0.6rem 0.8rem; border-bottom:1px solid #eee;
      font-size:0.9rem; cursor:pointer;
    }
    .notif-item:hover { background:#f1f1f1; }

    /* --- START: NEW ADMIN SYNC STYLES --- */
    .sidebar {
        width: 250px;
        background: #f0f3f6;
        border-right: 1px solid rgba(0,0,0,0.06);
        position: fixed;
        top: 60px; /* Starts below the header */
        left: 0;
        height: calc(100vh - 60px);
        z-index: 999;
        padding: 12px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease, transform 0.3s ease;
    }
    
    .sidebar .brand {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        display: flex;
        align-items: center;
        padding: 10px 20px;
        box-sizing: border-box;
        z-index: 1002;
        border-right: 1px solid rgba(255, 255, 255, 0.3);
        transition: width 0.3s ease;
    }
    
  .sidebar .brand .logo {
    height: 40px;
    width: 40px;
    background: transparent url("safespace.png") center/contain no-repeat;
    color: transparent;
    border-radius: 8px;
  }
    
    .sidebar .brand span {
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
        white-space: nowrap;
        margin-left: 10px;
        transition: opacity 0.3s ease, width 0.3s ease;
    }
    
    .sidebar a {
        margin: 0; /* Nav links start at the top of the sidebar container */
    }
    
    .topbar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        padding: 10px 30px;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .content {
        margin-top: 60px;
        margin-left: 250px;
        transition: margin-left 0.3s ease;
    }
    
   /* --- Collapsed State --- */
.sidebar.collapsed {
  width: 80px;
  padding: 12px 8px;
}

.sidebar.collapsed .brand {
  width: 80px;
  justify-content: center;
}

.sidebar.collapsed .brand span {
  opacity: 0;
  pointer-events: none;
  width: 0;
}

.sidebar.collapsed a span {
  display: none;
}
.sidebar.collapsed a {
  justify-content: center;
}

/* ADD THIS NEW CODE RIGHT HERE - Keep emoji icons visible when collapsed */
.sidebar.collapsed a::before {
  content: attr(data-emoji);
  font-size: 1.3rem;
}

.sidebar a::before {
  content: attr(data-emoji);
  margin-right: 8px;
}

.sidebar.collapsed a::before {
  margin-right: 0;
}
/* END OF NEW CSS CODE */
    
    .sidebar.collapsed a span {
        display: none;
    }
    .sidebar.collapsed a {
        justify-content: center;
    }
    
    .topbar.shifted {
        left: 80px;
    }
    
    .content.shifted {
        margin-left: 80px;
    }
    
    /* --- Mobile Overlay & Sidebar --- */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 998;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .sidebar {
            top: 0; /* On mobile, the sidebar is full height */
            height: 100vh;
            width: 280px;
            transform: translateX(-100%);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1200; /* Above overlay */
        }
    
        .sidebar.mobile-open {
            transform: translateX(0);
        }
    
        /* Prevent collapsing on mobile view */
        .sidebar.collapsed {
            width: 280px;
            transform: translateX(-100%);
        }
    
        .sidebar .brand {
            width: 280px; /* Brand takes full width of mobile sidebar */
        }
    
        .sidebar .brand.collapsed {
            width: 280px;
            justify-content: flex-start;
        }
    
        .sidebar .brand.collapsed span {
            opacity: 1;
            pointer-events: auto;
            width: auto;
        }
    
        .topbar, .topbar.shifted {
            left: 0;
        }
        .content, .content.shifted {
            margin-left: 0;
        }
    }
    /* --- END: NEW ADMIN SYNC STYLES --- */

  /* Rating modal styles (polished) */
  .rating-modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:3600; align-items:center; justify-content:center; }
  .rating-modal-overlay.active{ display:flex; }
  .rating-modal-box{ width:92%; max-width:560px; background:linear-gradient(180deg,#ffffff,#fbfffb); border-radius:12px; padding:20px; box-shadow:0 18px 50px rgba(2,6,23,0.18); color:#063d2b; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
  .rating-modal-box h3{ margin:0 0 8px 0; font-size:20px; color:#064e3b; }
  .rating-modal-meta{ color:#475569; margin-bottom:12px; font-size:14px }
  .rating-stars{ display:flex; align-items:center; gap:10px; justify-content:center; width:100%; }
  .rating-stars .star{ font-size:44px; color:#fbbf24; background:transparent; border:0; cursor:pointer; padding:6px 8px; border-radius:8px; transition:transform .12s ease, filter .12s ease }
  .rating-stars .star:hover{ transform:translateY(-3px) scale(1.06); filter:brightness(1.03) }
  .rating-stars .star.inactive{ color:#e6e6e6 }
  .rating-value{ text-align:center; font-size:16px; color:#374151; margin-top:6px; font-weight:600 }
  .rating-comment{ width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef7; min-height:82px; font-size:14px }
  .rating-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
  .rating-btn{ padding:9px 14px; border-radius:8px; border:0; cursor:pointer }
  .rating-btn.cancel{ background:#f3f4f6; color:#374151 }
  .rating-btn.submit{ background:#0f7a34; color:#fff }

  /* Thank-you modal (used after submitting a rating) */
  .thanks-modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:3700; align-items:center; justify-content:center; }
  .thanks-modal-overlay.active{ display:flex; }
  .thanks-modal-box{ width:320px; max-width:92%; background:linear-gradient(180deg,#ffffff,#f8fffb); border-radius:12px; padding:18px; box-shadow:0 14px 40px rgba(2,6,23,0.16); text-align:center; color:#064e3b; }
  .thanks-modal-box h4{ margin:0 0 6px 0; font-size:18px; }
  .thanks-modal-box p{ margin:6px 0 0 0; color:#4b5563 }

    /* Chat-specific styles (preserve message UI from original file) */
    .date-separator { display:flex;align-items:center;gap:12px;margin:12px 0;color:#6b7280;font-size:13px;justify-content:center; }
    .date-separator::before, .date-separator::after { content:''; flex:1; height:1px; background:#eef2f6; display:inline-block }
    .date-separator span { padding:6px 12px;background:#fff;border-radius:999px;border:1px solid #f1f5f9 }

    :root{ --green:#0f7a34; --panel:#ffffff; --muted:#6b7280; --bg:#f4f6fb; --card-shadow: 0 6px 18px rgba(16,24,40,0.06); --radius:10px; --sidebar-width:250px; --collapsed-width:80px; --topbar-height:64px; }
    *{box-sizing:border-box}
    html{font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; font-size:15px}
    body{margin:0;background:var(--bg);color:#111;overflow-y:auto}

    /* Content area adjustments for chat */
    .content { padding:0; transition:margin-left 0.3s ease; height: calc(100vh - 72px); display:flex; flex-direction:column; }
    .content.shrink { margin-left:var(--collapsed-width); }

    /* ===== Chat Layout ===== */
    .chat-header { background:white; padding:1rem 1.5rem; border-bottom:2px solid #e0e0e0; display:flex; align-items:center; gap:0.8rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:100; position:relative; }
    .counselor-info { display:flex; align-items:center; gap:0.8rem; flex:1; }
    .counselor-avatar { position: relative; width: 48px; height: 48px; background: #00723f; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; }
    .online-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #4caf50; border: 2px solid white; border-radius: 50%; }
    .counselor-details h3 { font-size: 1.1rem; color: #004c27; margin-bottom: 0.2rem; }
    .counselor-status { font-size: 0.85rem; color: #4caf50; font-weight: 500; }
    .chat-actions { display: flex; gap: 1rem; font-size: 1.2rem; color: #00723f; }
    .chat-actions i { cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: background 0.2s; }
    .chat-actions i:hover { background: rgba(0, 114, 63, 0.1); }

  /* Ensure action icons are above other UI layers and are clickable/accessibile */
  .chat-actions { position: relative; z-index: 1100; }
  .chat-actions i { position: relative; z-index: 1101; pointer-events: auto; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Chat input & conversation list */
    .chat-input-bar { display:flex; align-items:center; padding:0.8rem; background:#fff; border-top:2px solid #e0e0e0; gap:0.6rem; }

    /* small icon buttons (attach, emoji) placed to the left */
    .chat-input-bar .icon-btn-inline {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 6px solid rgba(235,245,252,1); /* pale ring */
      background: #fff;
      font-size: 20px;
      color: #10b981; /* green for icon */
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(2,6,23,0.04);
    }

    .chat-input-bar .icon-btn-inline i { font-size:20px; color:#0f7a34; }

    .chat-input-bar .icon-btn-inline:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(2,6,23,0.08); }

    .chat-input { flex: 1; padding: 0.9rem 1.1rem; border-radius: 999px; border: 1px solid #e6eef7; font-size: 1rem; outline: none; background: #fbfdff; min-width: 0; }
    .chat-input:focus { border-color: #9ae6b4; box-shadow: 0 4px 14px rgba(16,185,129,0.06); }

    /* send button styled as circular green button (right-most) */
    .chat-send-btn {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: #0f7a34; /* green */
      color: #fff;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 8px 18px rgba(16,24,40,0.12);
      transition: transform .08s ease, box-shadow .12s ease;
    }

    .chat-send-btn:active { transform: translateY(1px) scale(.995); }

    .chat-send-btn i { font-size: 16px; }

    .conversations-list { padding: 4px 0; }
    .conversations-list .conv-item.card { display:block; padding:12px; border:1px solid #eef2f6; border-radius:12px; margin-bottom:12px; background:#fff; box-shadow:0 6px 18px rgba(16,24,40,0.04); text-align:left; }
    .conversations-list .conv-item.card:hover { transform: translateY(-2px); box-shadow:0 10px 24px rgba(16,24,40,0.06); }
    .conversations-list .avatar-holder img, .conversations-list .avatar-holder .initials { width:52px; height:52px; border-radius:9999px; object-fit:cover; font-weight:700; color:#064e3b; display:flex; align-items:center; justify-content:center; }
    .conversations-list .conv-meta { min-width:80px; text-align:right; flex:0 0 auto; }
    .conversations-list .conv-item.unread { background: linear-gradient(90deg, rgba(15,122,52,0.02), rgba(255,255,255,0)); border-left:4px solid #0f7a34; }
    .unread-badge { width:12px;height:12px;border-radius:50%;background:#ef4444;display:inline-block;margin-left:8px;box-shadow:0 1px 0 rgba(0,0,0,0.06) }
    .conversations-list .conv-item.active { background: #eaf9d9; transform: translateY(-1px); border-left:4px solid #16a34a; }
    
    /* Bottom nav (mobile only) - hidden by default */
    .bottom-nav { display: none; }
    @media (max-width: 768px) {
      .bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #004c27;
        justify-content: space-around;
        padding: 0.5rem 0;
        z-index: 2000;
      }
      .bottom-nav a {
        flex: 1;
        text-align: center;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .bottom-nav a i { font-size: 1.2rem; margin-bottom: 0.2rem; }
      .bottom-nav a.active { color: #ffc107; }
    }
  </style>
  <style id="messages-mobile-fullwidth">
    /* Make the opened conversation truly full-bleed on small screens and fix input to bottom */
    @media (max-width: 768px) {
      /* Remove layout gaps that can create right-side whitespace */
      .chat-layout { gap: 0 !important; }

      /* Ensure the chat panel uses full width and no internal horizontal padding */
      .chat-panel { padding-left: 0 !important; padding-right: 0 !important; }

      /* When chat is opened on mobile, make it occupy the full viewport */
      body.mobile-chat-open .chat-panel {
        padding: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: 0 !important;
        bottom: 0 !important;
        height: 100vh !important;
        width: 100vw !important;
        box-sizing: border-box;
        overflow: hidden !important;
      }

      /* Messages container should fill available width and have extra bottom padding
         so fixed input doesn't overlap the latest messages */
      body.mobile-chat-open #messagesContainer {
        padding: 12px !important;
        padding-bottom: 110px !important; /* room for fixed input */
        margin: 0 !important;
        width: 100% !important;
        box-sizing: border-box;
        overflow-y: auto;
      }

      /* Fix the input bar to the bottom of the viewport when a conversation is opened */
      body.mobile-chat-open .chat-input-bar {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        padding: 10px 12px !important;
        background: #fff !important;
        z-index: 2400 !important;
        box-shadow: 0 -8px 30px rgba(2,6,23,0.08) !important;
      }

      /* Prevent horizontal scrolling caused by margins or gaps */
      html, body { overflow-x: hidden !important; }
    }
  </style>
  <style id="mobile-back-style">
    @media (max-width: 768px) {
      .mobile-back { display:none; border:0; background:transparent; padding:0; }
      body.mobile-chat-open .mobile-back {
        display:inline-flex !important;
        align-items:center; justify-content:center;
        width:40px; height:40px; border-radius:10px;
        background: rgba(255,255,255,0.12); color:#fff; border:0;
        box-shadow: 0 6px 18px rgba(2,6,23,0.12); cursor:pointer;
        font-size:18px; margin-right:8px;
      }
      .mobile-back i { font-size:20px; color:inherit; }
    }
  </style>
  <style id="messages-mobile-fixes">
    /* Session and system message styling to match screenshot */
    .chat-panel #messagesContainer .sys-message { color: #0f7a34; font-weight:700; text-align:center; margin:14px 0; }
    .chat-panel #messagesContainer .date-separator span { display:inline-block; background:#fff; border:1px solid #eee; padding:6px 12px; border-radius:20px; color:#6b7280; }

    /* Message bubble styling */
    .message-row { margin-bottom: 10px; }
    .message-bubble { display:inline-block; max-width:72%; padding:10px 14px; border-radius:16px; font-size:14px; box-shadow:0 1px 0 rgba(0,0,0,0.04); }
    .message-row.justify-end .message-bubble { background:#dcfce7; }
    .message-row.justify-start .message-bubble { background:#f1f5f9; }

    /* Force specific styles on small screens */
    @media (max-width: 520px) {
      .message-bubble { font-size:13px; padding:8px 10px; border-radius:14px; }
      .chat-panel #messagesContainer { padding:10px; }
      .chat-input-bar { padding:10px; }
      /* send button: circular green */
      .chat-send-btn { width:44px; height:44px; border-radius:50%; background:#0f7a34; color:#fff; display:inline-flex; align-items:center; justify-content:center; border:none; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
      .chat-send-btn i { transform:translateY(1px); }
      /* image attach icon style */
      .icon-btn-inline { width:44px; height:44px; border-radius:50%; background:#f1f5f9; display:inline-flex; align-items:center; justify-content:center; border:none; }
      .icon-btn-inline i { font-size:18px; color:#0f7a34; }
    }

    /* Icon enabled/disabled coloring: green on desktop, yellow on mobile when enabled */
    #videoCallBtn.icon-enabled, #counselorInfoBtn.icon-enabled { color: #0f7a34 !important; }
    #videoCallBtn.icon-disabled, #counselorInfoBtn.icon-disabled { color: #9ca3af !important; }
    @media (max-width: 768px) {
      #videoCallBtn.icon-enabled, #counselorInfoBtn.icon-enabled { color: #FFD166 !important; }
    }
  </style>
  <style id="messages-mobile-behavior">
    /* Messenger-like behavior on small screens: show list first, open chat full-width when tapped */
    @media (max-width: 768px) {
      .chat-layout { display:block; }
      .conversations-panel { width:100% !important; position:relative; display:block !important; border-right:none !important; height: calc(100vh - 64px - 64px); overflow:auto; }
      .chat-panel { display:none !important; }
      /* When `mobile-chat-open` is set on body, hide list and show chat full-width */
      body.mobile-chat-open .conversations-panel { display:none !important; }
      body.mobile-chat-open .chat-panel { display:flex !important; flex-direction:column !important; width:100% !important; height: calc(100vh - 64px - 64px); }
      /* Back button visible inside chat header on mobile when chat open */
      .mobile-back { display:none; }
      body.mobile-chat-open .mobile-back { display:inline-flex !important; align-items:center; justify-content:center; width:40px; height:40px; border-radius:6px; background:transparent; color:#fff; }
      /* ensure messages container fills available height inside chat-panel */
      .chat-panel #messagesContainer { flex:1 1 auto; overflow:auto; min-height:0; }
      /* hide chat input initially until a conversation is selected */
      .chat-input-bar { box-sizing:border-box; }
      /* Conversations list fills available viewport under topbar */
      .conversations-panel { width:100% !important; position:relative; display:block !important; border-right:none !important; height: calc(100vh - 64px - 64px); overflow:auto; box-sizing:border-box; }
      /* Hide chat-panel by default on small screens; reveal when a conversation is opened */
      .chat-panel { display:none !important; }
      /* When `mobile-chat-open` is set on body, hide list and show chat full-width */
      body.mobile-chat-open .chat-panel { display:flex !important; flex-direction:column !important; width:100% !important; height: calc(100vh - 64px - 64px); box-sizing:border-box; }

      /* Chat header: align back button, avatar and details, fixed at top of chat-panel */
      .chat-header { display:flex; align-items:center; gap:8px; padding:10px 12px; box-sizing:border-box; background: #1e8e3e; color: #fff; }
      .chat-header .counselor-info { display:flex; align-items:center; gap:8px; }
      .mobile-back { display:none !important; border:0; background:transparent; color:#fff; font-size:20px; cursor:pointer; }
      body.mobile-chat-open .mobile-back { display:inline-flex !important; align-items:center; justify-content:center; width:40px; height:40px; border-radius:6px; background:transparent; color:#fff; }
      .chat-header .counselor-avatar { width:44px; height:44px; border-radius:9999px; display:flex; align-items:center; justify-content:center; background:#fff; color:#064e3b; font-weight:700; overflow:hidden; flex-shrink:0; }
      .chat-header .counselor-avatar img { width:100%; height:100%; object-fit:cover; border-radius:9999px; display:block; }
      .chat-header .counselor-details h3 { margin:0; font-size:16px; color:#fff; line-height:1; }
      .chat-header .counselor-status { font-size:12px; color: rgba(255,255,255,0.9); }

      /* messages container expands to fill remaining space between header and input */
      .chat-panel #messagesContainer { flex:1 1 auto; overflow:auto; min-height:0; padding:12px; background:#fff; box-sizing:border-box; }

      /* chat input stays visible at bottom of chat-panel â€” use sticky so it remains above messages */
      .chat-input-bar { display:flex; align-items:center; gap:8px; padding:8px; background:#fff; box-sizing:border-box; position:sticky; bottom:0; z-index:1201; }
      .chat-input-bar .chat-input { flex:1 1 auto; }

      /* Give space for the bottom nav so the input isn't covered */
      body.mobile-chat-open .chat-panel { padding-bottom: 84px; }
      .bottom-nav { z-index: 1300; }

      /* When a conversation is opened we want the chat to occupy the full viewport
         and hide the topbar and bottom navigation for an immersive experience. */
      body.mobile-chat-open #topbar { display: none !important; }
      body.mobile-chat-open .bottom-nav { display: none !important; }

      /* Make the chat-panel fixed and fill the entire viewport when opened */
      body.mobile-chat-open .chat-panel {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        height: 100vh !important;
        z-index: 2000 !important;
        background: #fff;
      }

      /* Ensure the conversations list (when visible) fills the available area under the topbar */
      .conversations-panel { box-sizing: border-box; height: calc(100vh - 64px - 64px); }
    }
    /* Extra tightening for small phones */
    @media (max-width: 520px) {
      .chat-header .counselor-details h3 { font-size: 14px !important; }
      .chat-header .counselor-details .counselor-status { font-size: 12px !important; }
      .chat-panel #messagesContainer .sys-message { font-size: 12px !important; }
      /* reduce padding around message bubbles slightly */
      .chat-panel #messagesContainer div[style] { padding: 8px 10px !important; }
    }
  </style>
  <style id="assessments-mobile-overrides">
    /* Mobile overrides copied from assessments.html to ensure exact parity */
    /* Hide hamburger on small screens */
    @media (max-width: 768px) {
      .hamburger { display: none !important; }
    }

    /* Bottom Nav (mobile only) - match assessments.html exactly */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1e8e3e; /* match topbar color from assessments */
      justify-content: space-around;
      padding: 0.6rem 0;
      height: 64px;
      z-index: 1000;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.18);
    }

    @media (max-width: 768px) {
      .bottom-nav {
        display: flex !important;
        height: 64px !important;
        padding: 8px 0 !important;
      }
    }

    .bottom-nav a {
      flex: 1;
      text-align: center;
      color: #fff;
      text-decoration: none;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      opacity: 1;
      transition: all 0.3s ease;
      padding: 10px 6px !important;
      border-radius: 8px;
    }

    .bottom-nav a.active {
      color: #fff;
      background: rgba(255,255,255,0.06);
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }

    .bottom-nav a:hover:not(.active) { background: rgba(255,255,255,0.03); }

    .bottom-nav a i { font-size: 28px !important; line-height: 1; transition: all 0.3s ease; color: #ffffff; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }

    .bottom-nav a:hover i { transform: scale(1.05); }

    /* Hide bottom-nav text labels so only emoji/icons are shown */
    .bottom-nav a .bn-label { display: none !important; }
    .bottom-nav a .bn-emoji { font-size: 28px !important; line-height: 1; display: inline-block; }

    /* Topbar mobile adjustments to match assessments.html */
    @media (max-width: 768px) {
      .topbar { left: 0 !important; right: 0 !important; padding: 8px 12px !important; height: 64px; }
      .mobile-logo { display: flex !important; }
      .portal-title { gap: 0; }
      .portal-title small { display: inline-block; font-size:0.75rem; color: rgba(255,255,255,0.9); }
    }

    /* Make mobile logo image size and brand spacing match assessments exactly */
    @media (max-width: 768px) {
      .mobile-logo { width:48px; height:48px; display:flex; align-items:center; justify-content:center; }
      .mobile-logo img { height:40px !important; width:auto !important; object-fit:contain !important; }
      .sidebar .brand { height: 80px; align-items: center; padding: 12px 20px; }
      .sidebar .brand .logo { width:80px; height:80px; border-radius:8px; }
      .sidebar .brand .logo img { height:40px !important; width:auto !important; }
      /* Ensure sidebar is hidden on mobile (assessments shows bottom nav instead) */
      .sidebar { display: none !important; transform: translateX(-100%) !important; }
      .content { margin-left: 0 !important; padding: 20px 15px 4rem 15px !important; margin-top: 60px !important; }
    }
  </style>
  <style id="appointments-copy">
    :root {
      --primary: #0f7a34;
      --primary-light: #e8f5e9;
      --primary-dark: #0a5a26;
      --topbar-bg: #1e8e3e;
      --secondary: #4361ee;
      --accent: #7209b7;
      --text: #2d3748;
      --text-light: #718096;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
      --radius: 16px;
      --radius-sm: 8px;
      --sidebar-width: 280px;
      --collapsed-width: 80px;
      --topbar-height: 70px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      color: var(--text);
    }

    body {
      background: var(--bg);
      overflow-x: hidden;
    }

    /* ===== Sidebar (admin-like style) ===== */
    .sidebar {
      position:fixed; top:0; left:0;
      width:250px; height:100%;
      background:#f0f3f6; color:#1f2937;
      padding:12px;
      border-right:1px solid rgba(0,0,0,0.06);
      display:flex; flex-direction:column;
      transition:width 0.3s ease, transform 0.3s ease;
      z-index:1200;
    }

    .sidebar .brand {
      display:flex; align-items:center; gap:0.6rem;
      margin-bottom:1rem; padding:8px 4px;
    }

    .sidebar .logo {
      width:40px; height:40px; background:transparent;
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      color:#10b981; font-weight:700; font-size:0.95rem;
      flex-shrink:0; box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }

    .sidebar .brand span { font-weight:700; font-size:1rem; color:#374151; }

    /* collapsed (narrow) sidebar */
    .sidebar.shrink { width:80px; padding:12px 8px; }
    .sidebar.shrink .brand span { display:none; }
    .sidebar.shrink a { text-align:center; font-size:1.1rem; }
    .sidebar.shrink a span { display:none; }

    /* nav items (anchors) styled similar to admin .nav-item */
    .sidebar a {
      display:flex; align-items:center; gap:12px; color:#1f2937;
      text-decoration:none; margin:8px 0; font-size:15px;
      padding:12px 10px; border-radius:8px; background:transparent;
      transition:background 0.18s ease, color 0.18s ease;
    }

  .sidebar a .fa,
  .sidebar a i { width:28px; text-align:center; font-size:18px; color:#1f2937; background:transparent; }

    .sidebar a span { color:inherit; display:inline-block; white-space:nowrap; overflow:hidden; }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(15,122,52,0.08); color:#0f7a34; font-weight:600;
    }

    /* Admin-like header & sidebar overrides (no HTML changes) */
    .header-and-sidebar-top {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      background-color: #1e8e3e;
      color: white;
      height: 60px;
      transition: left 0.3s ease;
    }

    .sidebar-top {
      width: 250px;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      box-sizing: border-box;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      height: 60px;
      transition: width 0.3s ease;
    }

    .sidebar {
      position: fixed; /* ensure sidebar spans full height and brand sits at top */
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      background: #f0f3f6;
      border-right: none; /* remove full-height border so brand can appear flush */
      z-index: 1002; /* sit above topbar so brand overlays header area */
      overflow: auto;
    }

    /* Hide the native scrollbar for the sidebar while keeping content scrollable */
    .sidebar {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }
    .sidebar::-webkit-scrollbar {
      width: 0px;
      height: 0px;
      background: transparent;
    }

    /* vertical divider only below the brand area */
    .sidebar::after {
      content: '';
      position: absolute;
      left: 249px; /* 1px inside right edge */
      top: 60px; /* start after brand/topbar */
      width: 1px;
      height: calc(100vh - 60px);
      background: rgba(0,0,0,0.06);
      z-index: 1001;
    }

    .nav-item, .sidebar a {
      color: #1f2937;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 10px;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 400;
      font-size: 15px;
      transition: background 0.2s, color 0.2s;
    }

    .nav-item:hover, .sidebar a:hover {
      background: rgba(15,122,52,0.08) !important;
      color: #0f7a34 !important;
      font-weight: 400 !important;
    }

    .nav-item.active {
      background: rgba(15,122,52,0.12) !important;
      color: #0f7a34 !important;
      font-weight: 600 !important;
    }

    /* adjust content to sit below the fixed topbar and to the right of the sidebar */
    .content { margin-top: 60px; margin-left: 250px; }
    .content.shrink { margin-left: 80px; }

    /* Logo and brand name styling to mirror admin */
    .sidebar .logo {
      background: transparent;
      width:72px; height:72px; border-radius:6px; box-shadow:none; color:transparent;
      display:flex; align-items:center; justify-content:center; overflow:hidden; padding:0; border:0;
    }
    .sidebar .logo img{
      width:auto; height:64px; max-width:100%; max-height:64px; object-fit:contain; display:block;
      background:transparent; /* in case image has transparency preserve it */
      image-rendering: -webkit-optimize-contrast;
    }

    /* keep brand/logo aligned with topbar height (60px) */
    .sidebar .brand {
      height: 60px;
      align-items: center;
      padding: 0 12px;
      background: #1e8e3e; /* match topbar background for a seamless look */
      color: white;
      gap: 12px;
    }

    .sidebar .brand span { color: white; font-weight:700; margin-left:4px; }

    /* push nav content below the brand area */
    #nav { padding-top: 12px; margin-top: 60px; }

    /* make the small top-area logo visible in header-like layout */
    .header-and-sidebar-top .sidebar-logo span { color: white; font-weight:700; font-size:1.1rem; }

    /* ===== Topbar (admin-like appearance) ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 250px; /* sit to the right of the fixed sidebar */
      right: 0;
      height: 60px;
      background-color: var(--topbar-bg);
      color: white;
      padding: 10px 30px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 1001;
      transition: left 0.3s ease, margin-left 0.3s ease;
    }
    .topbar.shrink { left: 80px; }

    .topbar-left { display:flex; align-items:center; gap:0.6rem; }
    .hamburger {
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
    .portal-title { display:flex; flex-direction:column; line-height:1.2; }
    .portal-title strong span.safespace { display:inline; margin-right:0.3rem; }
    .portal-title small { font-size:0.75rem; opacity:0.9; }

    /* Show SafeSpace text when sidebar is shrunk */
    .topbar.shrink .portal-title strong span.safespace { display: inline; }

    /* Mobile logo styling */
    .mobile-logo {
      display: none;
      width: 44px;
      height: 44px;
      background: transparent; /* remove white circular background */
      border-radius: 6px;
      align-items: center;
      justify-content: center;
      color: #00723f;
      font-weight: bold;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      padding:0;
      overflow:hidden;
    }
  .mobile-logo img{ width:auto; height:34px; object-fit:contain; display:block; background:transparent }

    /* Profile + Notifications */
    .profile { width:38px; height:38px; border-radius:50%; background:#004c27;
      display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; }
    .notif-wrapper { position:relative; cursor:pointer; font-size:1.3rem; color:white; }
    .notif-badge {
      position:absolute; bottom:0; right:0;
      width:10px; height:10px; background:red;
      border-radius:50%; border:2px solid #00723f;
    }
    .notif-badge.hidden { display:none; }

    .notif-dropdown {
      position:absolute; top:48px; right:0;
      background:white; color:#333;
      width:260px; border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      display:none; flex-direction:column;
      overflow:hidden; z-index:2000;
    }
    .notif-dropdown.active { display:flex; }
    .notif-header { background:#00723f; color:white; padding:0.6rem; font-weight:bold; }
    .notif-list { max-height:220px; overflow-y:auto; }
    .notif-item {
      padding:0.6rem 0.8rem; border-bottom:1px solid #eee;
      font-size:0.9rem; cursor:pointer;
    }
    .notif-item:hover { background:#f1f1f1; }

    /* ===== Content ===== */
    .content {
      padding:1rem;
      max-width:1200px; margin:auto;
      margin-left:250px;
      transition:margin-left 0.3s ease;
    }
    .content.shrink { margin-left:70px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(350px,1fr)); gap:1rem; }
    .card { background:white; border-radius:10px; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .card h3 { margin-bottom:0.8rem; }

    /* Hide hamburger on mobile */
    @media (max-width:768px) {
      .hamburger { display: none; }
    }

    /* ===== Mobile Bottom Nav ===== */
    @media (max-width:768px) {
      .sidebar { 
        display: none !important;
        transform: translateX(-100%);
      }
      .topbar { margin-left:0; }
      .content { margin-left:0; }
      .hamburger { display: none; }
      
      /* Show mobile logo and SafeSpace text */
      .mobile-logo { display: flex; }
      .portal-title strong span.safespace { display: inline; }
      
      .bottom-nav {
        position:fixed; bottom:0; left:0; width:100%;
        background:#004c27; display:flex; justify-content:space-around;
        padding:0.5rem 0; z-index:2000;
      }
      .bottom-nav a {
        flex:1; text-align:center; color:white; text-decoration:none; font-size:0.9rem;
        display:flex; align-items:center; justify-content:center; gap:0.25rem;
        padding:0.6rem 0; opacity:1; background:transparent; border-radius:8px;
      }
      .bottom-nav a i { font-size:22px; line-height:1; }
      .bottom-nav a.active { color:#ffc107; }
    }
    
    /* Hide bottom nav on larger screens */
    .bottom-nav { display: none; }

    @media (max-width: 768px) {
      .bottom-nav { 
        display: flex !important;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: var(--primary-dark); /* solid colored bar */
        justify-content: space-around;
        padding: 0.6rem 0; height:64px; z-index: 2000;
      }
    }

    /* ===== Misc ===== */
    .hidden {
      display: none !important;
    }

    /* --- START: NEW ADMIN SYNC STYLES --- */
    .sidebar {
        width: 250px;
        background: #f0f3f6;
        border-right: 1px solid rgba(0,0,0,0.06);
        position: fixed;
        top: 60px; /* Starts below the header */
        left: 0;
        height: calc(100vh - 60px);
        z-index: 999;
        padding: 12px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease, transform 0.3s ease;
    }
    
    .sidebar .brand {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        display: flex;
        align-items: center;
        padding: 10px 20px;
        box-sizing: border-box;
        z-index: 1002;
        border-right: 1px solid rgba(255, 255, 255, 0.3);
        transition: width 0.3s ease;
    }
    
  .sidebar .brand .logo {
    height: 40px;
    width: 40px;
    background: transparent url("safespace.png") center/contain no-repeat;
    color: transparent;
    border-radius: 8px;
  }
    
    .sidebar .brand span {
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
        white-space: nowrap;
        margin-left: 10px;
        transition: opacity 0.3s ease, width 0.3s ease;
    }
    
    .sidebar a {
        margin: 0; /* Nav links start at the top of the sidebar container */
    }
    
    .topbar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        padding: 10px 30px;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .content {
        margin-top: 60px;
        margin-left: 250px;
        transition: margin-left 0.3s ease;
    }
    
   /* --- Collapsed State --- */
.sidebar.collapsed {
  width: 80px;
  padding: 12px 8px;
}

.sidebar.collapsed .brand {
  width: 80px;
  justify-content: center;
}

.sidebar.collapsed .brand span {
  opacity: 0;
  pointer-events: none;
  width: 0;
}

.sidebar.collapsed a span {
  display: none;
}
.sidebar.collapsed a {
  justify-content: center;
}

/* ADD THIS NEW CODE RIGHT HERE - Keep emoji icons visible when collapsed */
.sidebar.collapsed a::before {
  content: attr(data-emoji);
  font-size: 1.3rem;
}

.sidebar a::before {
  content: attr(data-emoji);
  margin-right: 8px;
}

.sidebar.collapsed a::before {
  margin-right: 0;
}
/* END OF NEW CSS CODE */
    
  </style>
</head>
<body>
  <!-- Sidebar (copied from assessments.html for pixel parity) -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo"><img src="safespace.png" alt="SafeSpace logo"></div>
      <span>SafeSpace</span>
    </div>
    <a href="index.html" data-emoji="ðŸ“…"><span>Appointments</span></a>
    <a href="history.html" data-emoji="ðŸ“‹"><span>History</span></a>
    <a href="assessments.html" data-emoji="ðŸ“"><span>Assessments</span></a>
    <a href="resources.html" data-emoji="ðŸ“š"><span>Resources</span></a>
    <a href="messages.html" class="active" data-emoji="ðŸ’¬"><span>Messages</span></a>
    <a href="settings.html" data-emoji="âš™ï¸"><span>Settings</span></a>
  </div>

  <!-- Topbar (copied from assessments.html for pixel parity) -->
  <div class="topbar" id="topbar">
    <div class="topbar-left">
      <div class="hamburger">
        <i class="fas fa-bars"></i>
      </div>
      <div class="mobile-logo"><img src="safespace.png" alt="SafeSpace"></div>
      <div class="portal-title">
        <strong><span class="safespace">RSU SafeSpace: </span>Student Portal</strong>
        <small></small>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:1rem; position:relative;">
      <div class="notif-wrapper" onclick="toggleNotif()">
        <span class="icon-btn">ðŸ””</span>
        <div class="notif-badge" style="position:absolute;right:4px;bottom:8px;width:8px;height:8px;background:#ef4444;border-radius:50%;border:2px solid var(--green)"></div>
      </div>
      <div id="notifDropdown" class="notif-dropdown">
        <div class="notif-header">Notifications</div>
        <div class="notif-list">
          <div class="notif-item" onclick="goToSection('appointments')">ðŸ”” New counseling slots available</div>
          <div class="notif-item" onclick="goToSection('messages')">ðŸ“© You have a new message from your counselor</div>
          <div class="notif-item" onclick="goToSection('assessments')">âš  Reminder: Complete your assessment</div>
        </div>
      </div>
      <div class="profile" onclick="window.location.href='profile.html'"></div>
    </div>
  </div>

  
  <!-- Content -->
  <div class="content" id="content">
    <div class="chat-layout" style="display:flex;gap:16px;height:100%;">
      <!-- Conversations list (left) -->
  <aside class="conversations-panel" style="width:320px;overflow:auto;background:#fff;padding:1rem;border-right:1px solid #eef2f6;">
        <h3 style="margin:0 0 10px 0;font-size:16px;">Conversations</h3>
        <div id="conversationsList" class="conversations-list">Loading conversations...</div>
      </aside>

      <!-- Chat area (right) -->
  <div class="chat-panel" id="chatPanel" style="flex:1;display:flex;flex-direction:column;min-width:0;padding-right:12px;">
        <!-- Chat Header -->
        <div class="chat-header">
      <div class="counselor-info">
        <button id="backToList" class="mobile-back" aria-label="Back" style="display:none;border:0;background:transparent;font-size:20px;margin-right:8px;cursor:pointer" onclick="document.body.classList.remove('mobile-chat-open'); document.body.style.overflow = '';">
          <i class="fas fa-circle-chevron-left" aria-hidden="true"></i>
        </button>
        <div class="counselor-avatar" id="counselorAvatar">
          SC
          <span class="online-dot" id="onlineStatus"></span>
        </div>
        <div class="counselor-details">
          <h3>SafeSpace Counselor</h3>
          <div class="counselor-status" id="counselorStatus">Connecting...</div>
        </div>
      </div>
      <div class="chat-actions">
        <!-- Updated: clicking this opens the student-side video call (embedded modal or new tab) -->
        <!-- Video call icon disabled for students: only counselors may start calls. Hover to see why. -->
        <i id="videoCallBtn" class="fas fa-video icon-disabled" title="Only counselors can start a video call" aria-disabled="true" style="cursor:not-allowed;"></i>
        <!-- Make the info icon focusable and keyboard-activatable for accessibility and ensure it's above overlays -->
        <i id="counselorInfoBtn" class="fas fa-circle-info icon-enabled" title="Counselor info" onclick="openCounselorInfo()" tabindex="0" role="button" aria-label="Counselor info"></i>
      </div>
        </div>

        <!-- Messages container (populated in realtime) -->
        <div id="messagesContainer" style="flex:1;overflow:auto;background:#fff;padding:1rem;">
          <p style="color:#666" id="noSessionMsg">Checking for active consultation...</p>
        </div>

        <!-- Chat Input Bar -->
        <div class="chat-input-bar">
          <!-- Attach & Emoji (left) -->
          <button id="attachBtn" class="icon-btn-inline" title="Attach image" aria-label="Attach image"><i class="fas fa-image" aria-hidden="true"></i></button>
          <input id="attachmentInput" type="file" accept="image/*" style="display:none">
          <!-- Attachment preview: larger rounded thumbnail with overlapping remove button -->
          <div id="attachmentPreview" style="display:none;position:relative;width:96px;height:96px;border-radius:12px;overflow:hidden;flex-shrink:0;margin-left:12px;">
            <img id="attachmentPreviewImg" src="" alt="attachment" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;" />
            <button id="attachmentRemove" title="Remove attachment" aria-label="Remove attachment" style="position:absolute;top:-12px;right:-12px;width:44px;height:44px;border-radius:999px;border:none;background:#fff;box-shadow:0 8px 20px rgba(2,6,23,0.12);display:none;align-items:center;justify-content:center;font-size:20px;color:#0f172a;">âœ•</button>
          </div>
          <input id="messageInput" type="text" class="chat-input" placeholder="Type your message..." style="padding:0.9rem 1rem;font-size:1rem;border-radius:8px;" />
          <button id="sendMessageBtn" class="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav (mobile only) -->
  <div class="bottom-nav">
    <a href="index.html"><span class="bn-emoji">ðŸ“…</span><span class="bn-label">Appointments</span></a>
    <a href="history.html"><span class="bn-emoji">ðŸ“‹</span><span class="bn-label">History</span></a>
    <a href="assessments.html"><span class="bn-emoji">ðŸ“</span><span class="bn-label">Assessments</span></a>
    <a href="resources.html"><span class="bn-emoji">ðŸ“š</span><span class="bn-label">Resources</span></a>
    <a href="messages.html" class="active"><span class="bn-emoji">ðŸ’¬</span><span class="bn-label">Messages</span></a>
    <a href="settings.html"><span class="bn-emoji">âš™ï¸</span><span class="bn-label">Settings</span></a>
  </div>

  
  <!-- Rating Modal (shown after a session/video/conversation ends) -->
  <div id="ratingModal" class="rating-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ratingTitle">
    <div class="rating-modal-box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="ratingTitle">Rate your counselor</h3>
        <button onclick="closeRatingModal()" style="background:transparent;border:0;font-size:18px;cursor:pointer" aria-label="Close rating dialog">âœ•</button>
      </div>
      <div class="rating-modal-meta">Please rate your recent session â€” your feedback helps improve counseling quality.</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div id="ratingStars" class="rating-stars" role="radiogroup" aria-label="Rating stars">
          <button class="star" data-value="1" aria-label="Rate 1" role="radio" aria-checked="false" tabindex="0"><i class="fa-regular fa-star"></i></button>
          <button class="star" data-value="2" aria-label="Rate 2" role="radio" aria-checked="false" tabindex="0"><i class="fa-regular fa-star"></i></button>
          <button class="star" data-value="3" aria-label="Rate 3" role="radio" aria-checked="false" tabindex="0"><i class="fa-regular fa-star"></i></button>
          <button class="star" data-value="4" aria-label="Rate 4" role="radio" aria-checked="false" tabindex="0"><i class="fa-regular fa-star"></i></button>
          <button class="star" data-value="5" aria-label="Rate 5" role="radio" aria-checked="false" tabindex="0"><i class="fa-regular fa-star"></i></button>
        </div>
        <div id="ratingLabel" class="rating-value" aria-live="polite">Not rated yet</div>
        <textarea id="ratingComment" class="rating-comment" rows="4" placeholder="Optional: leave a short comment..."></textarea>
        <div class="rating-actions">
          <button onclick="closeRatingModal()" class="rating-btn cancel">Cancel</button>
          <button id="submitRatingBtn" class="rating-btn submit">Submit Rating</button>
        </div>
      </div>
    </div>
  </div>
  
    <!-- Counselor Info Modal -->
    <div id="counselorInfoModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:3500">
      <div id="counselorInfoBox" style="background:#fff;width:94%;max-width:720px;margin:0 auto;border-radius:10px;padding:1rem;box-shadow:0 8px 30px rgba(2,6,23,0.18);position:relative;display:flex;gap:16px;align-items:flex-start;">
        <button onclick="closeCounselorInfo()" style="position:absolute;right:12px;top:10px;background:transparent;border:0;font-size:20px;cursor:pointer">âœ•</button>
        <!-- Avatar column -->
        <div id="ci-avatar" style="width:160px;min-width:160px;height:160px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#f1f5f9;font-size:40px;font-weight:800;color:#064e3b;cursor:pointer;border:4px solid rgba(0,0,0,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.06);" title="Click to enlarge photo" role="button" tabindex="0" aria-label="Open counselor photo"></div>
        <!-- Details column -->
        <div style="flex:1;min-width:0">
          <h3 id="ci-name" style="margin:0 0 6px 0;color:#064e3b;font-size:20px">Counselor Name</h3>
          <div id="ci-role" style="color:#0f7a34;font-weight:600;margin-bottom:10px">Specialization / Profession</div>
          <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
            <div id="ci-campus" style="flex:1;min-width:120px"><strong>Campus:</strong> <span></span></div>
            <div id="ci-college" style="flex:1;min-width:120px"><strong>College:</strong> <span></span></div>
          </div>
          <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
            <div id="ci-gender" style="flex:1;min-width:120px"><strong>Gender:</strong> <span></span></div>
            <div id="ci-contact" style="flex:1;min-width:120px"><strong>Contact:</strong> <span></span></div>
          </div>
          <div id="ci-bio" style="margin-top:8px;color:#333;font-size:14px;white-space:pre-wrap"></div>
        </div>
      </div>
    </div>

    <!-- Incoming call styles (improved UI) -->
    <style id="incoming-call-styles">
      .incoming-modal-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999999; background:rgba(0,0,0,0.55); animation: fadeIn .18s ease-out; }
      .incoming-panel{ width:80%; max-width:900px; height:60%; border-radius:10px; box-shadow:0 20px 60px rgba(2,6,23,0.35); display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:20px; transform:translateY(8px); animation: popIn .22s cubic-bezier(.2,.9,.3,1);
        /* moving warm-to-green gradient background to match requested look */
        background: linear-gradient(180deg, #cdb77a 0%, #9bd9b0 45%, #22d0a4 100%);
        background-size: 300% 300%;
        animation: popIn .22s cubic-bezier(.2,.9,.3,1), greenShift 9s ease infinite;
        color: #fff; /* use white text over the gradient */
      }
  .incoming-avatar{ width:160px; height:160px; border-radius:999px; background:transparent; display:flex; align-items:center; justify-content:center; font-size:44px; font-weight:800; color:#fff; box-shadow:0 8px 30px rgba(2,6,23,0.12); overflow:hidden; border:4px solid rgba(255,255,255,0.15); }
  .incoming-name{ font-size:28px; font-weight:900; color:#ffffff; text-shadow:0 2px 6px rgba(0,0,0,0.18); margin-top:8px; }
  .incoming-sub{ font-size:15px; color:rgba(255,255,255,0.92); opacity:0.95; margin-top:6px; }
      .incoming-btn-row{ display:flex; gap:28px; margin-bottom:28px; }
  .incoming-btn{ width:84px; height:84px; border-radius:999px; border:none; font-weight:700; font-size:22px; box-shadow:0 12px 30px rgba(2,6,23,0.18); cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .incoming-decline{ background:#ef4444; color:#fff; }
  .incoming-accept{ background:#10b981; color:#fff; }
  .incoming-label{ margin-top:8px; font-size:13px; color:rgba(255,255,255,0.95); }
  /* icon sizing inside circular buttons */
  .incoming-btn svg{ width:36px; height:36px; display:block; }
  .incoming-btn svg path{ fill:#ffffff; }
      @keyframes popIn{ from{ opacity:0; transform: translateY(16px) scale(.992) } to { opacity:1; transform: translateY(0) scale(1) } }
  @keyframes fadeIn{ from{ opacity:0 } to { opacity:1 } }
      @keyframes greenShift{ 0%{ background-position:0% 50% } 50%{ background-position:100% 50% } 100%{ background-position:0% 50% } }
    </style>

    <!-- Jitsi modal for embedded student video -->
    <div id="jitsiModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:4000">
      <div style="width:95%;height:90%;background:#fff;border-radius:8px;overflow:hidden;position:relative;display:flex;flex-direction:column">
        <button id="closeJitsiBtn" style="position:absolute;right:10px;top:8px;z-index:20;background:transparent;border:0;color:#111;font-size:24px;cursor:pointer">âœ•</button>
        <div id="jitsi-embed-container" style="flex:1;width:100%;height:100%;"></div>
      </div>
    </div>

    <!-- Disabled Video Explanation Modal -->
    <div id="disabledVideoModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:4500">
      <div style="background:#fff;width:92%;max-width:520px;margin:0 auto;border-radius:10px;padding:1rem;box-shadow:0 8px 30px rgba(2,6,23,0.14);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0;font-size:18px">Video calls â€” counselor only</h3>
          <button onclick="closeDisabledVideoModal()" style="background:transparent;border:0;font-size:18px;cursor:pointer" aria-label="Close">âœ•</button>
        </div>
        <div style="color:#374151;margin-bottom:10px">Only counselors can start a live video session.</div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button onclick="closeDisabledVideoModal()" style="background:#f3f4f6;border:0;padding:8px 12px;border-radius:6px;cursor:pointer">Close</button>
        </div>
      </div>
    </div>

  <!-- Add Firebase SDKs before your main script -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase_config.js"></script>
  
  <script>
    // Use shared firebase_config provided globals
    const auth = window.auth || (window.firebase ? firebase.auth() : null);
    const db = window.db || (window.firebase ? firebase.database() : null);
    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const topbar = document.getElementById("topbar");
      const content = document.getElementById("content");
      
      sidebar.classList.toggle("shrink");
      topbar.classList.toggle("shrink");
      content.classList.toggle("shrink");
    }

    // Notification toggle
    function toggleNotif() {
      const dropdown = document.getElementById("notifDropdown");
      const badge = document.querySelector(".notif-badge");
      dropdown.classList.toggle("active");
      if (dropdown.classList.contains("active")) { badge.classList.add("hidden"); }
    }
    
    document.addEventListener("click", function(e){
      const dropdown = document.getElementById("notifDropdown");
      const notifBtn = document.querySelector(".notif-wrapper");
      if (!notifBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
      }
    });

    // Navigation
    // Rating modal helpers: show/save per-consultation rating
    async function showRatingModal(consultRef){
      try{
        // showRatingModal accepts either a string consultId OR an object: { consultId, appointmentId, counselorId }
        let consultId = null;
        let appointmentId = null;
        if (!consultRef) return;
        if (typeof consultRef === 'string') {
          consultId = consultRef;
        } else if (typeof consultRef === 'object'){
          consultId = consultRef.consultId || null;
          appointmentId = consultRef.appointmentId || null;
        }

        // If consultId not provided but appointmentId is, try to resolve a consultation by appointmentId
        if (!consultId && appointmentId && window.db){
          try{
            const snap = await db.ref('consultations').orderByChild('appointmentId').equalTo(appointmentId).once('value');
            const val = snap.val() || {};
            const keys = Object.keys(val);
            if (keys.length) {
              consultId = keys[0];
            } else {
              // No consult found: create a minimal consultation record linking the student (if available)
              try{
                const newRef = db.ref('consultations').push();
                const createdAt = Date.now();
                const payload = { appointmentId: appointmentId, createdAt: createdAt, status: 'COMPLETED' };
                if (currentUserChat && currentUserChat.uid) { payload.studentId = currentUserChat.uid; payload.studentName = currentUserChat.displayName || null; }
                // include counselorId if provided in consultRef
                if (consultRef && consultRef.counselorId) payload.counselorId = consultRef.counselorId;
                await newRef.set(payload);
                consultId = newRef.key;
              }catch(e){ console.warn('failed to create consultation for appointmentId', e); }
            }
          }catch(e){ console.warn('failed to resolve consultation by appointmentId', e); }
        }

        if (!consultId) return;
        const modal = document.getElementById('ratingModal'); if (!modal) return;
        modal.classList.add('active');
        modal.dataset.consult = consultId;
        // reset UI
        setRatingStars(0);
        const commentEl = document.getElementById('ratingComment'); if (commentEl) commentEl.value = '';
        const labelEl = document.getElementById('ratingLabel'); if (labelEl) labelEl.textContent = 'Not rated yet';
        // prefill from localStorage if already saved
        try{
          const ratings = JSON.parse(localStorage.getItem('ratings') || '{}');
          const existing = ratings[consultId];
          if (existing){ setRatingStars(existing.rating || 0); if (commentEl) commentEl.value = existing.comment || ''; }
        }catch(e){}
        // focus first star for accessibility
        try{ const firstStar = document.querySelector('#ratingStars .star'); if (firstStar) firstStar.focus(); }catch(e){}
      }catch(e){ console.warn('showRatingModal failed', e); }
    }

    function closeRatingModal(){ try{ const m = document.getElementById('ratingModal'); if (m) m.classList.remove('active'); }catch(e){}
    }

    // Thank-you modal helpers
    let _thanksTimeout = null;
    function showThanksModal(message){
      try{
        const modal = document.getElementById('ratingThanksModal');
        if (!modal) return;
        const msg = document.getElementById('ratingThanksMessage'); if (msg) msg.textContent = message || 'Thanks for your feedback.';
        modal.classList.add('active');
        // auto-close after 2.5s
        try{ if (_thanksTimeout) clearTimeout(_thanksTimeout); _thanksTimeout = setTimeout(closeThanksModal, 2500); }catch(e){}
      }catch(e){ console.warn('showThanksModal failed', e); }
    }
    function closeThanksModal(){ try{ const m = document.getElementById('ratingThanksModal'); if (m) m.classList.remove('active'); if (_thanksTimeout) { clearTimeout(_thanksTimeout); _thanksTimeout = null; } }catch(e){}
    }

    function setRatingStars(n, persistPreview = true){
      try{
        n = Number(n) || 0;
        const stars = Array.from(document.querySelectorAll('#ratingStars .star'));
        stars.forEach((s, idx) => {
          const icon = s.querySelector('i');
          const i = idx + 1;
          if (!icon) return;
          if (n >= i){
            icon.className = 'fa-solid fa-star';
            s.classList.remove('inactive'); s.classList.remove('half');
            s.setAttribute('aria-checked', 'true');
          } else if (n >= i - 0.5){
            icon.className = 'fa-solid fa-star-half-stroke';
            s.classList.remove('inactive'); s.classList.add('half');
            s.setAttribute('aria-checked', 'mixed');
          } else {
            icon.className = 'fa-regular fa-star';
            s.classList.add('inactive'); s.classList.remove('half');
            s.setAttribute('aria-checked', 'false');
          }
        });
        const label = document.getElementById('ratingLabel'); if (label) { label.textContent = n ? (n + ' / 5') : 'Not rated yet'; }
        const modal = document.getElementById('ratingModal'); if (modal && persistPreview) modal.dataset.rating = String(n);
      }catch(e){ console.warn('setRatingStars failed', e); }
    }

    function attachHalfStarHandlers(){
      try{
        const stars = Array.from(document.querySelectorAll('#ratingStars .star'));
        stars.forEach((s, idx) => {
          s.addEventListener('mousemove', function(e){
            const rect = s.getBoundingClientRect();
            const relX = e.clientX - rect.left;
            const half = relX < rect.width / 2 ? 0.5 : 1;
            const preview = idx + half;
            setRatingStars(preview, true);
          });
          s.addEventListener('click', function(e){
            const rect = s.getBoundingClientRect();
            const relX = e.clientX - rect.left;
            const half = relX < rect.width / 2 ? 0.5 : 1;
            const rating = idx + half;
            setRatingStars(rating, true);
            s.focus();
          });
          s.addEventListener('mouseleave', function(){
            const modal = document.getElementById('ratingModal');
            const saved = modal && modal.dataset.rating ? Number(modal.dataset.rating) : 0;
            setRatingStars(saved || 0, true);
          });
          s.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); const rating = idx + 1; setRatingStars(rating, true); }
            else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); const modal = document.getElementById('ratingModal'); let cur = modal && modal.dataset.rating ? Number(modal.dataset.rating) : 0; cur = Math.max(0, cur - 0.5); setRatingStars(cur, true); }
            else if (e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); const modal = document.getElementById('ratingModal'); let cur = modal && modal.dataset.rating ? Number(modal.dataset.rating) : 0; cur = Math.min(5, cur + 0.5); setRatingStars(cur, true); }
          });
        });
      }catch(e){ console.warn('attachHalfStarHandlers failed', e); }
    }

    async function submitRating(){
      try{
        const modal = document.getElementById('ratingModal'); if (!modal) return;
        const consultId = modal.dataset.consult || null;
        const rating = Number(modal.dataset.rating || 0);
        const comment = (document.getElementById('ratingComment').value || '').trim();
        if (!consultId){ alert('No session id available to attach rating.'); closeRatingModal(); return; }
        if (!rating){ if (!confirm('You did not select a rating. Submit without star rating?')) return; }

        const payload = { consultationId: consultId, rating: rating || null, comment: comment || null, studentUid: currentUserChat ? currentUserChat.uid : null, counselorUid: activeCounselorUid || null, createdAt: Date.now() };

        // save locally (quick, offline-first) but avoid storing redundant consultationId inside the entry
        try{
          const ratings = JSON.parse(localStorage.getItem('ratings') || '{}');
          const localPayload = Object.assign({}, payload);
          try{ delete localPayload.consultationId; }catch(e){}
          ratings[consultId] = localPayload;
          localStorage.setItem('ratings', JSON.stringify(ratings));
        }catch(e){ console.warn('failed to persist rating locally', e); }

        // write rating to Firebase Realtime Database under the top-level ratings table
        try{
          if (window.db && typeof window.db.ref === 'function'){
            // choose a stable key: prefer studentUid so each student has at most one rating per consultation
            const studentKey = payload.studentUid || null;
            const ratingsBasePath = 'ratings/' + consultId; // main ratings node per consultation/appointment
            let ratingKey = null;

            if (studentKey) {
              ratingKey = String(studentKey);
            } else {
              // fallback to generated key when studentUid isn't available
              ratingKey = db.ref(ratingsBasePath).push().key;
            }

            // prepare entry payload without duplicated consultationId
            const entryPayload = Object.assign({}, payload);
            try{ delete entryPayload.consultationId; }catch(e){}

            const entryPath = ratingsBasePath + '/' + ratingKey;
            // DEBUG: log what we'll write so you can inspect in console if needed
            try{ console.debug('Writing rating entry to', entryPath, entryPayload); }catch(e){}

            // read existing rating (if any) for this key so we can update aggregates correctly
            let existingRating = null;
            try{
              const snap = await db.ref(entryPath).once('value');
              existingRating = snap.exists() ? snap.val() : null;
            }catch(e){ console.warn('failed to read existing rating', e); existingRating = null; }

            // write or overwrite the rating entry under ratings/<consultId>/<ratingKey>
            try{
              await db.ref(entryPath).set(entryPayload);
            }catch(e){ console.warn('failed to write rating entry', e); }

            // update aggregated stats under ratings/<consultId>/ratingStats
            try{
              const statsRef = db.ref(ratingsBasePath + '/ratingStats');
              await statsRef.transaction(function(current){
                const r = Number(payload.rating || 0);
                if (!current || typeof current !== 'object'){
                  // no stats yet
                  return { count: 1, sum: r, avg: r };
                }
                const prev = existingRating && typeof existingRating.rating !== 'undefined' ? Number(existingRating.rating) : null;
                if (prev === null){
                  // new rating
                  const count = (current.count || 0) + 1;
                  const sum = (current.sum || 0) + r;
                  return { count: count, sum: sum, avg: (count > 0 ? (sum / count) : 0) };
                } else {
                  // update existing rating: adjust sum, keep count
                  const count = (current.count || 0) || 1;
                  const sum = (current.sum || 0) - prev + r;
                  return { count: count, sum: sum, avg: (count > 0 ? (sum / count) : 0) };
                }
              });
            }catch(e){ console.warn('ratingStats transaction failed', e); }

            // store lastRating metadata under ratings/<consultId>/meta (non-critical)
            try{
              await db.ref(ratingsBasePath + '/meta').update({ lastRatingAt: payload.createdAt || Date.now(), lastRatingBy: payload.studentUid || null });
            }catch(e){ console.warn('failed to update ratings meta', e); }
          }
        }catch(e){
          console.warn('failed to push rating to ratings node', e);
        }

  closeRatingModal();
  // show a non-blocking thank-you modal instead of an alert
  try{ showThanksModal('Thanks for your feedback.'); }catch(e){ alert('Thanks for your feedback.'); }
      }catch(e){ console.warn('submitRating failed', e); alert('Failed to save rating locally.'); }
    }

    // wire submit button
    document.addEventListener('DOMContentLoaded', function(){
      const sb = document.getElementById('submitRatingBtn'); if (sb) sb.addEventListener('click', submitRating);
      // Attach half-star handlers so the rating modal matches the history modal behaviour
      try{ attachHalfStarHandlers(); }catch(e){}
      // Developer-only simulate button removed in production.
    });

    // Helper: find a consultation id for the current student and a counselor UID
    async function findConsultForStudentAndCounselor(counselorUid){
      try{
        if (!counselorUid) return null;
        if (!db) return null;
        const snap = await db.ref('consultations').once('value');
        const all = snap.val() || {};
        const keys = Object.keys(all);
        const me = currentUserChat && currentUserChat.uid ? currentUserChat.uid : null;
        for (let k of keys){
          const c = all[k] || {};
          const cId = c.counselorId || c.counselor_uid || (c.counselor && c.counselor.uid) || null;
          if (!cId) continue;
          // only consider consultations that belong to the logged-in student and match counselor
          const studentMatch = (c.studentId && String(c.studentId) === String(me)) || (c.student_uid && String(c.student_uid) === String(me)) || (c.studentUid && String(c.studentUid) === String(me));
          if (studentMatch && String(cId) === String(counselorUid)) return k;
        }
        return null;
      }catch(e){ console.warn('findConsultForStudentAndCounselor failed', e); return null; }
    }

    // Navigation
    function goToSection(sectionId) {
      if (sectionId === 'appointments') {
        window.location.href = 'index.html';
      } else {
        alert("Navigation to " + sectionId);
      }
      document.getElementById("notifDropdown").classList.remove("active");
    }

    // Load conversations and render left-side list (grouped by counselor)

    // Back navigation function
    function goBack() {
      // Check if there's a previous page in history
      if (document.referrer && document.referrer !== window.location.href) {
        window.history.back();
      } else {
        // Fallback to a default page (e.g., dashboard or appointments)
        window.location.href = 'index.html';
      }
    }
    
    // Chat actions
    function requestCall() {
      alert('Voice call request sent to counselor. They will contact you shortly.');
    }

    function requestVideoCall() {
      alert('Video call request sent to counselor. They will send you a meeting link.');
    }

    function showHelp() {
      alert('SafeSpace Support\n\n' +
            'â€¢ Chat with counselors 24/7\n' +
            'â€¢ Emergency: Call 911 or 988\n' +
            'â€¢ Campus counseling: (555) 123-4567\n' +
            'â€¢ Email: support@safespace.edu');
    }

    document.addEventListener('DOMContentLoaded', function() {
      var burger = document.getElementById('burgerToggle');
      if (burger) {
        burger.addEventListener('click', function(e) {
          e.stopPropagation();
          document.body.classList.toggle('collapsed');
          // Adjust content for collapsed sidebar
          var content = document.getElementById('content');
          if (content) content.classList.toggle('shrink');
          var topbar = document.getElementById('topbar');
          if (topbar) topbar.classList.toggle('shrink');
        });
      }

      // Wire admin-style hamburger (from messages.html) to collapse/expand sidebar
      var menuIcon = document.querySelector('.hamburger');
      if (menuIcon) {
        menuIcon.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          var sidebar = document.getElementById('sidebar');
          var topbar = document.getElementById('topbar');
          var mainContent = document.getElementById('content');
          function isMobile(){ return window.innerWidth <= 768; }
          if (isMobile()){
            // mobile: toggle overlay + mobile-open
            var overlay = document.querySelector('.sidebar-overlay');
            if (!overlay){ overlay = document.createElement('div'); overlay.className = 'sidebar-overlay'; document.body.appendChild(overlay); overlay.addEventListener('click', function(){ sidebar.classList.remove('mobile-open'); overlay.classList.remove('active'); document.body.style.overflow = ''; }); }
            var open = sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active', open);
            document.body.style.overflow = open ? 'hidden' : '';
          } else {
            // desktop: collapse
            var isCollapsed = sidebar.classList.toggle('collapsed');
            if (mainContent) mainContent.classList.toggle('shifted', isCollapsed);
            var brand = document.querySelector('.sidebar .brand'); if (brand) brand.classList.toggle('collapsed', isCollapsed);
            if (topbar) topbar.classList.toggle('shifted', isCollapsed);
          }
        });
      }
    });
    
  // --- Student chat integration for this chat view -----------------------
  let currentUserChat = null;
  let activeChatId = null;
  let _chatListenerRef = null;
  // track last prompted/joined room to avoid repeated prompts
  let _lastPromptedRoom = null;
  // New: active counselor-level view (one message box per counselor)
  let activeCounselorUid = null;
  let _consultationsListenerRef = null; // listener on consultations root when a counselor is selected
  let currentSessions = []; // array of consultation objects (sessions) for active counselor
  let activeConsultationId = null; // used as target for sends (latest session)
  // latest counselor profile object fetched from RTDB
  let currentCounselorProfile = null;
  // Image attachment state for chat
  let _pendingImage = null; // { dataUrl, fileName, mime }
  // guard to prevent duplicate sends and indicate send-in-progress
  let _isSending = false;

  // Resolve possible meeting room fields from a consultation object
  function resolveRoomFromConsultation(obj){
    if (!obj) return null;
    const candidates = [obj.videoRoom, obj.jitsiRoom, obj.room, obj.video_room, obj.video_url, obj.meetRoom, obj.meetingUrl, obj.meeting_link, obj.meetingRoom, obj.roomName];
    let room = candidates.find(Boolean);
    if (!room && obj.meta) room = obj.meta.room || obj.meta.videoRoom || obj.meta.meetingRoom;
    // also search nested session-level fields if provided
    if (!room && obj.sessions && Array.isArray(obj.sessions)){
      for (let s of obj.sessions){ if (s && (s.room || s.videoRoom || s.jitsiRoom)) { room = s.room || s.videoRoom || s.jitsiRoom; break; } }
    }
    return room ? String(room) : null;
  }

  // WebSocket helper: student will register to receive 'calling' events for a specific room
  let _ws = null;
  let _registeredRoom = null;
  let WS_ENABLED = false;
  try{
    if (window.WS_URL || window.WS_HOST || window.ENABLE_WS) WS_ENABLED = true;
  }catch(e){ WS_ENABLED = false; }

  function setupWebSocketForRoom(room){
    try{
      if (!WS_ENABLED) return;
      // if there's already an open socket, just (re)register for the room
      if (_ws && _ws.readyState === WebSocket.OPEN){
        if (room && room !== _registeredRoom){
          try{ _ws.send(JSON.stringify({ type: 'register', role: 'student', room: room })); _registeredRoom = room; }catch(e){ /* ignore send failures */ }
        }
        return;
      }

      // choose URL from explicit configuration when provided. This avoids attempting to connect
      // to 127.0.0.1:3000 by default which commonly isn't running and will produce a console error.
      let url = null;
      try{
        if (window.WS_URL) {
          url = window.WS_URL;
        } else if (window.WS_HOST) {
          const host = window.WS_HOST;
          const port = (typeof window.WS_PORT !== 'undefined' && window.WS_PORT) ? window.WS_PORT : 3000;
          const proto = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';
          url = proto + host + (port ? ':' + port : '') + '/';
        } else {
          // no explicit host provided; fall back to window.location only when ENABLE_WS was explicitly set
          if (window.ENABLE_WS) {
            const host = window.location.hostname || 'localhost';
            const port = (typeof window.WS_PORT !== 'undefined' && window.WS_PORT) ? window.WS_PORT : 3000;
            const proto = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';
            url = proto + host + (port ? ':' + port : '') + '/';
          }
        }
      }catch(e){ url = null; }

      if (!url) {
        // WS not configured; skip creating a WebSocket to avoid console network errors
        return;
      }

      try{
        _ws = new WebSocket(url);
      }catch(e){
        // fail silently (use console.debug so it's not noisy for end users)
        console.debug('WS connect failed', e);
        _ws = null;
        // try again later only if websockets are explicitly enabled
        if (window.ENABLE_WS || window.WS_URL || window.WS_HOST) setTimeout(()=>{ try{ setupWebSocketForRoom(room); }catch(e){} }, 5000);
        return;
      }

      _ws.addEventListener('open', ()=>{
        try{
          if (room) {
            _ws.send(JSON.stringify({ type: 'register', role: 'student', room: room }));
            _registeredRoom = room;
          }
        }catch(e){ /* ignore */ }
      });

      // Wire mobile back button to return to conversations list
      document.addEventListener('click', function(event) {
        // Use event delegation to catch clicks on the back button
        if (event.target.closest('#backToList')) {
          event.preventDefault();
          event.stopPropagation();
          document.body.classList.remove('mobile-chat-open');
          document.body.style.overflow = '';
        }
      });

      _ws.addEventListener('message', (ev)=>{
        let msg = null; try{ msg = JSON.parse(ev.data); }catch(e){ return; }
        if (!msg || !msg.type) return;
        if (msg.type === 'calling'){
          if (!msg.room || (msg.room && msg.room === _registeredRoom)){
            showIncomingCall(msg.from || 'Counselor', msg.room || _registeredRoom, null);
          }
        }
      });

      _ws.addEventListener('close', ()=>{ 
        _ws = null; _registeredRoom = null; 
        // schedule reconnect
        setTimeout(()=>{ try{ setupWebSocketForRoom(room); }catch(e){} }, 5000);
      });

      _ws.addEventListener('error', (e)=>{ console.debug('WS error', e); /* non-fatal, reconnect will be tried on close */ });
    }catch(e){ console.debug('setupWebSocketForRoom failed', e); }
  }

  // Incoming call UI for student
  function showIncomingCall(fromName, room, consultId){
    // full-screen incoming-call modal (mobile-friendly)
    const existing = document.getElementById('student-incoming-call-full');
    if (existing) { existing.querySelector('.caller-name').textContent = fromName; existing.dataset.room = room || ''; return; }

    const modal = document.createElement('div');
    modal.id = 'student-incoming-call-full';
  modal.dataset.room = room || '';
  if (consultId) modal.dataset.consult = consultId;
    // use CSS class for nicer visuals
    modal.className = 'incoming-modal-overlay';
    modal.style.fontFamily = 'Arial, Helvetica, sans-serif';

    const panel = document.createElement('div');
    panel.className = 'incoming-panel';

    // top spacer
    const topSpacer = document.createElement('div');
      const img = counselorAvatarEl.querySelector('img');
      if (img){
        try{
          // replace the initials text with the actual counselor photo (cloned)
          avatar.textContent = '';
          // clone the image node so we're not moving it out of the header
          const cloned = img.cloneNode(true);
          // ensure the cloned image fills the circular avatar and uses cover
          cloned.style.width = '100%';
          cloned.style.height = '100%';
          cloned.style.objectFit = 'cover';
          cloned.style.borderRadius = '50%';
          cloned.alt = img.alt || (fromName || 'Counselor');
          // clear any existing children and append cloned image
          while (avatar.firstChild) avatar.removeChild(avatar.firstChild);
          avatar.appendChild(cloned);
        }catch(e){}
      }
    // avatar
    const avatarWrap = document.createElement('div');
    avatarWrap.style.marginTop = '4vh';
    const avatar = document.createElement('div');
  avatar.style.width = '160px';
  avatar.style.height = '160px';
    avatar.style.borderRadius = '999px';
    avatar.style.background = '#fff';
    avatar.style.display = 'flex';
    avatar.style.alignItems = 'center';
    avatar.style.justifyContent = 'center';
    avatar.style.boxShadow = '0 8px 24px rgba(2,6,23,0.12)';
  avatar.style.fontSize = '44px';
    avatar.style.fontWeight = '800';
    avatar.textContent = (fromName && fromName.split(' ').map(s=>s[0]).slice(0,2).join('')) || 'C';
    avatarWrap.appendChild(avatar);
    // try to use counselor photo if available in header avatar
    try{
      const counselorAvatarEl = document.getElementById('counselorAvatar');
      if (counselorAvatarEl){
        const img = counselorAvatarEl.querySelector('img');
        if (img){
          avatar.innerHTML = '';
          const clone = img.cloneNode(true);
          clone.style.width = '100%'; clone.style.height = '100%'; clone.style.objectFit = 'cover'; clone.style.borderRadius = '50%';
          avatar.appendChild(clone);
        }
      }
    }catch(e){}

    // name + subtitle
    const nameBlock = document.createElement('div');
    nameBlock.style.textAlign = 'center';
    nameBlock.style.marginTop = '18px';
    const nameEl = document.createElement('div');
    nameEl.className = 'caller-name';
    nameEl.textContent = fromName || 'Counselor';
  nameEl.classList.add('incoming-name');
    const subEl = document.createElement('div');
    subEl.textContent = 'Video call';
  subEl.classList.add('incoming-sub');
    subEl.style.opacity = '0.9';
    nameBlock.appendChild(nameEl);
    nameBlock.appendChild(subEl);

    // center spacer
    const centerSpacer = document.createElement('div');
    centerSpacer.style.flex = '1';

    // buttons row
    const btnRow = document.createElement('div');
  btnRow.className = 'incoming-btn-row';

    // Decline wrapper with circular button and label
    const declineWrap = document.createElement('div');
    declineWrap.style.display = 'flex'; declineWrap.style.flexDirection = 'column'; declineWrap.style.alignItems = 'center';
    const decline = document.createElement('button');
    decline.className = 'incoming-btn incoming-decline';
    decline.setAttribute('aria-label','Decline');
    // close/X SVG (white)
    decline.innerHTML = `
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.89 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z" />
      </svg>
    `;
  decline.addEventListener('click', ()=>{ 
      try{ modal.remove(); }catch(e){}
      try{ stopIncomingAlerts(); }catch(e){}
      try{ clearActiveRoomStatus('student_decline'); }catch(e){}
    });
    const declineLabel = document.createElement('div');
    declineLabel.className = 'incoming-label';
    declineLabel.textContent = 'Decline';
    declineWrap.appendChild(decline); declineWrap.appendChild(declineLabel);

    // Accept wrapper with circular button and label
    const acceptWrap = document.createElement('div');
    acceptWrap.style.display = 'flex'; acceptWrap.style.flexDirection = 'column'; acceptWrap.style.alignItems = 'center';
    const accept = document.createElement('button');
    accept.className = 'incoming-btn incoming-accept';
    accept.setAttribute('aria-label','Answer');
    // camera SVG (white) to match provided style
    accept.innerHTML = `
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M17 10.5V7a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-3.5l4 4v-11l-4 4z" />
      </svg>
    `;
    accept.addEventListener('click', async ()=>{
      const r = modal.dataset.room || _registeredRoom;
      const consult = modal.dataset.consult || null;
      try{ modal.remove(); }catch(e){}
      try{ stopIncomingAlerts(); }catch(e){}

      // If we have a consult id, behave like the user clicked that conversation first
      if (consult){
        try{ attachChatListener(consult); activeConsultationId = consult; }catch(e){}
        try{
          const el = document.querySelector(`.conv-item[data-id="${consult}"]`);
          if (el){ el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }catch(e){}
      }

      if (!r){
        alert('No meeting room available to join.');
        return;
      }

      // Verify session is still open when we have a consultation id (best-effort)
      try{
        if (consult && db && typeof db.ref === 'function'){
          const snap = await db.ref('consultations/' + consult).once('value');
          const data = snap.val() || {};
          const status = (typeof data.roomStatus !== 'undefined') ? Number(data.roomStatus) : ((typeof data.room_status !== 'undefined') ? Number(data.room_status) : null);
          if (status === 0){ alert('The session has been closed and cannot be joined.'); return; }
        }
      }catch(e){ /* non-fatal: continue to attempt join */ }

      // Open embedded video
      try{ openJitsiEmbedded(r); }catch(e){ try{ openJitsiEmbedded(String(r)); }catch(e){ alert('Failed to open video.'); } }
    });
    const acceptLabel = document.createElement('div');
    acceptLabel.className = 'incoming-label';
    acceptLabel.textContent = 'Answer';
    acceptWrap.appendChild(accept); acceptWrap.appendChild(acceptLabel);

    btnRow.appendChild(declineWrap);
    btnRow.appendChild(acceptWrap);

    panel.appendChild(topSpacer);
    panel.appendChild(avatarWrap);
    panel.appendChild(nameBlock);
    panel.appendChild(centerSpacer);
    panel.appendChild(btnRow);

    modal.appendChild(panel);
    document.body.appendChild(modal);
    // focus accept button for quick keyboard action
    try{ accept.focus(); }catch(e){}

    // also show a browser notification and play ringtone/title flash so user sees it when on another tab
    try{ showBrowserNotification(fromName, room); startIncomingAlerts(fromName); }catch(e){ /* ignore */ }
  }

    // Time / Date helpers
    function formatTime(ts){
      if (!ts) return '';
      try{ return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){ return '' }
    }

    function isSameDay(a, b){
      const da = new Date(a); const db = new Date(b);
      return da.getFullYear() === db.getFullYear() && da.getMonth() === db.getMonth() && da.getDate() === db.getDate();
    }

    function formatDateLabel(ts){
      if (!ts) return '';
      const d = new Date(ts);
      const today = new Date();
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      if (isSameDay(d, today)) return 'Today';
      if (isSameDay(d, yesterday)) return 'Yesterday';
      // short month day, include year only when not current year
      const opts = { month: 'short', day: 'numeric' };
      if (d.getFullYear() !== today.getFullYear()) opts.year = 'numeric';
      return d.toLocaleDateString(undefined, opts);
    }

    // ----- Incoming call alerts: browser notification, title flash, ringtone -----
  let _ringtoneCtx = null;
  let _ringtoneGain = null;
  let _ringtoneInterval = null;
  let _ringtoneIndex = 0;
  let _titleInterval = null;
  let _origTitle = document.title;

    function startTitleFlash(name){
      try{
        if (_titleInterval) return;
        _origTitle = document.title || '';
        let show = false;
        _titleInterval = setInterval(()=>{
          document.title = show ? `Incoming: ${name}` : _origTitle;
          show = !show;
        }, 1000);
      }catch(e){}
    }

    function stopTitleFlash(){ try{ if (_titleInterval){ clearInterval(_titleInterval); _titleInterval = null; document.title = _origTitle; } }catch(e){} }

    // Start a short, pleasant ringtone melody using scheduled short oscillator notes.
    // This is more musical than a continuous tone and loops until stopped.
    function startRingtone(){
      try{
        if (_ringtoneCtx) return; // already running
        if (!(window.AudioContext || window.webkitAudioContext)) return;
        const Ctx = window.AudioContext || window.webkitAudioContext;
        _ringtoneCtx = new Ctx();
        _ringtoneGain = _ringtoneCtx.createGain();
        // keep overall volume low so it doesn't startle users
        _ringtoneGain.gain.value = 0.04;
        _ringtoneGain.connect(_ringtoneCtx.destination);

        // a short, friendly 4-note motif (A5, B5, D6, B5) in Hz
        const melody = [880, 987.77, 1174.66, 987.77];
        const noteDur = 300; // ms per note

        function playNote(freq, when, dur){
          try{
            const osc = _ringtoneCtx.createOscillator();
            const g = _ringtoneCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, when);
            // quick attack, gentle release
            g.gain.setValueAtTime(0.0, when);
            g.gain.linearRampToValueAtTime(0.08, when + 0.015);
            g.gain.linearRampToValueAtTime(0.0, when + dur / 1000);
            osc.connect(g);
            g.connect(_ringtoneGain);
            osc.start(when);
            osc.stop(when + dur / 1000 + 0.02);
            // let GC clean up refs after stop
            setTimeout(()=>{ try{ g.disconnect(); osc.disconnect(); }catch(e){} }, dur + 200);
          }catch(e){ console.warn('playNote failed', e); }
        }

        // schedule the first cycle immediately and then loop
        const scheduleCycle = ()=>{
          const start = _ringtoneCtx.currentTime + 0.02;
          for (let i = 0; i < melody.length; i++){
            const when = start + (i * (noteDur / 1000));
            playNote(melody[i], when, noteDur);
          }
        };

        // play one cycle now and then repeat every melody length
        scheduleCycle();
        _ringtoneInterval = setInterval(()=>{ try{ scheduleCycle(); }catch(e){} }, melody.length * noteDur + 100);
      }catch(e){ console.warn('ringtone start failed', e); }
    }

    function stopRingtone(){
      try{
        if (_ringtoneInterval){ clearInterval(_ringtoneInterval); _ringtoneInterval = null; }
        if (_ringtoneGain){ try{ _ringtoneGain.disconnect(); }catch(e){} _ringtoneGain = null; }
        if (_ringtoneCtx){ try{ _ringtoneCtx.close(); }catch(e){} _ringtoneCtx = null; }
      }catch(e){ console.warn('stopRingtone failed', e); }
    }

    function startIncomingAlerts(fromName){
      // start title flash + ringtone
      startTitleFlash(fromName || 'Caller');
      // start ringtone if user previously interacted (some browsers block autoplay)
      try{ startRingtone(); }catch(e){}
    }

    function stopIncomingAlerts(){ stopTitleFlash(); stopRingtone(); }

    // Image attachment helpers
    function clearPendingImagePreview(){
      try{
        _pendingImage = null;
        const attach = document.getElementById('attachmentInput'); if (attach) attach.value = '';
        const preview = document.getElementById('attachmentPreview'); if (preview) { preview.style.display = 'none'; }
        const previewImg = document.getElementById('attachmentPreviewImg'); if (previewImg) previewImg.src = '';
        const rem = document.getElementById('attachmentRemove'); if (rem) rem.style.display = 'none';
      }catch(e){ console.warn('clearPendingImagePreview failed', e); }
    }

    // Clear the consultation roomStatus = 0 for the currently active consultation.
    // This central helper is used by Decline / manual close / unload handlers so
    // all exit points consistently clear the DB state.
    async function clearActiveRoomStatus(clearedBy, consultIdParam){
      try{
        if (!window.db) return;
        let consultId = (typeof consultIdParam !== 'undefined' && consultIdParam) ? consultIdParam : null;
        if (!consultId){
          consultId = (typeof activeConsultationId !== 'undefined' && activeConsultationId) ? activeConsultationId : null;
        }
        // if modal carries a consult id, prefer that when activeConsultationId is not available
        try{
          const modal = document.getElementById('student-incoming-call-full');
          if (!consultId && modal && modal.dataset && modal.dataset.consult) consultId = modal.dataset.consult;
        }catch(e){}

        // If we still don't have a consultId but have a room, try to find the consultation that matches the room
        if (!consultId){
          try{
            const modal = document.getElementById('student-incoming-call-full');
            const room = modal && modal.dataset && modal.dataset.room ? modal.dataset.room : null;
            if (room){
              // scan consultations once to find a match by room fields
              const snap = await db.ref('consultations').once('value');
              const all = snap.val() || {};
              for (const k of Object.keys(all)){
                const c = all[k] || {};
                const resolved = resolveRoomFromConsultation(c);
                if (resolved && String(resolved) === String(room)) { consultId = k; break; }
              }
            }
          }catch(e){ console.warn('failed to resolve consult by room', e); }
        }

        // If still no consultId, try to resolve by active counselor (best-effort)
        if (!consultId){
          try{
            if (typeof findConsultForStudentAndCounselor === 'function' && activeCounselorUid){
              const maybe = await findConsultForStudentAndCounselor(activeCounselorUid);
              if (maybe) { consultId = maybe; }
            }
          }catch(e){ console.warn('fallback: findConsultForStudentAndCounselor failed', e); }
        }

        if (!consultId) return;
        // best-effort update; do not block UI on failures
        const payload = { roomStatus: 0 };
        // optional audit fields when available
        try{ if (clearedBy) payload.clearedBy = String(clearedBy); payload.clearedAt = Date.now(); }catch(e){}
        db.ref('consultations/' + consultId).update(payload).catch(()=>{});
        // Ensure the conversation is opened/attached so the UI matches clicking the conversation
        try{
          // attach listener so messages and header update immediately
          if (typeof attachChatListener === 'function') attachChatListener(consultId);
          try{ showConversationUI(); }catch(e){}
          try{
            const el = document.querySelector(`.conv-item[data-id="${consultId}"]`);
            if (el){ el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
          }catch(e){}
        }catch(e){ console.warn('failed to auto-open conversation after clearing roomStatus', e); }
        // Prompt student to rate the session when the consultation/video was ended by leaving/closing
        try{
          const endEvents = ['video_left','student_close','jitsi_ui_close','jitsi_removed','student_decline','video_ended','student_left'];
          if (consultId && clearedBy && endEvents.indexOf(String(clearedBy)) !== -1){
            // avoid showing the prompt multiple times for the same consultation
            try{
              if (!localStorage.getItem('rating_prompted_' + consultId)){
                  // small delay so any UI teardown finishes first
                  try{ console.debug('Prompting rating for consultId=', consultId, 'clearedBy=', clearedBy); }catch(e){}
                  setTimeout(()=>{ try{ showRatingModal(consultId); }catch(e){ console.warn('showRatingModal error', e); } }, 700);
                  localStorage.setItem('rating_prompted_' + consultId, '1');
                }
            }catch(e){}
          }
        }catch(e){}
      }catch(e){ console.warn('clearActiveRoomStatus failed', e); }
    }

    function showBrowserNotification(fromName, room){
      try{
        if (!('Notification' in window)) return;
        const body = fromName ? `${fromName} is calling you` : 'Incoming video call';
        // request permission if needed
        if (Notification.permission === 'default'){
          Notification.requestPermission().then(p => { if (p === 'granted') new Notification('Incoming call', { body }); });
          return;
        }
        if (Notification.permission === 'granted'){
          const n = new Notification(fromName ? `${fromName} â€” Video call` : 'Incoming call', { body, tag: room || 'video-call', renotify: true });
          n.onclick = function(ev){ try{ window.focus(); window.focus(); if (typeof openJitsiEmbedded === 'function'){ if (room) openJitsiEmbedded(room); } }catch(e){} this.close(); };
          // auto-close notification after 12s
          setTimeout(()=>{ try{ n.close(); }catch(e){} }, 12000);
        }
      }catch(e){ console.warn('notification failed', e); }
    }

    // Refresh conversation preview times: if a preview shows time for today but day changes, convert to date label
    function updateConversationPreviewTimes(){
      document.querySelectorAll('.conversations-list .conv-item').forEach(conv => {
        const ts = conv.getAttribute('data-last-ts');
        if (!ts) return;
        const timeEl = conv.querySelector('.conv-time');
        if (!timeEl) return;
        const isToday = (new Date(Number(ts))).toDateString() === (new Date()).toDateString();
        if (isToday) {
          timeEl.textContent = formatTime(Number(ts));
        } else {
          timeEl.textContent = formatDateLabel(Number(ts));
        }
        timeEl.title = new Date(Number(ts)).toLocaleString();
      });
    }

    function scheduleMidnightUpdate(){
      // compute ms until next local midnight
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
      const ms = next - now + 500; // small buffer
      setTimeout(()=>{ updateConversationPreviewTimes(); scheduleMidnightUpdate(); }, ms);
    }

    function renderChatMessages(msgs) {
      const container = document.getElementById('messagesContainer');
      container.innerHTML = '';
      if (!msgs || msgs.length === 0) {
        container.innerHTML = '<p style="color:#666">No messages yet. Say hello ðŸ‘‹</p>';
        return;
      }
      let lastDateKey = null;
      msgs.forEach(m => {
        // insert date separator when day changes
        const msgDateKey = m.timestamp ? new Date(m.timestamp).toDateString() : null;
        if (msgDateKey && msgDateKey !== lastDateKey) {
          lastDateKey = msgDateKey;
          const sep = document.createElement('div');
          sep.className = 'date-separator';
          const label = document.createElement('span');
          label.textContent = formatDateLabel(m.timestamp);
          sep.appendChild(label);
          container.appendChild(sep);
        }

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        // messenger-like sizing: auto width up to max, wrap long lines
        bubble.style.display = 'inline-block';
        bubble.style.maxWidth = '75%';
        bubble.style.width = 'auto';
  bubble.style.padding = '10px 14px';
  bubble.style.marginBottom = '8px';
  bubble.style.borderRadius = '20px';
  bubble.style.boxShadow = '0 1px 0 rgba(0,0,0,0.04)';
        bubble.style.background = (m.senderId === currentUserChat.uid) ? '#dcfce7' : '#f1f5f9';
        bubble.style.marginLeft = (m.senderId === currentUserChat.uid) ? 'auto' : '0';
        bubble.style.whiteSpace = 'pre-wrap';
        bubble.style.wordBreak = 'break-word';
        bubble.style.boxSizing = 'border-box';
        // label current user's messages as "You" and sanitize sender names (avoid showing raw emails)
        const isOwn = (m.senderId === currentUserChat.uid);
        let senderLabel = '';
        if (isOwn) {
          senderLabel = 'You';
        } else {
          const raw = m.senderName || (m.senderId === 'SYSTEM' ? 'System' : 'Counselor');
          if (typeof raw === 'string' && raw.includes('@')) {
            senderLabel = m.senderDisplayName || m.displayName || m.name || '';
          } else {
            senderLabel = raw || '';
          }
          if (typeof senderLabel === 'string' && senderLabel.includes('@')) senderLabel = '';
        // if still empty and we have a cached counselor profile for the active conversation, prefer that name
        try{
          if (!senderLabel && m.senderId && currentCounselorProfile){
            const p = currentCounselorProfile;
            const full = (p && (p.first_name || p.last_name)) ? `${p.first_name||''} ${p.last_name||''}`.trim() : (p && (p.name || p.fullName) ? (p.name || p.fullName) : 'Counselor');
            if (full) senderLabel = full;
          }
        }catch(e){}
        }
        const ts = m.timestamp ? formatTime(m.timestamp) : '';
        const tsFull = m.timestamp ? new Date(m.timestamp).toLocaleString() : '';
        // system messages centered
        if (m.senderId === 'SYSTEM'){
          const sys = document.createElement('div');
          sys.className = 'sys-message';
          sys.style.textAlign = 'center';
          sys.style.color = '#6b7280';
          sys.style.fontSize = '13px';
          sys.style.margin = '8px 0';
          sys.textContent = m.text || m.message || '';
          container.appendChild(sys);
        } else {
          // place sender label aligned based on ownership
          const labelHtml = isOwn ? `<div style="font-size:13px;color:#064e3b;font-weight:700;margin-bottom:6px;text-align:right">${senderLabel}</div>` : `<div style="font-size:13px;color:#064e3b;font-weight:700;margin-bottom:6px">${senderLabel}</div>`;
          // build content: image (if present) then text
          let contentHtml = '';
          if (m.imageData || m.imageURL){
            const src = m.imageData || m.imageURL;
            contentHtml += `<div><img src="${src}" style="max-width:320px;max-height:320px;border-radius:10px;display:block;margin-bottom:8px;" alt="image"/></div>`;
          }
          contentHtml += `<div style="font-size:14px;color:#111">${m.text||m.message||''}</div>`;
          // add title attribute for full timestamp on hover
          bubble.innerHTML = `${labelHtml}${contentHtml}<div style="font-size:11px;color:#666;margin-top:6px;text-align:right" title="${tsFull}">${ts}</div>`;
          // wrap the bubble inside a wrapper div to control alignment
          const wrapper = document.createElement('div');
          wrapper.className = 'message-row ' + (isOwn ? 'justify-end' : 'justify-start');
          wrapper.style.display = 'flex';
          wrapper.style.width = '100%';
          wrapper.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
          wrapper.appendChild(bubble);
          container.appendChild(wrapper);
        }
      });
      container.scrollTop = container.scrollHeight;
    }
      // ---------------- Video call (student-side) helpers -----------------
  let jitsiApi = null;
  // observer used to detect Jitsi DOM removal or prejoin-close clicks
  let _jitsiCloseObserver = null;
      let jitsiScriptLoaded = false;

      function generateRoomId(length = 16) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      function getQueryParam(key){ const params = new URLSearchParams(window.location.search); return params.get(key); }

      function loadJitsiScript(){
        return new Promise((resolve, reject)=>{
          if (jitsiScriptLoaded) return resolve();
          const s = document.createElement('script');
          s.src = 'https://8x8.vc/vpaas-magic-cookie-f889d6e6488646548cf6a78618a37cc8/external_api.js';
          s.onload = ()=>{ jitsiScriptLoaded = true; resolve(); };
          s.onerror = ()=> reject(new Error('Failed to load Jitsi script'));
          document.head.appendChild(s);
        });
      }

      async function openJitsiEmbedded(room){
        if (!room) { alert('No meeting room provided.'); return; }
        const modal = document.getElementById('jitsiModal');
        const container = document.getElementById('jitsi-embed-container');
        if (!modal || !container) { alert('Unable to show video here.'); return; }
        modal.style.display = 'flex';
        try{
          await loadJitsiScript();
          }catch(err){ console.error(err); alert('Failed to load video engine. Opening in new tab.');
            // build fallback URL including consultation id and counselor id/name
            const fallbackName = (currentUserChat && (currentUserChat.displayName||currentUserChat.email))||'Student';
            const consultId = (typeof activeConsultationId !== 'undefined' && activeConsultationId) ? activeConsultationId : '';
            const counselorParam = (typeof activeCounselorUid !== 'undefined' && activeCounselorUid) ? activeCounselorUid : (document.querySelector('.counselor-details h3') ? document.querySelector('.counselor-details h3').textContent : '');
            const url = 'video.html?room=' + encodeURIComponent(room) + '&consult=' + encodeURIComponent(consultId) + '&name=' + encodeURIComponent(fallbackName) + '&counselor=' + encodeURIComponent(counselorParam);
            window.open(url, '_blank');
            return; }

        // cleanup previous
        if (jitsiApi && typeof jitsiApi.dispose === 'function') { try{ jitsiApi.dispose(); }catch(e){} jitsiApi = null; }
        container.innerHTML = '';
        const domain = '8x8.vc';
        const options = {
          roomName: room,
          parentNode: container,
          host: domain,
          userInfo: { displayName: (currentUserChat && (currentUserChat.displayName || currentUserChat.email)) || 'Student' },
          configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: false },
          interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone','camera','chat','raisehand','hangup','tileview'] }
        };
        try{
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            // When the student leaves the conference, ensure the consultation roomStatus is cleared
            try{
              jitsiApi.addEventListener('videoConferenceLeft', function(){
                try{
                  // central helper to clear roomStatus; mark event source
                  clearActiveRoomStatus('video_left');
                }catch(e){ console.warn('failed to clear roomStatus on videoConferenceLeft', e); }
                // cleanup UI
                closeJitsiEmbedded();
              });

              // Also watch for Jitsi prejoin/close UI interactions that may not fire videoConferenceLeft
              try{
                // delegated click handler inside container: if a user clicks a close/leave button inside Jitsi UI,
                // treat it as an end and clear the roomStatus
                const delegatedClick = (ev)=>{
                  try{
                    const btn = ev.target && ev.target.closest && ev.target.closest('button[aria-label], button');
                    if (!btn) return;
                    // ignore clicks outside the container
                    if (!container.contains(btn)) return;
                    const label = (btn.getAttribute && (btn.getAttribute('aria-label') || '')).toLowerCase();
                    if (label.includes('close') || label.includes('leave') || label.includes('dismiss') || label.includes('hangup')){
                      clearActiveRoomStatus('jitsi_ui_close');
                    }
                  }catch(e){}
                };
                container.addEventListener('click', delegatedClick);

                // MutationObserver: if Jitsi removes its iframe or removes nodes from the container,
                // consider that the UI has been closed and clear roomStatus.
                _jitsiCloseObserver = new MutationObserver((mutations)=>{
                  try{
                    for (const m of mutations){
                      if (m.removedNodes && m.removedNodes.length){
                        for (const n of m.removedNodes){
                          if (n && n.querySelector && n.querySelector('iframe')){
                            clearActiveRoomStatus('jitsi_removed');
                          }
                        }
                      }
                    }
                  }catch(e){}
                });
                _jitsiCloseObserver.observe(container, { childList: true, subtree: true });
                // store refs on jitsiApi so cleanup can remove them
                jitsiApi._delegatedClickHandler = delegatedClick;
              }catch(e){ console.warn('failed to attach jitsi UI close detectors', e); }
            }catch(e){ console.warn('failed to attach jitsi event listeners', e); }
        }catch(err){ console.error('Jitsi init failed', err); alert('Failed to initialize video. Opening in new tab.');
          const fallbackName2 = (currentUserChat && (currentUserChat.displayName||currentUserChat.email))||'Student';
          const consultId2 = (typeof activeConsultationId !== 'undefined' && activeConsultationId) ? activeConsultationId : '';
          const counselorParam2 = (typeof activeCounselorUid !== 'undefined' && activeCounselorUid) ? activeCounselorUid : (document.querySelector('.counselor-details h3') ? document.querySelector('.counselor-details h3').textContent : '');
          const url2 = 'video.html?room=' + encodeURIComponent(room) + '&consult=' + encodeURIComponent(consultId2) + '&name=' + encodeURIComponent(fallbackName2) + '&counselor=' + encodeURIComponent(counselorParam2);
          window.open(url2, '_blank'); }
      }

      function closeJitsiEmbedded(){
        const modal = document.getElementById('jitsiModal');
        const container = document.getElementById('jitsi-embed-container');
        if (jitsiApi && typeof jitsiApi.dispose === 'function') { try{ jitsiApi.dispose(); }catch(e){} 
          // remove delegated click handler if set
          try{ if (jitsiApi._delegatedClickHandler && container) container.removeEventListener('click', jitsiApi._delegatedClickHandler); }catch(e){}
          // disconnect observer
          try{ if (_jitsiCloseObserver) { _jitsiCloseObserver.disconnect(); _jitsiCloseObserver = null; } }catch(e){}
          jitsiApi = null; }
        if (container) container.innerHTML = '';
        if (modal) modal.style.display = 'none';
        // when student closes the embedded video, clear roomStatus for this consultation
        try{
          clearActiveRoomStatus('student_close');
        }catch(e){ console.warn('Failed to clear roomStatus on student close', e); }
      }

      // Ensure roomStatus cleared if the student navigates away while in an embedded call
      window.addEventListener('beforeunload', function(){
        try{
          // best-effort: attempt to clear the active consultation roomStatus
          clearActiveRoomStatus('beforeunload');
        }catch(e){}
      });

      // Called when user clicks the video icon in the header
      async function openVideoCall(){
        // prefer the activeConsultationId if available
        try{
          if (activeConsultationId){
            const snap = await db.ref('consultations/' + activeConsultationId).once('value');
            const data = snap.val() || {};
            const candidates = [data.videoRoom, data.jitsiRoom, data.room, data.video_room, data.video_url, data.meetRoom, data.meetingUrl, data.meeting_link];
            let room = candidates.find(Boolean);
            if (!room && data.meta) room = data.meta.room || data.meta.videoRoom;
            if (room){ return openJitsiEmbedded(String(room)); }
          }
        }catch(err){ console.warn('Failed to read consultation for room', err); }
        // if we reach here there's no room provided by the counselor for the active consultation
        if (!activeConsultationId) {
          alert('Please select a conversation/session first.');
          return;
        }
        alert('No active video session from the counselor yet. The counselor must start the session and provide the meeting room before you can join.');
      }

      // Update the header video button state (enabled when a counselor-provided room exists
      // and either roomStatus is undefined (legacy) or explicitly active (roomStatus === 1)).
      function updateVideoButtonState(enabled, room){
        try{
          const btn = document.getElementById('videoCallBtn');
          if (!btn) return;
          if (enabled){
            btn.setAttribute('aria-disabled','false');
            // use CSS classes so media queries control the color (green on desktop, yellow on mobile)
            btn.classList.add('icon-enabled');
            btn.classList.remove('icon-disabled');
            btn.style.cursor = 'pointer';
            btn.title = 'Join video call';
            if (room) btn.dataset.room = String(room);
          } else {
            btn.setAttribute('aria-disabled','true');
            btn.classList.remove('icon-enabled');
            btn.classList.add('icon-disabled');
            btn.style.cursor = 'not-allowed';
            btn.title = 'Only counselors can start a video call';
            try{ delete btn.dataset.room; }catch(e){}
          }
        }catch(e){ console.warn('updateVideoButtonState failed', e); }
      }

      // Open/close helpers for the disabled-video modal
      function openDisabledVideoModal(){
        try{
          const m = document.getElementById('disabledVideoModal'); if (!m) return; m.style.display = 'flex';
        }catch(e){ console.warn('openDisabledVideoModal failed', e); }
      }
      function closeDisabledVideoModal(){
        try{ const m = document.getElementById('disabledVideoModal'); if (!m) return; m.style.display = 'none'; }catch(e){ console.warn('closeDisabledVideoModal failed', e); }
      }

      // wire close button
      document.addEventListener('DOMContentLoaded', function(){
        const closeBtn = document.getElementById('closeJitsiBtn');
        if (closeBtn) closeBtn.addEventListener('click', closeJitsiEmbedded);
        // wire video header icon: click will only act when enabled by updateVideoButtonState
        try{
          const vbtn = document.getElementById('videoCallBtn');
          if (vbtn){
            vbtn.addEventListener('click', function(){
              try{
                // If disabled, show a friendly modal explaining why they can't start a call
                if (vbtn.getAttribute('aria-disabled') === 'true'){
                  try{ openDisabledVideoModal(); }catch(e){ }
                  return;
                }
                // delegate to openVideoCall which will attempt to open the room for the active consultation
                try{ openVideoCall(); }catch(e){ console.warn('openVideoCall failed', e); }
              }catch(e){}
            });
          }
        }catch(e){}
          // If page was opened with a room/consult param (e.g. from a notification),
          // automatically show the incoming-call modal so the user sees the UI
          // similar to the screenshot and can Answer/Decline.
          (async function(){
            try{
              const roomParam = getQueryParam('room');
              const consultParam = getQueryParam('consult') || getQueryParam('consultId') || getQueryParam('consultation');
              const appointmentParam = getQueryParam('appointment') || getQueryParam('appointmentId');
              if (!roomParam && !consultParam && !appointmentParam) return;
              let room = roomParam || null;
              let name = 'Counselor';

              // If an appointment id was provided, try to resolve a consultation by appointmentId
              if (!consultParam && appointmentParam && db) {
                try{
                  const snap = await db.ref('consultations').once('value');
                  const all = snap.val() || {};
                  for (const k of Object.keys(all)){
                    const c = all[k] || {};
                    // accept various possible storing keys
                    if (String(c.appointmentId || c.appointment_id || c.appointment || c.appointmentKey || '') === String(appointmentParam)){
                      // found matching consultation
                      try{ name = c.counselorName || c.counselor_name || name; }catch(e){}
                      room = room || resolveRoomFromConsultation(c) || null;
                      // attach to this consultation immediately
                      try{ attachChatListener(k); activeConsultationId = k; }catch(e){}
                      break;
                    }
                  }
                }catch(e){ console.warn('failed to resolve consultation by appointment param', e); }
              }

              if (consultParam && db){
                try{
                  const snap = await db.ref('consultations/' + consultParam).once('value');
                  const data = snap.val() || {};
                  if (data.counselorName) name = data.counselorName;
                  // prefer explicit room in consult record if none provided in URL
                  if (!room){ const resolved = resolveRoomFromConsultation(data); if (resolved) room = resolved; }
                  // attach to this consultation so the conversation opens immediately
                  try{ attachChatListener(consultParam); activeConsultationId = consultParam; }catch(e){}
                }catch(e){ console.warn('failed to fetch consultation for incoming notification', e); }
              }

              if (room){
                // small delay to let the page finish rendering
                setTimeout(()=>{ try{ showIncomingCall(name, room, consultParam || appointmentParam); }catch(e){} }, 250);
              }
            }catch(e){ console.warn('auto incoming handler failed', e); }
          })();
      });
        // If redirected back from the embedded video player with ?consult=...&ended=1,
        // open that specific conversation so it behaves as if the user clicked it.
        document.addEventListener('DOMContentLoaded', function(){
          try{
            const consultParam = getQueryParam('consult') || getQueryParam('consultId') || getQueryParam('consultation');
            const ended = getQueryParam('ended');
            if (ended && consultParam){
              // small delay so the conversation list has time to render
              setTimeout(async ()=>{
                try{
                  // attach listener and show conversation UI
                  try{ attachChatListener(consultParam); activeConsultationId = consultParam; }catch(e){}
                  try{ showConversationUI(); }catch(e){}
                  // highlight and scroll the conversation item into view
                  try{
                    const el = document.querySelector(`.conv-item[data-id="${consultParam}"]`);
                    if (el){ el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  }catch(e){}
                }catch(e){ console.warn('auto-open conversation after video end failed', e); }
              }, 350);
            }
          }catch(e){ console.warn('post-video redirect handler failed', e); }
        });
    // UI helpers: hide conversation area until a conversation is selected
    function showEmptyConversation(){
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      container.innerHTML = '<div style="color:#666;padding:2rem;text-align:center">Select a conversation from the left to view messages.</div>';
      // hide input bar and top header completely
      const inputBar = document.querySelector('.chat-input-bar'); if (inputBar) inputBar.style.display = 'none';
      const header = document.querySelector('.chat-header'); if (header) header.style.display = 'none';
    }

    function showConversationUI(){
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      // ensure input bar visible
      const inputBar = document.querySelector('.chat-input-bar'); if (inputBar) inputBar.style.display = 'flex';
      const header = document.querySelector('.chat-header'); if (header) header.style.display = 'flex';
    }

    async function findOrAttachActiveConsultation() {
      // Search consultations where studentId === currentUserChat.uid OR any ACCEPTED session for this student
  const consRef = db.ref('consultations');
      const snap = await consRef.once('value');
      const data = snap.val() || {};
      const all = Object.keys(data).map(k=>({ id:k, ...data[k] }));
      const mine = all.find(c => c.studentId === currentUserChat.uid);
      const accepted = all.find(c => c.status === 'ACCEPTED' && c.studentId === currentUserChat.uid);
      const chosen = mine || accepted || null;
      if (!chosen) {
        const noMsgEl = document.getElementById('noSessionMsg');
        if (noMsgEl) noMsgEl.textContent = 'No active consultation. Go to Messages to join an open session.';
        return;
      }
  attachChatListener(chosen.id);
  // fetch and render counselor profile (photo) if possible
  if (chosen.counselorId) fetchAndSetCounselorProfile(chosen.counselorId);
      // Update header
      const headerName = document.querySelector('.counselor-details h3');
      if (headerName) headerName.textContent = chosen.counselorName || 'Counselor';
      const status = document.getElementById('counselorStatus');
      if (status) status.textContent = chosen.status || '';
    }

    function attachChatListener(id) {
      // detach previous
      if (_chatListenerRef) { try { _chatListenerRef.off(); } catch(e){} _chatListenerRef = null; }
      activeChatId = id;
  const ref = db.ref('consultations/' + id);
      _chatListenerRef = ref;
      ref.on('value', snap => {
        const s = snap.val() || {};
        const msgs = s.messages || [];
        // show conversation UI now that we have an active consultation
        showConversationUI();
        renderChatMessages(msgs);
        // highlight the corresponding conversation item in the list
        try{
          document.querySelectorAll('.conv-item').forEach(n=>n.classList.remove('active'));
          const btn = document.querySelector(`.conv-item[data-id="${id}"]`);
          if (btn) btn.classList.add('active');
        }catch(e){}
        const status = document.getElementById('counselorStatus');
        if (status) status.textContent = s.status || '';
        // if counselorId appears/changes, try to fetch profile
        if (s.counselorId) fetchAndSetCounselorProfile(s.counselorId);
        // if counselor started a video session and saved a room, prompt student to join
        try{
          const room = resolveRoomFromConsultation(s);
          if (room){
            // ensure student websocket is registered for this room so 'calling' events are received
            try{ setupWebSocketForRoom(room); }catch(e){}
          }
          // If counselor explicitly set roomStatus === 1, treat as an incoming call and show overlay
          try{
              if (s && Number(s.roomStatus) === 1 && room && room !== _lastPromptedRoom){
              _lastPromptedRoom = room;
              // show incoming-call overlay immediately (uses counselor name if available)
              try{ showIncomingCall(s.counselorName || s.from || 'Counselor', room, id); }catch(e){}
            } else if (s && (s.roomStatus === 0 || s.roomStatus === '0')){
              // clear prompt guard so future calls can re-prompt
              if (_lastPromptedRoom && _lastPromptedRoom === room) _lastPromptedRoom = null;
              // if an incoming modal is showing, remove it and stop alerts
              try{
                const existingModal = document.getElementById('student-incoming-call-full');
                if (existingModal){ existingModal.remove(); try{ stopIncomingAlerts(); }catch(e){} }
              }catch(e){}
            }
          }catch(e){ console.warn('roomStatus handling failed', e); }

          if (room && room !== _lastPromptedRoom){
            // small, non-blocking prompt asking student to join (legacy fallback)
            // only run the legacy confirm when the counselor hasn't set an explicit roomStatus
            if (s && (s.roomStatus === undefined || s.roomStatus === null)){
              _lastPromptedRoom = room;
              setTimeout(()=>{
                const join = confirm('Your counselor started a video session. Join now?');
                if (join) openJitsiEmbedded(room);
              }, 300);
            }
          }
          // Update video button: enabled only when a room exists and is active (or no explicit roomStatus)
          try{
            const enabled = Boolean(room) && (s.roomStatus === undefined || s.roomStatus === null || Number(s.roomStatus) === 1);
            updateVideoButtonState(enabled, room);
          }catch(e){ }
        }catch(e){ console.warn('video room detection failed', e); }
      });
      // If attaching a chat on mobile, open full-chat view so it fills the viewport
      try{ if (window.innerWidth <= 768) document.body.classList.add('mobile-chat-open'); }catch(e){}
    }

    // Fetch counselor profile from RTDB and set avatar image / initials
    async function fetchAndSetCounselorProfile(counselorUid) {
      try {
  const q = db.ref('counselors').orderByChild('uid').equalTo(counselorUid);
        const snap = await q.once('value');
        const val = snap.val();
        let profile = null;
        if (val) {
          const keys = Object.keys(val);
          profile = val[keys[0]];
        }
        // store globally for the info modal
        try{ currentCounselorProfile = profile || null; }catch(e){}
        const avatarEl = document.getElementById('counselorAvatar');
        if (!avatarEl) return;
        // clear existing
        avatarEl.innerHTML = '';
        // try multiple candidate fields for profile image (cover keys used in admin panel)
        const photo = (profile && (profile.photo_url || profile.photo || profile.avatar || profile.photoUrl || profile.image)) || '';
        console.log('fetchAndSetCounselorProfile: resolved profile for', counselorUid, Object.keys(profile||{}), 'photo=', photo);
        if (profile && photo) {
          const img = document.createElement('img');
          img.src = photo;
          img.alt = profile.first_name ? (profile.first_name + ' ' + (profile.last_name||'')) : 'Counselor';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '50%';
          avatarEl.appendChild(img);
        } else {
          // fallback initials
          const name = (profile && (profile.first_name || profile.last_name)) ? `${profile.first_name||''} ${profile.last_name||''}`.trim() : 'CN';
          const initials = name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'CN';
          avatarEl.textContent = initials;
          const dot = document.createElement('span');
          dot.className = 'online-dot';
          dot.id = 'onlineStatus';
          avatarEl.appendChild(dot);
        }
        // update header with counselor name + specialization if available
        try{
          const headerName = document.querySelector('.counselor-details h3');
          const headerStatus = document.getElementById('counselorStatus');
          if (headerName) {
            const fullName = profile && (profile.first_name || profile.last_name) ? `${profile.first_name||''} ${profile.last_name||''}`.trim() : (profile && (profile.name || profile.fullName) ? (profile.name || profile.fullName) : 'Counselor');
            // possible specialization fields
            const spec = profile && (profile.specialization || profile.specialty || profile.area || profile.expertise || profile.department || profile.title) ? (profile.specialization || profile.specialty || profile.area || profile.expertise || profile.department || profile.title) : '';
            headerName.textContent = spec ? `${fullName} â€” ${spec}` : fullName;
          }
          if (headerStatus && profile) {
            // prefer an explicit status/title field, otherwise keep existing status
            headerStatus.textContent = profile.status || profile.title || headerStatus.textContent || '';
          }
        }catch(e){ console.warn('Failed to set header info', e); }
      } catch (err) {
        console.warn('Failed to fetch counselor profile', err);
      }
    }

    // Open counselor info modal populated from the last fetched profile
    function openCounselorInfo(){
      const m = document.getElementById('counselorInfoModal');
      if (!m) return;
      // prefer the cached profile, fall back to DOM header
      const p = currentCounselorProfile || {};
      const name = (p && (p.first_name || p.last_name)) ? `${p.first_name||''} ${p.last_name||''}`.trim() : (document.querySelector('.counselor-details h3') ? document.querySelector('.counselor-details h3').textContent : 'Counselor');
      const role = p.specialization || p.specialty || p.title || p.profession || '';
  const campus = p.campus || p.campus_branch || p.location || p.campus_assigned || '';
  const college = p.college || p.department || p.unit || '';
  const gender = p.gender || p.sex || '';
  // phone / email keys used in admin panel: phone_number, email_address
  const contactPhone = p.phone_number || p.phone || p.contact || p.mobile || p.contact_number || '';
  const contactEmail = p.email_address || p.email || '';
  const contact = contactPhone ? contactPhone : (contactEmail ? contactEmail : (p.username || ''));
      const bio = p.bio || p.about || p.description || '';

      const elName = document.getElementById('ci-name'); if (elName) elName.textContent = name;
      const elRole = document.getElementById('ci-role'); if (elRole) elRole.textContent = role || 'â€”';
      const elCampus = document.getElementById('ci-campus'); if (elCampus) elCampus.querySelector('span').textContent = campus || 'â€”';
      const elCollege = document.getElementById('ci-college'); if (elCollege) elCollege.querySelector('span').textContent = college || 'â€”';
      const elGender = document.getElementById('ci-gender'); if (elGender) elGender.querySelector('span').textContent = gender || 'â€”';
      const elContact = document.getElementById('ci-contact'); if (elContact) elContact.querySelector('span').textContent = contact || 'â€”';
      const elBio = document.getElementById('ci-bio'); if (elBio) elBio.textContent = bio || '';

      // populate avatar area (clickable to enlarge)
      try{
        const avatarEl = document.getElementById('ci-avatar');
        if (avatarEl){
          // clear existing
          avatarEl.innerHTML = '';
          avatarEl.style.background = '#f1f5f9';
          avatarEl.style.color = '#064e3b';
          const photo = p && (p.photo_url || p.photo || p.photoUrl || p.image) ? (p.photo_url || p.photo || p.photoUrl || p.image) : null;
          if (photo){
            const img = document.createElement('img');
            img.src = photo;
            img.alt = name || 'Counselor';
            img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; img.style.display = 'block';
            img.style.cursor = 'zoom-in';
            avatarEl.appendChild(img);
            avatarEl.onclick = function(ev){ ev.stopPropagation(); openCounselorImage(photo); };
            avatarEl.onkeydown = function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCounselorImage(photo); } };
          } else {
            // initials fallback
            const displayName = name || 'Counselor';
            const initials = displayName.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'CN';
            const span = document.createElement('div');
            span.textContent = initials;
            span.style.fontSize = '48px'; span.style.fontWeight = '800'; span.style.width = '100%'; span.style.height = '100%'; span.style.display='flex'; span.style.alignItems='center'; span.style.justifyContent='center';
            avatarEl.appendChild(span);
            avatarEl.onclick = null; avatarEl.onkeydown = null;
          }
        }
      }catch(e){ console.warn('Failed to populate counselor avatar', e); }

      m.style.display = 'flex';
    }

    function closeCounselorInfo(){ const m = document.getElementById('counselorInfoModal'); if (m) m.style.display = 'none'; }

    // Lightweight lightbox for counselor photo enlargement
    function openCounselorImage(url){
      try{
        if (!url) return;
        // if already open, do nothing
        if (document.getElementById('ci-image-overlay')) return;
        const ov = document.createElement('div');
        ov.id = 'ci-image-overlay';
        ov.style.position = 'fixed'; ov.style.inset = '0'; ov.style.display = 'flex'; ov.style.alignItems = 'center'; ov.style.justifyContent = 'center';
        ov.style.background = 'rgba(0,0,0,0.85)'; ov.style.zIndex = 100000; ov.style.cursor = 'zoom-out';
        ov.onclick = function(){ try{ ov.remove(); }catch(e){} };
        const img = document.createElement('img'); img.src = url; img.alt = 'Counselor photo';
        img.style.maxWidth = '92%'; img.style.maxHeight = '92%'; img.style.boxShadow = '0 12px 40px rgba(0,0,0,0.6)'; img.style.borderRadius = '8px'; img.style.display = 'block'; img.style.objectFit = 'contain';
        // prevent clicks on the image from bubbling and closing immediately
        img.onclick = function(ev){ ev.stopPropagation(); };
        ov.appendChild(img);
        document.body.appendChild(ov);
      }catch(e){ console.warn('openCounselorImage failed', e); }
    }

    // close modal if clicking outside content
    // NOTE: ignore clicks that originate from the counselor info button itself so opening it
    // doesn't immediately close it due to this document-wide listener.
    document.addEventListener('click', function(e){
      try{
        // if the click came from the info button (or a child), don't treat it as an outside click
        if (e && e.target && e.target.closest && e.target.closest('#counselorInfoBtn')) return;
      }catch(err){}
      const m = document.getElementById('counselorInfoModal');
      if (!m || m.style.display !== 'flex') return;
      const box = m.querySelector('div');
      if (box && !box.contains(e.target)) closeCounselorInfo();
    });

    async function sendChatMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;
      // send to the currently active consultation for the selected counselor (most recent session)
      if (!activeConsultationId) { alert('No open session for this counselor. Please select or join a session.'); return; }
  const ref = db.ref('consultations/' + activeConsultationId);
      const snap = await ref.once('value');
      const s = snap.val() || {};
      const msgs = s.messages || [];
      msgs.push({ senderId: currentUserChat.uid, senderName: currentUserChat.displayName || currentUserChat.email, text: text, timestamp: Date.now() });
      await ref.update({ messages: msgs });
      input.value = '';
    }

    document.addEventListener('DOMContentLoaded', function(){
      // Attach / attachment preview wiring
      try{
        const attachBtn = document.getElementById('attachBtn');
        const attachInput = document.getElementById('attachmentInput');
        const preview = document.getElementById('attachmentPreview');
        const previewImg = document.getElementById('attachmentPreviewImg');
        const sendBtn = document.getElementById('sendMessageBtn');

        if (attachBtn && attachInput){
          attachBtn.addEventListener('click', function(e){ try{ attachInput.click(); }catch(e){} });

          attachInput.addEventListener('change', function(e){
            try{
              const f = (attachInput.files && attachInput.files[0]) || null;
              if (!f) return;
              if (!f.type || !f.type.startsWith('image/')){ alert('Please select an image file.'); attachInput.value = ''; return; }
              const reader = new FileReader();
              reader.onload = function(ev){
                try{
                  _pendingImage = { dataUrl: ev.target.result, fileName: f.name, mime: f.type };
                  if (previewImg) previewImg.src = _pendingImage.dataUrl;
                  if (preview) preview.style.display = 'block';
                  try{ const rem = document.getElementById('attachmentRemove'); if (rem) rem.style.display = 'flex'; }catch(e){}
                }catch(e){ console.warn('attachment preview failed', e); }
              };
              reader.readAsDataURL(f);
            }catch(e){ console.warn('attach change failed', e); }
          });
        }

        // wire remove button to clear pending image
        try{
          const remBtn = document.getElementById('attachmentRemove');
          if (remBtn){ remBtn.addEventListener('click', function(ev){ ev.preventDefault(); clearPendingImagePreview(); }); remBtn.style.display = 'none'; }
        }catch(e){}

        if (sendBtn){
          sendBtn.addEventListener('click', async function(){
            try{
              if (_pendingImage){
                if (_isSending) return;
                _isSending = true;
                const inputEl = document.getElementById('messageInput');
                const caption = inputEl ? (inputEl.value || '').trim() : '';
                const message = {
                  senderId: currentUserChat ? currentUserChat.uid : null,
                  senderName: currentUserChat ? (currentUserChat.displayName || currentUserChat.email) : 'Student',
                  imageData: _pendingImage.dataUrl,
                  imageName: _pendingImage.fileName || '',
                  imageMime: _pendingImage.mime || '',
                  text: caption || '',
                  timestamp: Date.now(),
                  id: 'm-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9)
                };

                // clear preview and caption input immediately for snappy UX
                try{ clearPendingImagePreview(); }catch(e){}
                try{ if (inputEl) inputEl.value = ''; }catch(e){}
                try{ sendBtn.disabled = true; }catch(e){}

                // perform DB write (best-effort)
                try{
                  if (!activeConsultationId){ alert('No active consultation to send image to.'); _isSending = false; try{ sendBtn.disabled = false; }catch(e){}; return; }
                  const ref = db.ref('consultations/' + activeConsultationId);
                  const snap = await ref.once('value');
                  const data = snap.val() || {};
                  const msgs = Array.isArray(data.messages) ? data.messages.slice() : [];
                  msgs.push(message);
                  await ref.update({ messages: msgs });
                }catch(err){ console.warn('failed to write image message', err); try{ alert('Failed to send image. Please try again.'); }catch(e){} }
                finally { _isSending = false; try{ sendBtn.disabled = false; }catch(e){} }

                return;
              }
              // otherwise normal text send (existing behavior)
              sendChatMessage();
            }catch(e){ console.warn('send button failed', e); }
          });

          // Send on Enter: delegate to the send button so image/text logic is centralized
          try{
            const inputEl2 = document.getElementById('messageInput');
            if (inputEl2){ inputEl2.addEventListener('keydown', function(ev){ if (ev.key === 'Enter'){ ev.preventDefault(); sendBtn.click(); } }); }
          }catch(e){}
        }

      }catch(e){ console.warn('attachment init failed', e); }

      // keyboard support for counselor info button
      try{
        const infoBtn = document.getElementById('counselorInfoBtn');
        if (infoBtn){
          infoBtn.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); try{ openCounselorInfo(); }catch(err){} } });
        }
      }catch(e){ /* ignore */ }
    });

    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentUserChat = user;
        // Populate topbar profile and student ID (same behavior as messages.html)
        try {
          db.ref('students').orderByChild('uid').equalTo(user.uid).once('value').then(function(snapshot) {
            if (snapshot.exists()) {
              snapshot.forEach(function(child) {
                const data = child.val();
                // Update profile image in topbar/sidebar
                const topbarProfile = document.querySelector('.profile');
                if (topbarProfile) {
                  if (data.photo_url) {
                    topbarProfile.innerHTML = `<img src="${data.photo_url}" alt="Profile Photo" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">`;
                  } else {
                    topbarProfile.textContent = (data.username || data.first_name || 'U')[0].toUpperCase();
                  }
                }
                // Update student ID in topbar
                const topbarStudentId = document.querySelector('.portal-title small');
                if (topbarStudentId) {
                  topbarStudentId.textContent = "ID: " + (data.student_id || 'N/A');
                }
              });
            }
          }).catch(function(err){ console.warn('Failed to load student profile', err); });
        } catch(e) { console.warn('Error while populating profile', e); }

        // do not auto-attach to any consultation â€” user must click a conversation
        loadConversationsList();
        showEmptyConversation();
      } else {
        // not authenticated, redirect handled elsewhere
      }
    });

    
  
    // Load conversations and render left-side list (grouped by counselor)
    async function loadConversationsList(){
      const listEl = document.getElementById('conversationsList');
      if (!listEl) return;
      listEl.innerHTML = '<div style="color:#666">Loading...</div>';
      try{
        // determine student DB key (some consultations store student by DB key instead of auth uid)
        let studentDbKey = null;
        try{
          const stuSnap = await db.ref('students').orderByChild('uid').equalTo(currentUserChat.uid).once('value');
          const sv = stuSnap.val();
          if (sv) studentDbKey = Object.keys(sv)[0];
        }catch(e){ console.warn('Failed to read student record', e); }

  const snap = await db.ref('consultations').once('value');
        const data = snap.val() || {};
        let items = Object.keys(data).map(k=>({ id:k, ...data[k]}));

        // helper: resolve student id from consultation (many possible fields)
        const studentFields = ['studentId','student_id','student_uid','studentUid','student'];
        function consultStudentId(c){
          for (let f of studentFields){ if (c && c[f]) return String(c[f]); }
          if (c && c.student && typeof c.student === 'object'){
            if (c.student.uid) return String(c.student.uid);
            if (c.student.id) return String(c.student.id);
          }
          return null;
        }

        // filter consultations that belong to this student
        items = items.filter(c => {
          const sid = consultStudentId(c);
          return sid && (String(sid) === String(currentUserChat.uid) || (studentDbKey && String(sid) === String(studentDbKey)));
        });

        if (items.length === 0) { listEl.innerHTML = '<div style="color:#666">No conversations yet.</div>'; return; }

        // group consultations by counselor id (fall back to counselorName if id missing)
        const groups = {};
        items.forEach(c => {
          const cid = c.counselorId || c.counselor_uid || (c.counselor && c.counselor.uid) || ('__no_counselor__:' + (c.counselorName||'Unknown'));
          if (!groups[cid]) groups[cid] = { counselorId: cid, name: c.counselorName || (c.counselor && (c.counselor.first_name||c.counselor.name)) || 'Counselor', sessions: [] };
          groups[cid].sessions.push({ id: c.id, data: c });
        });

        // create one conv item per counselor
        listEl.innerHTML = '';
        const profileCache = {};
        async function getCounselorPhoto(uid){
          if (!uid) return null;
          if (profileCache[uid]) return profileCache[uid];
          try{
            const snap = await db.ref('counselors').orderByChild('uid').equalTo(uid).once('value');
            const v = snap.val();
            if (v){ const k = Object.keys(v)[0]; const p = v[k]; const photo = p.photo_url || ''; profileCache[uid] = { photo, profile: p }; return profileCache[uid]; }
          }catch(e){ console.warn('failed to fetch counselor profile', e); }
          profileCache[uid] = { photo: null, profile: null };
          return profileCache[uid];
        }

        Object.keys(groups).forEach(async (gid) => {
          const g = groups[gid];
          const conv = document.createElement('button');
          conv.className = 'conv-item card';
          conv.style.display = 'flex'; conv.style.alignItems = 'center'; conv.style.gap = '12px'; conv.style.width = '100%'; conv.style.border = '0'; conv.style.cursor = 'pointer';
          conv.setAttribute('data-counselor-id', g.counselorId);

          const avatarHolder = document.createElement('div'); avatarHolder.className = 'avatar-holder'; avatarHolder.style.width='44px'; avatarHolder.style.height='44px'; avatarHolder.style.borderRadius='9999px'; avatarHolder.style.overflow='hidden'; avatarHolder.style.flex='0 0 auto'; avatarHolder.style.background='#f1f5f9';
          // try to find a photo from any session
          (async ()=>{
            let usedPhoto = null;
            for (let s of g.sessions){ if (s.data.counselorPhoto) { usedPhoto = s.data.counselorPhoto; break; } }
            if (!usedPhoto && gid && !String(gid).startsWith('__no_counselor__')){
              const res = await getCounselorPhoto(gid);
              if (res && res.photo) usedPhoto = res.photo;
            }
            avatarHolder.innerHTML = '';
            if (usedPhoto){ const img = document.createElement('img'); img.src = usedPhoto; img.alt = g.name; img.style.width='52px'; img.style.height='52px'; img.style.objectFit='cover'; img.style.borderRadius='50%'; img.onerror=()=>{ avatarHolder.textContent = (g.name||'C').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(); }; avatarHolder.appendChild(img); }
            else { const initials = document.createElement('div'); initials.className='initials'; initials.textContent = (g.name||'C').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(); initials.style.display='flex'; initials.style.alignItems='center'; initials.style.justifyContent='center'; initials.style.width='100%'; initials.style.height='100%'; initials.style.fontWeight='700'; initials.style.color='#064e3b'; avatarHolder.appendChild(initials); }
          })();

          const content = document.createElement('div'); content.style.flex='1'; content.style.minWidth='0'; content.style.paddingTop='2px';
          const title = document.createElement('div'); title.style.fontWeight='700'; title.style.fontSize='14px'; title.textContent = g.name;
          const preview = document.createElement('small'); preview.style.display='block'; preview.style.color='#6b7280'; preview.style.overflow='hidden'; preview.style.textOverflow='ellipsis'; preview.style.whiteSpace='nowrap'; preview.style.marginTop='6px'; preview.style.fontSize='13px';

          // determine most recent message across sessions
          let lastMsg = null; let lastTs = 0; let lastSessionId = null;
          g.sessions.forEach(s => { const msgs = s.data.messages || []; if (msgs.length){ const lm = msgs[msgs.length-1]; if ((lm.timestamp||0) > lastTs){ lastTs = lm.timestamp; lastMsg = lm; lastSessionId = s.id; } } });
          if (lastMsg && lastMsg.timestamp) conv.setAttribute('data-last-ts', lastMsg.timestamp); else conv.setAttribute('data-last-ts','');
          if (lastMsg){ const isOwnMsg = currentUserChat && lastMsg.senderId === currentUserChat.uid; const senderLabel = isOwnMsg ? 'You' : (lastMsg.senderName || (lastMsg.senderId === 'SYSTEM' ? 'System' : 'Counselor')); const raw = (lastMsg.text || lastMsg.message || ''); const truncated = raw.length > 60 ? raw.slice(0,57) + '...' : raw; preview.textContent = `${senderLabel}: ${truncated}`; preview.title = raw; }
          else preview.textContent = g.sessions[0] && g.sessions[0].data.topic ? g.sessions[0].data.topic : 'No messages yet';
          content.appendChild(title); content.appendChild(preview);

          const meta = document.createElement('div'); meta.className='conv-meta'; meta.style.flex='0 0 auto'; meta.style.textAlign='right'; meta.style.minWidth='70px'; meta.style.paddingTop='2px';
          const time = document.createElement('div'); time.className='conv-time'; time.style.fontSize='12px'; time.style.color='#6b7280';
          if (lastMsg && lastMsg.timestamp){ const isToday = (new Date(lastMsg.timestamp)).toDateString() === (new Date()).toDateString(); time.textContent = isToday ? formatTime(lastMsg.timestamp) : formatDateLabel(lastMsg.timestamp); time.title = lastMsg.timestamp ? new Date(lastMsg.timestamp).toLocaleString() : ''; }
          meta.appendChild(time);

          conv.appendChild(avatarHolder); conv.appendChild(content); conv.appendChild(meta);

          conv.addEventListener('click', function(){
            document.querySelectorAll('.conv-item').forEach(n=>n.classList.remove('active'));
            conv.classList.add('active');
            // set active counselor and attach listener to show all sessions
            activeCounselorUid = g.counselorId && String(g.counselorId).startsWith('__no_counselor__') ? null : g.counselorId;
            // set header
            const headerName = document.querySelector('.counselor-details h3'); if (headerName) headerName.textContent = g.name;
            // attach listener that will render all sessions for this counselor
            attachCounselorListener(activeCounselorUid, g.name);
            // ensure input + header are visible after selecting a counselor
            try{ showConversationUI(); }catch(e){}
            // On mobile, switch to full-chat view similar to messenger and lock scroll
            try{ if (window.innerWidth <= 768) { document.body.classList.add('mobile-chat-open'); document.body.style.overflow = 'hidden'; } }catch(e){}
          });

          listEl.appendChild(conv);
        });

      }catch(err){ console.warn('Failed to load conversations', err); listEl.innerHTML = '<div style="color:#c00">Failed to load conversations</div>'; }
    }

    // Attach a real-time listener for consultations filtered by counselor + this student.
    // When activeCounselorUid is null, we try to match by counselorName/unknown id.
    function attachCounselorListener(counselorUid, counselorName){
      // detach previous
      if (_consultationsListenerRef) { try{ _consultationsListenerRef.off(); }catch(e){} _consultationsListenerRef = null; }
      // set header avatar/name if possible
      if (counselorUid) fetchAndSetCounselorProfile(counselorUid);
      currentSessions = [];
      activeConsultationId = null;
  const ref = db.ref('consultations');
      _consultationsListenerRef = ref;
      ref.on('value', snap => {
        const all = snap.val() || {};
        const sessions = [];
        Object.keys(all).forEach(k => {
          const c = all[k];
          // resolve counselor id/name for comparison
          const cId = c.counselorId || c.counselor_uid || (c.counselor && c.counselor.uid) || null;
          const studentFields = ['studentId','student_id','student_uid','studentUid','student'];
          function consultStudentId(cobj){ for (let f of studentFields){ if (cobj && cobj[f]) return String(cobj[f]); } if (cobj.student && typeof cobj.student === 'object'){ return cobj.student.uid || cobj.student.id || null } return null; }
          const sid = consultStudentId(c);
          const isMine = sid && (String(sid) === String(currentUserChat.uid));
          if (!isMine) return; // only sessions for this student
          const matchesCounselor = counselorUid ? (cId && String(cId) === String(counselorUid)) : ( (c.counselorName && c.counselorName === counselorName) || (!c.counselorId && !c.counselorName && !cId) );
          if (matchesCounselor) sessions.push({ id: k, data: c });
        });
        // sort sessions by creation or last message
        sessions.sort((a,b)=>{ const at=(a.data.messages && a.data.messages.length)? a.data.messages[a.data.messages.length-1].timestamp: (a.data.createdAt||0); const bt=(b.data.messages && b.data.messages.length)? b.data.messages[b.data.messages.length-1].timestamp: (b.data.createdAt||0); return at - bt; });
        currentSessions = sessions;
        // choose active session as the latest one (if any)
        if (sessions.length) activeConsultationId = sessions[sessions.length-1].id; else activeConsultationId = null;
        // detect if any session (prefer latest) has a video room and prompt the student to join
        try{
          if (sessions.length){
            const latest = sessions[sessions.length-1].data || {};
            const room = resolveRoomFromConsultation(latest);
            if (room && room !== _lastPromptedRoom){
              // prefer explicit roomStatus flag when present: 1 => incoming call, 0 => idle
              try{
                if (latest.roomStatus === undefined || latest.roomStatus === null){
                  // legacy behavior: prompt once when room exists and no explicit status flag present
                  _lastPromptedRoom = room;
                  setTimeout(()=>{
                    const join = confirm('Your counselor started a video session for this conversation. Join now?');
                    if (join) openJitsiEmbedded(room);
                  }, 300);
                } else if (Number(latest.roomStatus) === 1){
                  // show incoming-call overlay immediately
                  _lastPromptedRoom = room;
                  try{ showIncomingCall(latest.counselorName || latest.from || 'Counselor', room, sessions[sessions.length-1] && sessions[sessions.length-1].id); }catch(e){}
                } else {
                  // roomStatus explicitly 0: do not prompt
                }
              }catch(e){
                // fallback to legacy prompt on any error
                _lastPromptedRoom = room;
                setTimeout(()=>{
                  const join = confirm('Your counselor started a video session for this conversation. Join now?');
                  if (join) openJitsiEmbedded(room);
                }, 300);
              }
            }
            // also ensure WS registration for latest counselor session room
            if (room) try{ setupWebSocketForRoom(room); }catch(e){}
            // update header video button (enable only when a room exists and is active)
            try{
              const enabledLatest = Boolean(room) && (latest.roomStatus === undefined || latest.roomStatus === null || Number(latest.roomStatus) === 1);
              updateVideoButtonState(enabledLatest, room);
            }catch(e){}
          }
        }catch(e){ console.warn('failed to detect video room in counselor sessions', e); }
        // prepare combined messages grouped by session, inserting a bold session separator between each session
        const combined = [];
        sessions.forEach(s => {
          // insert session separator
          combined.push({ senderId: 'SYSTEM', text: 'SESSION â€” ' + (s.data.counselorName || s.data.topic || s.id) + ' (' + (s.data.createdAt ? new Date(s.data.createdAt).toLocaleString() : '') + ')', timestamp: s.data.createdAt || (s.data.messages && s.data.messages.length ? s.data.messages[0].timestamp : Date.now()), isSessionSeparator: true });
          const msgs = s.data.messages || [];
          msgs.forEach(m => combined.push(Object.assign({}, m, { _sessionId: s.id })));
        });
        // render combined view
        renderChatMessagesBySession(combined);
        // ensure chat UI and input are visible when sessions are rendered for the counselor
        try{ showConversationUI(); }catch(e){}
      });
    }

    // Render combined messages where session separators are large and bold
    function renderChatMessagesBySession(items){
      const container = document.getElementById('messagesContainer');
      container.innerHTML = '';
      if (!items || items.length === 0) {
        container.innerHTML = '<p style="color:#666">No messages yet. Say hello ðŸ‘‹</p>';
        return;
      }
      let lastDateKey = null;
      items.forEach(m => {
        // if this item is a session separator (we added), render prominent bold centered text
        if (m.isSessionSeparator || m.senderId === 'SYSTEM'){
          const sep = document.createElement('div');
          sep.style.textAlign = 'center';
          sep.style.fontWeight = '800';
          sep.style.fontSize = '16px';
          sep.style.margin = '18px 0';
          sep.style.color = '#064e3b';
          sep.textContent = m.text || m.message || '';
          container.appendChild(sep);
          return;
        }

        // insert date separator when day changes (between messages)
        const msgDateKey = m.timestamp ? new Date(m.timestamp).toDateString() : null;
        if (msgDateKey && msgDateKey !== lastDateKey) {
          lastDateKey = msgDateKey;
          const sep = document.createElement('div');
          sep.className = 'date-separator';
          const label = document.createElement('span');
          label.textContent = formatDateLabel(m.timestamp);
          sep.appendChild(label);
          container.appendChild(sep);
        }

        const bubble = document.createElement('div');
        bubble.style.display = 'inline-block';
        bubble.style.maxWidth = '75%';
        bubble.style.width = 'auto';
        bubble.style.padding = '10px 14px';
        bubble.style.marginBottom = '8px';
        bubble.style.borderRadius = '20px';
        bubble.style.boxShadow = '0 1px 0 rgba(0,0,0,0.04)';
        bubble.style.background = (m.senderId === currentUserChat.uid) ? '#dcfce7' : '#f1f5f9';
        bubble.style.marginLeft = (m.senderId === currentUserChat.uid) ? 'auto' : '0';
        bubble.style.whiteSpace = 'pre-wrap';
        bubble.style.wordBreak = 'break-word';
        bubble.style.boxSizing = 'border-box';
        const isOwn = (m.senderId === currentUserChat.uid);
        let senderLabel = '';
        if (isOwn) {
          senderLabel = 'You';
        } else {
          const raw = m.senderName || (m.senderId === 'SYSTEM' ? 'System' : 'Counselor');
          if (typeof raw === 'string' && raw.includes('@')) {
            senderLabel = m.senderDisplayName || m.displayName || m.name || '';
          } else {
            senderLabel = raw || '';
          }
          if (typeof senderLabel === 'string' && senderLabel.includes('@')) senderLabel = '';
        }
        // if still empty and we have a cached counselor profile for the active conversation, prefer that name
        try{
          if (!senderLabel && m.senderId && currentCounselorProfile){
            const p2 = currentCounselorProfile;
            const full2 = (p2 && (p2.first_name || p2.last_name)) ? `${p2.first_name||''} ${p2.last_name||''}`.trim() : (p2 && (p2.name || p2.fullName) ? (p2.name || p2.fullName) : 'Counselor');
            if (full2) senderLabel = full2;
          }
        }catch(e){}
        const ts = m.timestamp ? formatTime(m.timestamp) : '';
        const tsFull = m.timestamp ? new Date(m.timestamp).toLocaleString() : '';
        const labelHtml = isOwn ? `<div style="font-size:13px;color:#064e3b;font-weight:700;margin-bottom:6px;text-align:right">${senderLabel}</div>` : `<div style="font-size:13px;color:#064e3b;font-weight:700;margin-bottom:6px">${senderLabel}</div>`;
        // build content: image (if present) then text
        let contentHtml = '';
        if (m.imageData || m.imageURL){
          const src = m.imageData || m.imageURL;
          contentHtml += `<div><img src="${src}" style="max-width:320px;max-height:320px;border-radius:10px;display:block;margin-bottom:8px;" alt="image"/></div>`;
        }
        contentHtml += `<div style="font-size:14px;color:#111">${m.text||m.message||''}</div>`;
        bubble.innerHTML = `${labelHtml}${contentHtml}<div style="font-size:11px;color:#666;margin-top:6px;text-align:right" title="${tsFull}">${ts}</div>`;
        const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.width='100%'; wrapper.style.justifyContent = isOwn ? 'flex-end' : 'flex-start'; wrapper.appendChild(bubble);
        container.appendChild(wrapper);
      });
      container.scrollTop = container.scrollHeight;
    }
  </script>
  <!-- Thank-you modal (appears after rating submit) -->
  <div id="ratingThanksModal" class="thanks-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ratingThanksTitle">
    <div class="thanks-modal-box">
      <h4 id="ratingThanksTitle">Thanks for your feedback!</h4>
      <p id="ratingThanksMessage">We appreciate your rating. It helps us improve counseling quality.</p>
      <div style="margin-top:12px; display:flex; justify-content:center; gap:8px">
        <button class="rating-btn cancel" onclick="closeThanksModal()">Close</button>
      </div>
    </div>
  </div>
</body>
</html>

