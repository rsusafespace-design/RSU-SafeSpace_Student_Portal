c\<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Profile | SafeSpace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Shared responsive styles used by other portal pages (matches index.html) -->
  <link rel="stylesheet" href="responsive.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary: #0f7a34;
      --topbar-bg: #1e8e3e;
      --text: #2d3748;
      --bg: #f8fafc;
    }

    /* Basic sidebar/topbar/content layout used across portal pages */
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100vh;background:#f0f3f6;padding:12px;z-index:1200;overflow:auto}
    .sidebar .brand{height:60px;align-items:center;display:flex;padding:10px 12px;gap:12px;background:#1e8e3e;color:#fff}
    .sidebar .logo img{height:40px;width:auto;object-fit:contain}
    .topbar{position:fixed;top:0;left:250px;right:0;height:60px;background:var(--topbar-bg);color:#fff;padding:10px 30px;display:flex;align-items:center;justify-content:space-between;z-index:1001}
    .topbar.shrink { left: 80px; }

    .topbar-left { display:flex; align-items:center; gap:0.15rem; }
    .hamburger {
      font-size: 1.05rem;
      cursor: pointer;
      padding: 0.12rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
  .portal-title { display:flex; flex-direction:column; line-height:1.2; margin-left:0; }
    .portal-title strong span.safespace { display:none; margin-right:0.3rem; }
    .portal-title small { font-size:0.75rem; opacity:0.9; }

    /* Show SafeSpace text when sidebar is shrunk */
    .topbar.shrink .portal-title strong span.safespace { display: inline; }
    .topbar .mobile-logo img{height:34px}
    /* ensure page content sits to the right of sidebar on desktop */
    .content{margin-top:60px;margin-left:250px;padding:1rem;transition:margin-left 0.3s}

    /* collapsed sidebar state */
    .sidebar.shrink{width:80px}
    .topbar.shrink{left:80px}
    .content.shrink{margin-left:80px}

    /* Mobile: hide sidebar and make content full width; show bottom nav styles matching index.html */
    @media (max-width:768px){
      .sidebar{display:none !important;transform:translateX(-100%)}
      .topbar{left:0;padding:10px 12px}
      .content{margin-left:0}
      .mobile-logo{display:flex}
      .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#004c27;display:flex;justify-content:space-around;padding:0.6rem 0;height:64px;z-index:2000}
      .bottom-nav a{color:#fff;text-decoration:none;font-size:0.9rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.25rem}
      .bottom-nav a i{font-size:22px;line-height:1}
    }
  </style>

  <!-- Enforce mobile topbar/logo visibility and spacing -->
  <style>
    @media (max-width:768px) {
      .topbar { left: 0 !important; right: 0 !important; padding: 10px 12px !important; box-sizing: border-box; }
      .mobile-logo { display: flex !important; width: 36px !important; height: 36px !important; border-radius: 6px !important; }
      .mobile-logo img { height: 28px !important; width: auto !important; display: block !important; background: transparent !important; }
      .portal-title { margin-left: 6px; }
      .topbar-left { align-items: center; }
      /* keep profile on the far right */
      .topbar > div:last-child { margin-left: auto; }
    }
  </style>
  <style>
    /* Additional overrides to exactly match index.html sizes and header/sidebar look on mobile */
    :root{ --topbar-height:60px; }
    .topbar{height:var(--topbar-height);padding:10px 30px}
    .topbar .mobile-logo{display:none;width:28px;height:28px;border-radius:50%;align-items:center;justify-content:center;margin-right:0.2rem}
    .topbar .mobile-logo img{width:auto;height:34px;object-fit:contain;display:block}
    .hamburger{font-size:1.2rem;padding:0.3rem;border-radius:4px}
    .profile{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .notif-wrapper{font-size:1.3rem; position:relative; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; color:#fff}
    .notif-badge{width:11px;height:11px;border-radius:50%; position:absolute; top:6px; right:6px; background:#ef4444; border:2px solid var(--topbar-bg); box-shadow:0 0 0 2px transparent; display:inline-block}
    /* bottom-nav icons and badges */
    .bottom-nav a { position:relative; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.25rem; text-decoration:none; }
    .bottom-nav a .fa { font-size:22px; line-height:1 }
    .bottom-notif-badge{ position:absolute; top:6px; right:18px; width:9px; height:9px; background:#ef4444; border-radius:50%; border:2px solid var(--topbar-bg); display:inline-block }

    /* Sidebar brand/logo sizing consistent with index.html */
    .sidebar .brand{height:60px;align-items:center;padding:10px 12px;background:#1e8e3e;color:#fff;gap:12px}
    .sidebar .logo img{height:40px;width:auto;object-fit:contain}

    /* Ensure topbar sits to right of sidebar on desktop like appointments page */
    @media (min-width:769px){
      .topbar{left:250px}
      .content{margin-left:250px}
      .mobile-logo{display:none !important}
    }

    /* Hide hamburger on small screens similar to index.html */
    @media (max-width:768px){
      .hamburger{display:none}
      .mobile-logo{display:flex}
    }
  </style>
  <style>
    /* Prevent inputs and flex/grid children from forcing line-wrap when the sidebar reduces content width.
       Applied only on md+ screens so mobile stacks remain unchanged. */
    @media (min-width: 768px) {
      /* allow flex children (like labels+inputs) to shrink instead of wrapping */
      .content .flex-1,
      .content .grid,
      .content input,
      .content textarea,
      .content select {
        min-width: 0;
      }

      /* prefer no wrapping for horizontal form rows on desktop */
      .content .form-row {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
      }

      /* utility to prevent label wrapping and ellipsize if too long */
      .content .label-nowrap {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
  </style>
  <style>
    /* Mobile stacking overrides to match `message look.html` */
    @media (max-width: 768px) {
      /* Ensure sidebar truly hidden and content uses full viewport width */
      .sidebar{display:none !important; transform:none !important; width:0 !important;}
      .topbar{left:0 !important; right:0 !important;}
      .content { padding: 0.75rem !important; margin-left:0 !important; max-width:100% !important; padding-left:0 !important; padding-right:0 !important; padding-bottom: 90px !important; }
      .content { padding-bottom: 100px !important; }
      section.bg-white { padding: 1rem !important; }
      section h3.text-xl { font-size: 1.125rem; }
      .edit-btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
      label, .text-sm, .text-base { font-size: 0.875rem !important; }
      input:not([type="radio"]):not([type="checkbox"]), select, textarea {
        padding: 0.5rem !important; font-size: 0.875rem !important; min-height:38px; box-sizing:border-box;
      }
      .content .form-row { flex-direction: column; align-items: stretch; }
      .content .form-row > label,
      .content .form-row .w-28,
      .content .form-row .w-24,
      .content .form-row .w-20 {
        width: 100% !important; border-right: none !important; border-bottom: 1px solid #d1d5db; padding-bottom:0.25rem; background:#f8fafc !important;
      }
      .content .form-row input,
      .content .form-row select,
      .content .form-row .flex-1 { width:100% !important; margin-top:0.5rem; }
      .content .grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
      .content .grid-cols-1.md\:grid-cols-4,
      .content .grid-cols-1.md\:grid-cols-3,
      .content .grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
      .content .grid-cols-1.md\:grid-cols-4 > div,
      .content .grid-cols-1.md\:grid-cols-3 > div,
      .content .grid-cols-1.md\:grid-cols-2 > div { width:100% !important; }
      #formPhotoPlaceholder { width:100px !important; height:100px !important; margin:1rem auto; }
      .content .flex.border.border-gray-400.form-row { flex-direction: column; align-items: stretch; border: none !important; }
      .content .flex.border.border-gray-400.form-row > div { width:100% !important; flex:none !important; border:1px solid #d1d5db; border-bottom:none !important; margin-top:-1px; }
      .content .flex.border.border-gray-400.form-row > div:last-child { border-bottom:1px solid #d1d5db !important; }
      .content .flex.border.border-gray-400.form-row label { width:auto !important; border-right:none !important; }
      .grid-cols-1.gap-2.text-gray-700 > div.flex.flex-wrap.gap-1.items-center { flex-direction:column; align-items:stretch; gap:0.25rem !important; }
      .grid-cols-1.gap-2.text-gray-700 > div.flex.flex-wrap.gap-1.items-center > * { width:100% !important; margin-top:0 !important; margin-bottom:0 !important; }
      #field_civil_status_other { width:100% !important; }
      .grid-cols-1.md\:grid-cols-4 > .relative.border { width:100% !important; height:auto !important; margin-top:1rem; padding-bottom:1rem; }
      .grid-cols-1.md\:grid-cols-4.gap-4.mb-4 > div { margin-top:0.5rem; }
      /* Remove horizontal centering so content fills remaining space on tiny viewports */
      main.content.mx-auto { margin-left:0 !important; margin-right:0 !important; }
    }
  </style>
  <script>
    // Profiling consent: when unchecked, disable inputs in the profiling section so students cannot input sensitive info
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const consent = document.getElementById('field_sensitive_opt_in');
        const profSection = document.getElementById('studentProfilingSection');
        if (!consent || !profSection) return;

        function setProfilingEnabled(enabled) {
          try {
            // Only target actual form controls. Do NOT disable section-level buttons
            // (for example the `.edit-btn`) so the user can click Edit to view the section.
            const els = profSection.querySelectorAll('input, select, textarea');
            els.forEach(el => {
              try {
                // Never disable the consent checkbox itself
                if (el.id === 'field_sensitive_opt_in') return;
                // Keep any protected elements (class 'protected') enabled
                if (el.classList && el.classList.contains('protected')) return;
                // Toggle disabled state
                el.disabled = !enabled;
                // Clear non-checkbox inputs when disabling to avoid stale values
                if (!enabled && el.type !== 'checkbox') {
                  try { el.value = ''; } catch(e) {}
                }
              } catch(e){}
            });
          } catch(e){}
        }

        // Wire both change and click to be robust across browsers
        consent.addEventListener('change', function(){ setProfilingEnabled(!!consent.checked); });
        consent.addEventListener('click', function(){ setProfilingEnabled(!!consent.checked); });

        // Initialize on load
        setProfilingEnabled(!!consent.checked);
      } catch(e) { console.warn('profiling consent init failed', e); }
    });
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Insert shared sidebar/topbar from portal pages so responsive CSS applies -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo"><img src="safespace.png" alt="SafeSpace logo"></div>
      <span>SafeSpace</span>
    </div>
    <a href="index.html" data-emoji="ðŸ“…"><span>Appointments</span></a>
    <a href="history.html" data-emoji="ðŸ“‹"><span>History</span></a>
    <a href="assessments.html" data-emoji="ðŸ“"><span>Assessments</span></a>
    <a href="resources.html" data-emoji="ðŸ“š"><span>Resources</span></a>
    <a href="messages.html" data-emoji="ðŸ’¬"><span>Messages</span></a>
    <a href="settings.html" data-emoji="âš™ï¸"><span>Settings</span></a>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="topbar" id="topbar">
    <div class="topbar-left">
      <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
      </div>
      <div class="mobile-logo"><img src="safespace.png" alt="SafeSpace" style="width:24px;height:24px;object-fit:contain"></div>
      <div class="portal-title">
        <strong><span class="safespace">RSU SafeSpace: </span>Student Portal</strong>
        <small id="topbarStudentId"></small>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:1rem; position:relative;">
      <div class="notif-wrapper" onclick="toggleNotif()">
        <span class="icon-btn">ðŸ””</span>
        <div class="notif-badge" style="position:absolute;right:4px;bottom:8px;width:8px;height:8px;background:#ef4444;border-radius:50%;border:2px solid var(--topbar-bg)"></div>
      </div>
      <div id="notifDropdown" class="notif-dropdown">
        <div class="notif-header">Notifications</div>
        <div class="notif-list">
          <div class="notif-item" onclick="goToSection('appointments')">ðŸ”” New counseling slots available</div>
          <div class="notif-item" onclick="goToSection('messages')">ðŸ“© You have a new message from your counselor</div>
          <div class="notif-item" onclick="goToSection('assessments')">âš  Reminder: Complete your assessment</div>
        </div>
      </div>
      <div class="profile" id="topProfile" title="Profile" onclick="openProfileMenu()" style="width:38px;height:38px;border-radius:50%;background:#004c27;display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;cursor:pointer"></div>
    </div>
  </div>

  <main id="content" class="content max-w-6xl mx-auto mt-0 p-6">
  <!-- Profile display removed (name can be long and overlap sidebar) -->
  <!-- status box removed -->
    <section class="bg-white mt-0 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
      <button onclick="toggleSection('section1')" class="text-green-700 hover:text-green-800">
        <i class="fas fa-chevron-down" id="icon-section1"></i>
      </button>
      INDIVIDUAL INVENTORY
    </h3>
    <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
  </div>

  <div id="content-section1">

  <!-- Data Privacy Statement -->
  <div class="border border-gray-300 p-3 mb-6 text-sm text-gray-700 rounded">
    <p><strong>Data Privacy Statement</strong></p>
    <p>
      Romblon State University respects your right to privacy and is committed to protecting
      the confidentiality of your personal information. By filling out this form, you are consenting
      to the collection, processing, and use of the information in accordance with this privacy notice.
      The information you have provided is used for access provision, attendance, monitoring,
      evaluation, documentation, and communication purposes. The University shall only retain
      the said personal information until it serves its purpose, after which it shall be securely
      disposed of.
    </p>
  </div>

  <!-- Student Info Fields -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
    <div class="md:col-span-3 space-y-4">
      <!-- Student ID (read-only) placed above the name -->
    <div class="flex items-center border border-gray-200 bg-gray-50 p-2 rounded form-row">
  <label class="w-28 bg-transparent px-2 py-2 font-semibold text-sm text-gray-700 label-nowrap">Student ID</label>
  <input id="field_student_id" type="text" readonly disabled class="protected p-2 text-sm bg-white border rounded w-48" placeholder="Student ID" />
      </div>

      <!-- Name -->
        <div class="flex items-center border border-gray-400 form-row">
    <label class="w-28 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">Name:</label>
      <div class="flex-1 grid grid-cols-4 divide-x divide-gray-400">
       <input id="field_last_name" type="text" disabled class="protected p-2 text-sm w-full border-none focus:ring-0" placeholder="Last Name">
       <input id="field_first_name" type="text" disabled class="protected p-2 text-sm w-full border-none focus:ring-0" placeholder="First Name">
       <input id="field_middle_name" type="text" disabled class="protected p-2 text-sm w-full border-none focus:ring-0" placeholder="Middle Initial">
  <input id="field_suffix" type="text" disabled class="p-2 text-sm w-full border-none focus:ring-0" placeholder="Suffix (optional)">
    </div>
  </div>

      <!-- Course, Year Level and Block (Horizontal Layout) -->
      <div class="flex border border-gray-400 form-row">
        <!-- Course (flex wider) -->
        <div class="flex items-center border-r border-gray-400" style="flex:2;">
          <label class="w-28 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">Course/Program:</label>
          <input id="field_course" 
            type="text" 
            placeholder="e.g., BS in Computer Science" 
            class="flex-1 p-2 text-sm border-none focus:ring-0"
            disabled
          >
        </div>

        <!-- Year Level -->
        <div class="flex items-center border-r border-gray-400" style="flex:1;">
          <label class="w-24 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">Year Level:</label>
          <select id="field_year_level"
            class="flex-1 p-2 text-sm border-none focus:ring-0"
            disabled
          >
            <option value="">Select Year Level</option>
            <option value="1st Year">1st Year</option>
            <option value="2nd Year">2nd Year</option>
            <option value="3rd Year">3rd Year</option>
            <option value="4th Year">4th Year</option>
          </select>
        </div>

        <!-- Block beside Year Level -->
        <div class="flex items-center" style="flex:1;">
          <label class="w-20 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">Block:</label>
          <input id="field_block" type="text" disabled placeholder="e.g., A, B, 1, 2" class="flex-1 p-2 text-sm border-none focus:ring-0" />
        </div>
      </div>


      <!-- Academic Year Admitted -->
      <div>
        <label class="block font-semibold">Academic Year Admitted</label>
        <div class="flex items-center gap-4 mt-1">
          <label class="flex items-center gap-1">
            <input id="field_admit_sem_1" name="field_admit_sem" value="1st Sem" type="radio" disabled class="accent-green-700"> 1st Sem
          </label>
          <label class="flex items-center gap-1">
            <input id="field_admit_sem_2" name="field_admit_sem" value="2nd Sem" type="radio" disabled class="accent-green-700"> 2nd Sem
          </label>
          <div class="flex items-center gap-2">
            <span>Year</span>
            <input id="field_admit_year_from" type="text" value="" disabled placeholder="Year (e.g., 2022)" class="bg-gray-100 p-2 rounded border w-32">
          </div>
        </div>

          <!-- Campus and College -->
          <div class="flex border border-gray-400 form-row mt-2">
            <div class="flex flex-1 items-center border-r border-gray-400">
              <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">Campus:</label>
              <select id="field_campus" class="flex-1 p-2 text-sm border-none focus:ring-0 bg-white" disabled></select>
            </div>
            <div class="flex flex-1 items-center">
              <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm label-nowrap">College:</label>
              <select id="field_college" class="flex-1 p-2 text-sm border-none focus:ring-0 bg-white" disabled></select>
            </div>
          </div>
          <!-- Block removed from here â€” now displayed beside Year Level above -->
      </div>

      <!-- Status of Enrollment -->
      <div>
        <label class="block font-semibold">Status of Enrollment</label>
        <div class="flex items-center gap-4 mt-1">
          <label class="flex items-center gap-1">
            <input id="field_status_new" name="field_status_enrollment" type="radio" disabled class="accent-green-700" value="New"> New
          </label>
          <label class="flex items-center gap-1">
            <input id="field_status_transferee" name="field_status_enrollment" type="radio" disabled class="accent-green-700" value="Transferee"> Transferee
          </label>
          <label class="flex items-center gap-1">
            <input id="field_status_returnee" name="field_status_enrollment" type="radio" disabled class="accent-green-700" value="Returnee"> Returnee
          </label>
        </div>
      </div>
    </div>

  <!-- 1x1 Photo Placeholder -->
  <div id="formPhotoPlaceholder" class="relative border border-gray-400 flex items-center justify-center text-sm text-gray-500 rounded w-50 h-50 bg-gray-50 overflow-hidden">
  <input 
    id="profilePhotoInput"
    type="file" 
    accept="image/*" 
    class="absolute inset-0 opacity-0 cursor-pointer" 
    onchange="previewPhoto(event)"
  >
  <img id="photoPreview" src="" alt="1x1 Photo" class="hidden object-cover w-full h-full">
  <span id="photoPlaceholder" class="text-gray-500">1x1 Photo</span>
</div>
  </div>
</div>
</section>


   <!-- Section 1: Background Information -->
<section class="bg-white mt-8 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
      <button onclick="toggleSection('section2')" class="text-green-700 hover:text-green-800">
        <i class="fas fa-chevron-right" id="icon-section2"></i>
      </button>
      Background Information
    </h3>
    <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
  </div>

  <div id="content-section2" style="display: none;">

  <!-- Present Address & FB Messenger -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div>
      <label class="block font-semibold">Present Address</label>
  <input id="field_present_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">FB Messenger</label>
    <input id="field_fb_messenger" type="text" value="" disabled placeholder="Facebook name or username" class="bg-gray-100 p-2 rounded w-full border">
    </div>
  </div>

  <!-- Permanent Address -->
  <div class="mb-4">
    <label class="block font-semibold">Permanent Address</label>
  <input id="field_permanent_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 p-2 rounded w-full border">
    <div class="flex items-center mt-2 gap-2">
      <input type="checkbox" id="sameAddress" disabled class="accent-green-700">
      <label for="sameAddress" class="text-gray-700 text-sm">Check the box if same as the present address</label>
    </div>
  </div>

  <!-- Email -->
  <div class="mb-4">
    <label class="block font-semibold">E-mail Address</label>
  <input id="field_email" type="email" value="" disabled placeholder="name@example.com" class="bg-gray-100 p-2 rounded w-full border">
  </div>

  <!-- Birth Info and Contact -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div>
      <label class="block font-semibold">Date of Birth (mm/dd/yyyy)</label>
  <input id="field_dob" type="date" value="" disabled placeholder="mm/dd/yyyy" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Contact No.</label>
  <input id="field_contact_no" type="text" value="" disabled placeholder="e.g., 09171234567" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Place of Birth</label>
  <input id="field_place_of_birth" type="text" value="" disabled placeholder="City, Province" class="bg-gray-100 p-2 rounded w-full border">
    </div>
  </div>

  <!-- Sex, Age, Civil Status, Religion -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-center">
    <div>
      <label class="block font-semibold">Sex</label>
  <input id="field_sex" type="text" value="" disabled placeholder="Male / Female / Other" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Age</label>
  <input id="field_age" type="number" value="" disabled placeholder="18" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Civil Status</label>
      <div class="flex items-center gap-2 flex-wrap mt-1">
        <label class="flex items-center gap-1"><input id="field_civil_single" name="field_civil_status" type="radio" disabled class="accent-green-700" value="Single"> Single</label>
        <label class="flex items-center gap-1"><input id="field_civil_married" name="field_civil_status" type="radio" disabled class="accent-green-700" value="Married"> Married</label>
        <label class="flex items-center gap-1"><input id="field_civil_others" name="field_civil_status" type="radio" disabled class="accent-green-700" value="Others"> Others:</label>
        <input id="field_civil_status_other" type="text" disabled class="bg-gray-100 p-2 rounded w-48 border" placeholder="Specify if others">
      </div>
    </div>
    <div>
      <label class="block font-semibold">Religion</label>
  <input id="field_religion" type="text" value="" disabled placeholder="e.g., Roman Catholic" class="bg-gray-100 p-2 rounded w-full border">
    </div>
  </div>

  <!-- Spouse info if married -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
    <div>
      <label class="block font-semibold">If Married, Name of Spouse</label>
      <input id="field_spouse_name" type="text" value="" disabled placeholder="Full name of spouse" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Occupation</label>
      <input id="field_spouse_occupation" type="text" value="" disabled placeholder="e.g., Teacher / Sales" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">No. of Children</label>
      <input id="field_spouse_children" type="number" value="" disabled placeholder="e.g., 0" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Address of Spouse</label>
      <input id="field_spouse_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 p-2 rounded w-full border">
    </div>
    <div>
      <label class="block font-semibold">Contact No.</label>
      <input id="field_spouse_contact" type="text" value="" disabled placeholder="e.g., 09171234567" class="bg-gray-100 p-2 rounded w-full border">
    </div>
  </div>

  <!-- Indigenous People membership -->
  <div class="mb-4">
    <label class="block font-semibold">Are you a member of Indigenous People Community?</label>
    <div class="flex items-center gap-4 mt-1">
      <label class="flex items-center gap-1"><input id="ipYes" name="indigenous_member" type="radio" value="yes" disabled class="accent-green-700"> Yes</label>
      <label class="flex items-center gap-1"><input id="ipNo" name="indigenous_member" type="radio" value="no" disabled class="accent-green-700"> No</label>
      <input id="field_indigenous_group" type="text" placeholder="If yes, what group" disabled class="bg-gray-100 p-1 border rounded w-64">
    </div>
  </div>

  <!-- Living Arrangement -->
  <div class="mb-4">
    <label class="block font-semibold">Present Living Arrangement</label>
    <div class="flex items-center gap-4 mt-1 flex-wrap">
      <label class="flex items-center gap-1"><input id="field_living_own" name="living_arrangement" value="Own House" type="radio" disabled class="accent-green-700"> Own House</label>
      <label class="flex items-center gap-1"><input id="field_living_apartment" name="living_arrangement" value="Apartment" type="radio" disabled class="accent-green-700"> Apartment</label>
      <label class="flex items-center gap-1"><input id="field_living_boarding" name="living_arrangement" value="Boarding House" type="radio" disabled class="accent-green-700"> Boarding House</label>
      <label class="flex items-center gap-1"><input id="field_living_relatives" name="living_arrangement" value="Living with Relatives/Non-Relatives" type="radio" disabled class="accent-green-700"> Living with Relatives/Non-Relatives</label>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
      <div>
        <label class="block font-semibold">Name of Landlord/Landlady</label>
        <input id="field_landlord_name" type="text" value="" disabled placeholder="Full name of landlord/landlady" class="bg-gray-100 p-2 rounded w-full border">
      </div>
      <div>
        <label class="block font-semibold">Contact Number</label>
        <input id="field_landlord_contact" type="text" value="" disabled placeholder="e.g., 09171234567" class="bg-gray-100 p-2 rounded w-full border">
      </div>
    </div>
  </div>
</div>
</section>


    <!-- Section 2: Family Background -->
   <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
      <button onclick="toggleSection('section3')" class="text-green-700 hover:text-green-800">
        <i class="fas fa-chevron-right" id="icon-section3"></i>
      </button>
      Family Background
    </h3>
    <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
  </div>

  <div id="content-section3" style="display: none;">

  <!-- Parents Info -->
   <div class="grid grid-cols-1 gap-2 text-gray-700">
  <!-- Father -->
  <div class="flex flex-wrap gap-1 items-center">
      <label class="font-semibold w-24">Fatherâ€™s Name</label>
  <input id="field_father_name" type="text" value="" disabled placeholder="Full name" class="bg-gray-100 text-black p-2 rounded w-50 border">

      <label class="font-semibold w-12">Age</label>
  <input id="field_father_age" type="number" value="" disabled placeholder="52" class="bg-gray-100 text-black p-2 rounded w-16 border">

    <label class="font-semibold w-24">Occupation</label>
  <input id="field_father_occupation" type="text" value="" disabled placeholder="e.g., Farmer / Laborer" class="bg-gray-100 text-black p-2 rounded w-28 border">

      <label class="font-semibold w-24">Contact No.</label>
  <input id="field_father_contact" type="text" value="" disabled placeholder="e.g., 0917xxxxxxx" class="bg-gray-100 text-black p-2 rounded w-38 border">
           <label class="block font-semibold mt-2">Fatherâ€™s Address</label>
  <input id="field_father_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 text-black p-2 rounded w-full border">
      <div class="flex items-center gap-2 mt-1">
        <input id="father_addr_same_perm" type="checkbox" disabled class="accent-green-700">
        <label>Check if same as Permanent Address</label>
      </div>
      <div class="flex items-center gap-2 mt-1">
        <input id="father_addr_same_present" type="checkbox" disabled class="accent-green-700">
        <label>Check if same as Present Address</label>
      </div>
    </div>

    <!-- Mother -->
    <div class="flex flex-wrap gap-1 items-center">
      <label class="font-semibold w-24">Motherâ€™s Name</label>
  <input id="field_mother_name" type="text" value="" disabled placeholder="Full name" class="bg-gray-100 text-black p-2 rounded w-50 border">

  <label class="font-semibold w-12">Age</label>
  <input id="field_mother_age" type="number" value="" disabled placeholder="50" class="bg-gray-100 text-black p-2 rounded w-16 border">

      <label class="font-semibold w-24">Occupation</label>
  <input id="field_mother_occupation" type="text" value="" disabled placeholder="e.g., Homemaker / Clerk" class="bg-gray-100 text-black p-2 rounded w-28 border">

      <label class="font-semibold w-24">Contact No.</label>
  <input id="field_mother_contact" type="text" value="" disabled placeholder="e.g., 0917xxxxxxx" class="bg-gray-100 text-black p-2 rounded w-38 border">

      <label class="block font-semibold mt-2">Motherâ€™s Address</label>
  <input id="field_mother_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 text-black p-2 rounded w-full border">

      <div class="flex items-center gap-2 mt-1">
        <input id="mother_addr_same_perm" type="checkbox" disabled class="accent-green-700">
        <label>Check if same as Permanent Address</label>
      </div>
      <div class="flex items-center gap-2 mt-1">
        <input id="mother_addr_same_present" type="checkbox" disabled class="accent-green-700">
        <label>Check if same as Present Address</label>
      </div>
    </div>
    </div>

 <!-- Additional Family Info -->
<!-- Additional Family Info -->
<div class="grid grid-cols-1 gap-4 text-gray-700 mt-4">
  <!-- Birth Order, Brothers, Sisters -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block font-semibold">Birth Order</label>
  <input id="field_birth_order" type="text" value="" disabled placeholder="e.g., 1st" class="bg-gray-100 text-black p-2 rounded w-full border">
    </div>

    <div>
      <label class="block font-semibold">No. of Brothers</label>
  <input id="field_num_brothers" type="number" value="" disabled placeholder="e.g., 1" class="bg-gray-100 text-black p-2 rounded w-full border">
    </div>

    <div>
      <label class="block font-semibold">No. of Sisters</label>
  <input id="field_num_sisters" type="number" value="" disabled placeholder="e.g., 0" class="bg-gray-100 text-black p-2 rounded w-full border">
    </div>
  </div>

  <!-- Legal Guardian Info: Name | Relationship | Contact | Address -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-2 items-end">
    <div class="flex flex-col">
      <label class="block font-semibold mb-1 text-sm whitespace-nowrap">Legal Guardian Name</label>
  <input id="field_legal_guardian" type="text" value="" disabled placeholder="e.g., Juan Dela Cruz" class="bg-gray-100 text-black p-2 rounded w-full border h-10 mt-1">
    </div>
    <div class="flex flex-col">
      <label class="block font-semibold mb-1 text-sm whitespace-nowrap">Relationship</label>
  <input id="field_legal_guardian_relationship" type="text" value="" disabled placeholder="e.g., Father / Aunt / Guardian" class="bg-gray-100 text-black p-2 rounded w-full border h-10 mt-1">
    </div>
    <div class="flex flex-col">
      <label class="block font-semibold mb-1 text-sm whitespace-nowrap">Contact No.</label>
  <input id="field_legal_guardian_contact" type="text" value="" disabled placeholder="e.g., 09171234567" class="bg-gray-100 text-black p-2 rounded w-full border h-10 mt-1">
    </div>
    <div class="flex flex-col">
      <label class="block font-semibold mb-1 text-sm whitespace-nowrap">Address</label>
  <input id="field_legal_guardian_address" type="text" value="" disabled placeholder="Street, Barangay, Municipality" class="bg-gray-100 text-black p-2 rounded w-full border h-10 mt-1">
    </div>
  </div>
</div>


  <!-- Marital Status of Parents -->
  <div class="mt-4">
    <label class="block font-semibold">Marital Status of Parents</label>
    <div class="flex items-center gap-2 mt-1 flex-wrap">
      <label class="flex items-center gap-2"><input id="parents_status_living" name="parents_marital_status" value="Living Together" type="radio" disabled class="accent-green-700"> Living Together</label>
      <label class="flex items-center gap-2"><input id="parents_status_separated" name="parents_marital_status" value="Separated" type="radio" disabled class="accent-green-700"> Separated</label>
      <label class="flex items-center gap-2"><input id="parents_status_deceased" name="parents_marital_status" value="One/Both Deceased" type="radio" disabled class="accent-green-700"> One/Both Deceased</label>
      <label class="flex items-center gap-2"><input id="parents_status_solo" name="parents_marital_status" value="Solo Parent" type="radio" disabled class="accent-green-700"> Solo Parent (Mother/Father)</label>
      <label class="flex items-center gap-2"><input id="parents_status_others" name="parents_marital_status" value="Others" type="radio" disabled class="accent-green-700"> Others:</label>
      <input id="parents_status_others_text" type="text" disabled class="border-b border-gray-400 w-32 p-1 bg-transparent focus:outline-none" placeholder="Specify">
    </div>
  </div>

  <!-- Relationships -->
 <div class="mt-6 space-y-4">
  <label class="block font-semibold mb-2">Current Description of Home Life</label>

  <!-- Relationship with Parents -->
  <div class="mt-2 space-y-3">
    <!-- Mother -->
    <div class="flex items-center gap-2">
      <label class="font-semibold">Relationship with Mother:</label>
      <label class="flex items-center gap-1"><input id="rel_mother_very_close" name="rel_parent_mother" value="Very Close" type="radio" disabled class="accent-green-700"> Very Close</label>
      <label class="flex items-center gap-1"><input id="rel_mother_close" name="rel_parent_mother" value="Close" type="radio" disabled class="accent-green-700"> Close</label>
      <label class="flex items-center gap-1"><input id="rel_mother_distant" name="rel_parent_mother" value="Distant" type="radio" disabled class="accent-green-700"> Distant</label>
    </div>

    <!-- Father (moved below mother) -->
    <div class="flex items-center gap-2">
      <label class="font-semibold">Relationship with Father:</label>
      <label class="flex items-center gap-1"><input id="rel_father_very_close" name="rel_parent_father" value="Very Close" type="radio" disabled class="accent-green-700"> Very Close</label>
      <label class="flex items-center gap-1"><input id="rel_father_close" name="rel_parent_father" value="Close" type="radio" disabled class="accent-green-700"> Close</label>
      <label class="flex items-center gap-1"><input id="rel_father_distant" name="rel_parent_father" value="Distant" type="radio" disabled class="accent-green-700"> Distant</label>
    </div>
  </div>


<!-- Relationship with Family Members -->
<div class="space-y-2 mt-1">
  <!-- Siblings -->
  <div class="grid grid-cols-4 items-center gap-1">
    <label class="font-semibold">Relationship with Sibling/s</label>
    <label class="flex items-center gap-1"><input id="rel_sib_very_close" name="rel_siblings" value="Very Close" type="radio" disabled class="accent-green-700"> Very Close</label>
    <label class="flex items-center gap-1"><input id="rel_sib_close" name="rel_siblings" value="Close" type="radio" disabled class="accent-green-700"> Close</label>
    <label class="flex items-center gap-1"><input id="rel_sib_distant" name="rel_siblings" value="Distant" type="radio" disabled class="accent-green-700"> Distant</label>
  </div>

  <!-- Spouse -->
  <div class="grid grid-cols-5 items-center gap-1">
    <label class="font-semibold">Relationship with Spouse</label>
    <label class="flex items-center gap-1"><input id="rel_spouse_very_close" name="rel_spouse" value="Very Close" type="radio" disabled class="accent-green-700"> Very Close</label>
    <label class="flex items-center gap-1"><input id="rel_spouse_close" name="rel_spouse" value="Close" type="radio" disabled class="accent-green-700"> Close</label>
    <label class="flex items-center gap-1"><input id="rel_spouse_distant" name="rel_spouse" value="Distant" type="radio" disabled class="accent-green-700"> Distant</label>
    <label class="flex items-center gap-1"><input id="rel_spouse_na" name="rel_spouse" value="N/A" type="radio" disabled class="accent-green-700"> N/A</label>
  </div>

  <!-- Children -->
  <div class="grid grid-cols-5 items-center gap-1">
    <label class="font-semibold">Relationship with Children</label>
    <label class="flex items-center gap-1"><input id="rel_children_very_close" name="rel_children" value="Very Close" type="radio" disabled class="accent-green-700"> Very Close</label>
    <label class="flex items-center gap-1"><input id="rel_children_close" name="rel_children" value="Close" type="radio" disabled class="accent-green-700"> Close</label>
    <label class="flex items-center gap-1"><input id="rel_children_distant" name="rel_children" value="Distant" type="radio" disabled class="accent-green-700"> Distant</label>
    <label class="flex items-center gap-1"><input id="rel_children_na" name="rel_children" value="N/A" type="radio" disabled class="accent-green-700"> N/A</label>
  </div>
</div>


  <!-- Siblings Enrolled at RSU -->
  <div class="mt-4">
    <label class="block font-semibold">Siblings Enrolled at RSU</label>
    <div class="overflow-x-auto">
      <table class="min-w-full border text-gray-700 text-sm">
        <thead class="bg-green-50 text-green-700">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Course & Year Level</th>
            <th class="p-2 border">Contact No.</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="border p-2"><input id="sibling_0_name" type="text" value="" disabled placeholder="Full name" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_0_course" type="text" value="" disabled placeholder="Course & Year (e.g., BSCS - 2nd Year)" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_0_contact" type="text" value="" disabled placeholder="Contact No. (e.g., 09171234567)" class="bg-gray-100 p-1 rounded w-full border"></td>
          </tr>
          <tr>
            <td class="border p-2"><input id="sibling_1_name" type="text" value="" disabled placeholder="Full name" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_1_course" type="text" value="" disabled placeholder="Course & Year (e.g., BSCS - 2nd Year)" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_1_contact" type="text" value="" disabled placeholder="Contact No. (e.g., 09171234567)" class="bg-gray-100 p-1 rounded w-full border"></td>
          </tr>
          <tr>
            <td class="border p-2"><input id="sibling_2_name" type="text" value="" disabled placeholder="Full name" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_2_course" type="text" value="" disabled placeholder="Course & Year (e.g., BSCS - 2nd Year)" class="bg-gray-100 p-1 rounded w-full border"></td>
            <td class="border p-2"><input id="sibling_2_contact" type="text" value="" disabled placeholder="Contact No. (e.g., 09171234567)" class="bg-gray-100 p-1 rounded w-full border"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<div class="mt-100 flex gap-1">
  <div class="flex-1 flex items-center gap-2">
    <label class="font-semibold w-100">Number of persons in the household:</label>
    <input id="field_household_count" type="number" value="" disabled placeholder="e.g., 4" class="bg-gray-100 p-2 rounded w- border">
  </div>
    <div class="flex-1 flex items-right gap-1">
    <label class="font-semibold w-40">Head of Household:</label>
    <input id="field_head_of_household" type="text" value="" disabled placeholder="e.g. Mother, Father" class="bg-gray-100 p-1 rounded w-full border">
  </div>
</div>

  <!-- Estimated Family Monthly Income -->
  <div class="mb-4 mt-6">
    <label class="block font-semibold">Estimated Family Monthly Income</label>
    <div class="flex flex-col mt-2 space-y-1 text-gray-700">
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Less than â‚±10,957" disabled class="accent-green-700"><label>Less than â‚±10,957</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Between â‚±9,520 to â‚±21,194" disabled class="accent-green-700"><label>Between â‚±9,520 to â‚±21,194</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Between â‚±21,194 to â‚±43,828" disabled class="accent-green-700"><label>Between â‚±21,194 to â‚±43,828</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Between â‚±43,828 to â‚±76,669" disabled class="accent-green-700"><label>Between â‚±43,828 to â‚±76,669</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Between â‚±76,669 to â‚±131,484" disabled class="accent-green-700"><label>Between â‚±76,669 to â‚±131,484</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="Between â‚±131,484 to â‚±219,140" disabled class="accent-green-700"><label>Between â‚±131,484 to â‚±219,140</label></div>
  <div class="flex items-center gap-2"><input type="radio" name="familyIncome" value="At least â‚±219,140 and up" disabled class="accent-green-700"><label>At least â‚±219,140 and up</label></div>
    </div>
  </div>
</div>
</section>
<section class="bg-white mt-8 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
      <button onclick="toggleSection('section4')" class="text-green-700 hover:text-green-800">
        <i class="fas fa-chevron-right" id="icon-section4"></i>
      </button>
      Medical Background
    </h3>
    <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
  </div>

  <div id="content-section4" style="display: none;">

  <!-- Therapy / Counseling -->
 <div class="mb-4 flex items-center gap-4">
  <label class="font-semibold w-64">
    Have you received therapy, counseling, or treatment in the past?
  </label>
  
  <!-- Yes / No Checkboxes -->
  <div class="flex items-center gap-4">
    <label class="flex items-center gap-1">
      <input id="med_therapy_yes" name="med_therapy" value="yes" type="radio" disabled class="accent-green-700"> Yes
    </label>
    <label class="flex items-center gap-1">
      <input id="med_therapy_no" name="med_therapy" value="no" type="radio" disabled class="accent-green-700"> No
    </label>
  </div>

  <!-- Input for "If Yes, when and with whom?" -->
  <input id="med_therapy_details" type="text" placeholder="If Yes, when and with whom?" disabled class="flex-1 bg-gray-100 p-2 rounded border">
</div>



  <!-- PWD: Person With Disability (moved here so it appears before the disability details) -->
  <div class="mb-4">
    <label class="font-semibold w-full">Are you a Person With Disability (PWD)?</label>
    <div class="flex items-center gap-4 mt-2">
      <label class="flex items-center gap-1"><input id="field_pwd_yes" name="field_pwd" value="Yes" type="radio" disabled class="accent-green-700"> Yes</label>
      <label class="flex items-center gap-1"><input id="field_pwd_no" name="field_pwd" value="No" type="radio" disabled class="accent-green-700"> No</label>
    </div>
  </div>

  <!-- Physical Disability -->
  <div class="mb-4 flex gap-4 items-center">
    <label class="font-semibold w-60">Physical Disability:</label>
    <input id="field_physical_disability" type="text" value="" disabled placeholder="Specify physical disability (if any)" class="flex-1 bg-gray-100 p-2 rounded border">
    <label class="font-semibold w-40">PWD ID No.:</label>
    <input id="field_physical_pwd_id" type="text" value="" disabled placeholder="PWD ID No. (if any)" class="w-40 bg-gray-100 p-2 rounded border">
  </div>

  <!-- Psychosocial Disability -->
  <div class="mb-4 flex gap-4 items-center">
    <label class="font-semibold w-60">Psychosocial Disability:</label>
    <input id="field_psychosocial_disability" type="text" value="" disabled placeholder="Specify psychosocial disability (if any)" class="flex-1 bg-gray-100 p-2 rounded border">
    <label class="font-semibold w-40">PWD ID No.:</label>
    <input id="field_psychosocial_pwd_id" type="text" value="" disabled placeholder="PWD ID No. (if any)" class="w-40 bg-gray-100 p-2 rounded border">
  </div>

  <!-- Current Medications -->
  <div class="mb-2 flex gap-4 items-center">
    <label class="font-semibold w-60">Current Medications:</label>
    <input id="field_current_medications" type="text" value="" disabled placeholder="List current medications (if any)" class="flex-1 bg-gray-100 p-2 rounded border">
  </div>
</div>
</div>
</section>

    <!-- Section 3: Educational Background -->
    <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
          <button onclick="toggleSection('section5')" class="text-green-700 hover:text-green-800">
            <i class="fas fa-chevron-right" id="icon-section5"></i>
          </button>
          Educational Background
        </h3>
        <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
      </div>

      <div id="content-section5" style="display: none;">
      <div class="overflow-x-auto">
        <table class="min-w-full border text-gray-700 text-sm">
          <thead class="bg-green-50 text-green-700">
            <tr>
              <th class="p-2 border">Level</th>
              <th class="p-2 border">School Name</th>
              <th class="p-2 border">Year Graduated</th>
              <th class="p-2 border">Honors Received</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border p-2">Elementary</td>
              <td class="border p-2"><input id="edu_elementary_school" type="text" value="" disabled placeholder="School name" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_elementary_grad" type="number" value="" disabled placeholder="Year graduated e.g., 2010" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_elementary_honors" type="text" value="" disabled placeholder="Honors (if any)" class="bg-gray-100 p-1 rounded w-full border"></td>
            </tr>
            <tr>
              <td class="border p-2">Junior High</td>
              <td class="border p-2"><input id="edu_junior_school" type="text" value="" disabled placeholder="School name" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_junior_grad" type="number" value="" disabled placeholder="Year graduated e.g., 2014" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_junior_honors" type="text" value="" disabled placeholder="Honors (if any)" class="bg-gray-100 p-1 rounded w-full border"></td>
            </tr>
            <tr>
              <td class="border p-2">Senior High</td>
              <td class="border p-2"><input id="edu_senior_school" type="text" value="" disabled placeholder="School name" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_senior_grad" type="number" value="" disabled placeholder="Year graduated e.g., 2018" class="bg-gray-100 p-1 rounded w-full border"></td>
              <td class="border p-2"><input id="edu_senior_honors" type="text" value="" disabled placeholder="Honors (if any)" class="bg-gray-100 p-1 rounded w-full border"></td>
            </tr>
          </tbody>
        </table>
      </div>
</div>
    </section>

    <!-- Section 4: Employment History -->
<!-- V. Employment History -->
<section class="bg-white mt-8 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
          <button onclick="toggleSection('section6')" class="text-green-700 hover:text-green-800">
            <i class="fas fa-chevron-right" id="icon-section6"></i>
          </button>
          Employment History
        </h3>
        <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
      </div>

  <div id="content-section6" style="display: none;"><!-- Work Experience Yes/No -->
  <div class="flex items-center gap-4 mb-4">
    <label class="font-semibold w-64">Do you have a work experience?</label>
    <label class="flex items-center gap-1">
      <input id="field_has_work_exp_yes" name="field_has_work_exp" value="yes" type="radio" disabled class="accent-green-700"> Yes
    </label>
    <label class="flex items-center gap-1">
      <input id="field_has_work_exp_no" name="field_has_work_exp" value="no" type="radio" disabled class="accent-green-700"> No
    </label>
    <span class="ml-4 text-gray-700">(If yes, please fill out the table.)</span>
  </div>

  <!-- Employment Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border text-gray-700 text-sm">
      <thead class="bg-green-50 text-green-700">
        <tr>
          <th class="p-2 border">Position Title</th>
          <th class="p-2 border">Agency/Company/Organization</th>
          <th class="p-2 border">Status of Appointment</th>
          <th class="p-2 border">Inclusive Dates From</th>
          <th class="p-2 border">Inclusive Dates To</th>
        </tr>
      </thead>
      <tbody>
        <!-- Example row -->
        <tr>
          <td class="border p-2">
            <input id="emp_0_position" type="text" value="" disabled placeholder="Position title (e.g., Clerk)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_0_agency" type="text" value="" disabled placeholder="Agency / Company / Organization" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_0_status" type="text" value="" disabled placeholder="Status of Appointment (e.g., Permanent)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_0_from" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_0_to" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
        </tr>
        <tr>
          <td class="border p-2">
            <input id="emp_1_position" type="text" value="" disabled placeholder="Position title (e.g., Clerk)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_1_agency" type="text" value="" disabled placeholder="Agency / Company / Organization" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_1_status" type="text" value="" disabled placeholder="Status of Appointment (e.g., Contractual)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_1_from" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_1_to" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
        </tr>
        <tr>
          <td class="border p-2">
            <input id="emp_2_position" type="text" value="" disabled placeholder="Position title (e.g., Clerk)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_2_agency" type="text" value="" disabled placeholder="Agency / Company / Organization" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_2_status" type="text" value="" disabled placeholder="Status of Appointment (e.g., Contractual)" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_2_from" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
          <td class="border p-2">
            <input id="emp_2_to" type="date" value="" disabled placeholder="YYYY-MM-DD" class="bg-gray-100 p-1 rounded w-full border">
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
<!-- VI. Other Relevant Information -->
<section class="bg-white mt-8 p-6 rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
          <button onclick="toggleSection('section7')" class="text-green-700 hover:text-green-800">
            <i class="fas fa-chevron-right" id="icon-section7"></i>
          </button>
          Other Relevant Information
        </h3>
        <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
      </div><!-- Scholarship Grant -->
  <div id="content-section7" style="display: none;">
  <div class="flex items-center gap-4 mb-4">
    <label class="font-semibold w-64">Are you enjoying any scholarship grant/s?</label>
    <label class="flex items-center gap-1">
      <input id="field_scholarship_yes" name="field_scholarship" value="yes" type="radio" disabled class="accent-green-700"> Yes
    </label>
    <label class="flex items-center gap-1">
      <input id="field_scholarship_no" name="field_scholarship" value="no" type="radio" disabled class="accent-green-700"> No
    </label>
    <input id="field_scholarship_sponsor" type="text" placeholder="If yes, put the name of the sponsor" disabled class="ml-4 flex-1 bg-gray-100 p-2 rounded border">
  </div>

  <!-- Interests -->
  <div class="space-y-3">
    <div class="flex items-center gap-2">
      <label class="font-semibold w-64">Performing Arts (Sports, Drama, Singing, Dancing, etc.)</label>
      <input id="field_interest_performing" type="text" placeholder="__________________________" disabled class="flex-1 bg-gray-100 p-2 rounded border">
    </div>
    <div class="flex items-center gap-2">
      <label class="font-semibold w-64">Creative Arts (Painting, Drawing, Photography, etc.)</label>
      <input id="field_interest_creative" type="text" placeholder="__________________________" disabled class="flex-1 bg-gray-100 p-2 rounded border">
    </div>
    <div class="flex items-center gap-2">
      <label class="font-semibold w-64">Literary Arts (Declamation, Reading, Writing, etc.)</label>
      <input id="field_interest_literary" type="text" placeholder="__________________________" disabled class="flex-1 bg-gray-100 p-2 rounded border">
    </div>
    <div class="flex items-center gap-2">
      <label class="font-semibold w-64">Others, specify</label>
      <input id="field_interest_others" type="text" placeholder="__________________________" disabled class="flex-1 bg-gray-100 p-2 rounded border">
    </div>
  </div>
</div>
</div>
</section>


  
  <!-- Student Profilling: import from Complete Profile (fields not already in Inventory) -->
  <section class="bg-white mt-8 p-6 rounded-xl shadow-md" id="studentProfilingSection">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-green-700 flex items-center gap-2">
        <button onclick="toggleSection('section8')" class="text-green-700 hover:text-green-800">
          <i class="fas fa-chevron-right" id="icon-section8"></i>
        </button>
        Student Profilling
      </h3>
      <button class="edit-btn bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800">Edit</button>
    </div>

    <div id="content-section8" style="display: none;">

    <div class="grid grid-cols-1 gap-4 text-gray-700">
      <div>
        <label class="block font-semibold">Primary Caretaker</label>
  <input id="field_caretaker" type="text" disabled placeholder="e.g., Father / Aunt / Guardian" class="bg-gray-100 p-2 rounded w-full border protected">
      </div>

      <div>
        <label class="block font-semibold">Sensitive information consent</label>
        <div class="flex items-center gap-2 mt-1">
          <label class="flex items-center gap-1"><input id="field_sensitive_opt_in" type="checkbox" disabled class="accent-green-700"> I consent to provide sensitive information (self-harm, abuse, bullying)</label>
        </div>
        <div class="mt-2">
          <label class="block font-semibold">If yes, select experienced issue</label>
          <select id="field_sensitive_experienced" disabled class="bg-gray-100 p-2 rounded w-full border">
            <option value="">Select</option>
            <option>Bullying</option>
            <option>Self-harm</option>
            <option>Physical Abuse</option>
            <option>Verbal Abuse</option>
            <option>Sexual Abuse</option>
            <option>Suicidal Thought</option>
            <option>Suicide Attempt</option>
            <option>Negative Emotions</option>
            <option>Not applicable</option>
          </select>
          <label class="block font-semibold mt-2">If yes, describe (optional)</label>
          <textarea id="field_sensitive_desc" rows="3" disabled class="bg-gray-100 p-2 rounded w-full border" placeholder="Optional details"></textarea>
        </div>
      </div>

      <div>
        <label class="block font-semibold">Coping mechanisms (Use comma to separate (,))</label>
        <input id="field_coping" type="text" disabled placeholder="e.g. Sleeping, Reading" class="bg-gray-100 p-2 rounded w-full border">
      </div>

      <div>
        <label class="block font-semibold">People you can seek help from (Use comma to separate (,))</label>
        <input id="field_help_people" type="text" disabled placeholder="e.g. Parents, Friends" class="bg-gray-100 p-2 rounded w-full border">
      </div>
    </div>
</div>
</div>
  </section>

  </main>

  <script>
    // Modal helpers: confirm and info modals
    function showConfirmModal(message, onConfirm, onCancel) {
      const id = 'confirmModal';
      const old = document.getElementById(id); if (old) old.remove();
      const html = `
        <div id="${id}" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;">
          <div style="background:#fff;padding:1.2rem;border-radius:10px;max-width:90vw;width:420px;text-align:left;">
            <div style="font-weight:600;margin-bottom:0.5rem;">Confirm</div>
            <div style="margin-bottom:1rem;">${message}</div>
            <div style="text-align:right;">
              <button id="${id}_cancel" style="margin-right:0.5rem;padding:0.4rem 0.8rem;border-radius:6px;border:1px solid #ccc;background:#fff;">Cancel</button>
              <button id="${id}_ok" style="padding:0.4rem 0.8rem;border-radius:6px;background:#00723f;color:#fff;border:none;">Confirm</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById(id + '_cancel').onclick = function(){ document.getElementById(id).remove(); if (onCancel) onCancel(); };
      document.getElementById(id + '_ok').onclick = function(){ document.getElementById(id).remove(); if (onConfirm) onConfirm(); };
    }

    function showInfoModal(message) {
      const id = 'infoModal'; const old = document.getElementById(id); if (old) old.remove();
      const html = `
        <div id="${id}" style="position:fixed;inset:0;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;">
          <div style="background:#fff;padding:1rem;border-radius:10px;max-width:90vw;width:360px;text-align:center;">
            <div style="font-weight:600;margin-bottom:0.5rem;">Saved</div>
            <div style="margin-bottom:1rem;">${message}</div>
            <div><button id="${id}_ok" style="padding:0.4rem 0.8rem;border-radius:6px;background:#00723f;color:#fff;border:none;">OK</button></div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById(id + '_ok').onclick = function(){ document.getElementById(id).remove(); };
    }
    const editButtons = document.querySelectorAll('.edit-btn');
    editButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.closest('section');
        const inputs = section.querySelectorAll('input, select, textarea');
        if (btn.textContent === 'Edit') {
          inputs.forEach(i => {
            // keep most protected fields disabled, but allow specific protected fields
            // (e.g., primary caretaker) to become editable when entering Edit mode
            if (i.classList && i.classList.contains('protected') && i.id !== 'field_caretaker') return;
            i.disabled = false;
          });
          btn.textContent = 'Save';
          btn.classList.replace('bg-green-700', 'bg-blue-700');
          // update photo input enabled state when entering edit mode
          try { updatePhotoInputState(); } catch(e){}
        } else {
          // Ask for confirmation before saving
          showConfirmModal('Are you sure you want to save changes to this section?', async function() {
            // on confirm: disable inputs and change button state
            inputs.forEach(i => {
              if (i.classList && i.classList.contains('protected')) { i.disabled = true; return; }
              i.disabled = true;
            });
            btn.textContent = 'Edit';
            btn.classList.replace('bg-blue-700', 'bg-green-700');
            // update photo input enabled state when leaving edit mode
            try { updatePhotoInputState(); } catch(e){}

            // Perform section-specific save: collect only fields inside this section
            try {
              const result = await saveSection(section);
              if (result && result.success) {
                try { showInfoModal('Changes saved!'); } catch(e){ showInfoModal('Changes saved!'); }
              } else {
                inputs.forEach(i => { if (!(i.classList && i.classList.contains('protected'))) i.disabled = false; });
                btn.textContent = 'Save';
                btn.classList.replace('bg-green-700', 'bg-blue-700');
                showInfoModal('Save failed: ' + (result && result.error && result.error.message ? result.error.message : 'Unknown error'));
              }
            } catch (err) {
              inputs.forEach(i => { if (!(i.classList && i.classList.contains('protected'))) i.disabled = false; });
              btn.textContent = 'Save';
              btn.classList.replace('bg-green-700', 'bg-blue-700');
              showInfoModal('Save failed: ' + (err && err.message ? err.message : 'Unknown error'));
            }
          }, function() {
            // on cancel: do nothing (leave inputs enabled and button as Save)
          });
        }
      });
    });

    // Photo input: enable only when some section is in Edit mode
    function isAnySectionEditing() {
      try {
        const btns = document.querySelectorAll('.edit-btn');
        for (const b of btns) {
          if (b && b.textContent && b.textContent.trim() === 'Save') return true;
        }
      } catch(e) {}
      return false;
    }

    function updatePhotoInputState() {
      const fileInputEl = document.getElementById('profilePhotoInput');
      const placeholderEl = document.getElementById('formPhotoPlaceholder');
      const enabled = isAnySectionEditing();
      if (fileInputEl) fileInputEl.style.pointerEvents = enabled ? 'auto' : 'none';
      // Keep the placeholder appearance unchanged when disabled per request.
      if (placeholderEl) {
        // expose an accessibility hint via aria-disabled but do not change visual styling
        try { placeholderEl.setAttribute('aria-disabled', enabled ? 'false' : 'true'); } catch(e){}
      }
    }

    // initialize photo input state
    try { updatePhotoInputState(); } catch(e){}

    // Medical therapy details state: enable details input only when user selected 'Yes'
    // and the section is in edit mode. When disabled, clear the details to avoid stale data.
    function updateMedTherapyDetailsState() {
      try {
        const yes = document.getElementById('med_therapy_yes');
        const no = document.getElementById('med_therapy_no');
        const details = document.getElementById('med_therapy_details');
        if (!details) return;
        // Only allow typing when the yes radio is selected AND some section is in edit mode
        const enabled = !!(yes && yes.checked && isAnySectionEditing());
        details.disabled = !enabled;
        if (!enabled) {
          // clear details when not enabled to avoid accidentally saving stale text
          try { details.value = ''; } catch(e){}
        }
      } catch(e) { console.warn('updateMedTherapyDetailsState error', e); }
    }

    // wire change listeners on the radios so toggling updates the details state immediately
    try {
      const y = document.getElementById('med_therapy_yes');
      const n = document.getElementById('med_therapy_no');
      if (y) y.addEventListener('change', updateMedTherapyDetailsState);
      if (n) n.addEventListener('change', updateMedTherapyDetailsState);
      // Also re-evaluate when entering/exiting edit mode (edit buttons toggle state)
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', function() { setTimeout(updateMedTherapyDetailsState, 60); }));
      // initial evaluation
      setTimeout(updateMedTherapyDetailsState, 50);
    } catch(e) { /* ignore wiring errors */ }
    // Spouse inputs: enable only when Civil Status is 'Married' AND the section is in Edit mode.
    function updateSpouseInputsState() {
      try {
        const marriedRadio = document.getElementById('field_civil_married');
        const married = !!(marriedRadio && marriedRadio.checked);
        const spouseIds = ['field_spouse_name','field_spouse_occupation','field_spouse_children','field_spouse_address','field_spouse_contact'];
        spouseIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          // determine if this field's section is currently in edit mode
          let allow = false;
          try {
            const section = el.closest && el.closest('section');
            if (married) {
              if (section) {
                const eb = section.querySelector('.edit-btn');
                allow = !!(eb && eb.textContent && eb.textContent.trim() === 'Save');
              } else {
                // fallback: allow only when any section is editing
                allow = married && isAnySectionEditing();
              }
            } else {
              allow = false;
            }
          } catch(e) { allow = false; }
          el.disabled = !allow;
          if (!allow) {
            try { el.value = ''; } catch(e){}
          }
        });
      } catch(e) { console.warn('updateSpouseInputsState error', e); }
    }

    // wire to civil status radios so toggling updates spouse inputs immediately
    try {
      const cs1 = document.getElementById('field_civil_single');
      const cs2 = document.getElementById('field_civil_married');
      const cs3 = document.getElementById('field_civil_others');
      if (cs1) cs1.addEventListener('change', function(){
        updateSpouseInputsState();
        // if Single selected, clear spouse inputs and persist the cleared values immediately
        try {
          if (cs1.checked) {
            // small delay to allow updateSpouseInputsState to clear fields
            setTimeout(async function(){
              try {
                const sec = cs1.closest ? cs1.closest('section') : null;
                let res = null;
                if (sec) {
                  res = await saveSection(sec);
                } else {
                  // fallback: perform a full profile save if section not found
                  res = await performProfileSave();
                }
                // surface errors to console so it's easier to debug when DB write fails
                if (!res || !res.success) console.warn('Auto-save on Single did not succeed', res);
              } catch (e) { console.warn('auto-save on Single failed', e); }
            }, 120);
          }
        } catch(e) { /* ignore */ }
      });
      if (cs2) cs2.addEventListener('change', updateSpouseInputsState);
      if (cs3) cs3.addEventListener('change', updateSpouseInputsState);
      // re-evaluate when entering/exiting edit mode
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', function() { setTimeout(updateSpouseInputsState, 60); }));
      setTimeout(updateSpouseInputsState, 60);
    } catch(e) { /* ignore wiring errors */ }
  function previewPhoto(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    const img = document.getElementById('photoPreview');
    const placeholder = document.getElementById('photoPlaceholder');

    reader.onload = function(e) {
        try {
          if (img) {
            img.src = e.target.result;
            img.classList.remove('hidden');
          }
          if (placeholder) {
            placeholder.classList.add('hidden');
          }
        } catch(err) { console.warn('previewPhoto onload error', err); }
    };
    if (file) reader.readAsDataURL(file);
  }
  </script>
  <!-- Defensive CSS to remove unexpected bottom whitespace and hide transient overlays -->
  <style>
    /* Remove browser default body margin and ensure full-height layout */
    html, body { height: 100%; margin: 0; padding: 0; }

    /* Ensure main content stretches to viewport so no stray gap remains */
    #content, .content, main { min-height: 100vh; box-sizing: border-box; }

    /* Hide transient overlays that may have been left in the DOM and contribute to layout gaps */
    .sidebar-overlay, .sidebar-overlay.active, #actionCard, .cropModal, .modal-backdrop { display: none !important; }

    /* Defensive: ensure footer-like elements don't add extra flow space */
    footer, .page-footer { margin: 0; padding: 0; }
  </style>
  <!-- Small layout tweak: ensure no unexpected extra bottom space on the page -->
  <style>
    /* ensure page bottoms don't leave large gaps; override any stray margins/paddings */
    html, body { margin: 0; padding: 0; min-height: 100%; }
    main.content { margin-bottom: 0 !important; padding-bottom: 1rem !important; }
    /* if any full-height overlays were left visible accidentally, keep them hidden by default */
    .sidebar-overlay { display: none !important; }
  </style>
 
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Profile - SafeSpace</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Override inline input styles inside the inventory to match Tailwind form controls */
    .info-section input[type="text"], .info-section input[type="number"],
    .info-section input[type="date"], .info-section select, .info-section textarea,
    .inv-section input[type="text"], .inv-section input[type="number"], .inv-section select,
    .inv-section textarea {
      padding: 0.5rem !important;
      border-radius: 0.375rem !important; /* rounded */
      border: 1px solid #d1d5db !important; /* gray-300 */
      background: #fff !important;
      box-sizing: border-box;
      font-size: 0.95rem;
    }
    .inv-header { font-weight:700; padding:0.5rem 0; margin-bottom:0.5rem }
    .inv-table th, .inv-table td { padding:0.5rem; }
    /* make small inputs look consistent but keep explicit width if set inline */
    .info-section input[placeholder], .inv-section input[placeholder] { color: #6b7280 }
    /* style the 1x1 photo placeholder */
    #formPhotoPlaceholder { width:120px; height:120px; border:1px solid #e5e7eb; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; background:#f8fafc }
  </style>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
    body { background:#f4f6f9; color:#333; overflow-x:hidden; }

    :root{
      --green:#0f7a34;
      --panel:#ffffff;
      --muted:#6b7280;
      --bg:#f4f6fb;
      --card-shadow: 0 6px 18px rgba(16,24,40,0.06);
      --radius:10px;
      --sidebar-width:250px;
      --collapsed-width:80px;
      --topbar-height:64px;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      position:fixed; left:0; top:0; height:100vh; width:var(--sidebar-width);
      background:#f0f3f6; border-right:1px solid rgba(0,0,0,0.06);
      display:flex;flex-direction:column;z-index:80;transition:width .18s ease, transform .25s ease;
    }
    .sidebar .top{
      background:var(--green);
      color:#fff;
      height:var(--topbar-height);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-left:12px;
      padding-right:12px;
      /* Remove vertical padding to use height */
      padding-top:0;
      padding-bottom:0;
    }
    .sidebar .brand{display:flex;align-items:center;gap:12px}
    .sidebar .logo{font-weight:800;font-size:18px}
    .burger{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer;padding:6px}

    .nav{padding:12px;display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;text-decoration:none;color:#1f2937;background:transparent}
    .nav a .label{font-size:15px}
    .nav a .icon{width:56px;display:inline-flex;align-items:center;justify-content:center;font-size:22px}
    .nav a.active{background:rgba(15,122,52,0.08);color:var(--green)}

    /* collapsed state (icon-only) */
    body.collapsed .sidebar{width:var(--collapsed-width)}
    body.collapsed .sidebar .top .logo{display:none}
    body.collapsed .nav a .label{display:none}
    body.collapsed .sidebar .bottom .logged{display:none}

    .sidebar .bottom{margin-top:auto;padding:12px;border-top:1px solid rgba(0,0,0,0.04)}

    /* ===== Topbar ===== */
    .topbar{
      position:fixed; top:0; right:0; left:var(--sidebar-width); height:var(--topbar-height);
      background:var(--green); color:#fff; display:flex;align-items:center;justify-content:space-between;padding:12px 18px;z-index:85;box-shadow:0 4px 18px rgba(2,6,23,0.06);
      transition:left .18s ease;
    }
    body.collapsed .topbar{ left: var(--collapsed-width); }

  /* When sidebar is collapsed, move content/main to match collapsed width */
  body.collapsed .content { margin-left: var(--collapsed-width); }
  body.collapsed main { margin-left: var(--collapsed-width); }

    .topbar-left{display:flex;align-items:center;gap:12px}
    .mobile-logo{display:none;width:36px;height:36px;border-radius:8px;background:transparent;color:var(--green);display:flex;align-items:center;justify-content:center;font-weight:800}
    .portal-title{display:flex;flex-direction:column}
    .portal-title .title{font-weight:800;font-size:20px;line-height:1}
    .portal-title .sub{font-size:13px;opacity:0.95}

    .top-right{display:flex;align-items:center;gap:12px}
    .icon-btn{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
    .avatar{width:40px;height:40px;border-radius:50%;background:transparent;color:var(--green);display:flex;align-items:center;justify-content:center;font-weight:800}

    /* notification dropdown recolor */
    .notif-dropdown{position:absolute;top:48px;right:0;background:var(--panel);color:#111;width:260px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.12);display:none;flex-direction:column;overflow:hidden;z-index:2000}
    .notif-dropdown.active{display:flex}
    .notif-header{background:var(--green);color:#fff;padding:0.6rem;font-weight:700}
    .notif-list{max-height:220px;overflow-y:auto}
    .notif-item{padding:0.6rem 0.8rem;border-bottom:1px solid #f2f4f6;cursor:pointer}
    .notif-item:hover{background:#f7fdf7}

    .notif-badge.hidden { display:none; }

    /* ===== Content ===== */
    .content {
      padding:1rem;
  /* move content higher: reduce the top offset further (avoid full overlap with topbar) */
  padding-top: calc(var(--topbar-height) - 24px);
      max-width:100vw; margin:auto;
      margin-left: var(--sidebar-width);
      transition:margin-left 0.3s ease;
      padding-bottom: 7rem; /* Space for footer and mobile bottom nav */
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    /* Ensure any main element also sits to the right of the sidebar and below the topbar
       This covers pages where content isn't wrapped by .content */
    main {
      margin-left: var(--sidebar-width);
  /* move main content slightly higher */
  padding-top: calc(var(--topbar-height) - 24px);
    }
    /* Inventory form styling to resemble the provided PDF-like images */
    .inventory-form {
      max-width:900px; margin:0 auto; background:transparent; padding:0.5rem; color:#111;
      font-size:14px; line-height:1.15;
    }
    .inventory-form .inv-section {
      border:1px solid #000; margin-bottom:10px; padding:8px; background:#fff;
    }
    .inventory-form .inv-section .inv-header {
      font-weight:700; padding:6px 8px; border-bottom:1px solid #000; background:#f4f4f4; margin:-8px -8px 8px -8px;
    }
    .inv-row { display:flex; gap:8px; align-items:flex-start; margin-bottom:6px; }
    .inv-row .inv-label { min-width:160px; font-weight:600; }
    .inv-row .inv-field { flex:1; }
    .inv-field input[type="text"], .inv-field input[type="date"], .inv-field input[type="number"], .inv-field select, .inv-field textarea {
      width:100%; padding:6px; border:1px solid #bbb; border-radius:3px; background:transparent;
    }
    .inv-table { width:100%; border-collapse:collapse; margin-top:6px }
    .inv-table th, .inv-table td { border:1px solid #000; padding:6px; font-size:13px }
    .inv-table th { background:#eee; font-weight:700 }
  .inv-table td.level-cell { background:#eee; font-weight:700; width:140px }
  .inv-table input { width:100%; padding:6px; border:0; outline:0; font-size:13px }
    /* compact checkbox style */
    .inv-checkbox { display:inline-flex; align-items:center; gap:6px; margin-right:8px }
  /* Signature feature removed: signature canvas and upload handlers were removed */
    .content.shrink { margin-left:70px; max-width: 100vw; }

    .profile-container {
      max-width: 600px;
      margin: 0 auto;
      /* remove extra bottom padding so container sits closer to footer */
      padding-bottom: 0;
    }

    /* Footer: keep it in the document flow (not fixed) so it stays at the bottom of the page
       instead of remaining visible while scrolling. */
    .fixed-footer {
      position:static; /* no longer fixed */
      left:auto;
      right:auto;
      padding:0.5rem 12px;
      background:transparent;
      /* reduce margin-top so footer sits closer to content */
      margin-top:0.25rem;
      z-index:auto;
      text-align:center;
    }
    /* hide footer on small screens where a bottom-nav may exist */
    @media (max-width:768px) { .fixed-footer { display:none; } }

    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #d1c4e9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      margin: 2rem auto;
      color: #4a148c;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .top-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
    }


    .info-section {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }

    .info-section h3 {
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      color: #00723f;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #666;
      font-weight: 500;
    }

    .info-value {
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-item i {
      color: #00723f;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .info-item i:hover {
      background: rgba(0, 114, 63, 0.1);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-item:hover {
      background: rgba(0, 114, 63, 0.05);
      margin: 0 -1.5rem;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
      border-radius: 6px;
    }

    .settings-item i {
      color: #00723f;
    }

    /* Show mobile logo on mobile */
    @media (max-width:768px) {
      .mobile-logo { display: flex; }
    }

    /* ===== Mobile Bottom Nav ===== */
    @media (max-width:768px) {
      .sidebar { 
        display: none !important;
        transform: translateX(-100%);
      }
      .topbar { margin-left:0; }
      .content { margin-left:0; }
      .hamburger { display: none; }
      
      /* Show mobile logo and SafeSpace text */
      .mobile-logo { display: flex; }
      .portal-title strong span.safespace { display: inline; }
      
      .bottom-nav {
        position:fixed; bottom:0; left:0; width:100%;
        background:#004c27; display:flex; justify-content:space-around;
        padding:0.5rem 0; z-index:2000;
      }
      .bottom-nav a {
        flex:1; text-align:center; color:white; text-decoration:none; font-size:0.9rem;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
      }
      .bottom-nav a i { font-size:1.2rem; margin-bottom:0.2rem; }
      .bottom-nav a.active { color:#ffc107; }
      
      .content { padding-bottom: 5rem; }
    }
    
    /* Hide bottom nav on larger screens */
    .bottom-nav { display: none; }

    @media (max-width: 768px) {
      .bottom-nav { 
        display: flex !important;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: var(--primary);
        justify-content: space-around;
        padding: 12px 0;
        z-index: 100;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }
      .bottom-nav a {
        flex: 1;
        text-align: center;
        color: white;
        text-decoration: none;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .bottom-nav a.active {
        opacity: 1;
      }
      .bottom-nav a i {
        font-size: 18px;
      }
      .content {
        padding: 1rem !important;
        padding-bottom: 5rem !important;
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        overflow-x: hidden !important;
      }
      /* Prevent horizontal scrolling */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
      input, textarea, select {
        max-width: 100%;
      }
    }
  </style>

  <!-- Additional styles to match Messages UI (sidebar & topbar) -->
  <style>
    :root{ --green:#0f7a34; --panel:#ffffff; --muted:#6b7280; --bg:#f4f6fb; --card-shadow: 0 6px 18px rgba(16,24,40,0.06); --radius:10px; --sidebar-width:250px; --collapsed-width:80px; --topbar-height:64px; }

    /* Sidebar (messages look) */
    .sidebar {
      position: fixed; top: 0; left: 0;
      width: var(--sidebar-width); height: 100vh;
      /* add top padding so nav items appear below the fixed brand/topbar */
      background: #f0f3f6; color:#1f2937; padding: calc(var(--topbar-height) + 12px) 12px 12px 12px; z-index:1002; overflow:auto;
      box-sizing: border-box; display:flex; flex-direction:column;
    }
    .sidebar .brand { position: fixed; top:0; left:0; width:var(--sidebar-width); height:var(--topbar-height); display:flex; align-items:center; padding:10px 20px; box-sizing:border-box; background:#1e8e3e; color:white; gap:12px; z-index:1003; }
    .sidebar .logo { height:40px; width:40px; background: transparent url("safespace.png") center/contain no-repeat; color:transparent; border-radius:8px; }
  /* menu items: remove vertical gaps so links sit flush, keep internal padding for click area */
  #sidebar a { display:flex; align-items:center; gap:12px; color:#1f2937; text-decoration:none; margin:0; padding:10px 12px; border-radius:6px; background:transparent; transition: background 0.18s ease, color 0.18s ease; }
  .sidebar a .fa, .sidebar a i { width:28px; text-align:center; font-size:18px; color:#1f2937; }
  .sidebar a span { display:inline-block; white-space:nowrap; overflow:hidden; }
  /* enforce the same green hover/active used in messages.html */
  .sidebar a:hover, .sidebar a.active { background: rgba(15,122,52,0.08) !important; color:#0f7a34 !important; font-weight:600 !important; }
  /* make sure consecutive anchors have no gaps */
  #sidebar a + a { margin-top: 0 !important; }

    /* collapsed sidebar */
    .sidebar.collapsed { width: var(--collapsed-width); }
    .sidebar.collapsed .brand { width: var(--collapsed-width); justify-content:center; }
  /* When collapsed only show the logo â€” hide the SafeSpace text */
  .sidebar.collapsed .brand span { display: none !important; }
  .sidebar.collapsed a span { display:none; }
    .sidebar a::before { content: attr(data-emoji); margin-right:8px; }

    /* Topbar */
    .topbar { position: fixed; top:0; left: var(--sidebar-width); right:0; height:var(--topbar-height); background:#1e8e3e; color:white; padding:10px 24px; display:flex; justify-content:space-between; align-items:center; z-index:1001; transition:left 0.3s ease; }
    .topbar.shifted { left: var(--collapsed-width); }
    .topbar-left { display:flex; align-items:center; gap:0.6rem; }
    .hamburger { font-size:1.2rem; cursor:pointer; padding:0.3rem; border-radius:4px; }
    .hamburger:hover { background: rgba(255,255,255,0.08); }
    @media (min-width:769px) {
      .portal-title strong span.safespace { display:none; }
    }

    /* content offset to sit below topbar and right of sidebar */
  /* raise content slightly so it sits closer to the topbar (reduce gap by 8px) */
  .content { margin-top: calc(var(--topbar-height) - 8px); margin-left: var(--sidebar-width); transition: margin-left 0.3s ease; }
    .content.shrink { margin-left: var(--collapsed-width); }

    /* Notifications */
    .notif-dropdown { position:absolute; top:48px; right:0; background:white; color:#333; width:260px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.15); display:none; z-index:2000; }
    .notif-dropdown.active { display:block; }

    /* Match messages.html base font and page background */
    html{ font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; font-size:15px; }
    body{ margin:0; background:var(--bg); color:#111; }

    /* vertical divider to visually separate sidebar and content (white-ish line) */
    .sidebar::after {
      content: '';
      position: absolute;
      left: calc(var(--sidebar-width) - 1px);
      top: var(--topbar-height);
      width: 1px;
      height: calc(100vh - var(--topbar-height));
      /* use a subtle gray divider (matches messages.html look) */
      background: rgba(0,0,0,0.06);
      z-index: 1001;
    }

    /* When sidebar is collapsed, keep the divider aligned with the smaller width */
    .sidebar.collapsed::after {
      left: calc(var(--collapsed-width) - 1px);
      height: calc(100vh - var(--topbar-height));
    }
  </style>

<!-- Action Card (for future use) -->
  <div id="actionCard" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:1.2rem 1.5rem; min-width:280px; max-width:90vw; text-align:center; position:relative;">
      <span style="position:absolute; top:10px; right:18px; font-size:1.3rem; cursor:pointer;" onclick="closeActionCard()">&times;</span>
      <div id="actionCardContent"></div>
    </div>
  </div>

  <!-- Fixed footer placed at the very bottom on desktop; hidden on small screens to avoid colliding with bottom-nav -->
  <footer class="fixed-footer text-center text-gray-500 text-sm" aria-hidden="false">
    Â© 2025 RSU SafeSpace | Student Support Management System
  </footer>

  <!-- Add Firebase SDKs before your main script -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib-browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="firebase_config.js"></script>
  <script>
    enforceAuthRedirect();
  </script>
  
<script>
  // Use shared firebase_config.js which sets window.auth/window.db/window.storage
  // Provide safe fallbacks in case the shared file didn't load for some reason.
  const auth = window.auth || (window.firebase ? firebase.auth() : null);
  const db = window.db || (window.firebase ? firebase.database() : null);
  const storage = window.storage || (window.firebase && firebase.storage ? firebase.storage() : null);

  // Async auth watcher (like home.html)
  function watchAuth(callback) {
    if (auth && typeof auth.onAuthStateChanged === 'function') {
      auth.onAuthStateChanged(callback);
    } else if (window.firebase && firebase.auth) {
      // final fallback to firebase global
      firebase.auth().onAuthStateChanged(callback);
    } else {
      console.error('Auth not available. Make sure firebase SDKs and firebase_config.js are loaded.');
    }
  }

  // Small helper to render profiling/assessment objects into HTML
  function renderProfilingSummary(obj) {
    // If it's a simple string or number, just return it
    if (obj === null || obj === undefined) return '<div class="text-sm text-gray-600">No data</div>';
    if (typeof obj === 'string' || typeof obj === 'number') return `<div>${String(obj)}</div>`;
    // If it's an array, render as list
    if (Array.isArray(obj)) {
      return '<ul class="list-disc pl-5">' + obj.map(i => `<li>${escapeHtml(JSON.stringify(i))}</li>`).join('') + '</ul>';
    }
    // Heuristics for nicer presentation of common assessment shapes
    const keys = Object.keys(obj);
    // If object looks like a score report
    if ((keys.includes('score') || keys.includes('total')) && (keys.includes('status') || keys.includes('assessmentDate') || keys.includes('date'))) {
      const score = obj.score || obj.total || '';
      const status = obj.status || '';
      const date = obj.assessmentDate || obj.date || obj.completedAt || '';
      const summary = (obj.summary || obj.notes || '');
      return `
        <div class="mb-2"><strong>Score:</strong> <span class="text-green-700 font-semibold">${escapeHtml(String(score))}</span></div>
        <div class="mb-2"><strong>Status:</strong> <span>${escapeHtml(String(status))}</span></div>
        <div class="mb-2"><strong>Date:</strong> <span>${escapeHtml(String(date))}</span></div>
        ${summary ? `<div class="mb-2"><strong>Summary:</strong> <div class="text-sm text-gray-700">${escapeHtml(String(summary))}</div></div>` : ''}
      `;
    }
    // If object appears to be question -> answer map (question_1, q1, etc.), show compact list and basic stats
    const qPattern = /^(q|question|item|q_)\d+/i;
    const questionKeys = keys.filter(k => qPattern.test(k) || /^question_/i.test(k));
    if (questionKeys.length >= Math.max(5, Math.floor(keys.length * 0.4))) {
      // render as list of Q: A
      const list = questionKeys.map(k => `<div class="mb-1"><strong>${escapeHtml(k.replace(/_/g,' '))}:</strong> <span class="text-gray-700">${escapeHtml(String(obj[k]))}</span></div>`).join('');
      return `<div>${list}</div>`;
    }
    // Fallback: render key/value pairs, show nested objects compactly
    const rows = keys.map(k => {
      const v = obj[k];
      if (v && typeof v === 'object') return `<div class="mb-2"><strong>${escapeHtml(k)}:</strong><div class="ml-3 text-sm text-gray-700">${escapeHtml(JSON.stringify(v, null, 2))}</div></div>`;
      return `<div class="mb-2"><strong>${escapeHtml(k)}:</strong> <span class="text-gray-700">${escapeHtml(String(v))}</span></div>`;
    });
    return rows.join('');
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  // Get student profile by UID
  async function getStudentProfile(uid) {
    const snapshot = await db.ref('students').orderByChild('uid').equalTo(uid).once('value');
    if (snapshot.exists()) {
      // Return the first matching student record
      const child = Object.values(snapshot.val())[0];
      const key = Object.keys(snapshot.val())[0];
      return { data: child, key };
    }
    return null;
  }

  // Main logic
  watchAuth(async (user) => {
    if (user) {
      // Load profile info
      const snapshot = await db.ref('students').orderByChild('uid').equalTo(user.uid).once('value');
      if (snapshot.exists()) {
        const studentKey = Object.keys(snapshot.val())[0];
        const data = Object.values(snapshot.val())[0];

        // Avatar: prefer the 1x1 preview photo if present, otherwise use data.photo_url (which may be a storage path), else fall back to initials
        (async function setPreferredPhoto(){
          try {
            const previewEl = document.getElementById('photoPreview');
            const placeholderEl = document.getElementById('photoPlaceholder');
            // If there's already a visible preview image (uploaded or present in DOM), prefer it
            if (previewEl && previewEl.src && !previewEl.classList.contains('hidden')) {
              const finalUrl = previewEl.src;
              const avatarEl = document.getElementById('profileAvatar'); if (avatarEl) avatarEl.innerHTML = `<img src="${finalUrl}" alt="Profile Photo" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">`;
              const topProfileEl = document.getElementById('topProfile'); if (topProfileEl) topProfileEl.innerHTML = `<img src="${finalUrl}" alt="Profile Photo" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`;
              try { const ph = document.getElementById('formPhotoPlaceholder'); if (ph) ph.innerHTML = `<img src="${finalUrl}" alt="1x1 Photo" style="width:120px;height:120px;object-fit:cover;display:block">`; } catch(e){}
              return;
            }

            // If DB contains a photo_url, try to resolve it (supports storage paths)
            if (data.photo_url) {
              let finalUrl = data.photo_url;
              try {
                if (storage && typeof storage.ref === 'function' && !/^\s*(data:|https?:|blob:)/i.test(finalUrl)) {
                  try { finalUrl = await storage.ref(finalUrl).getDownloadURL(); } catch(e) { /* keep original */ }
                }
              } catch(e) { console.warn('photo resolution failed', e); }
              const avatarEl2 = document.getElementById('profileAvatar'); if (avatarEl2) avatarEl2.innerHTML = `<img src="${finalUrl}" alt="Profile Photo" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">`;
              const topProfileEl2 = document.getElementById('topProfile'); if (topProfileEl2) topProfileEl2.innerHTML = `<img src="${finalUrl}" alt="Profile Photo" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`;
              try { const ph2 = document.getElementById('formPhotoPlaceholder'); if (ph2) ph2.innerHTML = `<img src="${finalUrl}" alt="1x1 Photo" style="width:120px;height:120px;object-fit:cover;display:block">`; } catch(e){}
              try { if (previewEl) { previewEl.src = finalUrl; previewEl.classList.remove('hidden'); if (placeholderEl) placeholderEl.classList.add('hidden'); } } catch(e){}
              return;
            }

            // No photo found: fallback to initials
            const initials = (data.first_name || data.username || 'U')[0].toUpperCase();
            const avatarEl3 = document.getElementById('profileAvatar'); if (avatarEl3) avatarEl3.textContent = initials;
            const topProfileEl3 = document.getElementById('topProfile'); if (topProfileEl3) topProfileEl3.textContent = initials;
            try { const ph3 = document.getElementById('formPhotoPlaceholder'); if (ph3) ph3.textContent = '1x1 Photo'; } catch(e){}
          } catch(e) { console.warn('setPreferredPhoto error', e); }
        })();

  // topbar student id (if present)
  const tbIdEl = document.getElementById('topbarStudentId');
  if (tbIdEl) tbIdEl.textContent = "ID: " + (data.student_id || 'N/A');
        // profile full name (if present)
        const pfEl = document.getElementById('profileFullName');
        if (pfEl) {
          const fullName = (data.first_name ? data.first_name : '') + (data.middle_initial ? ' ' + data.middle_initial : '') + (data.last_name ? ' ' + data.last_name : '');
          pfEl.textContent = fullName.trim() || 'N/A';
        }
        const psEl = document.getElementById('profileStudentId');
        if (psEl) psEl.textContent = data.student_id || 'N/A';
        // profile age/phone/email (these info elements were removed from the top; guard before using)
        const ageEl = document.getElementById('profileAge');
        if (ageEl) ageEl.innerHTML = (data.age || 'N/A') + ' <i class="fas fa-pen"></i>';
        const phoneEl = document.getElementById('profilePhone');
        if (phoneEl) phoneEl.innerHTML = (data.mobile || 'N/A') + ' <i class="fas fa-pen"></i>';
        // For email we display it if element exists but do not attach an edit handler (email should not be editable here)
        const emailEl = document.getElementById('profileEmail');
        if (emailEl) emailEl.innerHTML = (data.email_address || user.email || 'N/A');

        // Sign out button
        const signOutBtnEl = document.getElementById('signOutBtn');
        if (signOutBtnEl) signOutBtnEl.onclick = function() {
          auth.signOut().then(function() {
            window.location.href = "signin.html";
          });
        };

        // Upload photo logic
        const uploadPhotoBtnEl = document.getElementById('uploadPhotoBtn');
        const profilePhotoInputEl = document.getElementById('profilePhotoInput');
        if (uploadPhotoBtnEl && profilePhotoInputEl) {
          uploadPhotoBtnEl.onclick = function() { profilePhotoInputEl.click(); };
        }
        // also allow clicking the form photo placeholder to upload
        const formPhoto = document.getElementById('formPhotoPlaceholder');
        if (formPhoto && profilePhotoInputEl) {
          formPhoto.addEventListener('click', function(){ profilePhotoInputEl.click(); });
        }
        if (profilePhotoInputEl) profilePhotoInputEl.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
          }
          const reader = new FileReader();
          reader.onload = function(evt) {
            const base64String = evt.target.result;
            const updates = { photo_url: base64String };
            db.ref("students/" + studentKey).update(updates).then(() => {
              const pAvatar = document.getElementById('profileAvatar'); if (pAvatar) pAvatar.innerHTML = `<img src="${base64String}" alt="Profile Photo" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">`;
              const topProf = document.getElementById('topProfile'); if (topProf) topProf.innerHTML = `<img src="${base64String}" alt="Profile Photo" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`;
              // update the form header photo placeholder as a square
              const ph = document.getElementById('formPhotoPlaceholder');
              if (ph) ph.innerHTML = `<img src="${base64String}" alt="1x1 Photo" style="width:120px;height:120px;object-fit:cover;display:block">`;
              alert('Profile photo updated!');
            });
          };
          reader.readAsDataURL(file);
        };

        // Edit modal logic for age, phone, email
        // attach edit handlers for age/phone only if their elements exist and contain an edit icon
        if (ageEl) {
          const agePen = ageEl.querySelector && ageEl.querySelector('i.fas.fa-pen');
          if (agePen) agePen.onclick = function(e) {
            e.stopPropagation();
            const currentValue = data.age || '';
            showEditModal('Age', currentValue, 'number', function(newValue) {
              db.ref('students/' + studentKey).update({ age: newValue });
              if (ageEl) ageEl.innerHTML = newValue + ' <i class="fas fa-pen"></i>';
            });
          };
        }
        if (phoneEl) {
          const phonePen = phoneEl.querySelector && phoneEl.querySelector('i.fas.fa-pen');
          if (phonePen) phonePen.onclick = function(e) {
            e.stopPropagation();
            const currentValue = data.mobile || '';
            showEditModal('Mobile', currentValue, 'text', function(newValue) {
              db.ref('students/' + studentKey).update({ mobile: newValue });
              if (phoneEl) phoneEl.innerHTML = newValue + ' <i class="fas fa-pen"></i>';
            });
          };
        }
        // Populate the detailed form if available
        if (typeof populateProfileForm === 'function') {
          try { populateProfileForm(data, studentKey); } catch (e) { console.warn('populateProfileForm failed', e); }
        }
  // Load profiling/assessment answers (if any) and render into the summary card
        (async function loadProfiling() {
          const profilingContent = document.getElementById('profilingContent');
          const profilingEmpty = document.getElementById('profilingEmpty');
          const profilingToggle = document.getElementById('profilingToggle');
          // If the profiling elements are not present in the DOM, skip profiling load to avoid runtime errors
          if (!profilingContent || !profilingEmpty) {
            console.warn('loadProfiling: profiling DOM elements not found; skipping.');
            return;
          }
          const pathsToTry = [
            `students/${studentKey}/profile`,
            `students/${studentKey}/profiling`,
            `students/${studentKey}/assessments`,
            `assessments/${user.uid}`,
            `assessment_results/${user.uid}`
          ];

          let found = false;
          for (const p of pathsToTry) {
            try {
              const snap = await db.ref(p).once('value');
              if (snap.exists()) {
                const val = snap.val();
                profilingEmpty.style.display = 'none';
                profilingContent.style.display = 'block';
                profilingContent.innerHTML = renderProfilingSummary(val);
                found = true;
                break;
              }
            } catch (e) { console.warn('read', p, e); }
          }
          if (!found) {
            profilingContent.style.display = 'none';
            profilingEmpty.style.display = 'block';
          }

          if (profilingToggle) profilingToggle.onclick = function(){
            if (profilingContent.style.display === 'none') {
              profilingContent.style.display = 'block';
              profilingEmpty.style.display = 'none';
              profilingToggle.textContent = 'Hide';
            } else {
              profilingContent.style.display = 'none';
              profilingToggle.textContent = 'View';
              if (!found) profilingEmpty.style.display = 'block';
            }
          };
        })();
        // Do not attach an edit handler for email here (email is not editable from the inventory form)
      }
    } else {
      window.location.href = "signin.html";
    }
  console.log(auth ? auth.currentUser : null);
  });

  // Modal logic for editing fields
  function showEditModal(label, value, type, callback) {
    const modalHtml = `
      <div id="editModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:1.2rem 1.5rem;min-width:280px;max-width:90vw;text-align:center;position:relative;">
          <span style="position:absolute;top:10px;right:18px;font-size:1.3rem;cursor:pointer;" onclick="closeEditModal()">&times;</span>
          <strong>Edit ${label}</strong><br><br>
          <input id="editModalInput" type="${type}" value="${value}" style="width:80%;padding:0.5rem;margin-bottom:1rem;border-radius:6px;border:1px solid #ccc;">
          <br>
          <button id="editModalSaveBtn" style="background:#28a745;color:white;border:none;padding:0.5rem 1rem;border-radius:6px;">Save</button>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    document.getElementById('editModalSaveBtn').onclick = function() {
      const newValue = document.getElementById('editModalInput').value.trim();
      if (newValue === value || newValue === "") {
        closeEditModal();
        return;
      }
      if (confirm(`Are you sure you want to update your ${label.toLowerCase()}?`)) {
        callback(newValue);
        closeEditModal();
      }
    };
  }
  function closeEditModal() {
    const modal = document.getElementById('editModalOverlay');
    if (modal) modal.remove();
  }

  // Sign-out moved to settings page; profile links to settings.html instead
  // Modal for 2FA messages
  function show2FAModal(message) {
    const oldModal = document.getElementById('modal2FA');
    if (oldModal) oldModal.remove();

    const modalHtml = `
      <div id="modal2FA" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:1.2rem 1.5rem;min-width:280px;max-width:90vw;text-align:center;position:relative;">
          <span style="position:absolute;top:10px;right:18px;font-size:1.3rem;cursor:pointer;" onclick="document.getElementById('modal2FA').remove()">&times;</span>
          <div style="margin-bottom:1rem;">${message}</div>
          <button onclick="document.getElementById('modal2FA').remove()" style="background:#00723f;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">OK</button>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }

  // Modal for email 2FA enrollment
  function showEmail2FAModal(onSend, onVerify) {
    const oldModal = document.getElementById('modalEmail2FA');
    if (oldModal) oldModal.remove();

    const modalHtml = `
      <div id="modalEmail2FA" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:1.2rem 1.5rem;min-width:320px;max-width:90vw;text-align:center;position:relative;">
          <span style="position:absolute;top:10px;right:18px;font-size:1.3rem;cursor:pointer;" onclick="document.getElementById('modalEmail2FA').remove()">&times;</span>
          <strong>Enable Email-based Two-Factor Authentication</strong><br><br>
          <div id="email2FAstep1">
            <button id="email2FASendBtn" style="background:#00723f;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">Send Verification Code to Email</button>
          </div>
          <div id="email2FAstep2" style="display:none;margin-top:1rem;">
            <label style="font-size:0.98rem;">Verification Code:</label><br>
            <input id="email2FACode" type="text" placeholder="Enter code" style="width:80%;padding:0.5rem;margin-bottom:1rem;border-radius:6px;border:1px solid #ccc;"><br>
            <button id="email2FAVerifyBtn" style="background:#00723f;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">Verify & Enroll</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    document.getElementById('email2FASendBtn').onclick = async function() {
      this.disabled = true;
      this.textContent = "Sending...";
      await onSend();
      document.getElementById('email2FAstep2').style.display = 'block';
      document.getElementById('email2FAstep1').style.display = 'none';
    };

    document.getElementById('email2FAVerifyBtn').onclick = async function() {
      const code = document.getElementById('email2FACode').value.trim();
      if (!code) {
        alert("Please enter the verification code.");
        return;
      }
      this.disabled = true;
      this.textContent = "Verifying...";
      await onVerify(code);
    };
  }

  // Generate a random 6-digit code
  function generate2FACode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Attach click event to all settings items
  document.querySelectorAll('.settings-item').forEach(item => {
    item.addEventListener('click', async function() {
      const label = item.querySelector('.info-label').textContent;
      if (label === "Two-Factor Authentication") {
    const user = auth ? auth.currentUser : null;
        if (!user) return show2FAModal("You must be signed in.");

        // Check if already enrolled (use your own flag in DB)
        const snapshot = await db.ref('students').orderByChild('uid').equalTo(user.uid).once('value');
        let studentKey = null, data = null;
        if (snapshot.exists()) {
          studentKey = Object.keys(snapshot.val())[0];
          data = Object.values(snapshot.val())[0];
          if (data.email2FAEnabled || data.totpSecret) {
            show2FAModal("2FA is already enabled for your account.");
            return;
          }
        }

        // Show modal for 2FA method selection
        const modalHtml = `
          <div id="modal2FAChoice" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
            <div style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:1.2rem 1.5rem;min-width:320px;max-width:90vw;text-align:center;position:relative;">
              <span style="position:absolute;top:10px;right:18px;font-size:1.3rem;cursor:pointer;" onclick="document.getElementById('modal2FAChoice').remove()">&times;</span>
              <strong>Choose Two-Factor Authentication Method</strong><br><br>
              <button id="chooseEmail2FA" style="background:#00723f;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;margin-bottom:1rem;">Email-based 2FA</button><br>
              <button id="chooseApp2FA" style="background:#004c27;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">Authenticator App (TOTP)</button>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        document.getElementById('chooseEmail2FA').onclick = function() {
          document.getElementById('modal2FAChoice').remove();
          // Call your existing email 2FA modal logic
          let code = generate2FACode();
          showEmail2FAModal(
            async () => {
              show2FAModal(`A verification code has been sent to your email.<br><br><strong>Demo code: ${code}</strong>`);
              await db.ref('students/' + studentKey).update({ email2FACode: code });
            },
            async (inputCode) => {
              const snap = await db.ref('students/' + studentKey + '/email2FACode').once('value');
              if (snap.val() === inputCode) {
                await db.ref('students/' + studentKey).update({ email2FAEnabled: true, email2FACode: null });
                document.getElementById('modalEmail2FA').remove();
                show2FAModal("Email-based 2FA enabled! You will now be required to verify your email on login.");
              } else {
                show2FAModal("Incorrect code. Please try again.");
              }
            }
          );
        };

        document.getElementById('chooseApp2FA').onclick = async function() {
          document.getElementById('modal2FAChoice').remove();
          // Generate a TOTP secret (for demo, store in DB; for production, use backend)
          const secret = otplib.authenticator.generateSecret();
          const otpauth = otplib.authenticator.keyuri(user.email, "SafeSpace", secret);

          // Generate QR code
          let qrDataUrl = "";
          await QRCode.toDataURL(otpauth).then(url => { qrDataUrl = url; });

          // Show modal with QR code and input for code
          const modalAppHtml = `
            <div id="modalApp2FA" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;">
              <div style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:1.2rem 1.5rem;min-width:320px;max-width:90vw;text-align:center;position:relative;">
                <span style="position:absolute;top:10px;right:18px;font-size:1.3rem;cursor:pointer;" onclick="document.getElementById('modalApp2FA').remove()">&times;</span>
                <strong>Authenticator App Setup</strong><br><br>
                <div>Scan this QR code with your authenticator app:</div>
                <img src="${qrDataUrl}" alt="Authenticator QR" style="margin:1rem auto;max-width:180px;"><br>
                <div style="font-size:0.95rem;margin-bottom:1rem;">Or enter this code manually:<br><strong>${secret}</strong></div>
                <label>Enter the 6-digit code from your app:</label><br>
                <input id="totpCodeInput" type="text" maxlength="6" placeholder="Enter 6-digit code" style="width:80%;padding:0.5rem;margin-bottom:1rem;border-radius:6px;border:1px solid #ccc;"><br>
                <button id="totpVerifyBtn" style="background:#00723f;color:white;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">Verify & Enroll</button>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', modalAppHtml);

          document.getElementById('totpVerifyBtn').onclick = async function() {
            const code = document.getElementById('totpCodeInput').value.trim();
            if (otplib.authenticator.check(code, secret)) {
              await db.ref('students/' + studentKey).update({ totpSecret: secret });
              document.getElementById('modalApp2FA').remove();
              show2FAModal("Authenticator App 2FA enabled! You will now be required to enter a code from your app on login.");
            } else {
              show2FAModal("Incorrect code. Please try again.");
            }
          };
        };
      }
    });
  });
</script>

  <div id="recaptcha-container"></div>
  
  <!-- Crop modal (opened when user clicks or drops an image on the photo placeholder) -->
  <div id="cropModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-lg w-[90vw] max-w-3xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Crop profile photo</h3>
        <button id="cropCancelBtn" class="text-gray-600 hover:text-gray-900">Cancel</button>
      </div>
      <div class="flex gap-4">
        <div class="flex-1 overflow-hidden" style="max-height:60vh;">
          <div style="position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden;">
            <img id="cropImage" src="" alt="To crop" style="max-width:100%; max-height:60vh; width:auto; display:block; transform-origin:center center; cursor:grab; object-fit:contain;" />
            <div id="cropOverlay" style="position:absolute; border:2px dashed #fff; box-shadow:0 2px 8px rgba(0,0,0,0.3); cursor:move; display:none; background:rgba(255,255,255,0.0)"></div>
          </div>
        </div>
        <div style="width:180px;">
          <div class="mb-2">Preview</div>
          <div id="cropPreview" style="width:160px;height:160px;border:1px solid #ddd;border-radius:6px;overflow:hidden;background:#f7f7f7"></div>
          <div class="mt-4 text-right">
            <button id="cropSaveBtn" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Image crop modal + drag/drop handling
    (function(){
      const placeholder = document.getElementById('formPhotoPlaceholder');
      const fileInput = document.getElementById('profilePhotoInput');
      const cropModal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const cropOverlay = document.getElementById('cropOverlay');
      const cropPreview = document.getElementById('cropPreview');
      const cropSaveBtn = document.getElementById('cropSaveBtn');
      const cropCancelBtn = document.getElementById('cropCancelBtn');

      let imgNaturalWidth = 0, imgNaturalHeight = 0;
      let overlay = { x:0, y:0, w:100, h:100 };
      let dragging = false, dragStart = null;

      function openCropModalFromDataUrl(dataUrl) {
        // ensure image fits modal viewport
        cropImage.style.maxHeight = '60vh';
        cropImage.style.maxWidth = '100%';
        cropImage.style.width = 'auto';
        cropImage.style.objectFit = 'contain';
        cropImage.src = dataUrl;
        // reset previous pan/transform so each open starts centered
        imgOffset = { x: 0, y: 0 };
        cropImage.style.transform = '';
        cropOverlay.style.display = 'none';
        cropPreview.innerHTML = '';
        cropModal.classList.remove('hidden'); cropModal.classList.add('flex');
        // wait for image load
        cropImage.onload = function(){
          imgNaturalWidth = cropImage.naturalWidth; imgNaturalHeight = cropImage.naturalHeight;
          // compute displayed image size and set a centered square overlay
          const rect = cropImage.getBoundingClientRect();
          const parentRect = cropImage.parentElement.getBoundingClientRect();
          const size = Math.min(rect.width, rect.height) * 0.6;
          overlay.w = overlay.h = Math.max(80, size);
          // center overlay relative to displayed image
          overlay.x = Math.max(0, (rect.width - overlay.w) / 2);
          overlay.y = Math.max(0, (rect.height - overlay.h) / 2);
          // use pixel positions relative to the image element (we'll recompute during interactions)
          // position overlay
          positionOverlay();
          cropOverlay.style.display = 'block';
          updatePreview();
        };
      }

      function closeCropModal(){ cropModal.classList.add('hidden'); cropModal.classList.remove('flex'); }

      // Position overlay based on overlay obj and current image rect
      function positionOverlay(){
        const imgRect = cropImage.getBoundingClientRect();
        const parentRect = cropImage.parentElement.getBoundingClientRect();
        // clamp overlay values within image rect
        overlay.w = Math.min(overlay.w, imgRect.width);
        overlay.h = Math.min(overlay.h, imgRect.height);
        overlay.x = Math.max(0, Math.min(imgRect.width - overlay.w, overlay.x));
        overlay.y = Math.max(0, Math.min(imgRect.height - overlay.h, overlay.y));
        // compute left/top relative to parent container
        const left = (imgRect.left - parentRect.left) + overlay.x;
        const top = (imgRect.top - parentRect.top) + overlay.y;
        cropOverlay.style.left = left + 'px';
        cropOverlay.style.top = top + 'px';
        cropOverlay.style.width = overlay.w + 'px';
        cropOverlay.style.height = overlay.h + 'px';
        cropOverlay.style.position = 'absolute';
        cropOverlay.style.pointerEvents = 'auto';
      }

      function updatePreview(){
        // crop coords relative to displayed image -> map to natural size
        const imgRect = cropImage.getBoundingClientRect();
        const scaleX = imgNaturalWidth / imgRect.width;
        const scaleY = imgNaturalHeight / imgRect.height;
        const sx = overlay.x * scaleX;
        const sy = overlay.y * scaleY;
        const sw = overlay.w * scaleX;
        const sh = overlay.h * scaleY;
        const canvas = document.createElement('canvas'); canvas.width = 160; canvas.height = 160;
        const ctx = canvas.getContext('2d');
        // draw cropped region into preview canvas, fit into square
        const tmpCanvas = document.createElement('canvas'); tmpCanvas.width = sw; tmpCanvas.height = sh; const tctx = tmpCanvas.getContext('2d');
        const tmpImg = new Image(); tmpImg.crossOrigin = 'anonymous'; tmpImg.src = cropImage.src;
        tmpImg.onload = function(){
          tctx.drawImage(tmpImg, sx, sy, sw, sh, 0, 0, sw, sh);
          // draw scaled to preview
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(tmpCanvas, 0, 0, sw, sh, 0, 0, canvas.width, canvas.height);
          cropPreview.innerHTML = ''; const imgEl = document.createElement('img'); imgEl.src = canvas.toDataURL('image/png'); imgEl.style.width='100%'; imgEl.style.height='100%'; cropPreview.appendChild(imgEl);
        };
      }

  // Mouse & touch handling: drag to move overlay OR pan the image (dragging image moves the photo under the crop box)
  let isMoving = false, isPanning = false, startX=0, startY=0, startOverlayX=0, startOverlayY=0;
  // image translation state
  let imgOffset = { x: 0, y: 0 };
  let startImgOffsetX = 0, startImgOffsetY = 0;
  cropOverlay.addEventListener('mousedown', function(e){ e.preventDefault(); isMoving = true; startX = e.clientX; startY = e.clientY; startOverlayX = overlay.x; startOverlayY = overlay.y; });
  cropImage.addEventListener('mousedown', function(e){ e.preventDefault(); isPanning = true; startX = e.clientX; startY = e.clientY; startOverlayX = overlay.x; startOverlayY = overlay.y; startImgOffsetX = imgOffset.x; startImgOffsetY = imgOffset.y; cropImage.style.cursor = 'grabbing'; });

  // touch start handlers
  cropOverlay.addEventListener('touchstart', function(e){ if(!e.touches||!e.touches[0]) return; e.preventDefault(); isMoving = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; startOverlayX = overlay.x; startOverlayY = overlay.y; });
  cropImage.addEventListener('touchstart', function(e){ if(!e.touches||!e.touches[0]) return; e.preventDefault(); isPanning = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; startOverlayX = overlay.x; startOverlayY = overlay.y; startImgOffsetX = imgOffset.x; startImgOffsetY = imgOffset.y; });

  document.addEventListener('mousemove', function(e){ if (!isMoving && !isPanning) return; const imgRect = cropImage.getBoundingClientRect(); const dx = e.clientX - startX; const dy = e.clientY - startY; if (isMoving){ overlay.x = startOverlayX + dx; overlay.y = startOverlayY + dy; } else if (isPanning){ imgOffset.x = startImgOffsetX + dx; imgOffset.y = startImgOffsetY + dy; cropImage.style.transform = 'translate(' + imgOffset.x + 'px,' + imgOffset.y + 'px)'; overlay.x = startOverlayX - dx; overlay.y = startOverlayY - dy; } overlay.x = Math.max(0, Math.min(imgRect.width - overlay.w, overlay.x)); overlay.y = Math.max(0, Math.min(imgRect.height - overlay.h, overlay.y)); positionOverlay(); updatePreview(); });
  document.addEventListener('mouseup', function(){ if (isMoving) isMoving = false; if (isPanning){ isPanning = false; cropImage.style.cursor = 'grab'; } });

  document.addEventListener('touchmove', function(e){ if ((!isMoving && !isPanning) || !e.touches||!e.touches[0]) return; const imgRect = cropImage.getBoundingClientRect(); const dx = e.touches[0].clientX - startX; const dy = e.touches[0].clientY - startY; if (isMoving){ overlay.x = startOverlayX + dx; overlay.y = startOverlayY + dy; } else if (isPanning){ imgOffset.x = startImgOffsetX + dx; imgOffset.y = startImgOffsetY + dy; cropImage.style.transform = 'translate(' + imgOffset.x + 'px,' + imgOffset.y + 'px)'; overlay.x = startOverlayX - dx; overlay.y = startOverlayY - dy; } overlay.x = Math.max(0, Math.min(imgRect.width - overlay.w, overlay.x)); overlay.y = Math.max(0, Math.min(imgRect.height - overlay.h, overlay.y)); positionOverlay(); updatePreview(); }, { passive: false });
      document.addEventListener('touchend', function(){ if (isMoving) isMoving = false; if (isPanning){ isPanning = false; cropImage.style.cursor = 'grab'; } });

      // Handle wheel to resize overlay
      cropOverlay.addEventListener('wheel', function(e){ e.preventDefault(); const delta = e.deltaY > 0 ? -10 : 10; overlay.w = Math.max(40, overlay.w + delta); overlay.h = overlay.w; positionOverlay(); updatePreview(); });

      // Save: produce cropped dataURL and set #photoPreview.src
      cropSaveBtn.addEventListener('click', function(){
        const imgRect = cropImage.getBoundingClientRect();
        const scaleX = imgNaturalWidth / imgRect.width;
        const scaleY = imgNaturalHeight / imgRect.height;
        const sx = Math.max(0, overlay.x * scaleX);
        const sy = Math.max(0, overlay.y * scaleY);
        const sw = Math.max(1, overlay.w * scaleX);
        const sh = Math.max(1, overlay.h * scaleY);
        const canvas = document.createElement('canvas'); canvas.width = sw; canvas.height = sh; const ctx = canvas.getContext('2d');
        const tmpImg = new Image(); tmpImg.crossOrigin = 'anonymous'; tmpImg.src = cropImage.src;
        tmpImg.onload = async function(){
          ctx.drawImage(tmpImg, sx, sy, sw, sh, 0, 0, sw, sh);
          const finalCanvas = document.createElement('canvas'); finalCanvas.width = 400; finalCanvas.height = 400; const fctx = finalCanvas.getContext('2d');
          fctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, finalCanvas.width, finalCanvas.height);
          const dataUrl = finalCanvas.toDataURL('image/png');
            // update UI placeholders immediately so the first-section box reflects the change instantly
            try {
              const photoPreview = document.getElementById('photoPreview'); if (photoPreview) { photoPreview.src = dataUrl; photoPreview.dataset.cropped = '1'; }
              if (fileInput) fileInput._lastCroppedData = dataUrl;
              const pAvatar = document.getElementById('profileAvatar'); if (pAvatar) pAvatar.innerHTML = `<img src="${dataUrl}" alt="Profile Photo" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">`;
              const topProf = document.getElementById('topProfile'); if (topProf) topProf.innerHTML = `<img src="${dataUrl}" alt="Profile Photo" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`;
              const ph = document.getElementById('formPhotoPlaceholder'); if (ph) ph.innerHTML = `<img src="${dataUrl}" alt="1x1 Photo" style="width:120px;height:120px;object-fit:cover;display:block">`;
              const avatarPreview = document.getElementById('avatarPreview'); if (avatarPreview) avatarPreview.innerHTML = `<img src="${dataUrl}" style="width:120px;height:120px;object-fit:cover;display:block">`;
            } catch(e) { console.warn('Failed to update UI placeholders', e); }
            // persist to DB but do not block UI update
            try {
              // Use the globally tracked currentStudentKey (set by auth watcher) so we update the
              // correct student record. Previously this used a local/undefined `studentKey` which
              // prevented the DB write from happening.
              if (db && typeof currentStudentKey !== 'undefined' && currentStudentKey) {
                db.ref('students/' + currentStudentKey).update({ photo_url: dataUrl, photoUpdatedAt: Date.now() }).catch(e=>console.warn('DB update failed', e));
              } else {
                console.warn('Cannot save cropped photo: no currentStudentKey');
              }
            } catch (e) { console.warn('Failed to save cropped photo to DB', e); }
            closeCropModal();
        };
      });

      cropCancelBtn.addEventListener('click', function(){ closeCropModal(); });

      // When file input changes, open crop modal
      if (fileInput) {
        fileInput.addEventListener('change', function(e){
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader(); reader.onload = function(evt){ openCropModalFromDataUrl(evt.target.result); }; reader.readAsDataURL(f);
        });
      }

      // allow clicking the placeholder to open file select (existing behavior preserved)
      if (placeholder) {
        placeholder.addEventListener('click', function(){
          // Only allow opening file selector when in edit mode. Do nothing silently otherwise.
          if (!isAnySectionEditing()) return;
          if (fileInput) fileInput.click();
        });
        // drag/drop
        placeholder.addEventListener('dragover', function(e){ e.preventDefault(); placeholder.classList.add('opacity-70'); });
        placeholder.addEventListener('dragleave', function(e){ placeholder.classList.remove('opacity-70'); });
        placeholder.addEventListener('drop', function(e){
          e.preventDefault();
          // silently ignore drops when not editing
          if (!isAnySectionEditing()) return;
          placeholder.classList.remove('opacity-70');
          const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (!f) return; const reader = new FileReader(); reader.onload = function(evt){ openCropModalFromDataUrl(evt.target.result); }; reader.readAsDataURL(f);
        });
      }
    })();
  </script>

  <script>
    // Enhanced form population and save + signature handling
    let currentStudentKey = null;
    let currentStudentData = null;

    // Campus / College lists (copied from complete_profile.html) and helpers
    const campusList = [
      'Main Campus',
      'Cajidiocan Campus',
      'San Fernando Campus',
      'Romblon Campus',
      'San Agustin Campus',
      'Sta. Maria Campus',
      'Sta. Fe Campus',
      'Calatrava Campus'
    ];

    const collegesByCampus = {
      'Main Campus': [
        'College of Education',
        'College of Business and Accountancy',
        'College of Arts and Sciences',
        'College of Engineering and Technology',
        'College of Computing, Multimedia Arts and Digital Innovation'
      ],
      'Cajidiocan Campus': [],
      'San Fernando Campus': [],
      'Romblon Campus': [],
      'San Agustin Campus': [],
      'Sta. Maria Campus': [],
      'Sta. Fe Campus': [],
      'Calatrava Campus': []
    };

    function setSelectValueInsensitive(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (value === undefined || value === null) ? '' : String(value).trim();
      if (!v) { el.value = ''; return; }
      let matched = false;
      for (let i = 0; i < el.options.length; i++) {
        const opt = el.options[i];
        if (!opt) continue;
        if ((opt.value && String(opt.value).toLowerCase() === v.toLowerCase()) || (opt.text && String(opt.text).toLowerCase() === v.toLowerCase())) {
          el.selectedIndex = i; matched = true; break;
        }
      }
      if (!matched) {
        // add as an option and select it
        const newOpt = document.createElement('option'); newOpt.value = v; newOpt.text = v; newOpt.selected = true; el.appendChild(newOpt);
      }
    }

    function populateCampusOptions(selectedCampus, selectedCollege) {
      const el = document.getElementById('field_campus');
      const colEl = document.getElementById('field_college');
      if (!el) return;
      el.innerHTML = '<option value="">Select campus</option>' + campusList.map(c => `<option value="${c}">${c}</option>`).join('');
      // set selected campus (case-insensitive) or add it
      if (selectedCampus) setSelectValueInsensitive('field_campus', selectedCampus);
      // attach change handler to update colleges when campus changes (keeps selects disabled until Edit)
      el.addEventListener('change', function(){
        const cur = el.value || '';
        populateCollegeOptions(cur, (selectedCollege || ''));
      });
      // ensure colleges updated for the initial campus
      populateCollegeOptions((selectedCampus || ''), (selectedCollege || ''));
    }

    function populateCollegeOptions(campus, selectedCollege) {
      const el = document.getElementById('field_college');
      if (!el) return;
      const list = (campus && collegesByCampus[campus]) ? collegesByCampus[campus] : [];
      // Populate college options but keep the control disabled until explicit Edit is used
      if (campus === 'Main Campus' || (list && list.length)) {
        el.innerHTML = '<option value="">Select college</option>' + list.map(col => `<option value="${col}">${col}</option>`).join('');
        if (selectedCollege) setSelectValueInsensitive('field_college', selectedCollege);
      } else {
        // No colleges available for this campus: clear value and show a friendly placeholder
        // Do NOT persist a stale college value â€” keep stored value empty unless user explicitly selects one elsewhere
        el.innerHTML = '<option value="">No college available</option>';
        // ensure the select has empty value
        el.value = '';
      }
      // ensure control is enabled only when user is in Edit mode; default to disabled during initial load
      try {
        el.disabled = (typeof isAnySectionEditing === 'function') ? !isAnySectionEditing() : true;
      } catch (e) { el.disabled = true; }
    }

      // Helper: compute age (years) from a date string (expected yyyy-mm-dd or any ISO date)
      function computeAgeFromDOB(dobStr) {
        if (!dobStr) return '';
        try {
          // Normalize to Date
          const d = new Date(dobStr);
          if (isNaN(d.getTime())) return '';
          const today = new Date();
          let age = today.getFullYear() - d.getFullYear();
          const m = today.getMonth() - d.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
          return (age >= 0) ? age : '';
        } catch (e) { return ''; }
      }

      // Update the age input based on the DOB input value
      function updateAgeFieldFromDOB() {
        try {
          const dobEl = document.getElementById('field_dob');
          const ageEl = document.getElementById('field_age');
          if (!ageEl) return;
          const dobVal = (dobEl && dobEl.value) ? dobEl.value : '';
          const age = computeAgeFromDOB(dobVal);
          ageEl.value = (age === '' ? '' : String(age));
        } catch (e) { /* ignore */ }
      }

    // Ensure dropdowns populate early so user can interact even before DB load
    document.addEventListener('DOMContentLoaded', function(){
      try { if (document.getElementById('field_campus')) populateCampusOptions('', ''); } catch(e){}
      // wire DOB -> age auto-update
      try {
        const dobEl = document.getElementById('field_dob');
        if (dobEl) dobEl.addEventListener('change', updateAgeFieldFromDOB);
        // also try listening to input in case browsers provide different events
        if (dobEl) dobEl.addEventListener('input', updateAgeFieldFromDOB);
      } catch (e) { }
    });

    // populate the detailed form with data from DB
    function populateProfileForm(data, key) {
      currentStudentKey = key;
      currentStudentData = data || {};
      // If expected form elements aren't present (user may have reverted markup), bail out safely
      const primaryEl = document.getElementById('field_first_name') || document.getElementById('field_student_id') || document.getElementById('profileAvatar') || document.getElementById('field_last_name');
      if (!primaryEl) {
        console.warn('populateProfileForm: expected profile form elements not found in DOM. Skipping DOM population.');
        console.log('populateProfileForm: student data snapshot:', data);
        return;
      }
    try {
      // small resolver helper: try multiple keys (top-level and a simple family/flat fallback)
      function resolve(src, keys) {
        if (!src) return '';
        for (const k of keys) {
          if (src[k] !== undefined && src[k] !== null) return src[k];
          const camel = k.replace(/_([a-z])/g, g => g[1].toUpperCase());
          if (src[camel] !== undefined && src[camel] !== null) return src[camel];
        }
        if (src.family) {
          for (const k of keys) {
            if (src.family[k] !== undefined && src.family[k] !== null) return src.family[k];
            const camel = k.replace(/_([a-z])/g, g => g[1].toUpperCase());
            if (src.family[camel] !== undefined && src.family[camel] !== null) return src.family[camel];
          }
        }
        return '';
      }

      // small DOM helpers to avoid TypeErrors when elements are missing
      function setValue(id, v) { const el = document.getElementById(id); if (el) el.value = (v === undefined || v === null) ? '' : v; }
      function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = (v === undefined || v === null) ? '' : v; }
      function setChecked(id, v) { const el = document.getElementById(id); if (el) el.checked = !!v; }

      // Basic name fields (handle middle_initial / middle_name aliases)
      const fnEl = document.getElementById('field_first_name'); if (fnEl) fnEl.value = resolve(data, ['first_name','firstName','given_name','givenName','username']);
      const mnEl = document.getElementById('field_middle_name'); if (mnEl) mnEl.value = resolve(data, ['middle_initial','middle_name','middleName','mi']);
      const lnEl = document.getElementById('field_last_name'); if (lnEl) lnEl.value = resolve(data, ['last_name','lastName','surname','family_name']);
      const sEl = document.getElementById('field_suffix'); if (sEl) sEl.value = resolve(data, ['suffix']);
      try { const sidEl = document.getElementById('field_student_id'); if (sidEl) { sidEl.value = resolve(data, ['student_id','studentId','id','stid']); sidEl.readOnly = true; } } catch(e){}

      const cyEl = document.getElementById('field_year_level'); if (cyEl) cyEl.value = resolve(data, ['year_level']);
      try { const courseEl = document.getElementById('field_course'); if (courseEl) courseEl.value = resolve(data, ['course','program','program_name']); } catch(e){}
      try {
        const campusVal = resolve(data, ['campus','campus_name']);
        const collegeVal = resolve(data, ['college','college_name']);
        // If dropdowns are present, populate options and select values (case-insensitive)
        if (document.getElementById('field_campus') || document.getElementById('field_college')) {
          populateCampusOptions(campusVal || '', collegeVal || '');
        } else {
          // fallback for older markup: set as simple inputs
          const campusEl = document.getElementById('field_campus'); if (campusEl) campusEl.value = campusVal || '';
          const collegeEl = document.getElementById('field_college'); if (collegeEl) collegeEl.value = collegeVal || '';
        }
      } catch(e){}
      // populate academic admit semester checkboxes (data.academic_admit_sem may be '1st Sem' or '2nd Sem')
      try {
        const semVal = data.academic_admit_sem || '';
        const s1 = document.getElementById('field_admit_sem_1');
        const s2 = document.getElementById('field_admit_sem_2');
        if (s1) s1.checked = /1|1st|first/i.test(String(semVal));
        if (s2) s2.checked = /2|2nd|second/i.test(String(semVal));
      } catch (e) {}
      if (data.admit_year_from) { const a1 = document.getElementById('field_admit_year_from'); if (a1) a1.value = data.admit_year_from; }
      if (data.admit_year_to) { const a2 = document.getElementById('field_admit_year_to'); if (a2) a2.value = data.admit_year_to; }
      if (data.status_of_enrollment) {
        try {
          const val = String(data.status_of_enrollment || '').trim();
          const el = document.querySelector('input[name="field_status_enrollment"][value="' + val + '"]');
          if (el) el.checked = true;
        } catch (e) {}
      }

      const paEl = document.getElementById('field_present_address'); if (paEl) paEl.value = resolve(data, ['present_address','presentAddress','address_present']);
      // Student Profilling fields (from Complete Profile)
      try {
        const cEl = document.getElementById('field_caretaker'); if (cEl) cEl.value = resolve(data, ['caretaker']);
      } catch(e){}
      try {
        // sensitive opt-in and related fields
        const sOpt = resolve(data, ['sensitiveOptIn','sensitive_opt_in']);
        const sOptEl = document.getElementById('field_sensitive_opt_in'); if (sOptEl) sOptEl.checked = !!sOpt;
        const sExp = resolve(data, ['sensitiveExperienced','sensitive_experienced']);
        const sExpEl = document.getElementById('field_sensitive_experienced'); if (sExpEl) sExpEl.value = sExp || '';
        const sDesc = resolve(data, ['sensitiveDesc','sensitive_desc']);
        const sDescEl = document.getElementById('field_sensitive_desc'); if (sDescEl) sDescEl.value = (Array.isArray(sDesc) ? sDesc.join('\n') : (sDesc || ''));
      } catch(e){}
      try {
        const cVal = resolve(data, ['coping']);
        const cEl2 = document.getElementById('field_coping'); if (cEl2) cEl2.value = Array.isArray(cVal) ? cVal.join(', ') : (cVal || '');
        const hVal = resolve(data, ['helpPeople','help_people']);
        const hEl = document.getElementById('field_help_people'); if (hEl) hEl.value = Array.isArray(hVal) ? hVal.join(', ') : (hVal || '');
      } catch(e){}
      const permEl = document.getElementById('field_permanent_address'); if (permEl) permEl.value = resolve(data, ['permanent_address','permanentAddress','address_permanent']);
    // Background: FB Messenger and Email
    try { document.getElementById('field_fb_messenger').value = resolve(data, ['fb_messenger','fbMessenger','fb','messenger']); } catch(e){}
    try { document.getElementById('field_email').value = resolve(data, ['email','email_address','emailAddress','email_addr']); } catch(e){}

  if (data.dob) setValue('field_dob', data.dob);
      try {
        // gender/sex fallbacks
        const sexVal = resolve(data, ['sex','gender','gender_identity','sex_identity']);
        const sexEl = document.getElementById('field_sex'); if (sexEl) sexEl.value = sexVal;
      } catch(e){}
      try {
        // If a DOB is present, compute age from it; otherwise fall back to stored age
        const ageEl = document.getElementById('field_age');
        const dobEl = document.getElementById('field_dob');
        if (ageEl) {
          if (dobEl && dobEl.value) {
            ageEl.value = computeAgeFromDOB(dobEl.value);
          } else {
            ageEl.value = data.age || '';
          }
        }
      } catch(e){}
  setValue('field_place_of_birth', resolve(data, ['place_of_birth','placeOfBirth','birth_place']));
  // Civil status: prefer direct match to radios; if value not match Single/Married set 'Others' and populate text
  try {
    const civ = resolve(data, ['civil_status','civilStatus','marital_status']);
    if (civ) {
      const match = document.querySelector('input[name="field_civil_status"][value="' + civ + '"]');
      if (match) {
        match.checked = true;
      } else {
        const otherRadio = document.getElementById('field_civil_others');
        const otherInput = document.getElementById('field_civil_status_other');
        if (otherRadio) otherRadio.checked = true;
        if (otherInput) otherInput.value = civ;
      }
    }
  } catch (e) { /* ignore */ }
  setValue('field_religion', resolve(data, ['religion','religious_affiliation']));
      try {
        // contact number: try multiple variants (DB key is 'mobile')
        const contactVal = resolve(data, ['mobile']);
        // populate both possible input IDs used across pages
        const contactEl1 = document.getElementById('mobile');
        if (contactEl1) contactEl1.value = contactVal;
        const contactEl2 = document.getElementById('field_contact_no');
        if (contactEl2) contactEl2.value = contactVal;
      } catch(e){}

      // Profile full name display (best-effort)
      try {
        const pfEl2 = document.getElementById('profileFullName');
        if (pfEl2) {
          const f = resolve(data, ['first_name','firstName','given_name']);
          const m = resolve(data, ['middle_initial','middle_name','mi']);
          const l = resolve(data, ['last_name','lastName','surname']);
          const fullName = [f, m, l].filter(Boolean).join(' ');
          pfEl2.textContent = fullName.trim() || (data.fullName || data.full_name || 'N/A');
        }
      } catch(e){}

      // Spouse fields
      try { document.getElementById('field_spouse_name').value = (data.family && data.family.spouse_name) || data.spouse_name || ''; } catch(e){}
      try { document.getElementById('field_spouse_occupation').value = (data.family && data.family.spouse_occupation) || data.spouse_occupation || ''; } catch(e){}
      try { document.getElementById('field_spouse_children').value = (data.family && data.family.spouse_children) || data.spouse_children || ''; } catch(e){}
      try { document.getElementById('field_spouse_address').value = (data.family && data.family.spouse_address) || data.spouse_address || ''; } catch(e){}
      try { document.getElementById('field_spouse_contact').value = (data.family && data.family.spouse_contact) || data.spouse_contact || ''; } catch(e){}
      // Family income: prefer top-level 'income' or family.income (stored as label string)
      try {
        let incomeVal = '';
        if (data.income !== undefined) incomeVal = (typeof data.income === 'string') ? data.income.trim() : String(data.income || '');
        else if (data.family && data.family.income !== undefined) incomeVal = (typeof data.family.income === 'string') ? data.family.income.trim() : String(data.family.income || '');
        if (incomeVal) {
          const iEl = document.querySelector('input[name="familyIncome"][value="' + incomeVal + '"]');
          if (iEl) iEl.checked = true;
        }
      } catch(e) {}

      // prefer explicit 'ips' key if present (legacy keys: indigenous_member, indigenous)
      let indMember = '';
      try {
        if (data.ips !== undefined) {
          // data.ips is stored as 'Yes'/'No' (string) or boolean in some legacy cases
          if (typeof data.ips === 'string') {
            const v = data.ips.trim().toLowerCase();
            indMember = (v === 'yes') ? 'yes' : (v === 'no' ? 'no' : '');
          } else if (typeof data.ips === 'boolean') {
            indMember = data.ips ? 'yes' : 'no';
          }
        } else {
          indMember = (data.indigenous_member !== undefined) ? (data.indigenous_member ? 'yes' : 'no') : ((data.indigenous || (data.family && data.family.indigenous)) ? 'yes' : '');
        }
      } catch(e) { indMember = '' }
      if (indMember) {
        const el = document.querySelector('input[name="indigenous_member"][value="' + indMember + '"]'); if (el) el.checked = true;
      }
      try { document.getElementById('field_indigenous_group').value = data.indigenous_group || (data.family && data.family.indigenous_group) || ''; } catch(e){}

      // PWD: prefer data.pwd if present (stored as string 'Yes'/'No' or boolean)
      try {
        let pwdVal = '';
        if (data.pwd !== undefined) {
          if (typeof data.pwd === 'string') {
            const v = data.pwd.trim().toLowerCase(); pwdVal = (v === 'yes' ? 'Yes' : (v === 'no' ? 'No' : ''));
          } else if (typeof data.pwd === 'boolean') pwdVal = data.pwd ? 'Yes' : 'No';
        } else if (data.family && data.family.pwd !== undefined) {
          const fp = data.family.pwd;
          if (typeof fp === 'string') { const v = fp.trim().toLowerCase(); pwdVal = (v === 'yes' ? 'Yes' : (v === 'no' ? 'No' : '')); }
          else pwdVal = (typeof fp === 'boolean') ? (fp ? 'Yes' : 'No') : '';
        }
        if (pwdVal) {
          const pEl = document.querySelector('input[name="field_pwd"][value="' + pwdVal + '"]'); if (pEl) pEl.checked = true;
        }
      } catch(e) {}

      // Generic radio mapping: try to populate common radio groups from the loaded data
      try {
        const radioMap = {
          'familyIncome': ['income', 'family.income'],
          'field_pwd': ['pwd', 'family.pwd'],
          'indigenous_member': ['ips', 'indigenous_member', 'indigenous', 'family.indigenous', 'family.ips'],
          'field_scholarship': ['scholarship', 'other.scholarship'],
          'field_has_work_exp': ['has_work_exp', 'field_has_work_exp', 'work_experience', 'family.work_experience'],
          'med_therapy': ['medical_therapy', 'med_therapy']
        };

        Object.keys(radioMap).forEach(rname => {
          try {
            // find first available value from candidates
            let val = '';
            for (const cand of radioMap[rname]) {
              if (!cand) continue;
              const parts = cand.split('.');
              let v = data;
              for (const p of parts) {
                if (v === undefined || v === null) { v = undefined; break; }
                v = v[p];
              }
              if (v !== undefined && v !== null && v !== '') { val = v; break; }
            }
            if (val === undefined || val === null || val === '') return;
            if (typeof val === 'boolean') val = val ? 'yes' : 'no';
            val = String(val).trim();

            // try exact match, case-insensitive match by value attribute
            const exact = document.querySelector('input[name="' + rname + '"][value="' + val + '"]');
            if (exact) { exact.checked = true; return; }
            const lower = document.querySelector('input[name="' + rname + '"][value="' + val.toLowerCase() + '"]');
            if (lower) { lower.checked = true; return; }
            const upperFirst = document.querySelector('input[name="' + rname + '"][value="' + (val.charAt(0).toUpperCase() + val.slice(1)) + '"]');
            if (upperFirst) { upperFirst.checked = true; return; }
          } catch(e){}
        });
      } catch(e) {}

        // Ensure medical therapy radios and details populate explicitly from DB keys
        try {
          const medVal = resolve(data, ['medical_therapy', 'medicalTherapy']);
          const yesEl = document.getElementById('med_therapy_yes');
          const noEl = document.getElementById('med_therapy_no');
          if (medVal !== undefined && medVal !== null && String(medVal).trim() !== '') {
            const n = String(medVal).trim().toLowerCase();
            if (yesEl) yesEl.checked = (n === 'yes' || n === 'y');
            if (noEl) noEl.checked = (n === 'no' || n === 'n');
          }
          const detailsVal = resolve(data, ['medical_therapy_details', 'medicalTherapyDetails', 'med_therapy_details']);
          const detailsEl = document.getElementById('med_therapy_details');
          if (detailsEl) {
            detailsEl.value = detailsVal || '';
            try { detailsEl._lastValue = detailsEl.value || ''; } catch(e){}
          }
        } catch(e) { /* ignore populate errors */ }

      // Living arrangement and landlord
      const living = data.living_arrangement || (data.family && data.family.living_arrangement) || '';
      if (living) { const el = document.querySelector('input[name="living_arrangement"][value="' + living + '"]'); if (el) el.checked = true; }
      try { document.getElementById('field_landlord_name').value = data.landlord_name || (data.family && data.family.landlord_name) || ''; } catch(e){}
      try { document.getElementById('field_landlord_contact').value = data.landlord_contact || (data.family && data.family.landlord_contact) || ''; } catch(e){}

  // Family (structured)
  const family = data.family || {};
  // fallback to flat fields if family object not present
  setChecked('family_structure_nuclear', (family.structure === 'nuclear') || (data.structure_of_family === 'Nuclear') || false);
  setChecked('family_structure_extended', (family.structure === 'extended') || (data.structure_of_family === 'Extended') || false);

      try {
        const fName = family.father_name || family.father || data.father || data.father_name || data.fatherName || '';
        const fAge = family.father_age || data.father_age || data.fatherAge || '';
        const fOcc = family.father_occupation || data.father_occupation || data.fatherOccupation || '';
  const fContact = family.fatherMobile || family.father_contact || data.fatherMobile || data.father_contact || '';
        const fAddrPerm = !!(family.father_addr_same_perm || data.father_addr_same_perm);
        const fAddrPres = !!(family.father_addr_same_present || data.father_addr_same_present);
        const fNameEl = document.getElementById('field_father_name'); if (fNameEl) fNameEl.value = fName;
        const fAgeEl = document.getElementById('field_father_age'); if (fAgeEl) fAgeEl.value = fAge;
        const fOccEl = document.getElementById('field_father_occupation'); if (fOccEl) fOccEl.value = fOcc;
        const fContactEl = document.getElementById('field_father_contact'); if (fContactEl) fContactEl.value = fContact;
        const fAddrPermEl = document.getElementById('father_addr_same_perm'); if (fAddrPermEl) fAddrPermEl.checked = fAddrPerm;
        const fAddrPresEl = document.getElementById('father_addr_same_present'); if (fAddrPresEl) fAddrPresEl.checked = fAddrPres;
      } catch(e){}

      try {
        const mName = family.mother_name || family.mother || data.mother || data.mother_name || data.motherName || '';
        const mAge = family.mother_age || data.mother_age || data.motherAge || '';
        const mOcc = family.mother_occupation || data.mother_occupation || data.motherOccupation || '';
  const mContact = family.motherMobile || family.mother_contact || data.motherMobile || data.mother_contact || '';
        const mAddrPerm = !!(family.mother_addr_same_perm || data.mother_addr_same_perm);
        const mAddrPres = !!(family.mother_addr_same_present || data.mother_addr_same_present);
        const mNameEl = document.getElementById('field_mother_name'); if (mNameEl) mNameEl.value = mName;
        const mAgeEl = document.getElementById('field_mother_age'); if (mAgeEl) mAgeEl.value = mAge;
        const mOccEl = document.getElementById('field_mother_occupation'); if (mOccEl) mOccEl.value = mOcc;
        const mContactEl = document.getElementById('field_mother_contact'); if (mContactEl) mContactEl.value = mContact;
        const mAddrPermEl = document.getElementById('mother_addr_same_perm'); if (mAddrPermEl) mAddrPermEl.checked = mAddrPerm;
        const mAddrPresEl = document.getElementById('mother_addr_same_present'); if (mAddrPresEl) mAddrPresEl.checked = mAddrPres;
      } catch(e){}

      // Optional debug panel when loaded with ?debugProfile=1 â€” shows raw student data and resolve/find results
      try {
        if (window.location && window.location.search && window.location.search.indexOf('debugProfile=1') !== -1) {
          // remove previous if present
          const prev = document.getElementById('profileDebugPanel'); if (prev) prev.remove();
          const panel = document.createElement('div'); panel.id = 'profileDebugPanel';
          Object.assign(panel.style, { position:'fixed', right:'12px', bottom:'12px', left:'12px', maxHeight:'45vh', overflow:'auto', background:'rgba(255,255,255,0.98)', border:'1px solid #ddd', padding:'12px', zIndex:99999, fontSize:'13px', boxShadow:'0 6px 24px rgba(0,0,0,0.12)'});
          const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='8px'; title.textContent = 'DEBUG: student data snapshot and resolves (debugProfile=1)'; panel.appendChild(title);
          const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.wordBreak='break-word'; pre.style.background='#f7f7f7'; pre.style.padding='8px'; pre.style.borderRadius='6px'; pre.style.maxHeight='28vh'; pre.style.overflow='auto';
          try { pre.textContent = JSON.stringify(data, null, 2); } catch(e) { pre.textContent = String(data); }
          panel.appendChild(pre);
          const info = document.createElement('div'); info.style.marginTop='8px';
          function showFind(keys, label) {
            const f = findInObject(data, keys, 3);
            const v = resolve(data, keys);
            const row = document.createElement('div'); row.style.marginTop='6px';
            row.innerHTML = `<strong>${label}</strong>: resolved='${String(v)}'` + (f ? `; foundAt='${f.path}'; foundVal='${String(f.value)}'` : '');
            info.appendChild(row);
          }
          showFind(['father'], 'Father name');
          showFind(['father_contact','fatherMobile','father_mobile','father_phone','fatherContact'], 'Father contact');
          showFind(['father_address','father_addr','father_address_line'], 'Father address');
          showFind(['mother'], 'Mother name');
          showFind(['mother_contact','motherMobile','mother_mobile','mother_phone','motherContact'], 'Mother contact');
          showFind(['mother_address','mother_addr','mother_address_line'], 'Mother address');
          panel.appendChild(info);
          const closeBtn = document.createElement('button'); closeBtn.textContent = 'Close debug'; closeBtn.style.marginTop='8px'; closeBtn.onclick = () => panel.remove(); panel.appendChild(closeBtn);
          document.body.appendChild(panel);
          console.debug('populateProfileForm: debug panel inserted (debugProfile=1)');
        }
      } catch(e) { console.warn('populateProfileForm: debug panel failed', e); }

      document.getElementById('field_birth_order').value = family.birth_order || data.birth_order || '';
      document.getElementById('field_num_brothers').value = family.num_brothers || data.num_brothers || '';
      document.getElementById('field_num_sisters').value = family.num_sisters || data.num_sisters || '';
      document.getElementById('field_legal_guardian').value = family.legal_guardian || data.legal_guardian || '';
      document.getElementById('field_legal_guardian_relationship').value = family.legal_guardian_relationship || data.legal_guardian_relationship || '';
      document.getElementById('field_legal_guardian_contact').value = family.legal_guardian_contact || data.legal_guardian_contact || '';
      document.getElementById('field_legal_guardian_address').value = family.legal_guardian_address || data.legal_guardian_address || '';

      // Parents marital status: prefer single string (family.marital_status / parents_marital_status) and support 'Others' text
      try {
        const pStatus = family.marital_status || family.parents_marital_status || data.marital_status || data.parents_marital_status || '';
        if (pStatus) {
          const pEl = document.querySelector('input[name="parents_marital_status"][value="' + pStatus + '"]');
          if (pEl) pEl.checked = true;
          else {
            const otherRadio = document.getElementById('parents_status_others');
            const otherInput = document.getElementById('parents_status_others_text');
            if (otherRadio) otherRadio.checked = true;
            if (otherInput) otherInput.value = pStatus;
          }
        }
      } catch(e) {}
      // solo parent role and others specify (preserve existing solo-parent role field)
      try { document.getElementById('parents_solo_parent_role').value = family.parents_solo_parent_role || data.parents_solo_parent_role || ''; } catch(e){}

      // Relationship radios: mother/father
      const relMother = family.relationship_parent_mother || data.relationship_parent_mother || '';
      if (relMother) {
        const el = document.querySelector('input[name="rel_parent_mother"][value="' + relMother + '"]');
        if (el) el.checked = true;
      }
      const relFather = family.relationship_parent_father || data.relationship_parent_father || '';
      if (relFather) {
        const el2 = document.querySelector('input[name="rel_parent_father"][value="' + relFather + '"]');
        if (el2) el2.checked = true;
      }
      // Relationship with siblings/spouse/children
      const relSib = family.relationship_siblings || data.relationship_siblings || '';
      if (relSib) { const el = document.querySelector('input[name="rel_siblings"][value="' + relSib + '"]'); if (el) el.checked = true; }
      const relSpouse = family.relationship_spouse || data.relationship_spouse || '';
      if (relSpouse) { const el = document.querySelector('input[name="rel_spouse"][value="' + relSpouse + '"]'); if (el) el.checked = true; }
      const relChildren = family.relationship_children || data.relationship_children || '';
      if (relChildren) { const el = document.querySelector('input[name="rel_children"][value="' + relChildren + '"]'); if (el) el.checked = true; }

      // siblings (use setValue helper to avoid throwing when elements are missing)
      setValue('sibling_0_name', (family.siblings && family.siblings[0] && family.siblings[0].name) || data.sibling_0_name || '');
      setValue('sibling_0_course', (family.siblings && family.siblings[0] && family.siblings[0].course) || data.sibling_0_course || '');
      setValue('sibling_0_contact', (family.siblings && family.siblings[0] && family.siblings[0].contact) || data.sibling_0_contact || '');
      setValue('sibling_1_name', (family.siblings && family.siblings[1] && family.siblings[1].name) || data.sibling_1_name || '');
      setValue('sibling_1_course', (family.siblings && family.siblings[1] && family.siblings[1].course) || data.sibling_1_course || '');
      setValue('sibling_1_contact', (family.siblings && family.siblings[1] && family.siblings[1].contact) || data.sibling_1_contact || '');
      setValue('sibling_2_name', (family.siblings && family.siblings[2] && family.siblings[2].name) || data.sibling_2_name || '');
      setValue('sibling_2_course', (family.siblings && family.siblings[2] && family.siblings[2].course) || data.sibling_2_course || '');
      setValue('sibling_2_contact', (family.siblings && family.siblings[2] && family.siblings[2].contact) || data.sibling_2_contact || '');

      setValue('field_household_count', family.household_count || data.household_count || '');
      setValue('field_head_of_household', family.head_of_household || data.head_of_household || '');

      // Education (structured)
      const edu = data.education || data.educational_background || {};
      // support both array/object formats
      function setEdu(level, obj) {
        setValue('edu_' + level + '_school', obj && obj.school || '');
        setValue('edu_' + level + '_degree', obj && obj.degree || '');
        setValue('edu_' + level + '_grad', obj && obj.yearGraduation || '');
        setValue('edu_' + level + '_from', obj && obj.from || '');
        setValue('edu_' + level + '_to', obj && obj.to || '');
        setValue('edu_' + level + '_honors', obj && obj.honors || '');
      }
      if (Array.isArray(edu)) {
        const map = {};
        edu.forEach(e => { if (e.level) map[e.level] = e; });
        setEdu('elementary', map.elementary || map.Elementary || {});
        setEdu('junior', map['Junior High'] || map['junior_high'] || map.junior || {});
        setEdu('senior', map['Senior High'] || map.senior || {});
        setEdu('vocational', map.vocational || {});
        setEdu('college', map.college || {});
      } else {
        // object or fallback
        setEdu('elementary', edu.elementary || edu.Elementary || edu['Elementary'] || {});
        setEdu('junior', edu.junior || edu['Junior High'] || {});
        setEdu('senior', edu.senior || edu['Senior High'] || {});
        setEdu('vocational', edu.vocational || {});
        setEdu('college', edu.college || {});
      }

      // Employment (structured)
      const emp = data.employment || [];
      // employment yes/no radios
      if (data.has_work_experience === true || (Array.isArray(emp) && emp.length>0) || data.has_work_experience === 'yes') {
        document.getElementById('field_has_work_exp_yes').checked = true;
      } else if (data.has_work_experience === false || data.has_work_experience === 'no') {
        document.getElementById('field_has_work_exp_no').checked = true;
      }
      function setEmpRow(i, obj) {
        setValue('emp_' + i + '_position', obj && obj.position || '');
        setValue('emp_' + i + '_agency', obj && obj.agency || '');
        setValue('emp_' + i + '_status', obj && obj.status || '');
        setValue('emp_' + i + '_from', obj && obj.from || '');
        setValue('emp_' + i + '_to', obj && obj.to || '');
      }
      if (Array.isArray(emp)) {
        setEmpRow(0, emp[0] || {});
        setEmpRow(1, emp[1] || {});
        setEmpRow(2, emp[2] || {});
      } else {
        setEmpRow(0, emp[0] || {});
        setEmpRow(1, emp[1] || {});
        setEmpRow(2, emp[2] || {});
      }

      // Other Relevant Information (robust handling)
      try {
        // scholarship: try multiple possible keys/variants
        const schVal = resolve(data, ['scholarship','has_scholarship','scholarshipGrant','other.scholarship','other_scholarship']);
        let scholarship = schVal;
        if ((scholarship === '' || scholarship === null || scholarship === undefined) && data && data.other && typeof data.other === 'object' && (data.other.scholarship !== undefined)) scholarship = data.other.scholarship;
        const schYesEl = document.getElementById('field_scholarship_yes');
        const schNoEl = document.getElementById('field_scholarship_no');
        if (schYesEl) schYesEl.checked = (/^y/i).test(String(scholarship));
        if (schNoEl) schNoEl.checked = (/^n/i).test(String(scholarship));
        const sponsorEl = document.getElementById('field_scholarship_sponsor');
        if (sponsorEl) sponsorEl.value = resolve(data, ['scholarship_sponsor','scholarshipSponsor','other.scholarship_sponsor']) || '';
      } catch(e){ console.warn('scholarship populate failed', e); }

      // Interests: support multiple shapes (data.interests object, data.other object, or top-level interest_ keys)
      try {
        const interestsObj = data.interests || (data.other && data.other.interests) || (data.other) || {};
        ['performing','creative','literary','others'].forEach(iKey => {
          const id = 'field_interest_' + iKey;
          const el = document.getElementById(id);
          if (!el) return;
          // prefer explicit nested object keys, then various top-level variants
          const candidates = [
            (interestsObj && (interestsObj[iKey] !== undefined ? interestsObj[iKey] : interestsObj[iKey.charAt(0).toUpperCase()+iKey.slice(1)])),
            data['interest_' + iKey],
            data['interests_' + iKey],
            data['interest' + iKey.charAt(0).toUpperCase()+iKey.slice(1)],
            data[iKey],
            data['other_' + iKey]
          ];
          const found = candidates.find(v => v !== undefined && v !== null && String(v).trim() !== '');
          el.value = found || '';
        });
      } catch(e){ console.warn('interests populate failed', e); }

      // Signature preview (guarded: some variants of the form may omit this element)
      try {
        const sigPreview = document.getElementById('sigPreview');
        if (sigPreview) {
          sigPreview.innerHTML = '';
          if (data.signatureURL) {
            const img = document.createElement('img'); img.src = data.signatureURL; img.style.maxWidth = '180px'; img.style.border = '1px solid #ddd'; img.style.borderRadius = '6px';
            sigPreview.appendChild(img);
          } else if (data.signatureData) {
            const img = document.createElement('img'); img.src = data.signatureData; img.style.maxWidth = '180px'; img.style.border = '1px solid #ddd'; img.style.borderRadius = '6px';
            sigPreview.appendChild(img);
          }
        } else {
          console.warn('populateProfileForm: sigPreview element not found; skipping signature render');
        }
      } catch(e) { console.warn('signature populate failed', e); }
      // Best-effort populate any remaining simple fields (defined below)
  } catch(e) { console.warn('populateProfileForm partial populate failed', e); }
  try { if (typeof autoPopulateExtras === 'function') autoPopulateExtras(data); } catch(e) { console.warn('autoPopulateExtras failed', e); }
    }

    // Best-effort auto-population: map any remaining top-level keys or simple nested keys
    // to inputs whose id matches common patterns (field_<key>, <key>, <parent>_<child>)
    function autoPopulateExtras(obj) {
      if (!obj || typeof obj !== 'object') return;
      Object.keys(obj).forEach(k => {
        const v = obj[k];
        // skip large nested objects we've already handled above
        if (k === 'family' || k === 'education' || k === 'employment' || k === 'assessments' || k === 'profiling' || k === 'other') return;
        // try direct matches
        const tryIds = [ 'field_' + k, k, k.replace(/\./g,'_') ];
        for (const id of tryIds) {
          const el = document.getElementById(id);
          if (!el) continue;
          try {
            if (el.type === 'checkbox') { el.checked = !!v; }
            else if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.value = (v===null||v===undefined)?'':v; }
            else { el.textContent = String(v); }
            return; // populated this key
          } catch (e) { /* ignore */ }
        }
        // If value is object, try nested ids like field_<k>_<sub>
        if (v && typeof v === 'object' && !Array.isArray(v)) {
          Object.keys(v).forEach(sub => {
            const id = 'field_' + k + '_' + sub;
            const el2 = document.getElementById(id) || document.getElementById(sub);
            if (el2) {
              try { el2.value = v[sub] || ''; } catch(e){}
            }
          });
        }
      });
    }

  // autoPopulateExtras will be called by populateProfileForm when data is available

    // Wait for auth and student data to be available
    // Use a small interval to wait until current studentKey/data are set by the main watchAuth block above
    (function waitForStudentLoad(){
      let tries = 0;
      const iv = setInterval(async () => {
        tries++;
        if (window.firebase && (typeof db !== 'undefined')) {
          // try to find current logged-in user's record (if not already set)
          try {
            const user = (auth && auth.currentUser) ? auth.currentUser : (firebase && firebase.auth().currentUser ? firebase.auth().currentUser : null);
            if (user && !currentStudentKey) {
              const snapshot = await db.ref('students').orderByChild('uid').equalTo(user.uid).once('value');
              if (snapshot.exists()) {
                const key = Object.keys(snapshot.val())[0];
                const data = Object.values(snapshot.val())[0];
                populateProfileForm(data, key);
                clearInterval(iv);
                return;
              }
            }
            if (currentStudentKey) { clearInterval(iv); }
          } catch (err) {
            console.warn('Waiting for student record...', err.message);
          }
        }
        if (tries > 30) clearInterval(iv);
      }, 500);
    })();

  // Consolidated save logic used by global save button and per-section saves
  // Debug UI removed
  async function performProfileSave() {
    if (!currentStudentKey) throw new Error('Student record not loaded yet.');
    // gather simple fields (defensive: use getElementById checks)
    const get = id => (document.getElementById(id) ? document.getElementById(id).value : '');
    // determine semester value from the two checkboxes
    let semVal = '';
    try {
      const s1 = document.getElementById('field_admit_sem_1');
      const s2 = document.getElementById('field_admit_sem_2');
      if (s1 && s1.checked) semVal = '1st Sem';
      else if (s2 && s2.checked) semVal = '2nd Sem';
    } catch (e) { semVal = ''; }

    // determine civil_status from radio group (or the 'other' text if Others selected)
    let civilVal = '';
    try {
      const cs = document.querySelector('input[name="field_civil_status"]:checked');
      if (cs && cs.value) civilVal = cs.value;
      if (civilVal === 'Others') {
        const other = document.getElementById('field_civil_status_other'); if (other && other.value.trim()) civilVal = other.value.trim();
      }
    } catch (e) { civilVal = (document.getElementById('field_civil_status') ? document.getElementById('field_civil_status').value : ''); }

    const updates = {
      suffix: (document.getElementById('field_suffix') ? document.getElementById('field_suffix').value.trim() : ''),
      year_level: (document.getElementById('field_year_level') ? document.getElementById('field_year_level').value.trim() : ''),
      academic_admit_sem: semVal,
      admit_year_from: (document.getElementById('field_admit_year_from') ? document.getElementById('field_admit_year_from').value : ''),
      admit_year_to: (document.getElementById('field_admit_year_to') ? document.getElementById('field_admit_year_to').value : ''),
  status_of_enrollment: (document.querySelector('input[name="field_status_enrollment"]:checked') ? document.querySelector('input[name="field_status_enrollment"]:checked').value : ''),
      course: (document.getElementById('field_course') ? document.getElementById('field_course').value.trim() : ''),
      present_address: (document.getElementById('field_present_address') ? document.getElementById('field_present_address').value.trim() : ''),
      permanent_address: (document.getElementById('field_permanent_address') ? document.getElementById('field_permanent_address').value.trim() : ''),
      fb_messenger: (document.getElementById('field_fb_messenger') ? document.getElementById('field_fb_messenger').value.trim() : ''),
      dob: (document.getElementById('field_dob') ? document.getElementById('field_dob').value : ''),
      sex: (document.getElementById('field_sex') ? document.getElementById('field_sex').value : ''),
      age: (document.getElementById('field_age') ? document.getElementById('field_age').value : ''),
      place_of_birth: (document.getElementById('field_place_of_birth') ? document.getElementById('field_place_of_birth').value.trim() : ''),
  civil_status: civilVal,
      religion: (document.getElementById('field_religion') ? document.getElementById('field_religion').value.trim() : ''),
      // use 'mobile' as the database key for student's phone number
      mobile: (document.getElementById('field_contact_no') ? document.getElementById('field_contact_no').value.trim() : (document.getElementById('mobile') ? document.getElementById('mobile').value.trim() : '')),
      other_info: (document.getElementById('field_other_info') ? document.getElementById('field_other_info').value.trim() : '')
  ,
  // Student Profilling fields from Complete Profile
  caretaker: (document.getElementById('field_caretaker') ? document.getElementById('field_caretaker').value.trim() : ''),
  sensitiveOptIn: !!(document.getElementById('field_sensitive_opt_in') && document.getElementById('field_sensitive_opt_in').checked),
  sensitiveExperienced: (document.getElementById('field_sensitive_experienced') ? document.getElementById('field_sensitive_experienced').value.trim() : ''),
  sensitiveDesc: (document.getElementById('field_sensitive_desc') ? document.getElementById('field_sensitive_desc').value.trim() : ''),
  coping: (document.getElementById('field_coping') ? (document.getElementById('field_coping').value || '').split(',').map(s=>s.trim()).filter(Boolean) : []),
  helpPeople: (document.getElementById('field_help_people') ? (document.getElementById('field_help_people').value || '').split(',').map(s=>s.trim()).filter(Boolean) : [])
    };

    // Smart copy: if main "sameAddress" is checked, copy present to permanent
    try {
      const sameMain = document.getElementById('sameAddress');
      if (sameMain && sameMain.checked) updates.permanent_address = updates.present_address;
    } catch (e) {}

    // Campus and College (save normalized to lowercase)
    try {
      const campusVal = (document.getElementById('field_campus') ? document.getElementById('field_campus').value.trim() : '');
      const collegeVal = (document.getElementById('field_college') ? document.getElementById('field_college').value.trim() : '');
      updates.campus = campusVal ? campusVal.toLowerCase() : '';
      updates.college = collegeVal ? collegeVal.toLowerCase() : '';
    } catch (e) { console.warn('campus/college save failed', e); }

  // Family income: save selected label string (if any)
  try { const incChecked = document.querySelector('input[name="familyIncome"]:checked'); updates.income = incChecked ? (incChecked.value || '') : ''; } catch(e) { updates.income = ''; }

  // family object (with smart address copy for parents)
  // compute parents marital status selection (string) and legacy booleans for compatibility
  const parentsStatusVal = (document.querySelector('input[name="parents_marital_status"]:checked') ? document.querySelector('input[name="parents_marital_status"]:checked').value : '');
  const family = {};
  try {
    // structure
    const nuc = document.getElementById('family_structure_nuclear');
    const ext = document.getElementById('family_structure_extended');
    if ((nuc && nuc.checked) || (ext && ext.checked)) family.structure = (nuc && nuc.checked) ? 'nuclear' : 'extended';

    // father fields (only include if inputs exist)
    if (document.getElementById('field_father_name')) family.father = document.getElementById('field_father_name').value.trim();
    if (document.getElementById('field_father_age')) family.father_age = document.getElementById('field_father_age').value;
    if (document.getElementById('field_father_occupation')) family.father_occupation = document.getElementById('field_father_occupation').value.trim();
    if (document.getElementById('field_father_contact')) family.fatherMobile = document.getElementById('field_father_contact').value.trim();
    if (document.getElementById('father_addr_same_perm')) family.father_addr_same_perm = !!document.getElementById('father_addr_same_perm').checked;
    if (document.getElementById('father_addr_same_present')) family.father_addr_same_present = !!document.getElementById('father_addr_same_present').checked;

    // mother fields
    if (document.getElementById('field_mother_name')) family.mother = document.getElementById('field_mother_name').value.trim();
    if (document.getElementById('field_mother_age')) family.mother_age = document.getElementById('field_mother_age').value;
    if (document.getElementById('field_mother_occupation')) family.mother_occupation = document.getElementById('field_mother_occupation').value.trim();
    if (document.getElementById('field_mother_contact')) family.motherMobile = document.getElementById('field_mother_contact').value.trim();
    if (document.getElementById('mother_addr_same_perm')) family.mother_addr_same_perm = !!document.getElementById('mother_addr_same_perm').checked;
    if (document.getElementById('mother_addr_same_present')) family.mother_addr_same_present = !!document.getElementById('mother_addr_same_present').checked;

    // birth order / sibling counts / legal guardian
    if (document.getElementById('field_birth_order')) family.birth_order = document.getElementById('field_birth_order').value.trim();
    if (document.getElementById('field_num_brothers')) family.num_brothers = document.getElementById('field_num_brothers').value;
    if (document.getElementById('field_num_sisters')) family.num_sisters = document.getElementById('field_num_sisters').value;
    if (document.getElementById('field_legal_guardian')) family.legal_guardian = document.getElementById('field_legal_guardian').value.trim();
    if (document.getElementById('field_legal_guardian_relationship')) family.legal_guardian_relationship = document.getElementById('field_legal_guardian_relationship').value.trim();
    if (document.getElementById('field_legal_guardian_contact')) family.legal_guardian_contact = document.getElementById('field_legal_guardian_contact').value.trim();
    if (document.getElementById('field_legal_guardian_address')) family.legal_guardian_address = document.getElementById('field_legal_guardian_address').value.trim();

    // parents marital status: store single string (and keep legacy booleans for compatibility)
    if (parentsStatusVal) {
      family.parents_marital_status = parentsStatusVal;
      family.parents_living_together = (parentsStatusVal === 'Living Together');
      family.parents_separated = (parentsStatusVal === 'Separated');
      family.parents_deceased = (parentsStatusVal === 'One/Both Deceased');
      family.parents_solo_parent = (parentsStatusVal === 'Solo Parent');
    }
    if (document.getElementById('parents_solo_parent_role')) family.parents_solo_parent_role = document.getElementById('parents_solo_parent_role').value;
    if (document.getElementById('parents_status_others_text')) family.parents_others_specify = document.getElementById('parents_status_others_text').value.trim();

    // relationship radios
    const relPM = document.querySelector('input[name="rel_parent_mother"]:checked'); if (relPM) family.relationship_parent_mother = relPM.value;
    const relPF = document.querySelector('input[name="rel_parent_father"]:checked'); if (relPF) family.relationship_parent_father = relPF.value;
    const relS = document.querySelector('input[name="rel_siblings"]:checked'); if (relS) family.relationship_siblings = relS.value;
    const relSpouse = document.querySelector('input[name="rel_spouse"]:checked'); if (relSpouse) family.relationship_spouse = relSpouse.value;
    const relChild = document.querySelector('input[name="rel_children"]:checked'); if (relChild) family.relationship_children = relChild.value;

    // siblings array - include only rows whose inputs exist
    const sibs = [];
    for (let i=0;i<3;i++) {
      const n = document.getElementById('sibling_' + i + '_name');
      const c = document.getElementById('sibling_' + i + '_course');
      const ct = document.getElementById('sibling_' + i + '_contact');
      if (n || c || ct) {
        const sObj = {};
        if (n) sObj.name = (n.value || '').trim();
        if (c) sObj.course = (c.value || '').trim();
        if (ct) sObj.contact = (ct.value || '').trim();
        // only push if any of the inputs actually exist with values
        if (Object.keys(sObj).length) sibs.push(sObj);
      }
    }
    if (sibs.length) family.siblings = sibs;

    if (document.getElementById('field_household_count')) family.household_count = document.getElementById('field_household_count').value;
    if (document.getElementById('field_head_of_household')) family.head_of_household = document.getElementById('field_head_of_household').value.trim();
  } catch(e) { /* ignore */ }
    // Add spouse info into family
    try {
      if (document.getElementById('field_spouse_name')) family.spouse_name = document.getElementById('field_spouse_name').value.trim();
      if (document.getElementById('field_spouse_occupation')) family.spouse_occupation = document.getElementById('field_spouse_occupation').value.trim();
      if (document.getElementById('field_spouse_children')) family.spouse_children = document.getElementById('field_spouse_children').value || null;
      if (document.getElementById('field_spouse_address')) family.spouse_address = document.getElementById('field_spouse_address').value.trim();
      if (document.getElementById('field_spouse_contact')) family.spouse_contact = document.getElementById('field_spouse_contact').value.trim();
    } catch (e) {}

    // Smart copy for parents' addresses: if checked, copy from present/permanent
    try {
      const present = updates.present_address || '';
      const permanent = updates.permanent_address || '';
      if (family.father_addr_same_present) family.father_address = present;
      else if (family.father_addr_same_perm) family.father_address = permanent;
      else if (document.getElementById('field_father_address')) family.father_address = document.getElementById('field_father_address').value.trim();

      if (family.mother_addr_same_present) family.mother_address = present;
      else if (family.mother_addr_same_perm) family.mother_address = permanent;
      else if (document.getElementById('field_mother_address')) family.mother_address = document.getElementById('field_mother_address').value.trim();
    } catch (e) {}

    // Background-level fields
    // prefer to store a single-string key 'ips' = 'Yes'|'No' while keeping a boolean indigenous_member for compatibility
    try {
      const indChecked = document.querySelector('input[name="indigenous_member"]:checked');
      const indBool = indChecked ? (String(indChecked.value).toLowerCase() === 'yes') : null;
      updates.indigenous_member = indBool; // compatibility boolean
      updates.indigenous_group = (document.getElementById('field_indigenous_group') ? document.getElementById('field_indigenous_group').value.trim() : '');
      try { updates.ips = (indBool === null ? '' : (indBool ? 'Yes' : 'No')); } catch(e) { updates.ips = ''; }
    } catch(e) { updates.indigenous_member = null; updates.indigenous_group = ''; updates.ips = ''; }
  // collect PWD selection (store as 'Yes'/'No' string)
  try { const pwdChecked = document.querySelector('input[name="field_pwd"]:checked'); updates.pwd = pwdChecked ? (String(pwdChecked.value).trim() === 'Yes' ? 'Yes' : 'No') : ''; } catch(e) { updates.pwd = ''; }
    updates.living_arrangement = (document.querySelector('input[name="living_arrangement"]:checked') ? document.querySelector('input[name="living_arrangement"]:checked').value : '');
    updates.landlord_name = (document.getElementById('field_landlord_name') ? document.getElementById('field_landlord_name').value.trim() : '');
    updates.landlord_contact = (document.getElementById('field_landlord_contact') ? document.getElementById('field_landlord_contact').value.trim() : '');
    // Merge family fields into top-level updates (do not nest under 'family')
    try {
      // remove helper flags we don't want to persist
      try { delete family.father_addr_same_present; } catch(e){}
      try { delete family.father_addr_same_perm; } catch(e){}
      try { delete family.mother_addr_same_present; } catch(e){}
      try { delete family.mother_addr_same_perm; } catch(e){}
      Object.keys(family).forEach(k => { updates[k] = family[k]; });
    } catch(e) { console.warn('merge family into updates failed', e); }

    // education array (defensive: include only properties for inputs that exist)
    try {
      const educationArray = [];
      const buildLevel = (level) => {
        const schoolEl = document.getElementById('edu_' + level + '_school');
        if (!schoolEl) return null;
        const obj = { level, school: (schoolEl.value || '').trim() };
        const degreeEl = document.getElementById('edu_' + level + '_degree'); if (degreeEl) obj.degree = (degreeEl.value || '').trim();
        const gradEl = document.getElementById('edu_' + level + '_grad'); if (gradEl) obj.yearGraduation = (gradEl.value || '').trim();
        const fromEl = document.getElementById('edu_' + level + '_from'); if (fromEl) obj.from = (fromEl.value || '').trim();
        const toEl = document.getElementById('edu_' + level + '_to'); if (toEl) obj.to = (toEl.value || '').trim();
        const honorsEl = document.getElementById('edu_' + level + '_honors'); if (honorsEl) obj.honors = (honorsEl.value || '').trim();
        return obj;
      };
      ['elementary','junior','senior','vocational','college'].forEach(lvl => { const v = buildLevel(lvl); if (v) educationArray.push(v); });
      if (educationArray.length) updates.education = educationArray;
    } catch (e) { console.warn('education gather error', e); }

    // employment array (only if work-experience yes)
    try {
      const employmentArray = [];
      const hasWorkYes = (document.getElementById('field_has_work_exp_yes') && document.getElementById('field_has_work_exp_yes').checked);
      const hasWorkNo = (document.getElementById('field_has_work_exp_no') && document.getElementById('field_has_work_exp_no').checked);
      if (hasWorkYes) {
        for (let i = 0; i < 3; i++) {
          const posEl = document.getElementById('emp_' + i + '_position');
          const agencyEl = document.getElementById('emp_' + i + '_agency');
          const statusEl = document.getElementById('emp_' + i + '_status');
          const fromEl = document.getElementById('emp_' + i + '_from');
          const toEl = document.getElementById('emp_' + i + '_to');
          const empObj = {};
          if (posEl) { const v = (posEl.value || '').trim(); if (v) empObj.position = v; }
          if (agencyEl) { const v = (agencyEl.value || '').trim(); if (v) empObj.agency = v; }
          if (statusEl) { const v = (statusEl.value || '').trim(); if (v) empObj.status = v; }
          if (fromEl) { const v = (fromEl.value || '').trim(); if (v) empObj.from = v; }
          if (toEl) { const v = (toEl.value || '').trim(); if (v) empObj.to = v; }
          if (Object.keys(empObj).length) employmentArray.push(empObj);
        }
      }
      // If the user indicated No work experience, explicitly set employment to null
      // so Firebase will remove the key rather than leaving stale data.
      if (hasWorkNo) {
        updates.employment = null;
      } else {
        updates.employment = employmentArray;
      }
      // store a single key for work experience ('Yes'/'No') and keep legacy boolean for compatibility
      try { updates.has_work_exp = hasWorkYes ? 'Yes' : (hasWorkNo ? 'No' : ''); } catch(e) { updates.has_work_exp = ''; }
      try { updates.has_work_experience = (hasWorkYes ? true : (hasWorkNo ? false : null)); } catch(e) { updates.has_work_experience = null; }
    } catch (e) { console.warn('employment gather error', e); }

    // Other relevant info: scholarship and interests
    try {
      const scholarshipYes = (document.getElementById('field_scholarship_yes') && document.getElementById('field_scholarship_yes').checked);
      const scholarshipNo = (document.getElementById('field_scholarship_no') && document.getElementById('field_scholarship_no').checked);
      // store scholarship as single string 'Yes'/'No'
      try { updates.scholarship = scholarshipYes ? 'Yes' : (scholarshipNo ? 'No' : ''); } catch(e) { updates.scholarship = ''; }
      updates.scholarship_sponsor = (document.getElementById('field_scholarship_sponsor') ? document.getElementById('field_scholarship_sponsor').value.trim() : '');
      // if scholarship is no, clear sponsor
      if (scholarshipNo) updates.scholarship_sponsor = '';
      updates.interests = {
        performing: (document.getElementById('field_interest_performing') ? document.getElementById('field_interest_performing').value.trim() : ''),
        creative: (document.getElementById('field_interest_creative') ? document.getElementById('field_interest_creative').value.trim() : ''),
        literary: (document.getElementById('field_interest_literary') ? document.getElementById('field_interest_literary').value.trim() : ''),
        others: (document.getElementById('field_interest_others') ? document.getElementById('field_interest_others').value.trim() : '')
      };
      // Also write interests as child-path keys to ensure section-level updates persist
      try {
        const ip = updates.interests || {};
        if (ip.performing !== undefined) updates['interests/performing'] = ip.performing;
        if (ip.creative !== undefined) updates['interests/creative'] = ip.creative;
        if (ip.literary !== undefined) updates['interests/literary'] = ip.literary;
        if (ip.others !== undefined) updates['interests/others'] = ip.others;
        // remove the root object so we only use child-path updates to avoid overwrite surprises
        delete updates.interests;
      } catch(e) { console.warn('failed to map interests to child-path updates', e); }
    } catch (e) { console.warn('other info gather error', e); }

  // Medical history: store therapy selection as 'Yes'/'No' under 'medical_therapy' (no legacy 'med' key)
    try {
      const medYes = (document.getElementById('med_therapy_yes') && document.getElementById('med_therapy_yes').checked);
      const medNo = (document.getElementById('med_therapy_no') && document.getElementById('med_therapy_no').checked);
      try { updates.medical_therapy = medYes ? 'Yes' : (medNo ? 'No' : ''); } catch(e) { updates.medical_therapy = ''; }
      const medDetailsEl = document.getElementById('med_therapy_details');
      // If therapy not selected as Yes, clear the visible value to avoid stale display.
      // But preserve any last-typed value stored in _lastValue so global saves still capture
      // user input when the field was temporarily disabled by UI logic.
      if (!medYes && medDetailsEl) {
        try { medDetailsEl.value = ''; } catch(e){}
      }
      if (medDetailsEl) {
        let md = (medDetailsEl.value || '').trim();
        try { if ((!md || md === '') && medDetailsEl._lastValue) md = (medDetailsEl._lastValue || '').trim(); } catch(e){}
        updates.medical_therapy_details = md;
      }
    } catch (e) {}

    // Final cleanup: remove legacy per-radio boolean keys if present
    try {
      try { delete updates.field_scholarship_no; delete updates.field_scholarship_yes; } catch(e){}
      try { delete updates.med_therapy_yes; delete updates.med_therapy_no; } catch(e){}
      try { delete updates.field_has_work_exp_yes; delete updates.field_has_work_exp_no; } catch(e){}
  // PWD legacy per-radio keys
  try { delete updates.field_pwd_yes; delete updates.field_pwd_no; } catch(e){}
      // indigenous legacy per-radio keys (various possible naming patterns)
      try { delete updates.indigenous_member_yes; delete updates.indigenous_member_no; } catch(e){}
      try { delete updates.field_indigenous_member_yes; delete updates.field_indigenous_member_no; } catch(e){}
    } catch(e) {}

    // final DB update
    try {
      // If a cropped image was produced in the modal but not yet persisted, include it in the updates
      try {
        const profInput = document.getElementById('profilePhotoInput');
        if (profInput && profInput._lastCroppedData) {
          updates.photo_url = profInput._lastCroppedData;
        }
      } catch(e) { /* ignore */ }
  console.debug('performProfileSave: updating student', currentStudentKey, updates);
      // quiet: removed verbose payload debug and temporary alerts
      // sanity checks before attempting DB write
      if (typeof db === 'undefined' || db === null || typeof db.ref !== 'function') {
        console.error('Firebase Database object not available', db);
        alert('Save failed: Firebase Database not initialized. Check that firebase_config.js loaded and SDKs are included. See console for details.');
        return { success: false, error: new Error('Firebase Database not initialized') };
      }
      if (!currentStudentKey) {
        console.error('No currentStudentKey set, cannot save', currentStudentKey);
        alert('Save failed: student record not loaded yet.');
        return { success: false, error: new Error('Student record not loaded') };
      }

  await db.ref('students/' + currentStudentKey).update(updates);
  return { success: true };
    } catch (err) {
  console.error('performProfileSave failed', err, { studentKey: currentStudentKey, updates: updates, dbType: typeof db });
      // show helpful alerts for common error classes
      try {
        if (err && err.code && err.code === 'PERMISSION_DENIED') {
          alert('Save failed: permission denied by Firebase rules. Check your Realtime Database rules and auth state.');
        } else if (err && err.message) {
          alert('Save failed: ' + err.message + '\nSee console for details.');
        } else {
          alert('Save failed. See console for details.');
        }
      } catch (e) { /* ignore alert errors */ }
      return { success: false, error: err };
    }
  }

  // Collect only fields present inside a section and return an updates object
  function collectSectionUpdates(section) {
    const updates = {};
    const family = {};
    // helper to set key in updates
    const setUpdate = (k, v) => { updates[k] = v; };

    // gather simple field_ inputs into updates
    const inputs = section.querySelectorAll('input, textarea, select');
    inputs.forEach(i => {
      if (!i.id) return;
      const id = i.id;
      const val = (i.type === 'checkbox' || i.type === 'radio') ? !!i.checked : (i.value === undefined ? '' : i.value.trim());

      // mobile/contact
      if (id === 'field_contact_no' || id === 'mobile') {
        setUpdate('mobile', val || '');
        return;
      }

      // present/permanent and similar top-level fields
      if (id === 'field_present_address' || id === 'field_permanent_address' || id === 'field_fb_messenger' || id === 'field_email' || id === 'field_dob' || id === 'field_place_of_birth' || id === 'field_sex' || id === 'field_age' || id === 'field_religion' || id === 'field_course' || id === 'field_year_level' || id === 'field_suffix' || id === 'field_admit_year_from' || id === 'field_admit_year_to' || id === 'field_status_enrollment' || id === 'field_spouse_name' || id === 'field_spouse_occupation' || id === 'field_spouse_children' || id === 'field_spouse_address' || id === 'field_spouse_contact') {
        setUpdate(id.replace('field_', ''), val);
        return;
      }

      // Campus and College selects: save normalized values
      if (id === 'field_campus') {
        try { setUpdate('campus', val || ''); } catch(e) { setUpdate('campus', val || ''); }
        return;
      }
      if (id === 'field_college') {
        try { setUpdate('college', val || ''); } catch(e) { setUpdate('college', val || ''); }
        return;
      }
      // Block field in Section I
      if (id === 'field_block') {
        setUpdate('block', val || '');
        return;
      }

      // academic admit semester checkboxes
      if (id === 'field_admit_sem_1' || id === 'field_admit_sem_2') {
        // prefer 1st if checked, else 2nd if checked
        const s1 = document.getElementById('field_admit_sem_1');
        const s2 = document.getElementById('field_admit_sem_2');
        if (s1 && s1.checked) setUpdate('academic_admit_sem', '1st Sem');
        else if (s2 && s2.checked) setUpdate('academic_admit_sem', '2nd Sem');
        return;
      }

      // family fields: field_father_*, field_mother_*
      if (id === 'field_father_name') {
        setUpdate('father', val);
        return;
      }
      if (id === 'field_mother_name') {
        setUpdate('mother', val);
        return;
      }
      // map contact inputs to fatherMobile/motherMobile
      if (id === 'field_father_contact') {
        setUpdate('fatherMobile', val);
        return;
      }
      if (id === 'field_mother_contact') {
        setUpdate('motherMobile', val);
        return;
      }
      if (id.startsWith('field_father_')) {
        const k = id.replace('field_father_', 'father_');
        setUpdate(k, val);
        return;
      }
      if (id.startsWith('field_mother_')) {
        const k = id.replace('field_mother_', 'mother_');
        setUpdate(k, val);
        return;
      }

      // birth order / siblings and legal guardian fields (map into family object)
      if (id === 'field_birth_order' || id === 'field_num_brothers' || id === 'field_num_sisters' || id === 'field_legal_guardian' || id === 'field_legal_guardian_relationship' || id === 'field_legal_guardian_contact' || id === 'field_legal_guardian_address') {
        // normalize keys inside family
        const keyMap = {
          'field_birth_order': 'birth_order',
          'field_num_brothers': 'num_brothers',
          'field_num_sisters': 'num_sisters',
          'field_legal_guardian': 'legal_guardian',
          'field_legal_guardian_relationship': 'legal_guardian_relationship',
          'field_legal_guardian_contact': 'legal_guardian_contact',
          'field_legal_guardian_address': 'legal_guardian_address'
        };
        // store family-related simple fields at top-level (no nested family object)
        setUpdate(keyMap[id], val);
        return;
      }

      // father/mother address same checkboxes -> store top-level flags
      if (id === 'father_addr_same_present' || id === 'father_addr_same_perm' || id === 'mother_addr_same_present' || id === 'mother_addr_same_perm') {
        setUpdate(id, !!i.checked);
        return;
      }

      // employment rows emp_{i}_{field}
      const empMatch = id.match(/^emp_(\d+)_(.+)$/);
      if (empMatch) {
        // handled later
        return;
      }

      // scholarship and interests
      if (id === 'field_scholarship_sponsor' || id === 'field_scholarship_yes' || id === 'field_scholarship_no' || id.startsWith('field_interest_')) {
        // For scholarship radios, store a single 'scholarship' value (e.g., 'Yes' or 'No') instead
        if (id === 'field_scholarship_yes' || id === 'field_scholarship_no') {
          try {
            const sel = section.querySelector('input[name="field_scholarship"]:checked');
            const sval = sel ? (String(sel.value).trim().toLowerCase() === 'yes' ? 'Yes' : 'No') : '';
            setUpdate('scholarship', sval);
          } catch(e) { /* ignore */ }
        } else if (id === 'field_scholarship_sponsor') {
          // sponsor: keep as top-level key scholarship_sponsor
          setUpdate('scholarship_sponsor', val);
        } else if (id.startsWith('field_interest_')) {
          // Map interest inputs to child-path updates so DB.update updates only that interest field.
          // e.g., field_interest_performing -> 'interests/performing'
          try {
            const interestKey = id.replace('field_interest_', '');
            if (interestKey) setUpdate('interests/' + interestKey, val);
          } catch (e) { /* ignore */ }
        }
        return;
      }

        // Medical background text inputs: physical/psychosocial disability descriptions and PWD ID numbers, current medications
        if (id === 'field_physical_disability' || id === 'field_physical_pwd_id' || id === 'field_psychosocial_disability' || id === 'field_psychosocial_pwd_id' || id === 'field_current_medications') {
          switch(id) {
            case 'field_physical_disability': setUpdate('physical_disability', val); break;
            case 'field_physical_pwd_id': setUpdate('physical_pwd_id', val); break;
            case 'field_psychosocial_disability': setUpdate('psychosocial_disability', val); break;
            case 'field_psychosocial_pwd_id': setUpdate('psychosocial_pwd_id', val); break;
            case 'field_current_medications': setUpdate('current_medications', val); break;
          }
          return;
        }
        
      // medical therapy: store single key 'medical_therapy' ('Yes'/'No') and details separately
      if (id === 'med_therapy_yes' || id === 'med_therapy_no' || id === 'med_therapy_details') {
        if (id === 'med_therapy_yes' || id === 'med_therapy_no') {
          const sval = !!i.checked ? (String(i.value).trim().toLowerCase() === 'yes' ? 'Yes' : 'No') : '';
          setUpdate('medical_therapy', sval);
        } else {
          // prefer current value, but fall back to last-typed value stored on the element
          let detailsVal = val;
          try { if ((!detailsVal || detailsVal === '') && i._lastValue) detailsVal = (i._lastValue || '').trim(); } catch(e){}
          setUpdate('medical_therapy_details', detailsVal);
        }
        return;
      }

      // indigenous radios / group: store single key 'ips' = 'Yes'|'No' and keep boolean indigenous_member for compat
      if (i.name === 'indigenous_member' || id === 'field_indigenous_group') {
        if (i.name === 'indigenous_member') {
          const sval = !!i.checked ? (String(i.value).trim().toLowerCase() === 'yes' ? 'Yes' : 'No') : '';
          setUpdate('ips', sval);
          setUpdate('indigenous_member', (!!i.checked ? (String(i.value).trim().toLowerCase() === 'yes') : null));
        } else {
          // indigenous group text
          setUpdate('indigenous_group', val);
        }
        return;
      }

      // PWD radios: store single key 'pwd' = 'Yes'|'No'
      if (id === 'field_pwd_yes' || id === 'field_pwd_no') {
        const sval = !!i.checked ? (String(i.value).trim().toLowerCase() === 'yes' ? 'Yes' : 'No') : '';
        setUpdate('pwd', sval);
        return;
      }

      // Student Profilling fields (caretaker, sensitive consent & details, coping, help people)
      if (id === 'field_caretaker') {
        setUpdate('caretaker', val);
        return;
      }
      if (id === 'field_sensitive_opt_in') {
        // store as boolean for compatibility with performProfileSave
        setUpdate('sensitiveOptIn', !!i.checked);
        return;
      }
      if (id === 'field_sensitive_experienced') {
        setUpdate('sensitiveExperienced', val);
        return;
      }
      if (id === 'field_sensitive_desc') {
        setUpdate('sensitiveDesc', val);
        return;
      }
      if (id === 'field_coping') {
        // store as array (comma-separated) to match performProfileSave
        try { setUpdate('coping', (val || '').split(',').map(s => s.trim()).filter(Boolean)); } catch(e) { setUpdate('coping', []); }
        return;
      }
      if (id === 'field_help_people') {
        try { setUpdate('helpPeople', (val || '').split(',').map(s => s.trim()).filter(Boolean)); } catch(e) { setUpdate('helpPeople', []); }
        return;
      }

      // work experience radios: store single key 'has_work_exp' ('Yes'/'No')
      if (id === 'field_has_work_exp_yes' || id === 'field_has_work_exp_no') {
        setUpdate('has_work_exp', !!i.checked ? (String(i.value).trim().toLowerCase() === 'yes' ? 'Yes' : 'No') : '');
        return;
      }
    });

    // handle employment rows specifically (collect inputs starting with emp_)
    const empRows = {};
    section.querySelectorAll('[id^="emp_"]').forEach(i => {
      const m = i.id.match(/^emp_(\d+)_(.+)$/);
      if (!m) return;
      const idx = m[1]; const key = m[2];
      empRows[idx] = empRows[idx] || {};
      empRows[idx][key] = (i.value === undefined ? '' : i.value.trim());
    });
    const employmentArray = Object.values(empRows).filter(r => Object.values(r).some(v => v && v !== ''));
    // If there are employment rows, send them. If there are none but the user explicitly
    // selected "No" for work experience, send a null to remove any existing employment data
    // when performing a section-level update (Firebase update with null deletes the key).
    const workSelected = section.querySelector('input[name="field_has_work_exp"]:checked') || document.querySelector('input[name="field_has_work_exp"]:checked');
    if (employmentArray.length) {
      updates.employment = employmentArray;
    } else if (workSelected && String(workSelected.value).trim().toLowerCase() === 'no') {
      // explicit No: clear employment on the server
      updates.employment = null;
    }

    // Collect siblings, household_count and head_of_household from this section (or fallback to globals)
    try {
      const sibs = [];
      for (let i = 0; i < 3; i++) {
        const nameEl = section.querySelector('#sibling_' + i + '_name') || document.getElementById('sibling_' + i + '_name');
        const courseEl = section.querySelector('#sibling_' + i + '_course') || document.getElementById('sibling_' + i + '_course');
        const contactEl = section.querySelector('#sibling_' + i + '_contact') || document.getElementById('sibling_' + i + '_contact');
        const name = nameEl ? (nameEl.value || '').trim() : '';
        const course = courseEl ? (courseEl.value || '').trim() : '';
        const contact = contactEl ? (contactEl.value || '').trim() : '';
        if (name || course || contact) sibs.push({ name, course, contact });
      }
      if (sibs.length) {
        updates.siblings = sibs;
        // Also write into nested family path for populateProfileForm compatibility
        try { updates['family/siblings'] = sibs; } catch(e) { /* ignore */ }
      }
      // Also collect spouse fields if present inside this section (store as top-level keys for compatibility)
      try {
        const sName = section.querySelector('#field_spouse_name') || document.getElementById('field_spouse_name');
        const sOcc = section.querySelector('#field_spouse_occupation') || document.getElementById('field_spouse_occupation');
        const sChildren = section.querySelector('#field_spouse_children') || document.getElementById('field_spouse_children');
        const sAddr = section.querySelector('#field_spouse_address') || document.getElementById('field_spouse_address');
        const sContact = section.querySelector('#field_spouse_contact') || document.getElementById('field_spouse_contact');
        if (sName && sName.value) updates.spouse_name = (sName.value || '').trim();
        if (sOcc && sOcc.value) updates.spouse_occupation = (sOcc.value || '').trim();
        if (sChildren && (sChildren.value !== undefined)) updates.spouse_children = (sChildren.value === '' ? null : sChildren.value);
        if (sAddr && sAddr.value) updates.spouse_address = (sAddr.value || '').trim();
        if (sContact && sContact.value) updates.spouse_contact = (sContact.value || '').trim();
      } catch(e) { /* ignore */ }
    } catch (e) { /* ignore */ }

    // household_count and head_of_household
    try {
      const hhEl = section.querySelector('#field_household_count') || document.getElementById('field_household_count');
      const hohEl = section.querySelector('#field_head_of_household') || document.getElementById('field_head_of_household');
      if (hhEl) updates.household_count = (hhEl.value === undefined ? null : hhEl.value);
      if (hohEl) updates.head_of_household = (hohEl.value || '').trim();
      // family income (radio group) - store selected label string
      try {
        const inc = section.querySelector('input[name="familyIncome"]:checked') || document.querySelector('input[name="familyIncome"]:checked');
        updates.income = inc ? (inc.value || '') : '';
      } catch(e) { /* ignore */ }
      // living arrangement and landlord details
      try {
        const liv = section.querySelector('input[name="living_arrangement"]:checked') || document.querySelector('input[name="living_arrangement"]:checked');
        updates.living_arrangement = liv ? (liv.value || '') : '';
        const ln = section.querySelector('#field_landlord_name') || document.getElementById('field_landlord_name');
        const lc = section.querySelector('#field_landlord_contact') || document.getElementById('field_landlord_contact');
        updates.landlord_name = ln && ln.value ? ln.value.trim() : (updates.landlord_name || '');
        updates.landlord_contact = lc && lc.value ? lc.value.trim() : (updates.landlord_contact || '');
      } catch(e) { /* ignore */ }
    } catch (e) { /* ignore */ }

    // Education: gather edu_* fields if present inside the section or globally
    try {
      const educationArray = [];
      const pushEdu = (level) => {
        const schoolEl = section.querySelector('#edu_' + level + '_school') || document.getElementById('edu_' + level + '_school');
        if (!schoolEl) return;
        const obj = { level, school: (schoolEl.value || '').trim() };
        const degreeEl = section.querySelector('#edu_' + level + '_degree') || document.getElementById('edu_' + level + '_degree'); if (degreeEl) obj.degree = (degreeEl.value || '').trim();
        const gradEl = section.querySelector('#edu_' + level + '_grad') || document.getElementById('edu_' + level + '_grad'); if (gradEl) obj.yearGraduation = (gradEl.value || '').trim();
        const fromEl = section.querySelector('#edu_' + level + '_from') || document.getElementById('edu_' + level + '_from'); if (fromEl) obj.from = (fromEl.value || '').trim();
        const toEl = section.querySelector('#edu_' + level + '_to') || document.getElementById('edu_' + level + '_to'); if (toEl) obj.to = (toEl.value || '').trim();
        const honorsEl = section.querySelector('#edu_' + level + '_honors') || document.getElementById('edu_' + level + '_honors'); if (honorsEl) obj.honors = (honorsEl.value || '').trim();
        educationArray.push(obj);
      };
      ['elementary','junior','senior','vocational','college'].forEach(pushEdu);
      if (educationArray.length) updates.education = educationArray;
    } catch (e) { /* ignore */ }

    // Medical therapy: prefer radio inside section, fall back to global radios; set 'medical_therapy'
    try {
      // Prefer radios inside the section; fall back to global checked radio
      const chosen = section.querySelector('input[name="med_therapy"]:checked') || document.querySelector('input[name="med_therapy"]:checked');
      if (chosen && chosen.value !== undefined) {
        const normal = (String(chosen.value).trim().toLowerCase() === 'yes') ? 'Yes' : 'No';
        updates.medical_therapy = normal;
      } else if (typeof updates.medical_therapy === 'undefined' || updates.medical_therapy === '') {
        const gYes = document.getElementById('med_therapy_yes');
        const gNo = document.getElementById('med_therapy_no');
        if (gYes && gYes.checked) { updates.medical_therapy = 'Yes'; }
        else if (gNo && gNo.checked) { updates.medical_therapy = 'No'; }
      }

      // Details: include only if therapy is Yes. Do not clobber an earlier-collected value unless
      // the selected therapy value is explicitly 'No'. This avoids overwriting the details when
      // the details were already collected from inputs in this section.
      const detailsEl = document.getElementById('med_therapy_details');
      if (detailsEl) {
  const medVal = (updates.medical_therapy || '').toString().toLowerCase();
        if (medVal === 'yes') {
          updates.medical_therapy_details = detailsEl.value.trim();
        } else {
          // only set to empty string if no details were already captured earlier
          if (typeof updates.medical_therapy_details === 'undefined') updates.medical_therapy_details = '';
        }
      }
    } catch (e) { /* ignore */ }

  // Note: family fields are saved as top-level keys (parent names use `father`/`mother`) so we do not nest them under updates.family

    // status_of_enrollment: handle radio group named field_status_enrollment inside the section
    try {
      const statusChecked = section.querySelector('input[name="field_status_enrollment"]:checked');
      if (statusChecked) updates.status_of_enrollment = statusChecked.value;
    } catch (e) {}

    // parents marital status (radio) inside section - save as top-level 'marital_status'
    try {
      const pChecked = section.querySelector('input[name="parents_marital_status"]:checked');
      if (pChecked) {
        if (pChecked.value === 'Others') {
          const other = section.querySelector('#parents_status_others_text') || document.getElementById('parents_status_others_text');
          setUpdate('marital_status', (other && other.value && other.value.trim()) ? other.value.trim() : 'Others');
        } else setUpdate('marital_status', pChecked.value);
      }
    } catch (e) {}

    // relationship radios inside section - save as top-level relationship_* keys
    try {
      const relM = section.querySelector('input[name="rel_parent_mother"]:checked');
      if (relM) setUpdate('relationship_parent_mother', relM.value);
      const relF = section.querySelector('input[name="rel_parent_father"]:checked');
      if (relF) setUpdate('relationship_parent_father', relF.value);
      const relSib = section.querySelector('input[name="rel_siblings"]:checked');
      if (relSib) setUpdate('relationship_siblings', relSib.value);
      const relSp = section.querySelector('input[name="rel_spouse"]:checked');
      if (relSp) setUpdate('relationship_spouse', relSp.value);
      const relCh = section.querySelector('input[name="rel_children"]:checked');
      if (relCh) setUpdate('relationship_children', relCh.value);
    } catch (e) {}

      // civil_status: handle radio group named field_civil_status inside the section
      try {
        const civChecked = section.querySelector('input[name="field_civil_status"]:checked');
        if (civChecked) {
          if (civChecked.value === 'Others') {
            const other = section.querySelector('#field_civil_status_other') || document.getElementById('field_civil_status_other');
            updates.civil_status = (other && other.value && other.value.trim()) ? other.value.trim() : 'Others';
          } else {
            updates.civil_status = civChecked.value;
          }
        }
      } catch (e) {}

    // status_of_enrollment: handle radio group named field_status_enrollment inside the section
    try {
      const statusChecked = section.querySelector('input[name="field_status_enrollment"]:checked');
      if (statusChecked) updates.status_of_enrollment = statusChecked.value;
    } catch (e) {}

    // Ensure common Yes/No radio groups produce explicit 'Yes'/'No' values even if radios live outside the section
    try {
      // scholarship
      if (typeof updates.scholarship === 'undefined' || updates.scholarship === '') {
        const s = section.querySelector('input[name="field_scholarship"]:checked') || document.querySelector('input[name="field_scholarship"]:checked');
        if (s) updates.scholarship = (String(s.value).trim().toLowerCase() === 'yes') ? 'Yes' : 'No';
      }

      // PWD
      if (typeof updates.pwd === 'undefined' || updates.pwd === '') {
        const p = section.querySelector('input[name="field_pwd"]:checked') || document.querySelector('input[name="field_pwd"]:checked');
        if (p) updates.pwd = (String(p.value).trim().toLowerCase() === 'yes') ? 'Yes' : 'No';
      }

      // Work experience
      if (typeof updates.has_work_exp === 'undefined' || updates.has_work_exp === '') {
        const w = section.querySelector('input[name="field_has_work_exp"]:checked') || document.querySelector('input[name="field_has_work_exp"]:checked');
        if (w) updates.has_work_exp = (String(w.value).trim().toLowerCase() === 'yes') ? 'Yes' : 'No';
      }

      // Medical therapy (descriptive 'medical_therapy' only)
      if (typeof updates.medical_therapy === 'undefined' || updates.medical_therapy === '') {
        const m = section.querySelector('input[name="med_therapy"]:checked') || document.querySelector('input[name="med_therapy"]:checked') || document.getElementById('med_therapy_yes') || document.getElementById('med_therapy_no');
        if (m) {
          const val = (m.value !== undefined ? String(m.value).trim().toLowerCase() : (m.id && m.id.indexOf('_yes')>-1 ? 'yes' : 'no'));
          const out = (val === 'yes') ? 'Yes' : 'No';
          updates.medical_therapy = out;
        }
      }

      // Indigenous / IPS
      if (typeof updates.ips === 'undefined' || updates.ips === '') {
        const im = section.querySelector('input[name="indigenous_member"]:checked') || document.querySelector('input[name="indigenous_member"]:checked');
        if (im) {
          const ib = (String(im.value).trim().toLowerCase() === 'yes');
          updates.ips = ib ? 'Yes' : 'No';
          updates.indigenous_member = ib;
        }
      }
    } catch (e) { /* ignore */ }

    return updates;
  }

  // Save only the inputs inside a section (smart copy applied)
  async function saveSection(section) {
    if (!currentStudentKey) return { success: false, error: new Error('Student record not loaded yet.') };
    // collect fields only inside this section
    const updates = collectSectionUpdates(section);

    // Smart copy: if sameAddress checkbox exists in page-level, apply
    try {
      const sameMain = document.getElementById('sameAddress');
      if (sameMain && sameMain.checked && updates.present_address) updates.permanent_address = updates.present_address;
    } catch (e) {}

    // Parents address copy: honor top-level flags (father_addr_same_*/mother_addr_same_*) and write top-level father_address/mother_address
    try {
      const present = (document.getElementById('field_present_address') ? document.getElementById('field_present_address').value : '') || updates.present_address || '';
      const perm = (document.getElementById('field_permanent_address') ? document.getElementById('field_permanent_address').value : '') || updates.permanent_address || '';
      if (updates['father_addr_same_present']) updates['father_address'] = present;
      else if (updates['father_addr_same_perm']) updates['father_address'] = perm;
      if (updates['mother_addr_same_present']) updates['mother_address'] = present;
      else if (updates['mother_addr_same_perm']) updates['mother_address'] = perm;
      // remove the helper flags so DB only stores the resolved addresses unless you want to keep the flags
      try { delete updates['father_addr_same_present']; } catch(e){}
      try { delete updates['father_addr_same_perm']; } catch(e){}
      try { delete updates['mother_addr_same_present']; } catch(e){}
      try { delete updates['mother_addr_same_perm']; } catch(e){}
    } catch (e) {}

    // Scholarship: ensure sponsor cleared when scholarship is 'No'
    try {
      if (updates.scholarship && String(updates.scholarship).trim().toLowerCase() === 'no') {
        updates.scholarship_sponsor = '';
      }
      // remove any legacy per-radio keys if present
      try { delete updates.field_scholarship_no; delete updates.field_scholarship_yes; } catch(e){}
      // remove legacy med/work radio keys if present
      try { delete updates.med_therapy_yes; delete updates.med_therapy_no; } catch(e){}
      try { delete updates.field_has_work_exp_yes; delete updates.field_has_work_exp_no; } catch(e){}
      // remove legacy indigenous per-radio keys if present
      try { delete updates.indigenous_member_yes; delete updates.indigenous_member_no; } catch(e){}
      try { delete updates.field_indigenous_member_yes; delete updates.field_indigenous_member_no; } catch(e){}
      // remove legacy PWD per-radio keys
      try { delete updates.field_pwd_yes; delete updates.field_pwd_no; } catch(e){}
    } catch (e) {}

    // If employmentArray present but user indicated No, clear employment
    try {
      const noWork = (document.getElementById('field_has_work_exp_no') && document.getElementById('field_has_work_exp_no').checked) || (updates.has_work_exp && String(updates.has_work_exp).trim().toLowerCase() === 'no');
      if (noWork) {
        // explicitly set to null so Firebase will remove the key on update
        updates.employment = null;
      }
    } catch (e) {}

    // Ensure medical therapy details are persisted when user selected Yes (guard against section scoping issues)
    try {
      const gYes = document.getElementById('med_therapy_yes');
      const gNo = document.getElementById('med_therapy_no');
      const gDetails = document.getElementById('med_therapy_details');
      if (gYes || gNo) {
        const medVal = (gYes && gYes.checked) ? 'Yes' : (gNo && gNo.checked) ? 'No' : '';
        if (medVal && (!updates.medical_therapy || updates.medical_therapy === '')) updates.medical_therapy = medVal;
          if (medVal && medVal === 'Yes' && gDetails && (!updates.medical_therapy_details || updates.medical_therapy_details === '')) {
            // Prefer visible value, but if it's empty (UI may have cleared it when toggling edit mode),
            // fall back to the last-typed value preserved on the element (_lastValue).
            let gVal = (gDetails.value || '').trim();
            try { if ((!gVal || gVal === '') && gDetails._lastValue) gVal = (gDetails._lastValue || '').trim(); } catch(e){}
            if (gVal) updates.medical_therapy_details = gVal;
          }
      }
    } catch (e) { /* ignore */ }

    try {
      const domDetails = document.getElementById('med_therapy_details');
      const domYes = document.getElementById('med_therapy_yes');
      const domNo = document.getElementById('med_therapy_no');
      if (domDetails) {
        if (domYes && domYes.checked) {
          let md = (domDetails.value || '').trim();
          try { if ((!md || md === '') && domDetails._lastValue) md = (domDetails._lastValue || '').trim(); } catch(e){}
          updates.medical_therapy_details = md;
        } else if (domNo && domNo.checked) {
          updates.medical_therapy_details = '';
        } else {
          if (typeof updates.medical_therapy_details === 'undefined') updates.medical_therapy_details = '';
        }
      }
    } catch (e) { /* ignore defensive med details write errors */ }

    // Final write for this section
      try {
  console.debug('saveSection: performing update for student', currentStudentKey, updates);
        // quiet: removed verbose payload debug and temporary alerts for section save
        if (typeof db === 'undefined' || db === null || typeof db.ref !== 'function') {
          console.error('Firebase Database object not available', db);
          alert('Save failed: Firebase Database not initialized. Check that firebase_config.js loaded and SDKs are included. See console for details.');
          return { success: false, error: new Error('Firebase Database not initialized') };
        }
        await db.ref('students/' + currentStudentKey).update(updates);
        return { success: true };
      } catch (err) {
        console.error('saveSection failed', err);
        
        return { success: false, error: err };
      }
  }

  // wire the global save button (if present)
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  if (saveProfileBtn) saveProfileBtn.addEventListener('click', async function() {
    try {
      const res = await performProfileSave();
      if (res.success) alert('Profile updated successfully for record: ' + (currentStudentKey || '(unknown)'));
      else alert('Failed to save profile: ' + (res.error && res.error.message ? res.error.message : 'Unknown error'));
    } catch (e) { alert('Failed to save profile: ' + e.message); }
  });

    // Signature feature removed: canvas, upload and preview handlers removed to simplify profile form.
  </script>

  <script>
    // Improved hamburger behavior (matches messages.html)
    document.addEventListener('DOMContentLoaded', function() {
      // populate topbar student id from the profile field if available
      try{
        const sidField = document.getElementById('field_student_id');
        const sidEl = document.getElementById('topbarStudentId');
        if (sidEl && sidField) sidEl.textContent = sidField.value || sidField.placeholder || '';
        // also update when value changes (if some script fills it later)
        if (sidField && sidEl) {
          sidField.addEventListener('input', ()=> sidEl.textContent = sidField.value || sidField.placeholder || '');
        }
      }catch(e){}

      var menuIcon = document.querySelector('.hamburger');
      if (menuIcon) {
        menuIcon.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          var sidebar = document.getElementById('sidebar');
          var topbar = document.getElementById('topbar');
          var mainContent = document.getElementById('content');
          function isMobile(){ return window.innerWidth <= 768; }
          if (isMobile()){
            // mobile: toggle overlay + mobile-open
            var overlay = document.querySelector('.sidebar-overlay');
            if (!overlay){ overlay = document.createElement('div'); overlay.className = 'sidebar-overlay'; document.body.appendChild(overlay); overlay.addEventListener('click', function(){ if (sidebar) sidebar.classList.remove('mobile-open'); overlay.classList.remove('active'); document.body.style.overflow = ''; }); }
            var open = false;
            if (sidebar) open = sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active', open);
            document.body.style.overflow = open ? 'hidden' : '';
          } else {
            // desktop: collapse
            var isCollapsed = false;
            if (sidebar) isCollapsed = sidebar.classList.toggle('collapsed');
            if (mainContent) { mainContent.classList.toggle('shifted', isCollapsed); mainContent.classList.toggle('shrink', isCollapsed); }
            var brand = document.querySelector('.sidebar .brand'); if (brand) brand.classList.toggle('collapsed', isCollapsed);
            if (topbar) topbar.classList.toggle('shifted', isCollapsed);
          }
        });
      }
    });

    // Notification toggle
    function toggleNotif() {
      const dropdown = document.getElementById("notifDropdown");
      const badge = document.querySelector(".notif-badge");
      dropdown.classList.toggle("active");
      if (dropdown.classList.contains("active")) { badge.classList.add("hidden"); }
    }

    // Scroll to section (used by notification items)
    function goToSection(sectionId) {
      const el = document.getElementById(sectionId);
      if (el) { el.scrollIntoView({ behavior: "smooth" }); }
      const nd = document.getElementById("notifDropdown");
      if (nd) nd.classList.remove('active');
    }

    // Smart UI behaviors: conditional enabling and address-copy helpers
    document.addEventListener('DOMContentLoaded', function() {
      // helper to enable/disable inputs in a container (skip protected)
      function setInputsEnabled(container, enabled) {
        if (!container) return;
        const inputs = container.querySelectorAll('input, textarea, select');
        inputs.forEach(i => {
          if (i.classList && i.classList.contains('protected')) return;
          // skip checkboxes that control this container
          i.disabled = !enabled;
        });
      }

      // sameAddress: copy present -> permanent when checked
      const sameAddress = document.getElementById('sameAddress');
      if (sameAddress) {
        sameAddress.addEventListener('change', function() {
          const present = document.getElementById('field_present_address');
          const perm = document.getElementById('field_permanent_address');
          if (!perm || !present) return;
          if (sameAddress.checked) {
            perm.value = present.value;
            perm.disabled = true;
          } else {
            perm.disabled = false;
          }
        });
      }

      // Parent address copy: father
      const fPresentChk = document.getElementById('father_addr_same_present');
      const fPermChk = document.getElementById('father_addr_same_perm');
      const fatherAddrEl = document.getElementById('field_father_address');
      if (fPresentChk) {
        fPresentChk.addEventListener('change', function(){
          if (!fatherAddrEl) return;
          if (fPresentChk.checked) {
            fatherAddrEl.value = (document.getElementById('field_present_address') ? document.getElementById('field_present_address').value : '');
            fatherAddrEl.disabled = true;
            if (fPermChk) fPermChk.checked = false;
          } else {
            fatherAddrEl.disabled = false;
          }
        });
      }
      if (fPermChk) {
        fPermChk.addEventListener('change', function(){
          if (!fatherAddrEl) return;
          if (fPermChk.checked) {
            fatherAddrEl.value = (document.getElementById('field_permanent_address') ? document.getElementById('field_permanent_address').value : '');
            fatherAddrEl.disabled = true;
            if (fPresentChk) fPresentChk.checked = false;
          } else {
            fatherAddrEl.disabled = false;
          }
        });
      }

      // Mother address copy
      const mPresentChk = document.getElementById('mother_addr_same_present');
      const mPermChk = document.getElementById('mother_addr_same_perm');
      const motherAddrEl = document.getElementById('field_mother_address');
      if (mPresentChk) {
        mPresentChk.addEventListener('change', function(){
          if (!motherAddrEl) return;
          if (mPresentChk.checked) {
            motherAddrEl.value = (document.getElementById('field_present_address') ? document.getElementById('field_present_address').value : '');
            motherAddrEl.disabled = true;
            if (mPermChk) mPermChk.checked = false;
          } else {
            motherAddrEl.disabled = false;
          }
        });
      }
      if (mPermChk) {
        mPermChk.addEventListener('change', function(){
          if (!motherAddrEl) return;
          if (mPermChk.checked) {
            motherAddrEl.value = (document.getElementById('field_permanent_address') ? document.getElementById('field_permanent_address').value : '');
            motherAddrEl.disabled = true;
            if (mPresentChk) mPresentChk.checked = false;
          } else {
            motherAddrEl.disabled = false;
          }
        });
      }

      // Work experience: toggle employment table inputs when yes/no changed
      const workYes = document.getElementById('field_has_work_exp_yes');
      const workNo = document.getElementById('field_has_work_exp_no');
      if (workYes || workNo) {
        function setEmploymentEnabled(enabled) {
          // find the employment section by heading text
          const sec = Array.from(document.querySelectorAll('section')).find(s => s.textContent && s.textContent.indexOf('Employment History') !== -1);
          if (!sec) return;
          const inputs = sec.querySelectorAll('input, select, textarea');
          inputs.forEach(i => {
            try {
              // never disable the work-experience toggles themselves (they live inside this section)
              if (i.name === 'field_has_work_exp' || i.id === 'field_has_work_exp_yes' || i.id === 'field_has_work_exp_no') return;
              if (i.classList && i.classList.contains('protected')) return;
              i.disabled = !enabled;
              if (!enabled && i.type !== 'checkbox') i.value = '';
            } catch(e){}
          });
        }
        if (workYes) {
          workYes.addEventListener('change', function(){ if (workYes.checked) { if (workNo) workNo.checked = false; setEmploymentEnabled(true); } else setEmploymentEnabled(false); });
          workYes.addEventListener('click', function(){ if (workYes.checked) { if (workNo) workNo.checked = false; setEmploymentEnabled(true); } else setEmploymentEnabled(false); });
        }
        if (workNo) {
          workNo.addEventListener('change', function(){ if (workNo.checked) { if (workYes) workYes.checked = false; setEmploymentEnabled(false); } else setEmploymentEnabled(true); });
          workNo.addEventListener('click', function(){ if (workNo.checked) { if (workYes) workYes.checked = false; setEmploymentEnabled(false); } else setEmploymentEnabled(true); });
        }
        // initial state: enable/disable employment inputs based on currently checked radio
        try { const selWork = document.querySelector('input[name="field_has_work_exp"]:checked'); if (selWork && selWork.value === 'yes') setEmploymentEnabled(true); else setEmploymentEnabled(false); } catch(e){}
      }

      // Medical therapy toggles
      const medYes = document.getElementById('med_therapy_yes');
      const medNo = document.getElementById('med_therapy_no');
      const medDetails = document.getElementById('med_therapy_details');
      if (medYes || medNo) {
        if (medYes) medYes.addEventListener('change', function(){ if (medYes.checked) { if (medNo) medNo.checked = false; if (medDetails) medDetails.disabled = false; } else { if (medDetails) medDetails.disabled = true; medDetails.value = ''; } });
        if (medNo) medNo.addEventListener('change', function(){ if (medNo.checked) { if (medYes) medYes.checked = false; if (medDetails) { medDetails.disabled = true; medDetails.value = ''; } } else { if (medDetails) medDetails.disabled = false; } });
        // keep a last-typed copy of the details so temporary disabling won't lose the typed text
        try { if (medDetails) medDetails.addEventListener('input', function(){ medDetails._lastValue = medDetails.value; }); } catch(e){}
      }

      // Scholarship toggles
      const schYes = document.getElementById('field_scholarship_yes');
      const schNo = document.getElementById('field_scholarship_no');
      const schSponsor = document.getElementById('field_scholarship_sponsor');
      if (schYes || schNo) {
        if (schYes) schYes.addEventListener('change', function(){ if (schYes.checked) { if (schNo) schNo.checked = false; if (schSponsor) schSponsor.disabled = false; } else { if (schSponsor) schSponsor.disabled = true; } });
        if (schNo) schNo.addEventListener('change', function(){ if (schNo.checked) { if (schYes) schYes.checked = false; if (schSponsor) { schSponsor.value = ''; schSponsor.disabled = true; } } else { if (schSponsor) schSponsor.disabled = false; } });
      }
      // Indigenous toggles: enable/disable indigenous group input
      const indYes = document.getElementById('ipYes');
      const indNo = document.getElementById('ipNo');
      const indGroup = document.getElementById('field_indigenous_group');
      if (indYes || indNo) {
        if (indYes) {
          indYes.addEventListener('change', function(){ try { if (indYes.checked) { if (indNo) indNo.checked = false; if (indGroup) indGroup.disabled = false; } else { if (indGroup) indGroup.disabled = true; } } catch(e){} });
          indYes.addEventListener('click', function(){ try { if (indYes.checked) { if (indNo) indNo.checked = false; if (indGroup) indGroup.disabled = false; } else { if (indGroup) indGroup.disabled = true; } } catch(e){} });
        }
        if (indNo) {
          indNo.addEventListener('change', function(){ try { if (indNo.checked) { if (indYes) indYes.checked = false; if (indGroup) { indGroup.value = ''; indGroup.disabled = true; } } else { if (indGroup) indGroup.disabled = false; } } catch(e){} });
          indNo.addEventListener('click', function(){ try { if (indNo.checked) { if (indYes) indYes.checked = false; if (indGroup) { indGroup.value = ''; indGroup.disabled = true; } } else { if (indGroup) indGroup.disabled = false; } } catch(e){} });
        }
        // initial state
        try { const selInd = document.querySelector('input[name="indigenous_member"]:checked'); if (indGroup && (!selInd || selInd.value !== 'yes')) indGroup.disabled = true; } catch(e){}
      }

      // PWD toggles: when No is selected, make disability details non-inputable and clear them
      const pwdYes = document.getElementById('field_pwd_yes');
      const pwdNo = document.getElementById('field_pwd_no');
      const physDis = document.getElementById('field_physical_disability');
      const physId = document.getElementById('field_physical_pwd_id');
      const psychDis = document.getElementById('field_psychosocial_disability');
      const psychId = document.getElementById('field_psychosocial_pwd_id');
      if (pwdYes || pwdNo) {
        function setPWDEnabled(enabled) {
          try {
            [physDis, physId, psychDis, psychId].forEach(el => {
              if (!el) return;
              el.disabled = !enabled;
              if (!enabled) {
                if ('value' in el) el.value = '';
              }
            });
          } catch(e){}
        }
        if (pwdYes) {
          pwdYes.addEventListener('change', function(){ try { if (pwdYes.checked) { if (pwdNo) pwdNo.checked = false; setPWDEnabled(true); } else setPWDEnabled(false); } catch(e){} });
          pwdYes.addEventListener('click', function(){ try { if (pwdYes.checked) { if (pwdNo) pwdNo.checked = false; setPWDEnabled(true); } else setPWDEnabled(false); } catch(e){} });
        }
        if (pwdNo) {
          pwdNo.addEventListener('change', function(){ try { if (pwdNo.checked) { if (pwdYes) pwdYes.checked = false; setPWDEnabled(false); } else setPWDEnabled(true); } catch(e){} });
          pwdNo.addEventListener('click', function(){ try { if (pwdNo.checked) { if (pwdYes) pwdYes.checked = false; setPWDEnabled(false); } else setPWDEnabled(true); } catch(e){} });
        }
        // initial state
        try { const selPwd = document.querySelector('input[name="field_pwd"]:checked'); if (selPwd && String(selPwd.value).toLowerCase() === 'yes') setPWDEnabled(true); else setPWDEnabled(false); } catch(e){}
      }
      // Parents marital status: toggle 'others' text input when Others selected
      const parentsStatusInput = document.getElementById('parents_status_others_text');
      const parentsStatusRadios = document.querySelectorAll('input[name="parents_marital_status"]');
      if (parentsStatusRadios && parentsStatusRadios.length) {
        parentsStatusRadios.forEach(r => r.addEventListener('change', function(){ try { const sel = document.querySelector('input[name="parents_marital_status"]:checked'); if (parentsStatusInput) { if (sel && sel.value === 'Others') parentsStatusInput.disabled = false; else { parentsStatusInput.value = ''; parentsStatusInput.disabled = true; } } } catch(e){} }));
        try { const sel0 = document.querySelector('input[name="parents_marital_status"]:checked'); if (parentsStatusInput && (!sel0 || sel0.value !== 'Others')) parentsStatusInput.disabled = true; } catch(e){}
      }
      // Civil status radio: enable/disable the 'Other' text input when Others is selected
      const civilOtherInput = document.getElementById('field_civil_status_other');
      const civilRadios = document.querySelectorAll('input[name="field_civil_status"]');
      if (civilRadios && civilRadios.length) {
        civilRadios.forEach(r => r.addEventListener('change', function(){
          try {
            const sel = document.querySelector('input[name="field_civil_status"]:checked');
            if (civilOtherInput) {
              if (sel && sel.value === 'Others') { civilOtherInput.disabled = false; }
              else { civilOtherInput.value = ''; civilOtherInput.disabled = true; }
            }
          } catch(e){}
        }));
        // initial state
        try { const sel0 = document.querySelector('input[name="field_civil_status"]:checked'); if (civilOtherInput && (!sel0 || sel0.value !== 'Others')) civilOtherInput.disabled = true; } catch(e){}
      }
    });

    // Add event listener for notifBtn
    document.addEventListener('DOMContentLoaded', function() {
      var notifBtn = document.getElementById('notifBtn');
      if (notifBtn) {
        notifBtn.addEventListener('click', toggleNotif);
      }
    });

    document.addEventListener("click", function(e){
      const dropdown = document.getElementById("notifDropdown");
      const notifBtn = document.getElementById("notifBtn");
      if (!notifBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
      }
    });

    // Navigate to different pages
    function navigateTo(page) {
      window.location.href = `${page}.html`;
    }

    // Action Card functions
    function showActionCard(contentHtml) {
      document.getElementById('actionCardContent').innerHTML = contentHtml;
      document.getElementById('actionCard').style.display = 'flex';

      // Attach save button handler after rendering
      setTimeout(() => {
        const saveBtn = document.querySelector('#actionCardContent button');
        if (saveBtn) {
          saveBtn.onclick = function() {
            saveBtn.disabled = true;
            saveBtn.textContent = "Saved!";
            setTimeout(closeActionCard, 1200);
          };
        }
      }, 50);
    }

    function closeActionCard() {
      document.getElementById('actionCard').style.display = 'none';
    }

    // Toggle section visibility
    function toggleSection(sectionId) {
      const content = document.getElementById('content-' + sectionId);
      const icon = document.getElementById('icon-' + sectionId);
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
      } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
      }
    }
  </script>
  <style>
    #content, .content, main { min-height: auto !important; }
  .content { padding-bottom: 90px !important; }
    #actionCard, .sidebar-overlay, .cropModal { display: none !important; }
  </style>
  <!-- Mobile bottom navigation: use emoji menu, same as index.html -->
  <style>
    /* Ensure bottom-nav color, emoji sizing and spacing match index.html */
    .bottom-nav { background: var(--topbar-bg) !important; }
    .bottom-nav .emoji { font-size: 1.45rem; display:inline-block; line-height:1; }
    .bottom-nav a { padding: 0.25rem 0.5rem; }
  </style>
  <div class="bottom-nav" id="bottomNav" role="navigation" aria-label="Mobile navigation">
    <a href="index.html" aria-label="Appointments" class="active"><span class="emoji" aria-hidden="true">ðŸ“…</span></a>
    <a href="history.html" aria-label="History"><span class="emoji" aria-hidden="true">ðŸ“‹</span></a>
    <a href="assessments.html" aria-label="Assessments"><span class="emoji" aria-hidden="true">ðŸ“</span></a>
    <a href="resources.html" aria-label="Resources"><span class="emoji" aria-hidden="true">ðŸ“š</span></a>
    <a href="messages.html" aria-label="Messages"><span class="emoji" aria-hidden="true">ðŸ’¬</span></a>
    <a href="settings.html" aria-label="Settings"><span class="emoji" aria-hidden="true">âš™ï¸</span></a>
  </div>
</body>

</html>

