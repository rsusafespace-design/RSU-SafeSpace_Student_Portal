<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Session</title>
  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; }
    header { background:#0f7a34; color:#fff; padding:10px; font-size:16px; }
    #jitsi-container { flex:1; }
  </style>
</head>
<body>
  <header id="sessionTitle">Loading session...</header>
  <div id="jitsi-container"></div>

  <script src='https://8x8.vc/vpaas-magic-cookie-f889d6e6488646548cf6a78618a37cc8/external_api.js'></script>
  
  <script>
    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    document.addEventListener("DOMContentLoaded", function(){
        const roomName = getQueryParam('room');
        const displayName = getQueryParam('name') || 'Guest';
        const studentName = "Student Name";
        const jitsiContainer = document.getElementById('jitsi-container');
        let api = null;

        if(!roomName) { alert('No room generated. Please try again.'); return; }
        document.getElementById('sessionTitle').textContent =
        `Session with ${displayName}`;

        const domain = "8x8.vc";
        const options = {
            roomName: roomName,
            parentNode: jitsiContainer,
            host: domain,
            userInfo: { displayName: studentName },
            configOverwrite: {
                startWithAudioMuted: false,
                startWithVideoMuted: false
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: ['microphone','camera','chat','raisehand','hangup','tileview']
            }
        };

        try {
            api = new JitsiMeetExternalAPI(domain, options);
            // When the conference is left (user hangs up or connection ends), redirect back
            // to the messages page so the student can continue the conversation and rate the session.
            api.addEventListener('videoConferenceLeft', function(){
              try{
                // preserve consult query so messages.html can open the correct conversation
                const consultParam = getQueryParam('consult') || getQueryParam('consultId') || '';
                const redirectUrl = 'messages.html' + (consultParam ? ('?consult=' + encodeURIComponent(consultParam) + '&ended=1') : '?ended=1');
                // small delay to allow jitsi to tear down cleanly
                setTimeout(()=>{ try{ window.location.href = redirectUrl; }catch(e){} }, 250);
              }catch(e){ console.warn('redirect on leave failed', e); }
            });
            // also handle readyToClose for certain embeds
            api.addEventListener('readyToClose', function(){ try{ api.executeCommand && api.executeCommand('hangup'); }catch(e){} });
        } catch (err) {
            console.error('Jitsi API error', err);
            alert('Failed to initialize Jitsi API. Check console for details.');
            api = null;
            return;
        }
    });
  </script>
</body>
</html>
