<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SafeSpace Student Portal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Global responsive utilities -->
  <link rel="stylesheet" href="responsive.css">
  <style>
    :root {
      --primary: #0f7a34;
      --primary-light: #e8f5e9;
      --primary-dark: #0a5a26;
      --topbar-bg: #1e8e3e;
      --secondary: #4361ee;
      --accent: #7209b7;
      --text: #2d3748;
      --text-light: #718096;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
      --radius: 16px;
      --radius-sm: 8px;
      --sidebar-width: 280px;
      --collapsed-width: 80px;
      --topbar-height: 70px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      color: var(--text);
    }

    body {
      background: var(--bg);
      overflow-x: hidden;
    }

    /* ===== Sidebar (admin-like style) ===== */
    .sidebar {
      position:fixed; top:0; left:0;
      width:250px; height:100%;
      background:#f0f3f6; color:#1f2937;
      padding:12px;
      border-right:1px solid rgba(0,0,0,0.06);
      display:flex; flex-direction:column;
      transition:width 0.3s ease, transform 0.3s ease;
      z-index:1200;
    }

    .sidebar .brand {
      display:flex; align-items:center; gap:0.6rem;
      margin-bottom:1rem; padding:8px 4px;
    }

    .sidebar .logo {
      width:40px; height:40px; background:transparent;
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      color:#10b981; font-weight:700; font-size:0.95rem;
      flex-shrink:0; box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }

    .sidebar .brand span { font-weight:700; font-size:1rem; color:#374151; }

    /* collapsed (narrow) sidebar */
    .sidebar.shrink { width:80px; padding:12px 8px; }
    .sidebar.shrink .brand span { display:none; }
    .sidebar.shrink a { text-align:center; font-size:1.1rem; }
    .sidebar.shrink a span { display:none; }

    /* nav items (anchors) styled similar to admin .nav-item */
    .sidebar a {
      display:flex; align-items:center; gap:12px; color:#1f2937;
      text-decoration:none; margin:8px 0; font-size:15px;
      padding:12px 10px; border-radius:8px; background:transparent;
      transition:background 0.18s ease, color 0.18s ease;
    }

  .sidebar a .fa,
  .sidebar a i { width:28px; text-align:center; font-size:18px; color:#1f2937; background:transparent; }

    .sidebar a span { color:inherit; display:inline-block; white-space:nowrap; overflow:hidden; }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(15,122,52,0.08); color:#0f7a34; font-weight:600;
    }

    /* Admin-like header & sidebar overrides (no HTML changes) */
    .header-and-sidebar-top {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      background-color: #1e8e3e;
      color: white;
      height: 60px;
      transition: left 0.3s ease;
    }

    .sidebar-top {
      width: 250px;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      box-sizing: border-box;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      height: 60px;
      transition: width 0.3s ease;
    }

    .sidebar {
      position: fixed; /* ensure sidebar spans full height and brand sits at top */
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      background: #f0f3f6;
      border-right: none; /* remove full-height border so brand can appear flush */
      z-index: 1002; /* sit above topbar so brand overlays header area */
      overflow: auto;
    }

    /* Hide the native scrollbar for the sidebar while keeping content scrollable */
    .sidebar {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }
    .sidebar::-webkit-scrollbar {
      width: 0px;
      height: 0px;
      background: transparent;
    }

    /* vertical divider only below the brand area */
    .sidebar::after {
      content: '';
      position: absolute;
      left: 249px; /* 1px inside right edge */
      top: 60px; /* start after brand/topbar */
      width: 1px;
      height: calc(100vh - 60px);
      background: rgba(0,0,0,0.06);
      z-index: 1001;
    }

    .nav-item, .sidebar a {
      color: #1f2937;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 10px;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-weight: 400;
      font-size: 15px;
      transition: background 0.2s, color 0.2s;
    }

    .nav-item:hover, .sidebar a:hover {
      background: rgba(15,122,52,0.08) !important;
      color: #0f7a34 !important;
      font-weight: 400 !important;
    }

    .nav-item.active {
      background: rgba(15,122,52,0.12) !important;
      color: #0f7a34 !important;
      font-weight: 600 !important;
    }

    /* adjust content to sit below the fixed topbar and to the right of the sidebar */
    .content { margin-top: 60px; margin-left: 250px; }
    .content.shrink { margin-left: 80px; }

    /* Logo and brand name styling to mirror admin */
    .sidebar .logo {
      background: transparent;
      width:72px; height:72px; border-radius:6px; box-shadow:none; color:transparent;
      display:flex; align-items:center; justify-content:center; overflow:hidden; padding:0; border:0;
    }
    .sidebar .logo img{
      width:auto; height:64px; max-width:100%; max-height:64px; object-fit:contain; display:block;
      background:transparent; /* in case image has transparency preserve it */
      image-rendering: -webkit-optimize-contrast;
    }

    /* keep brand/logo aligned with topbar height (60px) */
    .sidebar .brand {
      height: 60px;
      align-items: center;
      padding: 0 12px;
      background: #1e8e3e; /* match topbar background for a seamless look */
      color: white;
      gap: 12px;
    }

    .sidebar .brand span { color: white; font-weight:700; margin-left:4px; }

    /* push nav content below the brand area */
    #nav { padding-top: 12px; margin-top: 60px; }

    /* make the small top-area logo visible in header-like layout */
    .header-and-sidebar-top .sidebar-logo span { color: white; font-weight:700; font-size:1.1rem; }

    /* ===== Topbar (admin-like appearance) ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 250px; /* sit to the right of the fixed sidebar */
      right: 0;
      height: 60px;
      background-color: var(--topbar-bg);
      color: white;
      padding: 10px 30px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 1001;
      transition: left 0.3s ease, margin-left 0.3s ease;
    }
    .topbar.shrink { left: 80px; }

    .topbar-left { display:flex; align-items:center; gap:0.6rem; }
    .hamburger {
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
  .portal-title { display:flex; flex-direction:column; line-height:1.2; }
  .portal-title strong span.safespace { display:inline; margin-right:0.3rem; }
    .portal-title small { font-size:0.75rem; opacity:0.9; }

    /* Show SafeSpace text when sidebar is shrunk */
    .topbar.shrink .portal-title strong span.safespace { display: inline; }

    /* Mobile logo styling */
    .mobile-logo {
      display: none;
      width: 44px;
      height: 44px;
      background: transparent; /* remove white circular background */
      border-radius: 6px;
      align-items: center;
      justify-content: center;
      color: #00723f;
      font-weight: bold;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      padding:0;
      overflow:hidden;
    }
  .mobile-logo img{ width:auto; height:34px; object-fit:contain; display:block; background:transparent }

    /* Profile + Notifications */
    .profile { width:38px; height:38px; border-radius:50%; background:#004c27;
      display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; }
    .notif-wrapper { position:relative; cursor:pointer; font-size:1.3rem; color:white; }
    .notif-badge {
      position:absolute; bottom:0; right:0;
      width:10px; height:10px; background:red;
      border-radius:50%; border:2px solid #00723f;
    }
    .notif-badge.hidden { display:none; }

    .notif-dropdown {
      position:absolute; top:48px; right:0;
      background:white; color:#333;
      width:260px; border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      display:none; flex-direction:column;
      overflow:hidden; z-index:2000;
    }
    .notif-dropdown.active { display:flex; }
    .notif-header { background:#00723f; color:white; padding:0.6rem; font-weight:bold; }
    .notif-list { max-height:220px; overflow-y:auto; }
    .notif-item {
      padding:0.6rem 0.8rem; border-bottom:1px solid #eee;
      font-size:0.9rem; cursor:pointer;
    }
    .notif-item:hover { background:#f1f1f1; }

    /* ===== Content ===== */
    .content {
      padding:1rem;
      max-width:1200px; margin:auto;
      margin-left:250px;
      transition:margin-left 0.3s ease;
    }
    .content.shrink { margin-left:70px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(350px,1fr)); gap:1rem; }
    .card { background:white; border-radius:10px; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .card h3 { margin-bottom:0.8rem; }

    /* Hide hamburger on mobile */
    @media (max-width:768px) {
      .hamburger { display: none; }
    }

    /* ===== Mobile Bottom Nav ===== */
    @media (max-width:768px) {
      .sidebar { 
        display: none !important;
        transform: translateX(-100%);
      }
      .topbar { margin-left:0; }
      .content { margin-left:0; }
      .hamburger { display: none; }
      
      /* Show mobile logo and SafeSpace text */
      .mobile-logo { display: flex; }
      .portal-title strong span.safespace { display: inline; }
      
      .bottom-nav {
        position:fixed; bottom:0; left:0; width:100%;
        background:#004c27; display:flex; justify-content:space-around;
        padding:0.5rem 0; z-index:2000;
      }
      .bottom-nav a {
        flex:1; text-align:center; color:white; text-decoration:none; font-size:0.9rem;
        display:flex; align-items:center; justify-content:center; gap:0.25rem;
        padding:0.6rem 0; opacity:1; background:transparent; border-radius:8px;
      }
      .bottom-nav a i { font-size:22px; line-height:1; }
      .bottom-nav a.active { color:#ffc107; }
    }
    
    /* Hide bottom nav on larger screens */
    .bottom-nav { display: none; }

    @media (max-width: 768px) {
      .bottom-nav { 
        display: flex !important;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: var(--primary-dark); /* solid colored bar */
        justify-content: space-around;
        padding: 0.6rem 0; height:64px; z-index: 2000;
      }
    }

    /* ===== Misc ===== */
    .hidden {
      display: none !important;
    }

    /* --- START: NEW ADMIN SYNC STYLES --- */
    .sidebar {
        width: 250px;
        background: #f0f3f6;
        border-right: 1px solid rgba(0,0,0,0.06);
        position: fixed;
        top: 60px; /* Starts below the header */
        left: 0;
        height: calc(100vh - 60px);
        z-index: 999;
        padding: 12px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease, transform 0.3s ease;
    }
    
    .sidebar .brand {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        display: flex;
        align-items: center;
        padding: 10px 20px;
        box-sizing: border-box;
        z-index: 1002;
        border-right: 1px solid rgba(255, 255, 255, 0.3);
        transition: width 0.3s ease;
    }
    
  .sidebar .brand .logo {
    height: 40px;
    width: 40px;
    background: transparent url("safespace.png") center/contain no-repeat;
    color: transparent;
    border-radius: 8px;
  }
    
    .sidebar .brand span {
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
        white-space: nowrap;
        margin-left: 10px;
        transition: opacity 0.3s ease, width 0.3s ease;
    }
    
    .sidebar a {
        margin: 0; /* Nav links start at the top of the sidebar container */
    }
    
    .topbar {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 60px;
        background-color: #1e8e3e;
        color: white;
        padding: 10px 30px;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .content {
        margin-top: 60px;
        margin-left: 250px;
        transition: margin-left 0.3s ease;
    }
    
   /* --- Collapsed State --- */
.sidebar.collapsed {
  width: 80px;
  padding: 12px 8px;
}

.sidebar.collapsed .brand {
  width: 80px;
  justify-content: center;
}

.sidebar.collapsed .brand span {
  opacity: 0;
  pointer-events: none;
  width: 0;
}

.sidebar.collapsed a span {
  display: none;
}
.sidebar.collapsed a {
  justify-content: center;
}

/* ADD THIS NEW CODE RIGHT HERE - Keep emoji icons visible when collapsed */
.sidebar.collapsed a::before {
  content: attr(data-emoji);
  font-size: 1.3rem;
}

.sidebar a::before {
  content: attr(data-emoji);
  margin-right: 8px;
}

.sidebar.collapsed a::before {
  margin-right: 0;
}
/* END OF NEW CSS CODE */
    
    .sidebar.collapsed a span {
        display: none;
    }
    .sidebar.collapsed a {
        justify-content: center;
    }
    
    .topbar.shifted {
        left: 80px;
    }
    
    .content.shifted {
        margin-left: 80px;
    }
    
    /* --- Mobile Overlay & Sidebar --- */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 998;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .sidebar {
            top: 0; /* On mobile, the sidebar is full height */
            height: 100vh;
            width: 280px;
            transform: translateX(-100%);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1200; /* Above overlay */
        }
    
        .sidebar.mobile-open {
            transform: translateX(0);
        }
    
        /* Prevent collapsing on mobile view */
        .sidebar.collapsed {
            width: 280px;
            transform: translateX(-100%);
        }
    
        .sidebar .brand {
            width: 280px; /* Brand takes full width of mobile sidebar */
        }
    
        .sidebar .brand.collapsed {
            width: 280px;
            justify-content: flex-start;
        }
    
        .sidebar .brand.collapsed span {
            opacity: 1;
            pointer-events: auto;
            width: auto;
        }
    
        .topbar, .topbar.shifted {
            left: 0;
        }
        .content, .content.shifted {
            margin-left: 0;
        }
    }
    /* --- END: NEW ADMIN SYNC STYLES --- */

    /* Your existing index.html styles continue below */
    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      animation: slideInLeft 0.6s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-subtitle {
      color: var(--text-light);
      font-size: 16px;
      animation: slideInLeft 0.8s ease-out;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      padding: 24px;
      transition: var(--transition);
      animation: fadeIn 0.8s ease-out;
    }

    .card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-5px);
    }

    .card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h3 i {
      color: var(--primary);
    }

/* Important Updates Carousel */
.updates-card {
  padding: 20;
  overflow: hidden;
}

.swiper {
  width: 100%;
  height: 30%;
}

.swiper-slide {
  background: linear-gradient(135deg, var(--primary-light) 0%, #e6f7eb 100%);
  border-left: 5px solid var(--primary);
  border-radius: var(--radius);
  padding: 24px 60px 24px 30px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  box-sizing: border-box;
  position: relative;
  animation: slideInRight 0.8s ease-out;
}

.swiper-slide::after {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 80px; /* Reduced width */
  height: 100%;
  background: linear-gradient(90deg, transparent 0%, var(--primary-light) 100%);
  z-index: 0;
}

.swiper-slide strong {
  font-size: 16px; /* Reduced font size */
  margin-bottom: 6px; /* Reduced margin */
  color: var(--primary-dark);
  z-index: 1;
  position: relative;
}

.swiper-slide p {
  margin-bottom: 12px; /* Reduced margin */
  color: var(--text);
  z-index: 1;
  position: relative;
  font-size: 14px; /* Reduced font size */
}

.swiper-slide button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 8px 16px; /* Reduced padding */
  border-radius: var(--radius-sm);
  cursor: pointer;
  align-self: flex-start;
  font-weight: 600;
  transition: var(--transition);
  z-index: 1;
  position: relative;
  font-size: 14px; /* Reduced font size */
}

.swiper-button-prev, .swiper-button-next {
  width: 30px; /* Reduced size */
  height: 30px;
  margin-top: -15px;
}

.swiper-button-prev:after, .swiper-button-next:after {
  font-size: 12px; /* Reduced font size */
}

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .swiper-slide::after {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100%;
      background: linear-gradient(90deg, transparent 0%, var(--primary-light) 100%);
      z-index: 0;
    }

    .swiper-slide strong {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--primary-dark);
      z-index: 1;
      position: relative;
    }

    .swiper-slide p {
      margin-bottom: 16px;
      color: var(--text);
      z-index: 1;
      position: relative;
    }

    .swiper-slide button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      align-self: flex-start;
      font-weight: 600;
      transition: var(--transition);
      z-index: 1;
      position: relative;
    }

    .swiper-slide button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .swiper-button-prev, .swiper-button-next {
      color: var(--primary);
      font-weight: bold;
      width: 36px;
      height: 36px;
      margin-top: -18px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
    }

    .swiper-button-prev:hover, .swiper-button-next:hover {
      transform: scale(1.1);
    }

    .swiper-button-prev:after, .swiper-button-next:after {
      font-size: 14px;
      font-weight: bold;
    }

    .swiper-pagination-bullet {
      background: var(--primary);
    }

    /* Report and Emergency Section */
    .report-emergency-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .report-card, .emergency-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .report-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .report-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .report-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.7s;
    }

    .report-btn:hover::before {
      left: 100%;
    }

    .report-btn.report-bullying {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffd6d6;
    }

    .report-btn.report-harassment {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffd6d6;
    }

    .report-btn.report-concern {
      background: #fff3e0;
      color: #f57c00;
      border: 1px solid #ffe0b2;
    }

    .report-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .emergency-hotline {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 20px;
      border-radius: var(--radius);
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: var(--transition);
    }

    .emergency-hotline:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .emergency-hotline strong {
      color: #856404;
      display: block;
      margin-bottom: 12px;
      font-size: 18px;
    }

    .emergency-hotline .hotline-number {
      color: #856404;
      font-weight: bold;
      font-size: 20px;
      text-decoration: none;
      margin: 0 8px;
      transition: var(--transition);
    }

    .emergency-hotline .hotline-number:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
    

    /* Appointments and Calendar Section */
    .appointments-calendar-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      /* Small nudge down so this section sits a bit lower on the page */
      margin-top: 12px;
    }

    .appointments-card, .calendar-card {
      display: flex;
      flex-direction: column;
      /* Use min-height so cards are tall on desktop but can shrink on smaller screens */
      min-height: 520px;
      height: auto;
    }

    .appointments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .appointments-tabs {
      display: flex;
      gap: 4px;
      background: #f1f5f9;
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-bottom: 20px;
    }

    .tab-btn {
      background: transparent;
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      color: var(--text-light);
      transition: var(--transition);
      flex: 1;
      text-align: center;
    }

    .tab-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .appointments-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* Mobile-specific tweaks for appointments & calendar */
    @media (max-width: 768px) {
      /* set a consistent mobile card height and keep the appointments list scrollable inside its card
         without changing calendar behavior */
      :root { --mobile-calendar-height: 300px; }

      .appointments-card, .calendar-card {
        /* both cards use the same base height on small screens */
        min-height: var(--mobile-calendar-height);
        height: auto;
        display: flex;
        flex-direction: column;
      }

      .appointments-container {
        /* keep the appointments list scrollable inside its card and prevent it from expanding
           and pushing the calendar; subtract header/tab heights so the list fits the card */
        overflow-y: auto;
        padding-right: 8px;
        -webkit-overflow-scrolling: touch;
        max-height: calc(var(--mobile-calendar-height) - 120px); /* adjust 120px if header/tabs change */
      }
      .appointment { padding: 14px; }
      .appointment .appointment-header { flex-direction: column; align-items: flex-start; gap:8px; }
      .appointment .appointment-datetime { font-size: 13px; }
      .appointment-actions { display:flex; flex-direction:column; gap:8px; }
      .appointment-actions button { width:100%; }
      .start-session-wrapper { position: static; right: auto; bottom: auto; margin-top: 8px; }
      /* Make calendar shorter on narrow screens so it doesn't push content too far */
      #calendar { min-height: 300px; }
    }

    /* Appointment items */
    .appointment {
      background: #f8fafc;
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      border-left: 4px solid #ddd;
      transition: var(--transition);
      position: relative;
      animation: slideInUp 0.5s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .appointment:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .appointment.pending {
      border-left-color: #ffc107;
      background: #fff9e6;
    }

    .appointment.missed {
      border-left-color: #ff0707;
      background: #ffe6e6;
    }

    .appointment.confirmed {
      border-left-color: #28a745;
      background: #f0f9f0;
    }

    .appointment.completed {
      border-left-color: #6c757d;
      background: #f8f9fa;
    }

    .appointment.rescheduled {
      border-left-color: #17a2b8;
      background: #e8f4f8;
    }

    .appointment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .counselor-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text);
    }

    .appointment-datetime {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: var(--transition);
    }

    .status-badge:hover {
      transform: scale(1.05);
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-missed {
      background: #ffcdcd;
      color: #850404;
    }

    .status-confirmed {
      background: #d4edda;
      color: #155724;
    }

    .status-completed {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-rescheduled {
      background: #d1ecf1;
      color: #0c5460;
    }

    .appointment-mode {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .appointment-actions {
      display: flex;
      gap: 10px;
    }

    .appointment-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .appointment-actions button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.7s;
    }

    .appointment-actions button:hover::before {
      left: 100%;
    }

    .reschedule {
      background: #ffc107;
      color: #212529;
    }

    .reschedule:hover {
      background: #e0a800;
      transform: translateY(-2px);
    }

    .view-details {
      background: var(--primary);
      color: white;
    }

    .view-details:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .start-session-wrapper {
      position: absolute;
      right: 20px;
      bottom: 20px;
    }

    /* Start/Join session button: use class-based disabled state so clicks still fire
       (we avoid using the HTML disabled attribute to allow clicking when 'disabled' to show a modal) */
    .start-session-btn {
      background: #ddd;
      color: #666;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer; /* allow clicks even when visually disabled */
      font-weight: 500;
      transition: var(--transition);
    }

    .start-session-btn.start-disabled {
      background: #ddd;
      color: #666;
      cursor: not-allowed;
      opacity: 0.95;
    }

    .start-session-btn.enabled {
      background: var(--primary);
      color: white;
      cursor: pointer;
    }

    .start-session-btn.enabled:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    

    /* Calendar */
    #calendar {
      flex: 1;
      width: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      background: #f8f9fa;
    }

    .fc .fc-toolbar {
      padding: 16px 20px 0;
    }

    .fc .fc-button {
      background: var(--primary);
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      font-weight: 500;
      transition: var(--transition);
    }

    .fc .fc-button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .fc .fc-daygrid-day-number {
      font-size: 14px;
      font-weight: 500;
    }

    .fc .fc-daygrid-event {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: var(--transition);
    }

    .fc .fc-daygrid-event:hover {
      transform: scale(1.05);
    }

    .calendar-event {
      background-color: var(--primary) !important;
      border-color: var(--primary) !important;
    }

    /* Bottom Nav (mobile only) */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--topbar-bg);
      justify-content: space-around;
      padding: 0.6rem 0;
      height: 64px;
      z-index: 1000;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.18);
    }

    .bottom-nav a {
      flex: 1;
      text-align: center;
      color: white;
      text-decoration: none;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      opacity: 1;
      transition: var(--transition);
      padding: 8px 6px;
      border-radius: 8px;
    }

    .bottom-nav a.active {
      color: #fff;
      background: rgba(255,255,255,0.06);
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }

    .bottom-nav a:hover:not(.active) {
      background: rgba(255, 255, 255, 0.03);
    }

    .bottom-nav a i {
      font-size: 22px;
      line-height:1;
      transition: var(--transition);
      color: #ffffff; /* icons should be white on the green bar */
      text-shadow: 0 1px 0 rgba(0,0,0,0.15);
    }

    .bottom-nav a:hover i {
      transform: scale(1.05);
    }

    /* Emoji style for colorful bottom nav icons */
    .bottom-nav a .emoji {
      font-size: 28px; /* slightly larger emoji */
      line-height: 1;
      display: inline-block;
      transform-origin: center;
      transition: transform .18s ease;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.12));
    }
    .bottom-nav a:hover .emoji { transform: translateY(-2px) scale(1.05); }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.4s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: var(--primary);
      color: white;
      padding: 24px;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 24px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal-footer button {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .modal-footer button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.7s;
    }

    .modal-footer button:hover::before {
      left: 100%;
    }

    .modal-footer button.primary {
      background: var(--primary);
      color: white;
    }

    .modal-footer button.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .modal-footer button.secondary {
      background: #f1f5f9;
      color: var(--text);
    }

    .modal-footer button.secondary:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    /* Floating Action Button removed per request */

    /* Card Spacing Enhancement */
.grid {
  gap: 16px; /* Ensures consistent spacing in grid layouts */
}

.card {
  margin-bottom: 16px; /* Adds space below each card */
}

/* Specific spacing for card containers */
.report-emergency-grid,
.appointments-calendar-grid {
  gap: 16px; /* Ensures spacing in these specific grid layouts */
}

/* Remove extra margin from the last card in containers to prevent double spacing */
.card:last-child {
  margin-bottom: 0;
}

    /* Responsive */
    @media (max-width: 1200px) {
      .report-emergency-grid,
      .appointments-calendar-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .topbar {
        left: 0;
      }

      .content {
        margin-left: 0;
        padding: 20px;
        padding-top: calc(var(--topbar-height) + 20px);
      }

      .bottom-nav {
        display: flex;
      }

      .page-title {
        font-size: 24px;
      }

      .card {
        padding: 20px;
      }

      .swiper-slide {
        padding: 20px 50px 20px 20px;
      }

      .report-buttons {
        flex-direction: column;
      }

      .report-btn {
        justify-content: center;
      }

      /* Card Spacing Enhancement */
.grid {
  gap: 18px; /* Ensures consistent spacing in grid layouts */
}

.card {
  margin-bottom: 18px; /* Adds space below each card */
}

/* Specific spacing for card containers */
.report-emergency-grid,
.appointments-calendar-grid {
  gap: 18px; /* Ensures spacing in these specific grid layouts */
}

/* Remove extra margin from the last card in containers to prevent double spacing */
.card:last-child {
  margin-bottom: 0;
}

      .appointments-calendar-grid {
        grid-template-columns: 1fr;
      }

      .appointments-card, .calendar-card {
        height: auto;
        min-height: 500px;
      }

      /* .fab positioning removed */
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    /* Booking modal specific styles */
    .modal-content.booking-modal .field-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
      font-size: 0.95rem;
    }

    /* ===== Mobile fixes: prevent appointments card overflow and reduce size ===== */
    @media (max-width: 768px) {
      /* Ensure card containers don't force extra height or horizontal scrolling */
      .appointments-card, .calendar-card {
        min-height: auto !important;
        height: auto !important;
        padding: 8px !important;
        box-sizing: border-box;
        max-width: 100%;
        width: 100%;
      }

      /* Make individual appointment items more compact and fluid */
      .appointment {
        padding: 10px !important;
        margin-bottom: 12px !important;
        border-left-width: 3px;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
      }

      /* Ensure header/actions wrap instead of overflowing */
      .appointment .appointment-header { gap: 8px; flex-wrap:wrap; }
      .appointment .appointment-datetime { font-size: 13px; white-space:normal; }

      /* Move start button into flow so it doesn't overflow on narrow screens */
      .start-session-wrapper { position: static !important; right: auto !important; bottom: auto !important; margin-top: 8px; }

      /* Reduce padding on swiper slides and make them respect container width */
      .swiper, .swiper-slide {
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding-right: 18px !important;
        padding-left: 12px !important;
      }

      /* Ensure any absolutely positioned elements inside cards do not overflow */
      .card, .appointment { position: relative; }
    }

    .booking-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
      font-size: 0.95rem;
      box-shadow: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .booking-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.06);
    }

    .booking-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e6e9ef;
      border-radius: 10px;
      min-height: 110px;
      font-size: 0.95rem;
      line-height: 1.4;
      resize: vertical;
      background: #fff;
    }

    .modal-content.booking-modal .modal-body {
      display: block;
      gap: 12px;
    }

    .modal-content.booking-modal .modal-header h3 {
      font-size: 1.05rem;
      margin: 0;
    }

    /* Make booking modal primary button green */
    .modal-content.booking-modal .modal-footer .primary {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
    }
    .modal-content.booking-modal .modal-footer .primary:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    .modal-content.booking-modal .modal-footer .primary[disabled] {
      background: #9fd4a9;
      color: #fff;
      cursor: not-allowed;
      opacity: 0.8;
      transform: none;
    }
    .field-error {
      color: #dc3545;
      font-size: 0.85rem;
      margin-top: 6px;
      line-height: 1.2;
    }
    .input-error {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 4px rgba(220,53,69,0.06) !important;
    }
    /* --- EXTRA MOBILE FIXES: make containers responsive and override inline spacing --- */
    @media (max-width: 1024px) {
      /* allow content to fill screen when sidebar hidden or collapsed */
      .content { margin-left: 0 !important; padding: 1rem !important; }
      .sidebar { transform: translateX(-100%); position: fixed; left: -100%; }
      .topbar { left: 0 !important; }
      .content-footer { margin-left: 0 !important; max-width: 100% !important; }
    }

    @media (max-width: 768px) {
      /* stack appointment and calendar into single column */
      .appointments-calendar-grid { grid-template-columns: 1fr !important; gap: 12px !important; }

      /* let cards size naturally instead of fixed heights */
      .appointments-card, .calendar-card { min-height: auto !important; height: auto !important; }

  /* make appointment list scroll inside its card on mobile instead of expanding the page */
  .appointments-container { overflow-y: auto !important; -webkit-overflow-scrolling: touch !important; padding-right: 0 !important; }

      /* make appointment actions touch-friendly */
      .appointment-actions { flex-direction: column !important; gap: 10px !important; }
      .appointment-actions button { width: 100% !important; box-sizing: border-box; }

      /* ensure calendar is usable but not too tall */
      #calendar { min-height: 260px !important; height: auto !important; }

      /* ensure content footer doesn't shift horizontally due to inline styles */
      .content-footer { margin-left: 0 !important; max-width: 100% !important; padding-left: 1rem !important; padding-right: 1rem !important; box-sizing: border-box; }

      /* bottom nav: show and increase tappable area */
      .bottom-nav { display: flex !important; height: 64px !important; padding: 8px 0 !important; }
      .bottom-nav a { padding: 10px 6px !important; }

      /* topbar: simplify and show mobile logo */
      .topbar { left: 0 !important; padding: 8px 12px !important; }
  .mobile-logo { display: flex !important; }
  /* Make the mobile topbar logo larger and override inline sizes */
  .mobile-logo img { height: 40px !important; width: auto !important; object-fit: contain !important; }

      /* sidebar overlay behavior when opened */
      .sidebar.mobile-open { transform: translateX(0) !important; left: 0 !important; }

      /* reduce paddings and card spacing on very small screens */
      .card { padding: 14px !important; }
      .page-title { font-size: 20px !important; }
      /* Appointment & calendar mobile fixes: ensure join button flows and calendar toolbar wraps */
      .appointments-calendar-grid { align-items: start !important; }
      .appointments-card, .calendar-card { min-height: 0 !important; height: auto !important; padding: 12px !important; }

      /* Make FullCalendar responsive: allow toolbar to wrap and buttons to scale */
      .calendar-card .fc { max-width: 100% !important; width: 100% !important; }
      .calendar-card .fc .fc-toolbar { display: flex !important; flex-wrap: wrap !important; gap: 8px !important; align-items: center !important; justify-content: space-between !important; }
      .calendar-card .fc .fc-toolbar-chunk { display: flex !important; gap: 8px !important; align-items: center !important; }
      .calendar-card .fc .fc-button { padding: 6px 10px !important; font-size: 0.95rem !important; }

      /* Ensure events and day cells wrap text */
      .fc .fc-daygrid-day-frame { word-break: break-word !important; white-space: normal !important; }

      /* Ensure appointment items stack vertically on mobile and the Join button flows into document flow */
      .appointment { display: flex !important; flex-direction: column !important; gap: 10px !important; position: relative !important; }
      .appointment .start-session-wrapper { position: static !important; right: auto !important; bottom: auto !important; display: flex !important; justify-content: flex-end !important; margin-top: 8px !important; }
      .appointment-actions { width: 100% !important; flex-direction: column !important; gap: 8px !important; }
      .start-session-btn { width: auto !important; padding: 8px 12px !important; border-radius: 8px !important; }
      .appointment-info { padding-right: 0 !important; }

      /* Slight size reductions for very small screens */
      @media (max-width:420px) {
        .page-title { font-size: 18px !important; }
        .appointment .appointment-info strong { font-size: 1rem !important; }
        .calendar-card .fc .fc-button { padding: 6px 8px !important; font-size: 0.85rem !important; }
      }
    }

    /* Make appointment/calendar containers match other student-portal components on mobile
       (same max-width and centered layout as concerns/important updates/emergency support) */
    @media (max-width:768px) {
      .appointments-container, .appointments-card, .calendar-card { max-width: 600px !important; width: 94% !important; margin: 0 auto !important; box-sizing: border-box !important; }
      .appointments-calendar-grid { justify-content: center !important; }
      /* Ensure top-level content uses same padding behavior */
      .content { padding-left: 1rem !important; padding-right: 1rem !important; }

      /* Footer sizing adjustments on mobile */
      .content-footer { padding: 8px 0 !important; margin-left: 0 !important; max-width: 100% !important; }
      .content-footer > div { max-width: 600px !important; width: 94% !important; margin: 0 auto !important; font-size: 0.85rem !important; color: var(--text-light) !important; }
      /* Reduce bottom spacing so footer and bottom-nav don't compete visually */
      .content { padding-bottom: 4rem !important; }
    }

    /* Fix: center the tab buttons (Pending/Today/Tomorrow/Upcoming/Past) on mobile */
    @media (max-width: 768px) {
      .appointments-tabs {
        align-items: center !important; /* vertically center tab buttons */
        padding: 6px !important; /* slightly smaller padding on mobile */
      }

      .appointments-tabs .tab-btn {
        padding: 8px 10px !important; /* reduce padding so text centers nicely */
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 36px !important;
        flex: 1 1 auto !important;
        line-height: 1 !important;
      }

      /* Remove the tiny raised transform for the active pill on mobile so it stays centered */
      .appointments-tabs .tab-btn.active {
        transform: none !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06) !important;
      }
    }

    /* Mobile override: keep Reschedule and View Details on same line when possible */
    @media (max-width: 768px) {
      .appointment-actions {
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        justify-content: flex-start !important;
        width: 100% !important;
      }

      .appointment-actions button {
        flex: 1 1 auto !important;
        min-width: 0 !important;
        width: auto !important;
        box-sizing: border-box !important;
      }

      /* If there are more than two actions, allow wrapping to avoid overflow on very small screens */
      @media (max-width: 420px) {
        .appointment-actions { flex-wrap: wrap !important; }
        .appointment-actions button { flex: 1 1 48% !important; }
      }
    }
    /* Additional compact mobile sizing for appointment items (padding/fonts) */
    @media (max-width: 768px) {
      .appointment {
        padding: 8px !important;
        margin-bottom: 10px !important;
      }
      /* Smaller counselor name and inline icon on mobile */
      .appointment .counselor-name {
        font-size: 12px !important;
        line-height: 1.08 !important;
        display: inline-block !important;
        max-width: calc(100% - 26px) !important; /* leave room for the info icon */
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        vertical-align: middle !important;
      }
      .counselor-info-btn { margin-left: 6px !important; }
      .counselor-info-btn i { font-size: 0.85rem !important; }
      .appointment .appointment-datetime,
      .appointment .appointment-mode { font-size: 12px !important; }
      .appointment-actions button { padding: 8px 10px !important; font-size: 13px !important; }
      .start-session-btn { padding: 8px 10px !important; font-size: 13px !important; }
    }
    @media (max-width: 420px) {
      .appointment .counselor-name { font-size: 11px !important; max-width: calc(100% - 24px) !important; }
      .counselor-info-btn i { font-size: 0.8rem !important; }
    }
    /* Inline button loading spinner styles */
    .btn-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.18);
      border-top-color: rgba(255,255,255,0.9);
      border-radius: 50%;
      vertical-align: middle;
      margin-left: 8px;
      animation: spinner 0.8s linear infinite;
    }

    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    /* When a button is in loading state, hide its textual content and show spinner */
    .btn-loading { pointer-events: none; opacity: 0.85; }
    .btn-loading .btn-text { visibility: hidden; }
    .btn-loading .btn-spinner { display: inline-block; }
    /* Default spinner hidden for non-loading buttons */
    .btn-spinner { display: none; }
    /* Mobile: reduce calendar title (month/year) size */
    @media (max-width: 768px) {
      .calendar-card .fc .fc-toolbar-title,
      .calendar-card .fc .fc-toolbar h2,
      .calendar-card .fc .fc-toolbar .fc-toolbar-title {
        font-size: 1rem !important;
        line-height: 1.1 !important;
        font-weight: 600 !important;
      }
    }
    @media (max-width: 420px) {
      .calendar-card .fc .fc-toolbar-title,
      .calendar-card .fc .fc-toolbar h2,
      .calendar-card .fc .fc-toolbar .fc-toolbar-title {
        font-size: 0.95rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar from assessments.html -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo"><img src="safespace.png" alt="SafeSpace logo"></div>
      <span>SafeSpace</span>
    </div>
    <a href="index.html" class="active" data-emoji=""><span>Appointments</span></a> 
    <a href="history.html" data-emoji=""><span>History</span></a>
    <a href="assessments.html" data-emoji=""><span>Assessments</span></a>
    <a href="resources.html" data-emoji=""><span>Resources</span></a>
    <a href="messages.html" data-emoji=""><span>Messages</span></a>
    <a href="settings.html" data-emoji=""><span>Settings</span></a>
  </div>

  <!-- Mobile overlay for sidebar when opened on small screens -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Topbar from assessments.html -->
  <div class="topbar" id="topbar">
    <div class="topbar-left">
      <div class="hamburger">
        <i class="fas fa-bars"></i>
      </div>
      <div class="mobile-logo"><img src="safespace.png" alt="SafeSpace" style="width:24px;height:24px;object-fit:contain"></div>
      <div class="portal-title">
        <strong><span class="safespace">RSU SafeSpace: </span>Student Portal</strong>
        <small></small>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:1rem; position:relative;">
      <div class="notif-wrapper" onclick="toggleNotif()">
        <span class="icon-btn"></span>
        <div class="notif-badge" style="position:absolute;right:4px;bottom:8px;width:8px;height:8px;background:#ef4444;border-radius:50%;border:2px solid var(--green)"></div>
      </div>
      <div id="notifDropdown" class="notif-dropdown">
        <div class="notif-header">Notifications</div>
        <div class="notif-list">
          <div class="notif-item" onclick="goToSection('appointments')"> New counseling slots available</div>
          <div class="notif-item" onclick="goToSection('messages')"> You have a new message from your counselor</div>
          <div class="notif-item" onclick="goToSection('assessments')"> Reminder: Complete your assessment</div>
        </div>
      </div>
      <div class="profile" onclick="window.location.href='profile.html'"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="page-header">
      <h1 class="page-title">Appointments</h1>
      <p class="page-subtitle">Schedule and manage your counseling sessions</p>
    </div>

    <!-- Important Updates -->
    <div class="card updates-card">
      <h3><i class="fas fa-bullhorn"></i> Important Updates</h3>
      <div class="swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide">
            <strong>Welcome Back to SafeSpace!</strong>
            <p>We're here to support your mental health journey with professional counseling services.</p>
            <button>Explore Resources</button>
          </div>
          <div class="swiper-slide">
            <strong>Psychological Testing Result</strong>
            <p>See if you psychological test results are available.</p>
            <button>See Assessments Result</button>
          </div>
          <div class="swiper-slide">
            <strong>New Counseling Sessions</strong>
            <p>Check available slots in your calendar and book your session with our qualified counselors.</p>
            <button>Book Now</button>
          </div>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </div>

    <!-- Report and Emergency Section -->
    <div class="report-emergency-grid">
      <div class="card report-card">
        <h3><i class="fas fa-flag"></i> Report a Concern</h3>
        <p style="color: var(--text-light); margin-bottom: 16px;">Report any issues you're experiencing</p>
        <div class="report-buttons">
          <button onclick="showReportModal('bullying')" class="report-btn report-bullying">
            <i class="fas fa-triangle-exclamation"></i> Bullying
          </button>
          <button onclick="showReportModal('harassment')" class="report-btn report-harassment">
            <i class="fas fa-exclamation-circle"></i> Harassment
          </button>
          <button onclick="showReportModal('concern')" class="report-btn report-concern">
            <i class="fas fa-comment-dots"></i> General Concern
          </button>
        </div>
      </div>

      <div class="card emergency-card">
        <h3><i class="fas fa-phone-alt"></i> Emergency Support</h3>
        <div class="emergency-hotline">
          <strong><i class="fas fa-exclamation-triangle"></i> Need Immediate Help?</strong>
          <div style="margin-top: 12px;">
            National Crisis: <a href="tel:988" class="hotline-number">000</a>
            <br>
            Philippine National Hotline: <a href="tel:5551234567" class="hotline-number">(000) 123-4567</a>
          </div>
          <p style="margin-top: 16px; font-size: 14px;">
            Call or urgent mental health support
          </p>
        </div>
      </div>
    </div>

    <!-- Appointments and Calendar Section -->
    <div class="appointments-calendar-grid">
      <div class="card appointments-card">
        <div class="appointments-header">
          <h3><i class="fas fa-calendar-alt"></i> My Appointments</h3>
          <!-- plus button removed -->
        </div>
        
        <div class="appointments-tabs">
          <button class="tab-btn active" data-tab="pending">Pending</button>
          <button class="tab-btn" data-tab="today">Today</button>
          <button class="tab-btn" data-tab="tomorrow">Tomorrow</button>
          <button class="tab-btn" data-tab="upcoming">Upcoming</button>
          <button class="tab-btn" data-tab="past">Past</button>
        </div>
        
        <div class="appointments-container">
          <div class="appointments-list tab-content" id="tab-pending"></div>
          <div class="appointments-list tab-content hidden" id="tab-today"></div>
          <div class="appointments-list tab-content hidden" id="tab-tomorrow"></div>
          <div class="appointments-list tab-content hidden" id="tab-upcoming"></div>
          <div class="appointments-list tab-content hidden" id="tab-past"></div>
        </div>
      </div>

      <div class="card calendar-card">
        <h3><i class="fas fa-calendar-days"></i> Calendar</h3>
        <div id="calendar"></div>
      </div>
    </div>
    <!-- Content footer -->
    <div class="content-footer" style="padding:1rem 0; margin-left:250px; max-width:calc(100% - 250px); box-sizing:border-box;">
      <div style="max-width:1200px; margin:0 auto; text-align:center; color:var(--text-light); font-size:0.95rem;">
         2025 RSU SafeSpace | Student Support Management System
      </div>
    </div>
  </div>

  <!-- Bottom Navigation from assessments.html -->
  <div class="bottom-nav">
    <a href="index.html" aria-label="Appointments" class="active"><span class="emoji" aria-hidden="true"></span></a>
    <a href="history.html" aria-label="History"><span class="emoji" aria-hidden="true"></span></a>
    <a href="assessments.html" aria-label="Assessments"><span class="emoji" aria-hidden="true"></span></a>
    <a href="resources.html" aria-label="Resources"><span class="emoji" aria-hidden="true"></span></a>
    <a href="messages.html" aria-label="Messages"><span class="emoji" aria-hidden="true"></span></a>
    <a href="settings.html" aria-label="Settings"><span class="emoji" aria-hidden="true"></span></a>
  </div>

  <!-- Floating Action Button -->
  <!-- Floating action button removed -->

  <!-- Report Modal -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="reportModalTitle">Report Bullying</h3>
        <button class="close-btn" onclick="closeReportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Please provide details about the incident you would like to report:</p>
        <div style="margin-top: 12px;">
          <label for="incidentDate">Date of Incident</label>
          <input type="date" id="incidentDate" style="width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ddd; border-radius: var(--radius-sm);">
          <div id="error-incidentDate" class="field-error" aria-live="polite"></div>
        </div>

        <!-- Visible report type/title above the description (matches reference UI) -->
        <div style="margin-top: 16px;">
          <h4 id="reportType" style="margin:0 0 8px 0; font-size:1rem; color:#004c27;">Harassment</h4>
          <label for="incidentDescription">Give a short description (what happened, when, where).</label>
          <textarea id="incidentDescription" rows="5" style="width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ddd; border-radius: var(--radius-sm);" placeholder="Give a short description (what happened, when, where)."></textarea>
          <div id="error-incidentDescription" class="field-error" aria-live="polite"></div>
        </div>

        <div style="margin-top: 12px; display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="anonymousCheck" checked style="width:18px;height:18px;" />
          <label for="anonymousCheck" style="margin:0; font-size:0.95rem;">Submit anonymously</label>
        </div>

        <div style="margin-top: 16px;">
          <label for="incidentLocation">Location (optional)</label>
          <input type="text" id="incidentLocation" style="width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ddd; border-radius: var(--radius-sm);" placeholder="Where did this happen?">
          <div id="error-incidentLocation" class="field-error" aria-live="polite"></div>
        </div>
        <div style="margin-top:12px;">
          <label for="reportAttachment">Attach file (optional)</label>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <input type="file" id="reportAttachment" style="flex:1;" />
            <span id="reportAttachmentName" style="color:var(--text-light);font-size:0.95rem;"></span>
          </div>
          <div id="error-reportAttachment" class="field-error" aria-live="polite"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary" onclick="closeReportModal()">Cancel</button>
        <button class="primary" onclick="submitReport()">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Booking Modal (used by booking flow) -->
  <div id="bookingModal" class="modal-overlay" style="display:none; position:fixed; inset:0; z-index:10000; align-items:center; justify-content:center; background:rgba(0,0,0,0.5);">
    <div class="modal-content" style="max-width:720px; width:96%; border-radius:12px; background:#fff; position:relative; padding:1rem;">
      <!-- bookingModal content will be injected dynamically -->
    </div>
  </div>

  <!-- Action Card (generic side/modal content container) -->
  <div id="actionCard" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:11000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:1.25rem; border-radius:12px; max-width:720px; width:96%; position:relative;">
      <span style="position:absolute; top:10px; right:14px; font-size:1.3rem; cursor:pointer;" onclick="closeActionCard()">&times;</span>
      <div id="actionCardContent"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase_config.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script>
    // Ensure `auth` and `db` variables exist and listen for auth state changes.
    // Many pages in this project expect `auth` and `db` to be available globally.
    window.auth = window.auth || (window.firebase ? firebase.auth() : null);
    window.db = window.db || (window.firebase && firebase.database ? firebase.database() : null);

    // Auth state listener: load data when user is signed in
    if (window.auth && window.auth.onAuthStateChanged) {
      window.auth.onAuthStateChanged(function(user) {
        if (user) {
          console.log('Firebase auth: user signed in', user.uid);
          // Ensure globals are present
          window.auth = firebase.auth();
          window.db = firebase.database();
          // Call loadData if defined (it will load student/counselor data and appointments)
          if (typeof loadData === 'function') {
            try { loadData(user); } catch (e) { console.error('Error calling loadData on auth state change', e); }
          }
        } else {
          console.log('Firebase auth: no user signed in');
          // Optionally redirect to signin page if your app requires auth to view this page
          // window.location.href = 'signin.html';
        }
      });
    } else {
      console.warn('Auth SDK not available yet. Make sure firebase-auth.js is loaded before this script.');
    }

    // Add a flag to prevent duplicate loading - MOVE THIS TO THE TOP
    let isDataLoaded = false;
    let selectedSlot = "";
    let studentData = null;
    let allCounselors = [];
    let availableSlotsByDate = {};
    // If the student has at least one 'referred' appointment, allow booking more broadly within same campus
    let studentHasReferral = false;
let calendarEl = null;

// Helper: return local YYYY-MM-DD for a Date (avoids UTC timezone shifts)
function toLocalISODate(d) {
  try {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  } catch (e) { return new Date().toISOString().split('T')[0]; }
}

// Helper: parse a date string YYYY-MM-DD and a time like "HH:MM - HH:MM" (or "HH:MM") into a local Date
function parseLocalDateTime(dateStr, timeStr) {
  try {
    const parts = String(dateStr).split('-').map(Number);
    if (parts.length < 3) return new Date(0);
    const year = parts[0], month = parts[1] - 1, day = parts[2];
    if (!timeStr) return new Date(year, month, day);
    const timeStart = String(timeStr).split(' - ')[0] || String(timeStr);
    const tparts = timeStart.split(':').map(v => Number(v));
    const hour = Number.isFinite(tparts[0]) ? tparts[0] : 0;
    const minute = Number.isFinite(tparts[1]) ? tparts[1] : 0;
    return new Date(year, month, day, hour, minute, 0, 0);
  } catch (e) { return new Date(0); }
}

// --- BEGIN: Holiday and Exception Logic ---
let dateExceptions = {};
let phHolidays = [];

// Fetch date exceptions for all relevant counselors and PH holidays
async function loadDateExceptionsAndHolidays(relevantCounselors) {
  dateExceptions = {};
  // 1. Load date exceptions (from all counselors relevant to the student)
  for (const counselor of relevantCounselors) {
    if (!counselor.uid) continue;
    try {
      // Try both possible keys: 'dateExceptions' and '__dateExceptions'
      const availSnap = await db.ref('availabilities/' + counselor.uid).once('value');
      if (availSnap.exists()) {
        const avail = availSnap.val();
        if (avail.dateExceptions) {
          Object.assign(dateExceptions, avail.dateExceptions);
        }
        if (avail.__dateExceptions) {
          Object.assign(dateExceptions, avail.__dateExceptions);
        }
      }
    } catch (e) { /* ignore */ }
  }

  // 2. Load PH holidays for this year (from API, or cache in localStorage)
  const year = new Date().getFullYear();
  try {
    // Try cache first
    const cache = localStorage.getItem('phHolidays_' + year);
    if (cache) {
      phHolidays = JSON.parse(cache);
    } else {
      const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/PH`);
      if (res.ok) {
        phHolidays = await res.json();
        localStorage.setItem('phHolidays_' + year, JSON.stringify(phHolidays));
      } else {
        phHolidays = [];
      }
    }
  } catch (e) { phHolidays = []; }
}
// --- END: Holiday and Exception Logic ---

    // Initialize calendar element when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      calendarEl = document.getElementById('calendar');
      console.log(' Calendar element initialized:', calendarEl);
      
      // Test if FullCalendar loads properly
      if (typeof FullCalendar !== 'undefined') {
        console.log(' FullCalendar library loaded');
      } else {
        console.error(' FullCalendar library not loaded');
      }
    });

    // Sidebar toggle

    // Burger menu for collapsed sidebar (restyled)
    document.addEventListener('DOMContentLoaded', function() {
      var burger = document.querySelector('.hamburger') || document.getElementById('burgerToggle');
      var sidebar = document.getElementById('sidebar');
      var topbar = document.getElementById('topbar');
      var content = document.getElementById('content');
      var overlay = document.getElementById('sidebarOverlay') || document.querySelector('.sidebar-overlay');

      function toggleDesktop() {
        if (sidebar) sidebar.classList.toggle('collapsed');
        if (topbar) topbar.classList.toggle('shifted');
        if (content) content.classList.toggle('shifted');
      }

      function openMobile() {
        if (sidebar) sidebar.classList.add('mobile-open');
        if (overlay) overlay.classList.add('active');
      }

      function closeMobile() {
        if (sidebar) sidebar.classList.remove('mobile-open');
        if (overlay) overlay.classList.remove('active');
      }

      if (burger) {
        burger.addEventListener('click', function(e) {
          e.stopPropagation();
          // On small screens, slide in/out the sidebar with overlay
          if (window.innerWidth <= 768) {
            if (sidebar && sidebar.classList.contains('mobile-open')) {
              closeMobile();
            } else {
              openMobile();
            }
          } else {
            // Desktop: toggle collapsed state
            toggleDesktop();
          }
        });
      }

      // Close mobile sidebar when clicking overlay
      if (overlay) {
        overlay.addEventListener('click', function() { closeMobile(); });
      }

      // Optional: close mobile sidebar on window resize if switching to desktop layout
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          // ensure mobile classes are removed
          if (sidebar) sidebar.classList.remove('mobile-open');
          if (overlay) overlay.classList.remove('active');
        }
      });
    });

    // Notification toggle
    function toggleNotif() {
      const dropdown = document.getElementById("notifDropdown");
      const badge = document.querySelector(".notif-badge");
      dropdown.classList.toggle("active");
      if (dropdown.classList.contains("active")) { badge.classList.add("hidden"); }
    }
    document.addEventListener("click", function(e){
      const dropdown = document.getElementById("notifDropdown");
      const notifBtn = document.querySelector(".notif-wrapper");
      if (!notifBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
      }
    });

    // Scroll to section
    function goToSection(sectionId) {
      const el = document.getElementById(sectionId);
      if (el) { el.scrollIntoView({ behavior:"smooth" }); }
      document.getElementById("notifDropdown").classList.remove("active");
    }

    // Modal booking
    function openModal(dateStr, slots) {
      selectedSlot = "";
      document.getElementById("modal-date").textContent = `Book a Session on ${dateStr}`;
      const container = document.getElementById("modal-slots");
      container.innerHTML = "";
      slots.forEach(slot => {
        const div = document.createElement("div");
        div.classList.add("modal-slot");
        div.textContent = slot;
        div.onclick = () => {
          document.querySelectorAll(".modal-slot").forEach(el => el.classList.remove("selected"));
          div.classList.add("selected");
          selectedSlot = slot;
        };
        container.appendChild(div);
      });
      document.getElementById("bookingModal").style.display = "flex";
    }
    function closeModal() { document.getElementById("bookingModal").style.display = "none"; }

    // Action Card
    function showActionCard(contentHtml) {
      document.getElementById('actionCardContent').innerHTML = contentHtml;
      document.getElementById('actionCard').style.display = 'flex';
    }
    function closeActionCard() {
      document.getElementById('actionCard').style.display = 'none';
    }

    // Make all buttons show a card instead of alert/popup
    document.addEventListener('DOMContentLoaded', function () {
      // Important Updates buttons
      document.querySelectorAll('.swiper-slide button').forEach(btn => {
        btn.onclick = function(e) {
          let content = "";
          // Normalize label and match by keyword to handle slight variations like "Explore Resources"
          const label = (btn.textContent || '').trim().toLowerCase();
          if (label.includes('explore')) {
            // Navigate directly to resources (no action card)
            window.location.href = 'resources.html';
            return; 
          } else if (label.includes('result')) {
            // Navigate directly to assessments (no action card)
            window.location.href = 'assessments.html';
            return;
          } else if (label.includes('book')) {
            // Navigate/scroll to the calendar on this page (no action card)
            // Prefer an element with id 'calendarCard' if present, otherwise '#calendar'
            var target = document.getElementById('calendarCard') || document.getElementById('calendar');
            if (target) {
              target.scrollIntoView({ behavior: 'smooth' });
            } else {
              // Fallback: navigate to this page with anchor
              window.location.href = 'index.html#calendarCard';
            }
            return;
          } else {
            content = `<strong>${btn.textContent}</strong><br><br>This is a sample action for "${btn.textContent}".`;
          }
          showActionCard(content);
        };
      });

      // Upcoming Appointments buttons
      document.querySelectorAll('.appointment-actions button').forEach(btn => {
        btn.onclick = function(e) {
          const parent = btn.closest('.appointment');
          const title = parent.querySelector('strong').textContent;
          const action = btn.textContent.trim();
          let content = "";
          if (action === "Reschedule") {
            content = `<strong>Reschedule Appointment</strong><br><br>You can select a new date and time for:<br><b>${title}</b><br><br>
          <button id="chooseSlotBtn" style="background:#28a745;color:white;border:none;padding:0.5rem 1rem;border-radius:6px;">Choose New Slot</button>`;
          } 
          showActionCard(content);

          // Add event listeners for modal buttons after rendering
          setTimeout(() => {
            const chooseSlotBtn = document.getElementById('chooseSlotBtn');
            if (chooseSlotBtn) {
              chooseSlotBtn.onclick = function() {
                closeActionCard();
                showActionCard(`<strong>Choose a new slot for:</strong><br><b>${title}</b><br><br>
              <a href="#calendarCard" style="background:#0073f;color:white;padding:0.5rem 1rem;border-radius:6px;text-decoration:none;display:inline-block;" onclick="closeActionCard()">Go to Calendar</a>`);
              };
            }
          }, 50);
        };
      });

      // Booking button handler removed here to avoid conflicting handlers.
      // Booking is handled by the dedicated booking modal when a slot is selected
      // (openBookingModal / bookSlot). Do not attach a global handler here.
    });

    // Swiper (carousel)
    const swiper = new Swiper('.swiper', {
      loop: true,
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev'
      },
      autoplay: {
        delay: 5000,
        disableOnInteraction: false
      },
      keyboard: { enabled: true },
      spaceBetween: 12,
      slidesPerView: 1,
      breakpoints: {
        769: { // desktop+
          spaceBetween: 16
        }
      }
    });

    // Load all availabilities for assigned advocate and unassigned counselors/psychologists
    async function loadAllAvailabilities() {
      // CLEAR DATA FIRST to prevent accumulation
      availableSlotsByDate = {}; 
      
      let relevantCounselors = [];

      console.log(' Finding relevant counselors for student:', studentData.first_name, studentData.campus, studentData.college);
 
      // Find relevant counselors in a single loop
      allCounselors.forEach(c => {
        console.log('Student data:', studentData);
        console.log('Checking counselor:', c.first_name, c.last_name, 'Campus:', c.campus, 'College:', c.college, 'Spec:', c.specialization);

        // Normalize campus/college strings for robust comparison
        const counselorCampusRaw = (c.campus || '').toString();
        const studentCampusRaw = (studentData && studentData.campus) ? studentData.campus.toString() : '';
        const counselorCampus = counselorCampusRaw.trim().toLowerCase();
        const studentCampus = studentCampusRaw.trim().toLowerCase();
        const counselorCollegeRaw = (c.college || '').toString();
        const studentCollegeRaw = (studentData && studentData.college) ? studentData.college.toString() : '';
        const counselorCollege = counselorCollegeRaw.trim().toLowerCase();
        const studentCollege = studentCollegeRaw.trim().toLowerCase();

        // If counselor is 'general' (no specific campus/college assigned), always include
        const counselorIsGeneral = ((!c.campus || String(c.campus).trim() === '' || String(c.campus).toLowerCase() === 'general') &&
                                   (!c.college || String(c.college).trim() === '' || String(c.college).toLowerCase() === 'general'));
        if (counselorIsGeneral) {
          relevantCounselors.push(c);
          console.log(' Added general counselor:', c.first_name, c.last_name, c.specialization);
          return;
        }

        // Consider Advocates, Counselors, and Psychologists using the same campus/college rules
        if (["Advocate", "Counselor", "Psychologist"].includes(c.specialization)) {
          // For Main Campus: require same campus AND same college, unless the student has a referral (then relax college)
          if (studentCampus === 'main campus') {
            const campusMatch = (counselorCampus === studentCampus);
            const collegeMatch = (counselorCollege === studentCollege);
            console.log('Main Campus check  campus raw/student:', counselorCampusRaw, '/', studentCampusRaw, '->', campusMatch, 'college raw/student:', counselorCollegeRaw, '/', studentCollegeRaw, '->', collegeMatch, 'Student referred:', studentHasReferral);
            if (campusMatch && (collegeMatch || studentHasReferral)) {
              relevantCounselors.push(c);
              console.log(' Added Main Campus counselor (allowed by referral? ' + (studentHasReferral ? 'yes' : 'no') + '):', c.first_name, c.last_name, c.college, c.specialization);
            }
          }
          // For other campuses: match only campus
          else {
            const campusMatch = (counselorCampus === studentCampus);
            if (campusMatch) {
              relevantCounselors.push(c);
              console.log(' Added campus counselor:', c.first_name, c.last_name, c.campus, c.specialization);
            }
          }
          return;
        }
        // Other specializations are ignored for availability matching
      });

      console.log(' Total relevant counselors:', relevantCounselors.length);

      // For each relevant counselor, get their availability
      for (const counselor of relevantCounselors) {
        try {
          if (!counselor.uid) {
            console.log(' No UID for counselor:', counselor.first_name);
            continue;
          }

          // Get weekly ranges from availabilities/{uid}/weeklyRanges
          let weeklyRangesSnap = await db.ref('availabilities/' + counselor.uid + '/weeklyRanges').once('value');
          if (weeklyRangesSnap.exists()) {
            const weeklyRanges = weeklyRangesSnap.val();
            console.log(' Found weekly ranges for:', counselor.first_name, Object.keys(weeklyRanges));
            
            // ADD DEBUG HERE
            debugWeeklyAvailability(counselor, weeklyRanges);
            
            // Get booked slots for this counselor
            const bookedSlotsSnap = await db.ref('availabilities/' + counselor.uid + '/bookedSlots').once('value');
            const bookedSlots = bookedSlotsSnap.exists() ? bookedSlotsSnap.val() : {};
            
            // Process weekly ranges into daily slots - ensure we only process each range once
            const processedRanges = new Set(); // Track processed ranges to avoid duplicates
            
            if (Array.isArray(weeklyRanges)) {
              weeklyRanges.forEach((range, index) => {
                const rangeKey = `${counselor.uid}-${index}`;
                if (range && range.weeklyAvailability && range.range && !processedRanges.has(rangeKey)) {
                  processedRanges.add(rangeKey);
                  expandWeeklyRangeToSlots(range, counselor, bookedSlots);
                }
              });
            } else if (weeklyRanges && typeof weeklyRanges === 'object') {
              Object.entries(weeklyRanges).forEach(([key, range]) => {
                const rangeKey = `${counselor.uid}-${key}`;
                if (range && range.weeklyAvailability && range.range && !processedRanges.has(rangeKey)) {
                  processedRanges.add(rangeKey);
                  expandWeeklyRangeToSlots(range, counselor, bookedSlots);
                }
              });
            }
            continue;
          }
          
          console.log(' No availability data for:', counselor.first_name);
        } catch (err) {
          console.warn(' Permission denied for', counselor.first_name, err.message);
          continue;
        }
      }
      
      // --- NEW: Load date exceptions and holidays before rendering calendar ---
      await loadDateExceptionsAndHolidays(relevantCounselors);

      // DEBUG: Check final slots before rendering
      console.log(' Final available slots before rendering:');
      console.log('Keys:', Object.keys(availableSlotsByDate));
      console.log('Total dates with slots:', Object.keys(availableSlotsByDate).length);
      Object.entries(availableSlotsByDate).forEach(([date, slots]) => {
        console.log(`${date}: ${slots.length} slots`);
      });
      
      renderCalendar();
    }

    // Render calendar with all available dates
    function renderCalendar() {
      if (!calendarEl) {
        console.error('Calendar element not found');
        return;
      }
      
      // Clear calendar container completely
      calendarEl.innerHTML = '';
      
      // --- BEGIN: Compose events including slots, exceptions, and holidays ---
      const events = [];

      // Build sets for fast lookup
      const exceptionDates = new Set(Object.keys(dateExceptions || {}));
      const holidayDates = new Set((phHolidays || []).map(h => h.date));

      // 1. Date exceptions (red, "Unavailable" or note)
      Object.keys(dateExceptions || {}).forEach(dateStr => {
        const info = dateExceptions[dateStr];
        const note = typeof info === 'string' ? info : (info && info.note) ? info.note : 'Unavailable';
        events.push({
          title: note || 'Unavailable',
          start: dateStr,
          backgroundColor: '#dc3545',
          borderColor: '#dc3545',
          textColor: '#fff',
          allDay: true,
          extendedProps: { type: 'exception', note }
        });
      });

      // 2. PH holidays (yellow, short label)
      (phHolidays || []).forEach(h => {
        events.push({
          title: 'Holiday',
          start: h.date,
          backgroundColor: '#ffc107',
          borderColor: '#ffc107',
          textColor: '#fff',
          allDay: true,
          extendedProps: { type: 'holiday', holidayName: h.localName || h.name }
        });
      });

      // 3. Available slots (green)  only if not a holiday or exception
      Object.keys(availableSlotsByDate).forEach(dateStr => {
        if (exceptionDates.has(dateStr) || holidayDates.has(dateStr)) return;
        const slotsCount = availableSlotsByDate[dateStr].length;
        events.push({
          title: `${slotsCount} slot${slotsCount > 1 ? 's' : ''}`,
          start: dateStr,
          backgroundColor: '#28a745',
          borderColor: '#28a745',
          textColor: '#fff',
          allDay: true,
          extendedProps: { type: 'slot', slots: availableSlotsByDate[dateStr] }
        });
      });

      setTimeout(() => {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 'auto',
          contentHeight: 340,
          fixedWeekCount: true,
          headerToolbar: { left:'prev,next today', center:'title', right:'' },
          showNonCurrentDates: true,
          events: events,
          eventDisplay: 'block',
          dayMaxEvents: 2,
          moreLinkClick: 'popover',
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            const props = info.event.extendedProps;
            if (props.type === 'exception') {
              showActionCard(`<strong style=\"color:#dc3545;\">Date Exception</strong><br>${props.note || 'Unavailable'}`);
            } else if (props.type === 'holiday') {
              showActionCard(`<strong style=\"color:#ffc107;\">Holiday</strong><br>${props.holidayName || info.event.title}`);
            } else if (props.type === 'slot') {
              showCounselorTimeModal(info.event.startStr);
            }
          },
          dateClick: function(info) {
            // If the clicked day is not in the current month, navigate to that month
            const calendarApi = info.view.calendar;
            const clickedDate = new Date(info.dateStr);
            const currentMonth = info.view.currentStart.getMonth();
            if (clickedDate.getMonth() !== currentMonth) {
              calendarApi.gotoDate(clickedDate);
              return;
            }
            // If any exception or holiday event exists for this date, block booking
            const hasException = events.some(ev => ev.start === info.dateStr && ev.extendedProps && ev.extendedProps.type === 'exception');
            const hasHoliday = events.some(ev => ev.start === info.dateStr && ev.extendedProps && ev.extendedProps.type === 'holiday');
            if (hasException) {
              showActionCard(`<strong>This date is unavailable (exception).</strong>`);
              return;
            }
            if (hasHoliday) {
              showActionCard(`<strong>This date is a holiday.</strong>`);
              return;
            }
            showCounselorTimeModal(info.dateStr);
          },
          eventClassNames: function(arg) {
            const props = arg.event.extendedProps;
            if (props.type === 'exception') return ['calendar-event', 'calendar-exception'];
            if (props.type === 'holiday') return ['calendar-event', 'calendar-holiday'];
            if (props.type === 'slot') return ['calendar-event', 'calendar-slot'];
            return ['calendar-event'];
          }
        });

        calendar.render();

        // Custom styles for exception (red), holiday (yellow), and slot (green) with white font
        const style = document.createElement('style');
        style.textContent = `
          .calendar-event {
            font-weight: bold !important;
            text-align: center !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-size: 0.8rem !important;
            color: #fff !important;
            border: none !important;
          }
          .calendar-exception {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: #fff !important;
          }
          .calendar-holiday {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #fff !important;
          }
          .calendar-slot {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: #fff !important;
          }
          .fc-daygrid-event {
            margin: 1px !important;
            border-radius: 3px !important;
          }
          .fc-event-title {
            font-weight: bold !important;
            color: #fff !important;
          }
        `;
        document.head.appendChild(style);

      }, 100);
    }

    // Show available counselors dropdown for a specific date
    function showCounselorTimeModal(dateStr) {
      const slots = availableSlotsByDate[dateStr] || [];
      if (slots.length === 0) {
        showActionCard(`<strong>No available slots for this date.</strong>`);
        return;
      }
      
      // Group by counselor
      const byCounselor = {};
      slots.forEach(slot => {
        const key = slot.counselor.key;
        if (!byCounselor[key]) {
          byCounselor[key] = { 
            counselor: slot.counselor, 
            times: [],
            description: getCounselorDescription(slot.counselor)
          };
        }
        byCounselor[key].times.push(slot.time);
      });

      let html = `<strong>Select a Counselor for ${new Date(dateStr).toLocaleDateString()}</strong><br><br>`;
      
      // Create counselor dropdown
      html += `<div style="margin-bottom:1rem;">
        <label for="counselorSelect" style="display:block; margin-bottom:0.5rem; font-weight:bold;">Choose Counselor:</label>
        <select id="counselorSelect" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:6px; font-size:0.9rem;" onchange="showTimeSlotsForCounselor('${dateStr}')">
          <option value="">-- Select a Counselor --</option>`;
      
      Object.values(byCounselor).forEach(entry => {
        const counselor = entry.counselor;
        const slotsCount = entry.times.length;
        html += `<option value="${counselor.key}">${counselor.first_name} ${counselor.last_name} (${counselor.specialization}) - ${slotsCount} slot${slotsCount > 1 ? 's' : ''} available</option>`;
      });
      
      html += `</select></div>`;
      
      // Container for time slots (initially empty)
      html += `<div id="timeSlotsContainer" style="margin-top:1rem;"></div>`;
      
      showActionCard(html);
      
      // Store counselor data for later use
      window.counselorsByDate = window.counselorsByDate || {};
      window.counselorsByDate[dateStr] = byCounselor;
    }

    // Show time slots for selected counselor
    window.showTimeSlotsForCounselor = function(dateStr) {
      const counselorSelect = document.getElementById('counselorSelect');
      const timeSlotsContainer = document.getElementById('timeSlotsContainer');
      const selectedCounselorKey = counselorSelect.value;
      
      if (!selectedCounselorKey) {
        timeSlotsContainer.innerHTML = '';
        return;
      }
      
      const counselorData = window.counselorsByDate[dateStr][selectedCounselorKey];
      const counselor = counselorData.counselor;
      const allTimes = counselorData.times.sort(); // Sort times chronologically
      
      // Filter out past times for today's date
      const now = new Date();
      const selectedDate = new Date(dateStr);
      const isToday = selectedDate.toDateString() === now.toDateString();
      
      const availableTimes = allTimes.filter(time => {
        if (!isToday) return true; // If not today, all times are available
        
        // For today, check if the time has passed (with buffer)
        const timeStart = time.split(' - ')[0];
        const [hours, minutes] = timeStart.split(':').map(Number);
        const slotDateTime = new Date();
        slotDateTime.setHours(hours, minutes, 0, 0);
        
        // Add 30-minute buffer to prevent booking slots that are starting very soon
        const bufferTime = 30 * 60 * 1000; // 30 minutes
        return (slotDateTime.getTime() - bufferTime) > now.getTime();
      });
      
      let html = `<div style="border-top:1px solid #ddd; padding-top:1rem;">
        <strong>${counselor.first_name} ${counselor.last_name}</strong><br>
        <small style="color:#666;">${getCounselorDescription(counselor)}</small><br><br>`;
      
      if (availableTimes.length === 0) {
        if (isToday && allTimes.length > 0) {
          html += `<p style="color:#999; font-style:italic;">All slots for today have passed or are starting too soon. Please select a future date.</p>`;
        } else {
          html += `<p style="color:#999; font-style:italic;">No available times remaining for this date.</p>`;
        }
      } else {
        html += `<strong>Available Times:</strong><br>`;
        availableTimes.forEach(time => {
          html += `<button style="margin:0.3rem 0.3rem 0.3rem 0;padding:0.4rem 0.8rem;border-radius:6px;background:#00723f;color:white;border:none;cursor:pointer; font-size:0.9rem;"
            onclick="window.selectSlotForBooking('${dateStr}','${selectedCounselorKey}','${time}')">${time}</button>`;
        });
      }
      
      html += `</div>`;
      timeSlotsContainer.innerHTML = html;
    };

    // Select slot for booking (called when time button is clicked)
    window.selectSlotForBooking = function(dateStr, counselorKey, timeSlot) {
      const dateObj = new Date(dateStr);
      closeActionCard(); // Close the counselor selection modal
      openBookingModal(dateObj, counselorKey, timeSlot);
    };

    // Booking modal logic
    async function openBookingModal(dateObj, counselorKey, slotTime) {
      // Get counselor info
      const counselor = allCounselors.find(c => c.key === counselorKey);
      
      // Ensure we have the latest student block value from the DB in case it changed
      let latestBlock = (studentData && studentData.block) ? String(studentData.block) : '';
      try {
        if (studentData && studentData.key) {
          const snap = await db.ref(`students/${studentData.key}/block`).once('value');
          if (snap.exists()) latestBlock = String(snap.val() || '');
        } else if (auth && auth.currentUser && auth.currentUser.uid) {
          // Fallback: look up student record by uid
          const q = await db.ref('students').orderByChild('uid').equalTo(auth.currentUser.uid).once('value');
          if (q.exists()) {
            q.forEach(ch => {
              const val = ch.val();
              if (val && (val.block || val.block === '')) {
                latestBlock = String(val.block || '');
              }
              // grab key for later convenience
              if (!studentData) {
                studentData = val || {};
                studentData.key = ch.key;
              } else if (!studentData.key) {
                studentData.key = ch.key;
              }
            });
          }
        }
      } catch (e) {
        console.warn('Could not read latest student block:', e);
      }

      // Prefill modal fields
      const modal = document.getElementById('bookingModal');
      
      // Show counselor assignment reason
      let assignmentReason = '';
      // Normalize fields for robust, case-insensitive comparisons
      const spec = (counselor.specialization || '').toString().trim().toLowerCase();
      const counselorCampus = (counselor.campus || '').toString().trim();
      const counselorCampusLC = counselorCampus.toLowerCase();
      const studentCampusRaw = (studentData && studentData.campus) ? studentData.campus.toString().trim() : '';
      const studentCampus = studentCampusRaw.toLowerCase();
      const counselorCollege = (counselor.college || '').toString().trim().toLowerCase();
      const studentCollege = (studentData && studentData.college) ? studentData.college.toString().trim().toLowerCase() : '';

      // If the counselor has a campus assigned and it matches the student's campus, show a campus-specific message.
      // This is case-insensitive and works for both "Advocate" and other counselor specializations.
      if (counselorCampus && counselorCampusLC === studentCampus) {
        // Main Campus vs other campus messaging
        if (studentCampus === 'main campus' && (counselorCollege === studentCollege || studentHasReferral)) {
          assignmentReason = `<div style="background:#e6f7eb; padding:1rem; border-radius:8px; margin-bottom:1.5rem; font-size:0.9rem;">
    <strong> Assigned ${counselor.specialization || 'Counselor'}:</strong> This ${counselor.specialization || 'counselor'} is specifically assigned to students from ${counselor.college || ''}, ${counselor.campus || ''}.
  </div>`;
        } else {
          assignmentReason = `<div style="background:#e6f7eb; padding:1rem; border-radius:8px; margin-bottom:1.5rem; font-size:0.9rem;">
    <strong> Campus ${counselor.specialization || 'Counselor'}:</strong> This ${counselor.specialization || 'counselor'} serves all students at ${counselor.campus || ''}.
  </div>`;
        }
      }

      // If no campus-specific message was set above, show the general availability message
      if (!assignmentReason) {
        assignmentReason = `<div style="background:#fff3cd; padding:1rem; border-radius:8px; margin-bottom:1.5rem; font-size:0.9rem;">
  <strong> General ${counselor.specialization || 'Counselor'}:</strong> Available for all students regardless of campus or college.
</div>`;
      }
      
      modal.innerHTML = `
<div class="modal-content booking-modal" role="dialog" aria-modal="true">
  <button class="close-btn" onclick="closeModal()">&times;</button>
  
  <div class="modal-header">
    <h3>Book a Session on ${dateObj.toLocaleDateString()} at ${slotTime}</h3>
  </div>
  
  <div class="modal-body">
    ${assignmentReason}
    
    <div style="margin-bottom:0.75rem;">
      <strong>Session Details</strong>
    </div>
    <div style="color:var(--text-light); margin-bottom:12px;">
      <b>Date & Time:</b> ${dateObj.toLocaleDateString()} at ${slotTime}<br>
      <b>Counselor/Advocate:</b> ${counselor ? (counselor.first_name + ' ' + counselor.last_name + ' (' + counselor.specialization + ')') : ''}
    </div>

    <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:12px;">
      <strong style="display:block;margin-bottom:6px;">Your Information</strong>
      <div style="color:var(--text);font-size:0.95rem;line-height:1.3;">
        <div><b>Name:</b> ${studentData.first_name || ''} ${studentData.last_name || ''}</div>
        <div><b>Email:</b> ${studentData.email_address || ''}</div>
        <div><b>Phone:</b> ${studentData.mobile || studentData.phone || ''}</div>
        <div class="field-error" id="error-phoneDisplay" style="display:none;"></div>
        <div><b>College/Campus:</b> ${studentData.college || ''} / ${studentData.campus || ''}</div>
        <div style="margin-top:6px;"><b>Year Level:</b> ${studentData.year_level || 'N/A'} &nbsp; <b style="margin-left:8px;">Block:</b>
          <input type="text" id="studentBlock" value="${latestBlock || ''}" style="width:100px; padding:0.3rem; border:1px solid #ddd; border-radius:6px; margin-left:6px;" placeholder="e.g. A, B, 1, 2">
          <div class="field-error" id="error-studentBlock" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div class="form-row" style="margin-bottom:12px;">
      <label for="modeSession" class="field-label">Mode of Session</label>
      <select id="modeSession" class="booking-select">
        <option value="Virtual">Virtual (Online)</option>
        <option value="Face-to-face">Face-to-face (In-person)</option>
      </select>
      <div class="field-error" id="error-modeSession" style="display:none;"></div>
    </div>

    <div class="form-row">
      <label for="concernDesc" class="field-label">Brief Description of Concern</label>
      <textarea id="concernDesc" class="booking-textarea" rows="5" placeholder="Please describe what you'd like to discuss..."></textarea>
      <div class="field-error" id="error-concernDesc" style="display:none;"></div>
    </div>
  </div>
  
  <div class="modal-footer">
    <button id="bookBtn" onclick="bookSlot()" class="primary">Book Session</button>
  </div>
</div>
`;
      // Attach validation handlers: show inline errors and clear them on input
      try {
    const bookBtn = modal.querySelector('#bookBtn');
    const blockEl = modal.querySelector('#studentBlock');
    const modeEl = modal.querySelector('#modeSession');
    const descEl = modal.querySelector('#concernDesc');
    // phone is display-only in this modal; errors use #error-phoneDisplay
    // define phoneEl safely (may be absent in the markup)
    const phoneEl = modal.querySelector('#phoneDisplay');

        function clearError(el) {
          if (!el) return;
          el.classList.remove('input-error');
          const err = modal.querySelector('#error-' + el.id);
          if (err) { err.style.display = 'none'; err.textContent = ''; }
        }
        function showError(el, message) {
          if (!el) return;
          el.classList.add('input-error');
          const err = modal.querySelector('#error-' + el.id);
          if (err) { err.style.display = 'block'; err.textContent = message; }
          try { el.focus(); } catch (e) {}
        }

        if (blockEl) blockEl.addEventListener('input', function(){ clearError(blockEl); });
        if (modeEl) modeEl.addEventListener('change', function(){ clearError(modeEl); });
        if (descEl) descEl.addEventListener('input', function(){ clearError(descEl); });
        if (phoneEl) phoneEl.addEventListener('input', function(){ clearError(phoneEl); });

        // Do not disable the Book button; allow user to click and show inline errors
        if (bookBtn) bookBtn.disabled = false;
      } catch (e) {
        console.warn('Failed to attach booking modal validation', e);
      }

      modal.style.display = "flex";
      // Save selected slot for booking
      window.selectedSlot = { date: dateObj, time: slotTime, counselorKey };
    }

    // Book slot (save to Firebase)
    async function bookSlot() {
      const slot = window.selectedSlot;
      if (!slot) return;
      
      const mode = document.getElementById('modeSession').value;
      const concern = document.getElementById('concernDesc').value.trim();
  const block = (document.getElementById('studentBlock') || { value: '' }).value.trim();
      
        // Validate required fields and show inline errors if missing
        const blockEl = document.getElementById('studentBlock');
        const descEl = document.getElementById('concernDesc');
  // phone display element is not editable here; reference error container by id
        const modeEl = document.getElementById('modeSession');

        function setInlineError(elId, message) {
          const el = document.getElementById(elId);
          if (el) {
            el.classList.add('input-error');
            try { el.focus(); } catch (e) {}
          }
          const err = document.getElementById('error-' + elId);
          if (err) { err.style.display = 'block'; err.textContent = message; }
        }
        function clearInlineError(elId) {
          const el = document.getElementById(elId);
          if (el) el.classList.remove('input-error');
          const err = document.getElementById('error-' + elId);
          if (err) { err.style.display = 'none'; err.textContent = ''; }
        }

        // Clear any prior inline errors first
  ['studentBlock','concernDesc','phoneDisplay','modeSession'].forEach(clearInlineError);

        if (!block) {
          setInlineError('studentBlock', 'This field is required.');
          return;
        }
        if (!mode || mode.trim() === '') {
          setInlineError('modeSession', 'Please choose a session mode.');
          return;
        }
        if (!concern) {
          setInlineError('concernDesc', 'Please enter a brief description of your concern.');
          return;
        }
        const phonePresent = (studentData && (studentData.mobile || studentData.phone));
        if (!phonePresent) {
          setInlineError('phoneDisplay', 'Please add your mobile number in your profile before booking.');
          return;
        }

      // Enhanced time validation
      const now = new Date();
      const slotDate = new Date(slot.date.toISOString().split('T')[0]);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      slotDate.setHours(0, 0, 0, 0);
      
      // Check if trying to book a past date
      if (slotDate < today) {
        showActionCard(`<strong>Cannot Book Past Date</strong><br>This date has already passed. Please select a future date.`);
        return;
      }
      
      // For today's bookings, check time with buffer
      if (slotDate.getTime() === today.getTime()) {
        const timeStart = slot.time.split(' - ')[0];
        const [hours, minutes] = timeStart.split(':').map(Number);
        const slotDateTime = new Date();
        slotDateTime.setHours(hours, minutes, 0, 0);
        
        // 30-minute buffer
        const bufferTime = 30 * 60 * 1000;
        if ((slotDateTime.getTime() - bufferTime) <= now.getTime()) {
          showActionCard(`<strong>Cannot Book This Slot</strong><br>This time slot has passed or is starting too soon. Please select a slot that starts at least 30 minutes from now.`);
          return;
        }
      }

      try {
        // Get the counselor data
        const counselor = allCounselors.find(c => c.key === slot.counselorKey);
        if (!counselor) {
          showActionCard(`<strong>Error: Counselor not found.</strong>`);
          return;
        }

        // 1. Save appointment to Firebase with proper null checks
        const appointmentData = {
          student_uid: auth.currentUser.uid,
          student_name: `${studentData.first_name || 'Unknown'} ${studentData.last_name || ''}`.trim(),
          student_email: studentData.email_address || studentData.email || '',
          student_id: studentData.student_id || '',
          student_phone: (studentData && (studentData.mobile || studentData.phone)) ? (studentData.mobile || studentData.phone) : '',
          student_block: block || '',
          counselor_key: slot.counselorKey,
          counselor_name: `${counselor.first_name || 'Unknown'} ${counselor.last_name || ''}`.trim(),
          counselor_uid: counselor.uid || '',
          // Persist the date as local YYYY-MM-DD to match client-side comparisons
          date: toLocalISODate(slot.date),
          time: slot.time,
          mode: mode,
          concern: concern,
          status: 'Pending', // provisional until the student completes the ORS
          ors_required: true,
          ors_submitted: false,
          created_at: Date.now(),
          booking_timestamp: now.toISOString()
        };

        // Remove any undefined values to prevent Firebase errors
        Object.keys(appointmentData).forEach(key => {
          if (appointmentData[key] === undefined) {
            appointmentData[key] = '';
          }
        });

        console.log(' Booking appointment with data:', appointmentData); // Debug log

        // Persist the student's block under students/<studentKey>/block when changed
        try {
          if (studentData && studentData.key) {
            const existingBlock = (studentData.block || '').toString();
            if (block !== existingBlock) {
              await db.ref(`students/${studentData.key}`).update({ block: block });
              // reflect change locally so subsequent modal opens are instant
              studentData.block = block;
              console.log('Saved student block to students/' + studentData.key + '/block ->', block);
            }
          } else if (auth && auth.currentUser && auth.currentUser.uid) {
            // As a fallback, attempt to find the student record by uid and update block
            const q = await db.ref('students').orderByChild('uid').equalTo(auth.currentUser.uid).once('value');
            if (q.exists()) {
              q.forEach(ch => {
                db.ref(`students/${ch.key}`).update({ block: block }).catch(e => console.warn('Failed saving fallback student block', e));
                // set local studentData key if missing
                if (!studentData) studentData = ch.val() || {};
                if (!studentData.key) studentData.key = ch.key;
                studentData.block = block;
              });
            }
          }
        } catch (e) {
          console.warn('Failed to save student block:', e);
        }


  // Save under student and counselor
  const appointmentRef = await db.ref(`appointments_by_student/${appointmentData.student_uid}`).push(appointmentData);
  const appointmentId = appointmentRef.key;
  await db.ref(`appointments_by_counselor/${appointmentData.counselor_uid}/${appointmentId}`).set(appointmentData);

        // 2. Update counselor availability to mark this slot as booked
        const bookedDate = slot.date.toISOString().split('T')[0];
        const bookedTime = slot.time;
        
        // Add to booked slots for this counselor
        const bookedSlotData = {
          time: bookedTime,
          appointment_id: appointmentRef.key,
          student_uid: auth.currentUser.uid,
          student_name: `${studentData.first_name || 'Unknown'} ${studentData.last_name || ''}`.trim(),
          booked_at: Date.now(),
          booking_timestamp: now.toISOString()
        };

        const bookedSlotRef = db.ref(`availabilities/${counselor.uid}/bookedSlots/${bookedDate}`);
        await bookedSlotRef.push(bookedSlotData);

        // 3. Remove from local availableSlotsByDate to update UI immediately
        if (availableSlotsByDate[bookedDate]) {
          availableSlotsByDate[bookedDate] = availableSlotsByDate[bookedDate].filter(
            s => !(s.counselor.key === slot.counselorKey && s.time === bookedTime)
          );
          
          // If no more slots for this date, remove the date entirely
          if (availableSlotsByDate[bookedDate].length === 0) {
            delete availableSlotsByDate[bookedDate];
          }
        }

        // 4. Re-render calendar to reflect changes
        renderCalendar();
        
        // 5. Reload appointments to show the new appointment
        await loadUpcomingAppointments(auth.currentUser.uid);

        // Close booking modal and open ORS immediately (ORS appears before the thank-you)
        try {
          closeModal();
          // Ensure flags are clear then open ORS and indicate it was opened right after booking
          window._orsSavedFlag = false;
          openORSModal(appointmentId, appointmentData, true);
        } catch (e) {
          console.warn('ORS trigger failed', e);
          // Fallback: show booking confirmation if ORS cannot open
          showActionCard(`<strong>Booking submitted!</strong><br>Your session is booked for:<br><b>${slot.date.toLocaleDateString()} at ${slot.time}</b><br><br>You will receive a confirmation email shortly.`);
        }

      } catch (error) {
        console.error('Error booking appointment:', error);
        showActionCard(`<strong>Booking Failed</strong><br>There was an error booking your appointment. Please try again.<br><br><small>Error: ${error.message}</small>`);
      }
    }

    // REMOVE this line - it's causing the duplicate call:
    // document.getElementById('bookBtn').onclick = bookSlot;

    // (Auth listener consolidated earlier to avoid duplicate loads)

    // Load student data and counselors from Firebase
    async function loadData(user) {
      try {
        // Load student data
        const studentSnap = await db.ref('students').orderByChild('uid').equalTo(user.uid).once('value');
        if (studentSnap.exists()) {
          studentSnap.forEach(function(child) {
            studentData = child.val();
            studentData.key = child.key;
            console.log('Student data loaded:', studentData);
            
            // Debug: Check available phone number fields (prefer mobile)
            console.log(' Phone fields available:', {
              mobile: studentData.mobile || '',
              phone: studentData.phone || ''
            });
            // Update topbar small text with student ID (if present) and profile avatar
            try {
              const topbarStudentId = document.querySelector('.portal-title small');
              if (topbarStudentId) {
                topbarStudentId.textContent = "ID: " + (studentData.student_id || studentData.student_id_number || 'N/A');
              }

              const topbarProfile = document.querySelector('.profile');
              if (topbarProfile) {
                if (studentData.photo_url) {
                  topbarProfile.innerHTML = `<img src="${studentData.photo_url}" alt="Profile Photo" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">`;
                } else if (studentData.first_name || studentData.last_name || studentData.username) {
                  const initials = ((studentData.first_name || '').charAt(0) + (studentData.last_name || '').charAt(0)).toUpperCase() || (studentData.username || 'U').charAt(0).toUpperCase();
                  topbarProfile.textContent = initials;
                } else {
                  topbarProfile.textContent = 'U';
                }
              }
            } catch (e) {
              console.warn('Failed to update topbar info', e);
            }
          });
        } else {
          console.error('Student data not found');
          return;
        }

        // Load all counselors
        const counselorsSnap = await db.ref('counselors').once('value');
        if (counselorsSnap.exists()) {
          allCounselors = [];
          counselorsSnap.forEach(function(child) {
            const counselor = child.val();
            counselor.key = child.key;
            allCounselors.push(counselor);
          });
          console.log('Counselors loaded:', allCounselors);
        }

        // Load student's existing appointments
        await loadUpcomingAppointments(user.uid);

        // Load availability data - ONLY CALL ONCE HERE
        await loadAllAvailabilities();

      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // (Removed duplicate/older definition of loadUpcomingAppointments)


    // Tab logic for appointments
document.addEventListener('DOMContentLoaded', function() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      tabBtns.forEach(b => {
        b.classList.remove('active');
        b.style.color = '';
        b.style.borderBottom = 'none';
      });
      btn.classList.add('active');
      btn.style.color = '#2563eb';
      btn.style.borderBottom = '2px solid #2563eb';
      tabContents.forEach(tc => tc.classList.add('hidden'));
      const tab = btn.getAttribute('data-tab');
      document.getElementById('tab-' + tab).classList.remove('hidden');
    });
  });
  // Set initial active tab style
  const initialActive = document.querySelector('.tab-btn.active');
  if (initialActive) {
    initialActive.style.color = '#2563eb';
    initialActive.style.borderBottom = '2px solid #2563eb';
  }
});

// Enhanced function to load and filter appointments into tabs
async function loadUpcomingAppointments(studentUid) {
  try {
    const appointmentsSnap = await db.ref('appointments_by_student/' + studentUid).once('value');
  const now = new Date();
  // Use local date strings to avoid timezone/UTC shifts that make dates appear off by one day
  const todayStr = toLocalISODate(now);
  const tomorrow = new Date(now);
  tomorrow.setDate(now.getDate() + 1);
  const tomorrowStr = toLocalISODate(tomorrow);

    // Clear all tab contents
    ['pending','today','tomorrow','upcoming','past'].forEach(tab => {
      const el = document.getElementById('tab-' + tab);
      if (el) el.innerHTML = '';
    });

    if (appointmentsSnap.exists()) {
      const appointments = [];
      appointmentsSnap.forEach(function(child) {
        const appointment = child.val();
        appointment.key = child.key;
        appointments.push(appointment);
      });

      // Sort by date/time ascending
      function safeStartDateTime(apt) {
        const dateStr = apt && apt.date ? String(apt.date) : '';
        let startTime = '';
        if (apt && apt.time && typeof apt.time === 'string') {
          startTime = apt.time.split(' - ')[0] || '';
        }
        // Parse using local date/time to avoid browser-dependent parsing of ISO strings as UTC
        const dt = parseLocalDateTime(dateStr, startTime);
        return isNaN(dt.getTime()) ? new Date(0) : dt;
      }
  appointments.sort((a, b) => safeStartDateTime(a) - safeStartDateTime(b));

  // If any appointment is a referral (prefer explicit flag or presence of referral fields),
  studentHasReferral = appointments.some(a => (a.referred === true || a.referred_from_name || a.referred_to_name));

      // Categorize appointments
      const tabs = {
        pending: [],
        today: [],
        tomorrow: [],
        upcoming: [],
        past: []
      };

      appointments.forEach(appointment => {
        const counselor = allCounselors.find(c => c.key === appointment.counselor_key);
        const counselorName = counselor ? `${counselor.first_name} ${counselor.last_name} (${counselor.specialization})` : 'Unknown Counselor';
        // By default display the assigned counselor name. For referred appointments, we'll show the receiving counselor on top.
        let displayCounselor = counselorName;
        const appointmentDateTime = safeStartDateTime(appointment);
        const status = (appointment.status || 'Pending').toLowerCase();
        const statusClass = status.replace(/\s+/g, '-');
        const appointmentDate = appointment.date;
        const isToday = appointmentDate === todayStr;
        const isTomorrow = appointmentDate === tomorrowStr;
  // Treat an appointment as "past" only if it's more than 15 minutes after the scheduled start.
  // This allows students to still join for a short grace period after the scheduled time.
  const GRACE_MS = 15 * 60 * 1000; // 15 minutes
  const isPast = appointmentDateTime.getTime() + GRACE_MS < now.getTime();
        const isUpcoming = appointmentDateTime > now && !isToday && !isTomorrow && status !== 'completed';

        // Prepare actions and info
        let actions = '';
        if ((status === 'pending' || status === 'confirmed') && !isPast) {
          actions = `
            <div class="appointment-actions">
              <button class="reschedule" onclick="rescheduleAppointment('${appointment.key}')">Reschedule</button>
              <button class="view-details" onclick="viewAppointmentDetails('${appointment.key}')">View Details</button>
            </div>
          `;
        } else {
          actions = `
            <div class="appointment-actions">
              <button class="view-details" onclick="viewAppointmentDetails('${appointment.key}')">View Details</button>
            </div>
          `;
        }
        const safeTimeDisplay = (appointment.time && typeof appointment.time === 'string') ? appointment.time : 'Not specified';
        const formattedDate = new Date(appointment.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        let referredInfo = '';
  if (appointment.referred === true || appointment.referred_to_name || appointment.referred_from_name) {
          // Only show important referral info. Show the receiving counselor on top and label the source as 'Referred by'
          const reason = appointment.referral_reason ? `<div><b>Reason:</b> ${appointment.referral_reason.replace(/_/g, ' ')}</div>` : '';
          // Prefer a human-friendly name for the referring counselor. If referred_from_name is present
          // try to resolve it to a full name using the loaded allCounselors list. Otherwise, try
          // to look up the counselor by uid/key stored in appointment.referred_from (or referred_from_uid/key).
          let referredBy = '';
          try {
            const refNameRaw = appointment.referred_from_name;
            const refIdAlt = appointment.referred_from || appointment.referred_from_uid || appointment.referred_from_key;
            let resolvedName = '';
            // If we have a raw name, attempt to resolve to full name via allCounselors
            if (refNameRaw) {
              // try find by matching username or by matching any concatenated name
              const lookup = allCounselors.find(cc => {
                if (!cc) return false;
                const fullname = ((cc.first_name || '') + ' ' + (cc.last_name || '')).trim();
                if (!fullname) return false;
                // direct exact matches (case-insensitive) against stored referred_from_name
                if (String(fullname).toLowerCase() === String(refNameRaw).toLowerCase()) return true;
                // sometimes referred_from_name may be username or last name; also check uid/key
                if (String(cc.uid || '').toLowerCase() === String(refNameRaw).toLowerCase()) return true;
                if (String(cc.key || '').toLowerCase() === String(refNameRaw).toLowerCase()) return true;
                return false;
              });
              if (lookup) resolvedName = (lookup.first_name || '') + ' ' + (lookup.last_name || '');
            }
            // If not resolved yet, try lookup by id/key fields
            if (!resolvedName && refIdAlt) {
              const lookup2 = allCounselors.find(cc => (cc.uid === refIdAlt) || (cc.key === refIdAlt));
              if (lookup2) resolvedName = (lookup2.first_name || '') + ' ' + (lookup2.last_name || '');
            }
            // Final fallback: use the raw name or id as-is
            const displayRef = resolvedName || refNameRaw || refIdAlt || '';
            if (displayRef) referredBy = `<div><b>Referred by:</b> ${displayRef}</div>`;
          } catch (e) {
            // On error, fall back to any raw value
            if (appointment.referred_from_name) referredBy = `<div><b>Referred by:</b> ${appointment.referred_from_name}</div>`;
            else if (appointment.referred_from) referredBy = `<div><b>Referred by:</b> ${appointment.referred_from}</div>`;
          }
          const date = appointment.referred_at ? `<div><b>Date:</b> ${new Date(appointment.referred_at).toLocaleString()}</div>` : '';
          referredInfo = `<div style=\"background:#f0f6ff;padding:8px 12px;border-radius:8px;margin:6px 0 0 0;\"><span style=\"color:#007bff;font-weight:600;\"><i class=\"fas fa-share\"></i> Referred Appointment</span>${reason}${referredBy}${date}</div>`;
            // Put the receiving counselor at the top as the main counselor shown
            displayCounselor = appointment.referred_to_name;
        }
          // Ensure the counselor name shown in the card includes the specialization in parentheses
          // Try to resolve the referred-to counselor object first, otherwise use the assigned counselor
          let displaySpec = '';
          try {
            let referredCounselorObj = null;
            if (appointment.referred_to_key || appointment.referred_to_uid || appointment.referred_to_id) {
              referredCounselorObj = allCounselors.find(cc => cc.key === appointment.referred_to_key || cc.uid === appointment.referred_to_uid || cc.key === appointment.referred_to_id || cc.uid === appointment.referred_to_id);
            }
            if (!referredCounselorObj) referredCounselorObj = counselor;
            if (referredCounselorObj && referredCounselorObj.specialization) displaySpec = referredCounselorObj.specialization;
          } catch (e) { /* ignore */ }
          let displayCounselorWithSpec = displayCounselor || '';
          if (displaySpec) {
            const esc = String(displaySpec).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const specRe = new RegExp('\\(' + esc + '\\)', 'i');
            if (!specRe.test(displayCounselorWithSpec)) {
              displayCounselorWithSpec = displayCounselorWithSpec + ' (' + displaySpec + ')';
            }
          }
          // Resolve a counselor key to open the info modal. Prefer referred_to if present.
          let displayCounselorKey = counselor && counselor.key ? counselor.key : '';
          try {
            if (appointment.referred_to_key) {
              displayCounselorKey = appointment.referred_to_key;
            } else if (appointment.referred_to_uid) {
              const byUid = allCounselors.find(cc => cc.uid === appointment.referred_to_uid);
              if (byUid && byUid.key) displayCounselorKey = byUid.key;
            } else if (appointment.referred_to_id) {
              const byId = allCounselors.find(cc => cc.uid === appointment.referred_to_id || cc.key === appointment.referred_to_id);
              if (byId && byId.key) displayCounselorKey = byId.key;
            }
          } catch (e) { /* ignore resolution errors */ }
        const pastIndicator = isPast && status !== 'completed' ? '<small style="color: #dc3545; font-weight: bold;">(Past appointment)</small><br>' : '';

        const html = `
  <div class="appointment ${statusClass}" data-appointment-id="${appointment.key}" style="position:relative;">
    <div class="appointment-info">
  <strong>${displayCounselorWithSpec}</strong>
  <button aria-label="Counselor info" onclick="openCounselorInfoByKey('${displayCounselorKey}')" style="border:none;background:transparent;color:#00723f;cursor:pointer;margin-left:8px;font-size:1rem;vertical-align:middle;"><i class="fas fa-info-circle"></i></button><br>
      ${referredInfo ? referredInfo + '<br>' : ''}
      ${pastIndicator}
      <small><i class="fas fa-calendar"></i> ${formattedDate} at ${safeTimeDisplay}</small><br>
      <span class="status-badge status-${statusClass}">${appointment.status || 'Pending'}</span>
      ${appointment.rescheduled_from_date ? `<br><small style="color:#666;"><i class="fas fa-exchange-alt"></i> Rescheduled to ${formattedDate} at ${safeTimeDisplay} from ${new Date(appointment.rescheduled_from_date).toLocaleDateString()} at ${appointment.rescheduled_from_time}</small>` : ''}
      <small><i class="fas fa-laptop"></i> Mode: ${appointment.mode || 'Not specified'}</small>
    </div>
    ${actions}
    ${!isPast ? `<div class="start-session-wrapper" style="position:absolute;right:12px;bottom:12px;">
      <button class="start-session-btn start-disabled" id="start-btn-${appointment.key}" style="background:#ddd;color:#666;border:none;padding:6px 10px;border-radius:6px;">Join</button>
    </div>` : ''}

  </div>
        `;

        // Categorize  prefer Today over Pending so today's appointments appear in Today tab
        if (isToday && !isPast) {
          tabs.today.push(html);
          setTimeout(() => attachSessionStartedListener(appointment.key), 0);
        } else if (status === 'pending' && !isPast) {
          tabs.pending.push(html);
          setTimeout(() => attachSessionStartedListener(appointment.key), 0);
        } else if (isTomorrow) {
          tabs.tomorrow.push(html);
          setTimeout(() => attachSessionStartedListener(appointment.key), 0);
        } else if (isUpcoming) {
          tabs.upcoming.push(html);
          setTimeout(() => attachSessionStartedListener(appointment.key), 0);
        } else {
          tabs.past.push(html);
        }
      });

      // Render each tab
      Object.entries(tabs).forEach(([tab, htmls]) => {
        const el = document.getElementById('tab-' + tab);
        if (el) {
          el.innerHTML = htmls.length > 0 ? htmls.join('') : '<p style="color:#666; text-align:center; padding:2rem;">No appointments found</p>';
        }
      });

      // Auto-open Today tab if there are any appointments for today.
      // Trigger the existing tab button's click handler so styles and any attached logic run normally.
      // NOTE: do not scroll the container  just switch the active tab.
      try {
        const todayItems = tabs.today || [];
        const todayBtn = document.querySelector('.tab-btn[data-tab="today"]');
        if (todayItems.length > 0 && todayBtn) {
          // Small timeout to ensure UI has rendered before clicking
          setTimeout(() => {
            try { todayBtn.click(); } catch(e) { console.warn('Auto-click today tab failed', e); }
          }, 25);
        }
      } catch (e) {
        console.warn('Auto-open today tab failed', e);
      }
    } else {
      // No appointments at all
      ['pending','today','tomorrow','upcoming','past'].forEach(tab => {
        const el = document.getElementById('tab-' + tab);
        if (el) el.innerHTML = '<p style="color:#666; text-align:center; padding:2rem;">No appointments found</p>';
      });
    }
  } catch (error) {
    console.error('Error loading appointments:', error);
    ['pending','today','tomorrow','upcoming','past'].forEach(tab => {
      const el = document.getElementById('tab-' + tab);
      if (el) el.innerHTML = '<p style="color:#dc3545; text-align:center; padding:2rem;">Error loading appointments</p>';
    });
  }
}

// Get counselor description based on their role
function getCounselorDescription(counselor) {
  // Provide a descriptive label that reflects campus/college assignment when present.
  // Treat Advocates, Counselors, and Psychologists similarly: if they have campus/college metadata,
  // show that assignment instead of a generic 'General' label.
  try {
    const spec = (counselor.specialization || '').toString();
    const counselorCampusRaw = (counselor.campus || '').toString();
    const counselorCollegeRaw = (counselor.college || '').toString();
    const counselorCampus = counselorCampusRaw.trim();
    const counselorCollege = counselorCollegeRaw.trim();
    const counselorCampusNorm = counselorCampus.toLowerCase();
    const counselorCollegeNorm = counselorCollege.toLowerCase();

    // If both campus and college are set and not 'General', show assigned label
    if (counselorCampus && counselorCollege && counselorCampusNorm !== 'general' && counselorCollegeNorm !== 'general') {
      return ` Assigned ${spec} for ${counselorCollege}, ${counselorCampus}`;
    }

    // If only campus is set (and not 'General'), show campus-level label
    if (counselorCampus && counselorCampusNorm !== 'general') {
      return ` Campus ${spec} for ${counselorCampus}`;
    }

    // If only college is set (and not 'General'), show college-level label
    if (counselorCollege && counselorCollegeNorm !== 'general') {
      return ` ${spec} assigned to ${counselorCollege}`;
    }

    // Fallback: generic available label
    return ` ${spec} - Available for all students`;
  } catch (e) {
    // On any unexpected error, fall back to a safe generic label
    return ` ${counselor.specialization || 'Counselor'} - Available for all students`;
  }
}

// Attach a real-time listener for session start flag for an appointment
function attachSessionStartedListener(appointmentKey) {
  const btn = document.getElementById(`start-btn-${appointmentKey}`);
  if (!btn) return;
  // Listen to the appointment record under student's node; counselor will set session_started under appointment
  const aptRef = db.ref(`appointments_by_student/${auth.currentUser ? auth.currentUser.uid : 'unknown'}/${appointmentKey}`);
  aptRef.on('value', snapshot => {
    const data = snapshot.val();
    const started = data && data.session_started === true;
    setStartButtonState(btn, started, data);

    // Always attach a click handler (we rely on class-based disabled state so clicks still fire)
    btn.onclick = function(e) {
      e.preventDefault();
      try {
        // Allow students to join immediately if the appointment status is 'Ongoing',
        // even when the explicit session_started flag isn't present.
        if (!started && !(data && String(data.status || '').toLowerCase() === 'ongoing')) {
          showJoinDisabledModal(data, appointmentKey); return;
        }

        // Prefer an explicit consultation id stored on the appointment record
        const consultKeys = ['consultation_id','consultationId','consult_id','consult','consultation_key','consultationKey','consultId'];
        let consultId = null;
        for (let k of consultKeys){ if (data && data[k]) { consultId = data[k]; break; } }
        if (consultId){
          // Navigate to messages view and open the consultation.
          // If we have a counselor id on the appointment, include it so messages.html
          // can behave like a conversation click (select the counselor group).
          const counselorId = data && (data.counselor_uid || data.counselorId || data.counselor_id || (data.counselor && (data.counselor.uid || data.counselor.id)));
          let url = 'messages.html?consult=' + encodeURIComponent(String(consultId));
          if (counselorId) url += '&counselor=' + encodeURIComponent(String(counselorId));
          window.location.href = url;
          return;
        }

        // Fallback: if a session_link is present, pass it as a room param so messages.html can show the incoming UI
        if (data && data.session_link){
          // include counselor id when available
          const counselorId = data && (data.counselor_uid || data.counselorId || data.counselor_id || (data.counselor && (data.counselor.uid || data.counselor.id)));
          let url = 'messages.html?room=' + encodeURIComponent(String(data.session_link)) + '&appointment=' + encodeURIComponent(appointmentKey);
          if (counselorId) url += '&counselor=' + encodeURIComponent(String(counselorId));
          window.location.href = url;
          return;
        }

        // Last-resort: navigate with appointment id so messages.html can attempt to resolve a consultation by appointment
  // Last-resort: navigate with appointment id so messages.html can attempt
  // to resolve a consultation by appointment. Include counselor id if known
  // so messages view can open the same conversation UI as a conversation click.
  const counselorId = data && (data.counselor_uid || data.counselorId || data.counselor_id || (data.counselor && (data.counselor.uid || data.counselor.id)));
  let lastResUrl = 'messages.html?appointment=' + encodeURIComponent(appointmentKey);
  if (counselorId) lastResUrl += '&counselor=' + encodeURIComponent(String(counselorId));
  window.location.href = lastResUrl;
      } catch(err) {
        console.warn('start button navigation failed', err);
        showJoinDisabledModal(data, appointmentKey);
      }
    };
  }, error => {
    console.warn('Failed to listen for session_started for', appointmentKey, error);
  });
}

// Outcome Rating Scale (ORS) modal functions
function openORSModal(appointmentId, appointmentData, showBookingOnClose) {
  try {
    // If modal already exists, remove it first
    const existing = document.getElementById('orsModalOverlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'orsModalOverlay';
    overlay.className = 'modal-overlay';
    overlay.style.display = 'flex';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.zIndex = 12000;
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.innerHTML = `
      <div class="modal-content booking-modal" role="dialog" aria-modal="true" style="max-width:720px; width:96%;">
        <div class="modal-header"><h3>Outcome Rating Scale (ORS)</h3></div>
        <div class="modal-body" style="max-height:60vh; overflow:auto;">
          <p style="margin-top:0.1rem;color:var(--text);"><strong>Please help your counselor by answering this short ORS before your session.</strong> We filled in your name already. Only the ratings are needed. Your answers help us give better support. (Comments are optional)</p>
          <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:12px;">
            <div><b>Student:</b> ${appointmentData && appointmentData.student_name ? String(appointmentData.student_name) : (studentData && (studentData.first_name+' '+studentData.last_name)) || 'You'}</div>
            <div><b>Session:</b> ${appointmentData && appointmentData.date ? appointmentData.date + ' ' + (appointmentData.time || '') : ''}</div>
            <div style="margin-top:6px;color:#666;font-size:0.9rem;">Please choose a number from 0 (low) to 10 (high) for each area.</div>
          </div>

          <div style="margin-bottom:12px;">
            <label><b>Individually (Personal well-being)</b></label>
            <div style="font-size:0.9rem;color:#555;margin-top:4px;">0 = Very low (having a hard time) to 10 = Very high (feeling well)</div>
            <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
              <input id="ors_individual" type="range" min="0" max="10" value="5" step="1" style="flex:1;">
              <output id="ors_individual_out">5</output>
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <label><b>Interpersonally (Family, close relationships)</b></label>
            <div style="font-size:0.9rem;color:#555;margin-top:4px;">0 = Very hard (feeling alone) to 10 = Very good (feeling supported)</div>
            <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
              <input id="ors_interpersonal" type="range" min="0" max="10" value="5" step="1" style="flex:1;">
              <output id="ors_interpersonal_out">5</output>
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <label><b>Socially (Work, school, friendships)</b></label>
            <div style="font-size:0.9rem;color:#555;margin-top:4px;">0 = Struggling at school, work, or with friends to 10 = Doing well and involved</div>
            <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
              <input id="ors_social" type="range" min="0" max="10" value="5" step="1" style="flex:1;">
              <output id="ors_social_out">5</output>
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <label><b>Overall (General sense of well-being)</b></label>
            <div style="font-size:0.9rem;color:#555;margin-top:4px;">0 = Poor overall well-being to 10 = Excellent overall well-being</div>
            <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
              <input id="ors_overall" type="range" min="0" max="10" value="5" step="1" style="flex:1;">
              <output id="ors_overall_out">5</output>
            </div>
          </div>

          <div style="margin-bottom:12px;">
            <label for="ors_comment"><b>Comments (optional)</b></label>
            <textarea id="ors_comment" rows="3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;" placeholder="Anything you'd like to add (optional)"></textarea>
          </div>

          <div style="font-size:0.85rem;color:#666;margin-top:6px;line-height:1.05;text-align:center;">
            <div style="font-weight:600;color:var(--text);">International Center for Clinical Excellence</div>
            <div><a href="https://www.scottdmiller.com/" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:underline;">www.scottdmiller.com</a></div>
            <div style="font-size:0.82rem;color:#666;margin-top:4px;"> 2000, Scott D. Miller &amp; Barry L. Duncan</div>
          </div>
        </div>
        <div class="modal-footer" style="display:flex;align-items:center;gap:12px;justify-content:flex-end;flex-wrap:wrap;">
          <button class="primary" onclick="submitORS('${appointmentId}')">Submit ORS</button>
        </div>
      </div>
    `;

  // Remember this appointment and whether ORS was opened right after booking
  window._currentORSAppointmentData = appointmentData || null;
  window._orsOpenedFromBooking = !!showBookingOnClose;
  document.body.appendChild(overlay);

    // Prevent closing the ORS by clicking the backdrop: clicking outside should do nothing
    overlay.addEventListener('click', function(e){
      if (e.target === overlay) {
        // Do nothing - ORS is required and cannot be dismissed without submitting
        e.stopPropagation();
      }
    });

    // Prevent closing ORS with Esc key while it's open
    const _orsEscHandler = function(e){
      if (e.key === 'Escape' || e.keyCode === 27) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    };
    window._orsEscapeHandler = _orsEscHandler;
    document.addEventListener('keydown', _orsEscHandler, true);

    // Wire outputs to ranges for immediate numeric feedback
    const map = [
      ['ors_individual','ors_individual_out'],
      ['ors_interpersonal','ors_interpersonal_out'],
      ['ors_social','ors_social_out'],
      ['ors_overall','ors_overall_out']
    ];
    map.forEach(pair => {
      const el = document.getElementById(pair[0]);
      const out = document.getElementById(pair[1]);
      if (el && out) {
        el.addEventListener('input', function(){ out.textContent = el.value; });
      }
    });
  } catch (e) {
    console.warn('openORSModal error', e);
  }
}

function closeORSModal() {
  try {
    const el = document.getElementById('orsModalOverlay');
    if (el) el.remove();
    // Remove the Escape key handler if set
    try { if (window._orsEscapeHandler) { document.removeEventListener('keydown', window._orsEscapeHandler, true); window._orsEscapeHandler = null; } } catch(e){}
    // If ORS was opened immediately after booking, show the booking confirmation now.
    try {
      if (window._orsOpenedFromBooking) {
        const appt = window._currentORSAppointmentData || {};
        const dateText = appt.date ? (new Date(String(appt.date)).toLocaleDateString() + (appt.time ? ' at ' + appt.time : '')) : '';
        const savedMsg = window._orsSavedFlag ? '<br><br>Your ORS responses have been saved.' : '<br><br>You skipped the ORS.';
        showActionCard(`<strong>Booking submitted!</strong><br>Your session is booked for:<br><b>${dateText}</b>${savedMsg}`);
      }
    } catch (e) {
      console.warn('Failed to show booking confirmation after ORS', e);
    }
    // Clear temporary ORS flags
    window._orsOpenedFromBooking = false;
    window._orsSavedFlag = false;
    window._currentORSAppointmentData = null;
  } catch (e) { console.warn('closeORSModal failed', e); }
}

async function submitORS(appointmentId) {
  try {
  const get = id => document.getElementById(id) ? document.getElementById(id).value : null;
    const individual = parseInt(get('ors_individual') || '0', 10);
    const interpersonal = parseInt(get('ors_interpersonal') || '0', 10);
    const social = parseInt(get('ors_social') || '0', 10);
    const overall = parseInt(get('ors_overall') || '0', 10);
    const comment = document.getElementById('ors_comment') ? document.getElementById('ors_comment').value.trim() : '';

    // Build ORS object
    const apptDataForSave = window._currentORSAppointmentData || {};
    const orsObj = {
      student_uid: (apptDataForSave && apptDataForSave.student_uid) ? apptDataForSave.student_uid : (auth && auth.currentUser ? auth.currentUser.uid : null),
      student_name: (apptDataForSave && apptDataForSave.student_name) ? apptDataForSave.student_name : (studentData && (studentData.first_name + ' ' + studentData.last_name)),
      responses: {
        individual: individual,
        interpersonal: interpersonal,
        social: social,
        overall: overall
      },
      comment: comment,
      created_at: Date.now()
    };

    // Save ORS responses under `ors/<studentUid>/<generatedKey>` so ORS are scoped by student
    let savedKey = null;
    const studentUid = orsObj.student_uid || (auth && auth.currentUser && auth.currentUser.uid) || null;

    if (studentUid) {
      const newRef = await db.ref(`ors/${studentUid}`).push();
      savedKey = newRef.key;
      await newRef.set(Object.assign({}, orsObj, { generated_key: savedKey }));
    } else {
      // No student UID: fallback to root-based storage
      const newRef = await db.ref('ors').push();
      savedKey = newRef.key;
      await newRef.set(Object.assign({}, orsObj, { generated_key: savedKey }));
    }

    // After saving ORS, update the corresponding appointment to mark the ORS as submitted
    try {
      const apptId = appointmentId || null;
      const studentUid = orsObj.student_uid || (auth && auth.currentUser && auth.currentUser.uid) || null;
      const apptData = window._currentORSAppointmentData || {};
      if (apptId && studentUid) {
        const updateObj = {
          ors_submitted: true,
          ors_saved_at: Date.now(),
          ors_key: savedKey
        };
        try {
          await db.ref(`appointments_by_student/${studentUid}/${apptId}`).update(updateObj);
        } catch (e) {
          console.warn('Failed to update appointments_by_student with ORS metadata', e);
        }
        try {
          const counselorUid = apptData.counselor_uid || apptData.counselorUid || apptData.counselor_id || apptData.counselorId;
          if (counselorUid) {
            await db.ref(`appointments_by_counselor/${counselorUid}/${apptId}`).update(updateObj);
          }
        } catch (e) {
          console.warn('Failed to update appointments_by_counselor with ORS metadata', e);
        }
      }
    } catch (e) {
      console.warn('Failed to attach ORS metadata to appointment', e);
    }

    // Mark saved and close; close handler will show booking confirmation
    window._orsSavedFlag = true;
    closeORSModal();
  } catch (e) {
    console.error('Failed to submit ORS', e);
    showActionCard(`<strong>ORS Submission Failed</strong><br>We could not save your responses. Please try again.`);
  }
}

// Show a modal with a fuller explanation when student clicks a disabled Join button
function showJoinDisabledModal(appointmentData, appointmentKey) {
  let modal = document.getElementById('joinDisabledModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'joinDisabledModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-header"><h3>Session Not Ready Yet</h3><button class="close-btn" aria-label="Close" onclick="document.getElementById('joinDisabledModal').remove()">&times;</button></div>
        <div class="modal-body">
          <p>The Join button will become active when your counselor starts the session or 5 minutes before the scheduled time.</p>
          <p><strong>Appointment:</strong> ${appointmentData && appointmentData.date ? (new Date(String(appointmentData.date)).toLocaleDateString() + ' ' + (appointmentData.time || '')) : 'Not available'}</p>
          <p>If you believe the counselor has already started the session, please wait a moment, refresh this page, or contact your counselor directly.</p>
        </div>
        <div class="modal-footer">
          <button class="secondary" onclick="document.getElementById('joinDisabledModal').remove()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  } else {
    modal.style.display = 'flex';
  }
}

function setStartButtonState(btn, started, appointment) {
  if (!btn) return;
  // Remove any previous countdown
  if (btn._countdownInterval) {
    clearInterval(btn._countdownInterval);
    btn._countdownInterval = null;
  }
  // Remove any previous timer display
  let timerDiv = btn.parentElement && btn.parentElement.querySelector('.session-timer');
  if (timerDiv) timerDiv.remove();

  // Helper to insert timer above button
  function insertTimer(text) {
    let div = document.createElement('div');
    div.className = 'session-timer';
    div.style.color = 'red';
    div.style.fontWeight = 'bold';
    div.style.marginBottom = '6px';
    div.textContent = text;
    btn.parentElement.insertBefore(div, btn);
  }

  // Configuration: enable 5 minutes before and allow joining up to 15 minutes after scheduled time
  const PRE_ENABLE_MS = 5 * 60 * 1000; // 5 minutes before
  const JOIN_GRACE_MS = 15 * 60 * 1000; // 15 minutes after

  // If session started by counselor, enable immediately
  if (started) {
    btn.classList.remove('start-disabled');
    btn.classList.add('enabled');
    btn.textContent = 'Join';
    btn.title = '';
    btn.setAttribute('aria-disabled','false');
    btn.style.background = '#28a745';
    btn.style.color = '#fff';
    btn.style.cursor = 'pointer';
    return;
  }
  // If appointment status already marked Ongoing, enable immediately
  if (appointment && String(appointment.status || '').toLowerCase() === 'ongoing') {
    btn.classList.remove('start-disabled');
    btn.classList.add('enabled');
    btn.textContent = 'Join';
    btn.title = '';
    btn.setAttribute('aria-disabled','false');
    btn.style.background = '#28a745';
    btn.style.color = '#fff';
    btn.style.cursor = 'pointer';
    return;
  }
  // If no appointment info, just disable (class-based so clicks still work)
  if (!appointment) {
    btn.classList.remove('enabled');
    btn.classList.add('start-disabled');
    btn.textContent = 'Join';
    btn.title = 'Join available when counselor starts the session or 5 minutes before the scheduled time.';
    btn.setAttribute('aria-disabled','true');
    btn.style.background = '#ddd';
    btn.style.color = '#666';
    btn.style.cursor = 'not-allowed';
    return;
  }
  // Only show timer if confirmed and today; otherwise keep disabled
  const status = (appointment.status || '').toLowerCase();
  const todayStr = new Date().toISOString().split('T')[0];
  if (status !== 'confirmed' || appointment.date !== todayStr) {
    btn.classList.remove('enabled');
    btn.classList.add('start-disabled');
    btn.textContent = 'Join';
    btn.title = 'Join is enabled from 5 minutes before until 15 minutes after the scheduled time.';
    btn.setAttribute('aria-disabled','true');
    btn.style.background = '#ddd';
    btn.style.color = '#666';
    btn.style.cursor = 'not-allowed';
    return;
  }
    // Parse appointment date/time using local parser to avoid timezone issues
  let dateStr = appointment.date;
  let timeStr = (appointment.time && typeof appointment.time === 'string') ? appointment.time.split(' - ')[0] : '';
  let target = parseLocalDateTime(dateStr, timeStr);
  if (isNaN(target.getTime())) {
    btn.classList.remove('enabled');
    btn.classList.add('start-disabled');
    btn.textContent = 'Join';
    btn.title = 'Join available when counselor starts the session.';
    btn.setAttribute('aria-disabled','true');
    btn.style.background = '#ddd';
    btn.style.color = '#666';
    btn.style.cursor = 'not-allowed';
    return;
  }
  // Enable 5 minutes before
  function updateCountdown() {
    const now = new Date();
    const diff = target.getTime() - now.getTime();
    // Remove previous timer
    let timerDiv = btn.parentElement && btn.parentElement.querySelector('.session-timer');
    if (timerDiv) timerDiv.remove();
    // Allow joining when we're within PRE_ENABLE_MS before start, or up to JOIN_GRACE_MS after start.
    if (diff <= PRE_ENABLE_MS) {
      btn.classList.remove('start-disabled');
      btn.classList.add('enabled');
      btn.textContent = 'Join';
      btn.title = '';
      btn.setAttribute('aria-disabled','false');
      btn.style.background = '#28a745';
      btn.style.color = '#fff';
      btn.style.cursor = 'pointer';
      clearInterval(btn._countdownInterval);
      btn._countdownInterval = null;
    } else {
      btn.classList.remove('enabled');
      btn.classList.add('start-disabled');
      btn.textContent = 'Join';
      btn.title = 'Join available in a few minutes (enabled 5 minutes before scheduled time).';
      btn.setAttribute('aria-disabled','true');
      btn.style.background = '#ddd';
      btn.style.color = '#666';
      btn.style.cursor = 'not-allowed';
      // Show countdown above button in red
      let mins = Math.floor(diff / 60000);
      let secs = Math.floor((diff % 60000) / 1000);
      insertTimer(`${mins}m ${secs < 10 ? '0' : ''}${secs}s`);
    }
  }
  updateCountdown();
  btn._countdownInterval = setInterval(updateCountdown, 1000);
}

// Keep appointments list roughly the same visible height as the calendar and make it scrollable
function adjustAppointmentsListHeight() {
  try {
    const calendar = document.getElementById('calendar');
    const apptContainer = document.querySelector('.appointments-container');
    if (!calendar || !apptContainer) return;

  // Prefer to size the appointments list to fill its card height so there's no empty gap
  const appointmentsCard = document.querySelector('.appointments-card');
  // If we have the card, base height on it; otherwise fall back to calendar height
  let baseHeight = null;
  if (appointmentsCard) baseHeight = appointmentsCard.getBoundingClientRect().height;
  if (!baseHeight) baseHeight = calendar.getBoundingClientRect().height;

  // If calendar is taller (or on desktop/window view), make the appointments card match the
  // calendar height so both columns align and there isn't visual empty space.
  try {
    const calRect = calendar.getBoundingClientRect();
    const calH = calRect.height;
    if (appointmentsCard && window.innerWidth > 768) {
      const apRect = appointmentsCard.getBoundingClientRect();
      const apH = apRect.height;
      const targetCardH = Math.max(calH, apH);
      // apply explicit height to appointments card so its inner list can exactly fill it
      appointmentsCard.style.height = targetCardH + 'px';
      baseHeight = targetCardH;
    } else if (!appointmentsCard) {
      baseHeight = calH;
    }
  } catch (e) {
    // noop if measurement fails
  }

  // Subtract header and tabs inside the appointments card
  const header = document.querySelector('.appointments-card .appointments-header');
  const tabs = document.querySelector('.appointments-card .appointments-tabs');
  const headerH = header ? header.getBoundingClientRect().height : 0;
  const tabsH = tabs ? tabs.getBoundingClientRect().height : 0;

  // Account for the card's vertical padding so the list fills the inner area precisely
  let cardPaddingV = 0;
  if (appointmentsCard) {
    const cs = window.getComputedStyle(appointmentsCard);
    const pt = parseFloat(cs.paddingTop) || 0;
    const pb = parseFloat(cs.paddingBottom) || 0;
    cardPaddingV = pt + pb;
  }

  // Compute desired inner height for the appointments list so it fills the card exactly.
  // Base: card height minus header/tabs and the card's vertical padding. Use floor to avoid sub-pixel gaps.
  let desired = Math.floor(baseHeight - headerH - tabsH - cardPaddingV);

  // On mobile, allow a small extra visual space so users can see more items before scrolling
  if (window.innerWidth <= 768) {
    const EXTRA_MOBILE_APPT_HEIGHT = 120; // px; adjust if you want more/less space
    desired = desired + EXTRA_MOBILE_APPT_HEIGHT;
  }

  // Ensure desired is not unreasonably small
  desired = Math.max(160, desired);

  // Prevent the desired height from exceeding the viewport (leave room for header/topbar)
  const maxAllowed = Math.max(180, Math.floor(window.innerHeight - 120));
  const finalHeight = Math.min(desired, maxAllowed);

  // Apply explicit height so the appointments list fills the allocated area and scrolls internally
  apptContainer.style.height = finalHeight + 'px';
  apptContainer.style.maxHeight = finalHeight + 'px';
  apptContainer.style.overflowY = 'auto';
  apptContainer.style.paddingRight = '8px';
  } catch (e) {
    // noop
  }
}

// Run on load and resize
document.addEventListener('DOMContentLoaded', function(){
  // Allow calendar to render then adjust
  setTimeout(adjustAppointmentsListHeight, 300);
  // Keep calendar/appointments heights in sync even after FullCalendar renders or changes.
  function setupCalendarResizeSync() {
    try {
      const cal = document.getElementById('calendar');
      const calCard = document.querySelector('.calendar-card');
      const apptCard = document.querySelector('.appointments-card');
      if (!cal || !apptCard) return;
      // Use ResizeObserver when available to detect size changes and re-run the adjustment
      if (window.ResizeObserver) {
        if (window._appointmentsCalendarRO) window._appointmentsCalendarRO.disconnect();
        window._appointmentsCalendarRO = new ResizeObserver(entries => {
          // run on next animation frame to allow layout to settle
          requestAnimationFrame(adjustAppointmentsListHeight);
        });
        window._appointmentsCalendarRO.observe(cal);
        if (calCard) window._appointmentsCalendarRO.observe(calCard);
      }
    } catch (e) { /* noop */ }
  }
  // Try to set up immediately and again a bit later to catch asynchronous calendar rendering
  setTimeout(setupCalendarResizeSync, 400);
  setTimeout(setupCalendarResizeSync, 1200);
});
window.addEventListener('resize', function(){
  setTimeout(adjustAppointmentsListHeight, 120);
});

// When the calendar is re-rendered programmatically, calling this helper will keep heights in sync.
// renderCalendar calls in this file already execute; call adjust after those events where needed.
// Expand weekly availability ranges into individual date slots
function expandWeeklyRangeToSlots(rangeData, counselor, bookedSlots = {}) {
  const { weeklyAvailability, range } = rangeData;
  
  if (!range || !range.from || !range.to) {
    console.log(' Invalid range for:', counselor.first_name, range);
    return;
  }
  
  const fromDate = new Date(range.from);
  const toDate = new Date(range.to);
  const now = new Date();
  
  console.log(' Expanding range for:', counselor.first_name, 'from', range.from, 'to', range.to);
  
  for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
    const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
    const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    
    // Skip past dates entirely
    const slotDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset time to start of day for comparison
    slotDate.setHours(0, 0, 0, 0);
    
    if (slotDate < today) {
      console.log(' Skipping past date:', dateStr);
      continue;
    }
    
    // Determine if this is TODAY (not just any current or future date)
    const isToday = slotDate.getTime() === today.getTime();
    
    // Check if this date has any booked slots
    const bookedForDate = bookedSlots[dateStr] || {};
    const bookedTimes = Object.values(bookedForDate).map(slot => slot.time);
    
    // Find availability for this weekday
    const dayConfig = weeklyAvailability ? weeklyAvailability.find(wa => wa.day === dayName && wa.enabled) : null;
    
    if (dayConfig && Array.isArray(dayConfig.slots)) {
      dayConfig.slots.forEach(slot => {
        // Use the exact time range from the counselor's availability (from - to)
        const timeSlot = `${slot.from} - ${slot.to}`;
        
        // Initialize as available
        let isAvailable = true;
        
        // ONLY apply time filtering if this is TODAY
        if (isToday) {
          // Parse the slot start time for TODAY only
          const [hours, minutes] = slot.from.split(':').map(Number);
          const slotDateTime = new Date(); // Current date and time
          slotDateTime.setHours(hours, minutes, 0, 0);
          
          // Add 30-minute buffer to prevent booking slots that are starting very soon
          const bufferTime = 30 * 60 * 1000; // 30 minutes in milliseconds
          const isPastOrTooSoon = (slotDateTime.getTime() - bufferTime) <= now.getTime();
          
          if (isPastOrTooSoon) {
            isAvailable = false;
            console.log(' Today\'s slot is past or too soon:', dateStr, timeSlot, 'Current time:', now.toLocaleTimeString());
          }
        }
        
        // Check if slot is already booked
        const isBooked = bookedTimes.includes(timeSlot);
        
        // Only add if available AND not booked
            if (isAvailable && !isBooked) {
              if (!availableSlotsByDate[dateStr]) availableSlotsByDate[dateStr] = [];
              // Compute a stable counselor id for de-duplication checks (covers different possible id fields)
              const counselorUniqueId = (counselor && (counselor.uid || counselor.id || counselor.key || counselor.counselor_uid || counselor.counselorId || counselor.counselor_id)) || 'unknown_counselor';
              // Avoid pushing duplicate identical slots for the same counselor on the same date/time
              const alreadyExists = availableSlotsByDate[dateStr].some(existing => {
                const existingCounselorId = (existing.counselor && (existing.counselor.uid || existing.counselor.id || existing.counselor.key || existing.counselor.counselor_uid || existing.counselor.counselorId || existing.counselor.counselor_id)) || 'unknown_counselor';
                return existingCounselorId === counselorUniqueId && existing.time === timeSlot;
              });
              if (!alreadyExists) {
                availableSlotsByDate[dateStr].push({
                  counselor,
                  time: timeSlot
                });
                console.log(' Time slot generated:', dateStr, timeSlot, counselor.first_name, isToday ? '(TODAY)' : '(FUTURE)');
              } else {
                console.log(' Duplicate slot skipped:', dateStr, timeSlot, counselor.first_name);
              }
            } else {
          if (isBooked) {
            console.log(' Slot already booked:', dateStr, timeSlot, counselor.first_name);
          } else if (!isAvailable) {
            console.log(' Slot unavailable (past/too close for today):', dateStr, timeSlot, counselor.first_name);
          }
        }
      });
    }
  }
}

/* Also add the missing debugWeeklyAvailability function: */
function debugWeeklyAvailability(counselor, weeklyRanges) {
  console.log(' Debugging weekly availability for:', counselor.first_name);
  console.log('Raw weeklyRanges:', weeklyRanges);
  
  if (Array.isArray(weeklyRanges)) {
    weeklyRanges.forEach((range, index) => {
      console.log(`Range ${index}:`, range);
      if (range.weeklyAvailability) {
        console.log(`  Weekly availability:`, range.weeklyAvailability);
      }
    });
  } else if (weeklyRanges && typeof weeklyRanges === 'object') {
    Object.entries(weeklyRanges).forEach(([key, range]) => {
      console.log(`Range ${key}:`, range);
      if (range.weeklyAvailability) {
        console.log(`  Weekly availability:`, range.weeklyAvailability);
      }
    });
  }
}

// View appointment details
function viewAppointmentDetails(appointmentKey) {
  // Find the appointment data
  db.ref('appointments_by_student/' + auth.currentUser.uid + '/' + appointmentKey).once('value').then(function(snapshot) {
    if (snapshot.exists()) {
      const appointment = snapshot.val();
      const counselor = allCounselors.find(c => c.key === appointment.counselor_key);
      const counselorName = counselor ? 
        `${counselor.first_name} ${counselor.last_name} (${counselor.specialization})` : 
        'Unknown Counselor';
      
      // Format date nicely
      const appointmentDate = new Date(appointment.date);
      const formattedDate = appointmentDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      const content = `
        <div style="text-align: left;">
          <strong>Appointment Details</strong><br><br>
          
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong> Date & Time:</strong><br>
            ${formattedDate}<br>
            ${appointment.time}<br><br>
            
            <strong> Counselor/Advocate:</strong><br>
            ${counselorName} <button aria-label="Counselor info" onclick="openCounselorInfoByKey('${counselor ? counselor.key : ''}')" style="border:none;background:transparent;color:#00723f;cursor:pointer;margin-left:8px;font-size:1rem;vertical-align:middle;"><i class="fas fa-info-circle"></i></button><br><br>
            
            <strong> Mode:</strong><br>
            ${appointment.mode || 'Not specified'}<br><br>
            
            <strong> Status:</strong><br>
            <span class="status-badge status-${appointment.status.toLowerCase().replace(/\s+/g, '-')}">${appointment.status}</span><br><br>
            
            <strong> Booked on:</strong><br>
            ${new Date(appointment.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
          
          ${appointment.status === 'Completed' ? `
            <div style="background: #d4edda; color: #155724; padding: 0.8rem; border-radius: 6px; font-size: 0.9rem;">
              <strong> This appointment has been completed.</strong>
            </div>
          ` : ''}
        </div>
      `;
      
      showActionCard(content);
    } else {
      showActionCard(`<strong>Error</strong><br>Appointment details not found.`);
    }
  }).catch(function(error) {
    console.error('Error loading appointment details:', error);
    showActionCard(`<strong>Error</strong><br>Failed to load appointment details.`);
  });
}

// Reschedule appointment
function rescheduleAppointment(appointmentKey) {
  db.ref('appointments_by_student/' + auth.currentUser.uid + '/' + appointmentKey).once('value').then(function(snapshot) {
    if (!snapshot.exists()) {
      showActionCard(`<strong>Error</strong><br>Appointment not found.`);
      return;
    }
    const appointment = snapshot.val();
    // Prefer referred-to counselor when present (use referred_to_key / referred_to_uid),
    // otherwise fall back to the original assigned counselor_key.
    let counselorKey = appointment.referred_to_key || appointment.counselor_key || appointment.counselor_key;
    // Try to find the counselor by key first
    let counselor = allCounselors.find(c => c.key === counselorKey);
    // If not found, try by referred_to_uid or other id fields
    if (!counselor && appointment.referred_to_uid) {
      counselor = allCounselors.find(c => c.uid === appointment.referred_to_uid);
    }
    if (!counselor && appointment.referred_to_id) {
      counselor = allCounselors.find(c => c.uid === appointment.referred_to_id || c.key === appointment.referred_to_id);
    }
    // If we found a counselor by uid, ensure counselorKey matches their key for availability lookup
    if (counselor && counselor.key && counselor.key !== counselorKey) {
      counselorKey = counselor.key;
    }
    if (!counselor) {
      showActionCard(`<strong>Error</strong><br>Counselor not found.`);
      return;
    }

    const futureDates = Object.keys(availableSlotsByDate).filter(dateStr => {
      return availableSlotsByDate[dateStr].some(slot => slot.counselor.key === counselorKey);
    }).sort();

    if (futureDates.length === 0) {
      showActionCard(`<strong>No available slots for rescheduling with this counselor.</strong>`);
      return;
    }

    let html = `<strong>Reschedule Appointment</strong><br>
      <div style="margin:1rem 0;">
        <b>Counselor:</b> ${counselor.first_name} ${counselor.last_name} (${counselor.specialization})<br>
        <b>Current:</b> ${appointment.date} at ${appointment.time}
      </div>
      <div id="reschedCalendarContainer" style="margin-bottom:1rem;"></div>
      <div id="reschedTimeSlots"></div>
      <div id="reschedSubmitContainer"></div>
    `;

    // Show the modal with wider style
    document.getElementById('actionCardContent').innerHTML = html;
    const actionCardDiv = document.getElementById('actionCard').querySelector('div');
    if (actionCardDiv) {
      actionCardDiv.style.minWidth = '700px';
      actionCardDiv.style.maxWidth = '600px';
    }
    document.getElementById('actionCard').style.display = 'flex';

    // Custom styles for calendar cells and events
    const style = document.createElement('style');
    style.textContent = `
      /* Keep sizing and spacing but DO NOT force a background color so event classes control colors */
      .fc-daygrid-event {
        font-size: 0.65rem !important;
        padding: 2px 6px !important;
        border-radius: 5px !important;
        margin: 2px 0 !important;
      }
      .fc-daygrid-day.fc-day-today {
        background: #e8f4e8 !important;
      }
      .fc-daygrid-day.selected-date {
        background: #bee5eb !important;
        border: 2px solid #17a2b8 !important;
      }
      .resched-slot-btn {
        margin: 0.3rem 0.3rem 0.3rem 0;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        background: #00723f;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s;
      }
      .resched-slot-btn.selected {
        background: #ffc107 !important;
        color: #212529 !important;
        font-weight: bold;
        border: 2px solid #e0a800 !important;
      }
      #reschedSubmitBtn {
        margin-top: 1rem;
        background: #28a745;
        color: white;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
    `;
    document.head.appendChild(style);

    // Render calendar
    setTimeout(() => {
      const calendarDiv = document.getElementById('reschedCalendarContainer');
      calendarDiv.innerHTML = '';
      let selectedDateStr = null;

      const calendar = new FullCalendar.Calendar(calendarDiv, {
        initialView: 'dayGridMonth',
        height: 340,
        selectable: true,
        headerToolbar: { left:'prev,next today', center:'title', right:'' },
        // Load events dynamically for the currently visible range so navigation across months shows correct slots
        events: function(fetchInfo, successCallback, failureCallback) {
          try {
            const ev = [];
            const exceptionDates = new Set(Object.keys(dateExceptions || {}));
            const holidayDates = new Set((phHolidays || []).map(h => h.date));
            // iterate union of dates so we include exceptions/holidays and available slots across months
            const allDates = new Set([
              ...Object.keys(availableSlotsByDate || {}),
              ...Object.keys(dateExceptions || {}),
              ...((phHolidays || []).map(h => h.date))
            ]);
            allDates.forEach(dateStr => {
              // Exception takes precedence
              if (exceptionDates.has(dateStr)) {
                const info = dateExceptions[dateStr];
                const note = typeof info === 'string' ? info : (info && info.note) ? info.note : 'Unavailable';
                ev.push({ title: note || 'Unavailable', start: dateStr, backgroundColor: '#dc3545', borderColor: '#dc3545', textColor: '#fff', allDay: true, extendedProps: { type: 'exception', note } });
                return;
              }

              // Holiday next
              if (holidayDates.has(dateStr)) {
                const h = (phHolidays || []).find(x => x.date === dateStr) || {};
                ev.push({ title: 'Holiday', start: dateStr, backgroundColor: '#ffc107', borderColor: '#ffc107', textColor: '#fff', allDay: true, extendedProps: { type: 'holiday', holidayName: h.localName || h.name } });
                return;
              }

              // Available slots for this counselor
              const slotsForDate = (availableSlotsByDate[dateStr] || []).filter(s => s.counselor.key === counselorKey);
              if (slotsForDate.length > 0) {
                ev.push({ title: `${slotsForDate.length} slot${slotsForDate.length > 1 ? 's' : ''}`, start: dateStr, backgroundColor: '#28a745', borderColor: '#28a745', textColor: '#fff', allDay: true, extendedProps: { type: 'slot', slots: slotsForDate } });
              }
            });
            successCallback(ev);
          } catch (err) {
            console.error('Failed to build resched events', err);
            failureCallback(err);
          }
        },
        eventDisplay: 'block',
        dayMaxEvents: 2,
        moreLinkClick: 'popover',
        eventClick: function(info) {
          info.jsEvent.preventDefault();
          const props = info.event.extendedProps;
          if (props.type === 'exception') {
            // Show exception note in the resched time slot area instead of opening a modal
            showReschedTimeSlots(info.event.startStr, counselorKey, props.note || 'Unavailable');
          } else if (props.type === 'holiday') {
            // Show holiday name in the resched time slot area
            showReschedTimeSlots(info.event.startStr, counselorKey, props.holidayName || info.event.title || 'Holiday');
          } else if (props.type === 'slot') {
            // open time slots for this counselor on that date
            showReschedTimeSlots(info.event.startStr, counselorKey);
          }
        },
        dateClick: function(info) {
          // Remove previous selection
          calendarDiv.querySelectorAll('.fc-daygrid-day').forEach(cell => cell.classList.remove('selected-date'));
          // Highlight selected cell
          const cell = calendarDiv.querySelector(`[data-date="${info.dateStr}"]`);
          if (cell) cell.classList.add('selected-date');
          // If exception or holiday exists for date, show message instead of slots
          const exceptionDates = new Set(Object.keys(dateExceptions || {}));
          const holidayDates = new Set((phHolidays || []).map(h => h.date));
          if (exceptionDates.has(info.dateStr)) {
            const infoObj = dateExceptions[info.dateStr];
            const note = typeof infoObj === 'string' ? infoObj : (infoObj && infoObj.note) ? infoObj.note : 'Unavailable';
            // Put note into time slot area
            showReschedTimeSlots(info.dateStr, counselorKey, note);
            return;
          }
          if (holidayDates.has(info.dateStr)) {
            const h = (phHolidays || []).find(x => x.date === info.dateStr) || {};
            showReschedTimeSlots(info.dateStr, counselorKey, h.localName || h.name || 'Holiday');
            return;
          }
          selectedDateStr = info.dateStr;
          showReschedTimeSlots(info.dateStr, counselorKey);
        },
        eventClassNames: function(arg) {
          const props = arg.event.extendedProps;
          if (props.type === 'exception') return ['calendar-event', 'calendar-exception'];
          if (props.type === 'holiday') return ['calendar-event', 'calendar-holiday'];
          if (props.type === 'slot') return ['calendar-event', 'calendar-slot'];
          return ['calendar-event'];
        }
      });
      calendar.render();
    }, 100);

    // Show time slots for selected date
    window.showReschedTimeSlots = function(dateStr, counselorKey, infoMessage) {
      const slotDiv = document.getElementById('reschedTimeSlots');
      slotDiv.innerHTML = '';
      document.getElementById('reschedSubmitContainer').innerHTML = '';

      // If an infoMessage is provided (exception/holiday), display it here and stop
      if (infoMessage) {
        slotDiv.innerHTML = `<div style="background:#fff3cd;padding:0.8rem;border-radius:8px;color:#7a4a00;"><strong>Notice:</strong><br>${infoMessage}</div>`;
        return;
      }

      // Get available times for this counselor on selected date
      const slots = (availableSlotsByDate[dateStr] || []).filter(slot => slot.counselor.key === counselorKey);
      if (slots.length === 0) {
        slotDiv.innerHTML = `<small>No available times for this date.</small>`;
        return;
      }
      slotDiv.innerHTML = `<b>Pick a time:</b><br>`;
      slots.forEach((slot, idx) => {
        const btn = document.createElement('button');
        btn.textContent = slot.time;
        btn.className = 'resched-slot-btn';
        btn.onclick = function() {
          // Mark selected visually
          slotDiv.querySelectorAll('.resched-slot-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          window._reschedSelected = { dateStr, time: slot.time };
          // Show submit button
          document.getElementById('reschedSubmitContainer').innerHTML = `
            <button id="reschedSubmitBtn">Confirm Reschedule</button>
          `;
          document.getElementById('reschedSubmitBtn').onclick = async function() {
            const sel = window._reschedSelected;
            if (!sel) return;

            // 1. Update appointment in Firebase (student and counselor nodes)
            await db.ref('appointments_by_student/' + auth.currentUser.uid + '/' + appointmentKey).update({
              date: sel.dateStr,
              time: sel.time,
              ...(appointment.rescheduled_from_date ? {} : { rescheduled_from_date: appointment.date, rescheduled_from_time: appointment.time, rescheduled_at: Date.now() })
            });
            await db.ref('appointments_by_counselor/' + appointment.counselor_uid + '/' + appointmentKey).update({
              date: sel.dateStr,
              time: sel.time,
              ...(appointment.rescheduled_from_date ? {} : { rescheduled_from_date: appointment.date, rescheduled_from_time: appointment.time, rescheduled_at: Date.now() })
            });

            // 2. Handle booked slots: remove old and add new
            // Free up the old slot
            await db.ref(`availabilities/${appointment.counselor_uid}/bookedSlots/${appointment.date}/${appointmentKey}`).remove();
            // Book the new slot
            await db.ref(`availabilities/${appointment.counselor_uid}/bookedSlots/${sel.dateStr}/${appointmentKey}`).set({
              time: sel.time,
              student_uid: auth.currentUser.uid
            });

            // 3. Update local availableSlotsByDate: remove new slot (mark as booked)
            if (availableSlotsByDate[sel.dateStr]) {
              availableSlotsByDate[sel.dateStr] = availableSlotsByDate[sel.dateStr].filter(
                s => !(s.counselor.key === counselor.key && s.time === sel.time)
              );
              if (availableSlotsByDate[sel.dateStr].length === 0) {
                delete availableSlotsByDate[sel.dateStr];
              }
            }

            // 4. Re-render calendar to reflect changes (will free up old slot based on updated appointments)
            renderCalendar();

            showActionCard(`<strong>Appointment Rescheduled!</strong><br>New date: <b>${new Date(sel.dateStr).toLocaleDateString()}</b> at <b>${sel.time}</b>`);
            if (auth.currentUser) await loadUpcomingAppointments(auth.currentUser.uid);
            window._reschedSelected = null;
          };
        };
        slotDiv.appendChild(btn);
      });
    };
  });
}

// Open counselor info modal by counselor key (closes any open action card first)
function openCounselorInfoByKey(counselorKey) {
  try { closeActionCard(); } catch(e) {}
  if (!counselorKey) return alert('Counselor not found');
  const counselor = allCounselors.find(c => c.key === counselorKey || c.uid === counselorKey);
  if (!counselor) return alert('Counselor not found');

  // Remove existing modal if present
  const existing = document.getElementById('counselorInfoModal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'counselorInfoModal';
  modal.style.position = 'fixed';
  modal.style.left = '0';
  modal.style.top = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.background = 'rgba(0,0,0,0.45)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = 4000;

  // Inject styles for counselor modal (once)
  if (!document.getElementById('counselorInfoStyles')) {
    const s = document.createElement('style');
    s.id = 'counselorInfoStyles';
    s.textContent = `
      /* Base styles */
      #counselorInfoModal { backdrop-filter: blur(4px); }
      #counselorInfoModal .counselor-box { width:92%; max-width:720px; border-radius:14px; padding:18px 20px; background:#fff; box-shadow:0 12px 40px rgba(2,6,23,0.12); font-family: Inter, Arial, Helvetica, sans-serif; color:#111; }
      #counselorInfoModal .counselor-row { display:flex; gap:20px; align-items:flex-start; }
      #counselorInfoModal .counselor-avatar { width:128px; height:128px; border-radius:12px; object-fit:cover; flex-shrink:0; box-shadow:0 6px 18px rgba(2,6,23,0.08); }
      #counselorInfoModal .counselor-meta { flex:1; }
      #counselorInfoModal .counselor-name { font-weight:800; color:#0f7a34; font-size:20px; line-height:1.05; }
      #counselorInfoModal .counselor-spec { color:#0f7a34; font-weight:600; margin-top:6px; font-size:14px; }
      #counselorInfoModal .counselor-details { display:flex; gap:28px; margin-top:14px; }
      #counselorInfoModal .counselor-details .col { flex:1; }
      #counselorInfoModal .counselor-details b { color:#111; }
      #counselorInfoModal .counselor-contact div { margin-top:6px; }
      #counselorInfoModal .counselor-bio { margin-top:14px; color:#374151; font-size:0.95rem; line-height:1.45; }
      #counselorInfoModal .modal-close-btn { position:absolute; right:12px; top:12px; border:none; background:#fff; font-size:20px; cursor:pointer; color:#111; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.12); border:1px solid rgba(0,0,0,0.06); }

      /* Wide screens (>=1200px): larger card and avatar */
      @media (min-width:1200px) {
        #counselorInfoModal .counselor-box { max-width:980px; padding:22px 26px; }
        #counselorInfoModal .counselor-avatar { width:160px; height:160px; border-radius:14px; }
        #counselorInfoModal .counselor-name { font-size:22px; }
        #counselorInfoModal .counselor-spec { font-size:16px; }
        #counselorInfoModal .counselor-details { gap:36px; }
      }

      /* Medium desktops (992px - 1199px) */
      @media (min-width:992px) and (max-width:1199px) {
        #counselorInfoModal .counselor-box { max-width:840px; padding:20px 24px; }
        #counselorInfoModal .counselor-avatar { width:140px; height:140px; }
        #counselorInfoModal .counselor-name { font-size:21px; }
      }

      /* Small desktops / large tablets (768px - 991px) */
      @media (min-width:768px) and (max-width:991px) {
        #counselorInfoModal .counselor-box { max-width:720px; padding:18px 20px; }
        #counselorInfoModal .counselor-avatar { width:128px; height:128px; }
      }

      /* Mobile / narrow screens */
      @media (max-width:767px) {
        #counselorInfoModal .counselor-row { flex-direction:column; align-items:center; text-align:center; }
        #counselorInfoModal .counselor-details { flex-direction:column; gap:8px; }
        #counselorInfoModal .counselor-avatar { width:112px; height:112px; }
      }
    `;
    document.head.appendChild(s);
  }

  const box = document.createElement('div');
  // Make box positioned so the absolute close button is placed relative to it
  box.style.position = 'relative';
  box.className = 'counselor-box';

  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '&times;';
  closeBtn.setAttribute('aria-label', 'Close counselor info');
  // Use CSS class for close button
  closeBtn.className = 'modal-close-btn';
  closeBtn.onclick = () => { modal.remove(); };
  closeBtn.onkeydown = (e) => { if (e.key === 'Escape') modal.remove(); };

  const initials = ((counselor.first_name||'').charAt(0)||'') + ((counselor.last_name||'').charAt(0)||'');
  const fullName = ((counselor.first_name||'') + ' ' + (counselor.last_name||'')).trim();

  // Build content that matches the provided design: avatar left, name+spec in green, two-column details, bio below
  // Make avatar clickable when a photo exists so students can view it larger
  const photoUrlSafe = (counselor.photo_url || '').replace(/'/g, "\\'");
  const avatarHtml = counselor.photo_url ?
    `<img class="counselor-avatar" src="${counselor.photo_url}" alt="${fullName}" onclick="openCounselorPhoto('${photoUrlSafe}')" style="cursor:pointer;">` :
    `<div class="counselor-avatar" style="display:flex;align-items:center;justify-content:center;font-weight:700;font-size:40px;color:#0f5132;background:#f3f4f6;">${initials}</div>`;

  const bioHtml = `<div style="margin-top:12px;color:#374151;font-size:0.95rem;line-height:1.4;">${counselor.description || counselor.bio || ''}</div>`;

  const campusText = counselor.campus ? counselor.campus : '';
  const collegeText = counselor.college ? counselor.college : '';
  const genderText = counselor.gender ? counselor.gender : '';
  // Use the canonical keys for contact data if present. Show phone above email when both exist.
  const phone = counselor.phone_number ? String(counselor.phone_number) : '';
  const email = counselor.email_address ? String(counselor.email_address) : '';
  let contactHtml = '';
  if (phone || email) {
    contactHtml = '';
    if (phone) contactHtml += `<div>${phone}</div>`;
    if (email) contactHtml += `<div style="margin-top:6px;">${email}</div>`;
  }

  box.innerHTML = `
    <div class="counselor-row">
      ${avatarHtml}
      <div class="counselor-meta">
        <div class="counselor-header">
          <div class="counselor-name">${fullName}</div>
          <div class="counselor-spec">${counselor.specialization || ''}</div>
        </div>

        <div class="counselor-details">
          <div class="col">
            <div><b>Campus:</b> ${campusText}</div>
            <div style="margin-top:8px;"><b>Gender:</b> ${genderText}</div>
          </div>
          <div class="col">
            <div><b>College:</b> ${collegeText}</div>
            <div style="margin-top:8px;"><b>Contact:</b> <div class="counselor-contact">${contactHtml}</div></div>
          </div>
        </div>

        <div class="counselor-bio">${bioHtml}</div>
      </div>
    </div>
  `;

  // append close button after content so it sits on top-right of the box (box is position:relative)
  box.appendChild(closeBtn);
  modal.appendChild(box);
  document.body.appendChild(modal);
  // focus close for keyboard
  try { closeBtn.focus(); } catch (e) {}
}

function closeCounselorInfoModal() {
  const el = document.getElementById('counselorInfoModal');
  if (el) el.remove();
}

// Open a full-size preview of the counselor photo (or a large initials placeholder)
window.openCounselorPhoto = function(url) {
  // If no url provided, do nothing
  const safeUrl = url || '';
  // Remove any existing preview
  const existing = document.getElementById('imgPreviewModal');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'imgPreviewModal';
  overlay.style.position = 'fixed';
  overlay.style.left = '0';
  overlay.style.top = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.6)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = 4500;

  const box = document.createElement('div');
  box.style.position = 'relative';
  box.style.maxWidth = '95%';
  box.style.maxHeight = '95%';
  box.style.borderRadius = '10px';
  box.style.overflow = 'hidden';

  if (safeUrl) {
    const img = document.createElement('img');
    img.src = safeUrl;
    img.alt = 'Counselor photo';
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    img.style.display = 'block';
    img.style.objectFit = 'contain';
    box.appendChild(img);
  } else {
    // Show a large initials placeholder
    const initialsDiv = document.createElement('div');
    initialsDiv.style.width = '420px';
    initialsDiv.style.height = '420px';
    initialsDiv.style.display = 'flex';
    initialsDiv.style.alignItems = 'center';
    initialsDiv.style.justifyContent = 'center';
    initialsDiv.style.background = '#f3f4f6';
    initialsDiv.style.color = '#0f5132';
    initialsDiv.style.fontSize = '140px';
    initialsDiv.style.fontWeight = '700';
    const initialsText = (document.querySelector('#counselorInfoModal img') && document.querySelector('#counselorInfoModal img').alt) ? document.querySelector('#counselorInfoModal img').alt.charAt(0) : '';
    initialsDiv.textContent = initialsText || '';
    box.appendChild(initialsDiv);
  }

  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '&times;';
  closeBtn.setAttribute('aria-label', 'Close image preview');
  closeBtn.style.cssText = 'position:absolute;right:10px;top:10px;border:none;background:#fff;font-size:20px;cursor:pointer;color:#111;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.12);border:1px solid rgba(0,0,0,0.06);z-index:10;';
  closeBtn.onclick = () => { overlay.remove(); };

  box.appendChild(closeBtn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Close on background click
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) overlay.remove();
  });

  // Close on Esc
  function onKey(e) { if (e.key === 'Escape') { overlay.remove(); window.removeEventListener('keydown', onKey); } }
  window.addEventListener('keydown', onKey);
};
  </script>

  <!-- Global report modal handlers (ensure functions exist for inline onclicks) -->
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // Show report modal (uses the existing reportModal markup)
    window.showReportModal = function(type){
      const overlay = document.getElementById('reportModal');
      const title = document.getElementById('reportModalTitle');
      if (!overlay || !title) return;
      title.textContent = (type === 'bullying') ? 'Report Bullying' : (type === 'harassment' ? 'Report Harassment' : 'Report a Concern');
      // Clear inputs
      const dateEl = document.getElementById('incidentDate');
      if (dateEl) {
        // don't allow selecting a future date
        const today = new Date().toISOString().split('T')[0];
        dateEl.max = today;
        dateEl.value = '';
      }
      const descEl = document.getElementById('incidentDescription'); if (descEl) descEl.value = '';
      const locEl = document.getElementById('incidentLocation'); if (locEl) locEl.value = '';
  const attachEl = document.getElementById('reportAttachment'); if (attachEl) attachEl.value = null;
  const attachName = document.getElementById('reportAttachmentName'); if (attachName) attachName.textContent = '';
      window.currentReportType = type;
      overlay.style.display = 'flex';
    };

    window.closeReportModal = function(){
      const overlay = document.getElementById('reportModal'); if (overlay) overlay.style.display = 'none';
    };

    // Wire the Cancel/Close buttons
    const closeButtons = document.querySelectorAll('#reportModal .close-btn, #reportModal .secondary');
    closeButtons.forEach(btn => btn.addEventListener('click', window.closeReportModal));

      // Show selected filename when user picks an attachment
      const reportAttachInput = document.getElementById('reportAttachment');
      if (reportAttachInput) {
        reportAttachInput.addEventListener('change', function(){
          const nameSpan = document.getElementById('reportAttachmentName');
          if (!nameSpan) return;
          if (this.files && this.files.length>0) nameSpan.textContent = this.files[0].name; else nameSpan.textContent = '';
          // clear any previous inline attachment error
          const err = document.getElementById('error-reportAttachment'); if (err) err.textContent = '';
          if (this.files && this.files.length>0) {
            const fileInput = document.getElementById('reportAttachment'); if (fileInput) fileInput.classList.remove('input-error');
          }
        });
      }

      // Clear inline errors when the user types/selects
      const descInput = document.getElementById('incidentDescription');
      if (descInput) descInput.addEventListener('input', () => { const e = document.getElementById('error-incidentDescription'); if (e) e.textContent = ''; descInput.classList.remove('input-error'); });
      const dateInput = document.getElementById('incidentDate');
      if (dateInput) dateInput.addEventListener('change', () => { const e = document.getElementById('error-incidentDate'); if (e) e.textContent = ''; dateInput.classList.remove('input-error'); });
      const locInput = document.getElementById('incidentLocation');
      if (locInput) locInput.addEventListener('input', () => { const e = document.getElementById('error-incidentLocation'); if (e) e.textContent = ''; locInput.classList.remove('input-error'); });

    // Submit report handler (reads inputs and writes to Firebase 'reports' node)
    window.submitReport = async function() {
      // helper functions for inline errors
      const setInlineError = (fieldId, message) => {
        const el = document.getElementById(fieldId);
        if (el) el.classList.add('input-error');
        const err = document.getElementById('error-' + fieldId);
        if (err) err.textContent = message;
      };
      const clearInlineError = (fieldId) => {
        const el = document.getElementById(fieldId);
        if (el) el.classList.remove('input-error');
        const err = document.getElementById('error-' + fieldId);
        if (err) err.textContent = '';
      };

      // clear previous inline errors
      ['incidentDate','incidentDescription','incidentLocation','reportAttachment'].forEach(id=>clearInlineError(id));

      const type = window.currentReportType || 'concern';
      const date = document.getElementById('incidentDate') ? document.getElementById('incidentDate').value : '';
      const description = document.getElementById('incidentDescription') ? document.getElementById('incidentDescription').value.trim() : '';
      const location = document.getElementById('incidentLocation') ? document.getElementById('incidentLocation').value.trim() : '';
      const anonymous = document.getElementById('anonymousCheck') ? !!document.getElementById('anonymousCheck').checked : true;

      // Inline validation: require date and description
      if (!date) {
        setInlineError('incidentDate', 'Please select the date of the incident.');
        const d = document.getElementById('incidentDate'); if (d) d.focus();
        return;
      }
      // Prevent future dates  compare date strings (YYYY-MM-DD) to avoid timezone issues
      try {
        const todayIso = new Date().toISOString().split('T')[0];
        if (date > todayIso) {
          setInlineError('incidentDate', 'Date cannot be in the future.');
          const d = document.getElementById('incidentDate'); if (d) d.focus();
          return;
        }
      } catch (e) { /* ignore parse errors, validation above will catch empty */ }
      if (!description) {
        setInlineError('incidentDescription', 'Please describe the incident before submitting.');
        const descEl = document.getElementById('incidentDescription'); if (descEl) descEl.focus();
        return;
      }

      if (!db) {
        showActionCard('<strong>Database not initialized</strong><br>Please make sure Firebase is configured.');
        return;
      }

      // If a file was selected, show its name and prepare for upload
      const attachmentInput = document.getElementById('reportAttachment');
      let attachmentFile = null;
      if (attachmentInput && attachmentInput.files && attachmentInput.files.length > 0) {
        attachmentFile = attachmentInput.files[0];
        const nameSpan = document.getElementById('reportAttachmentName'); if (nameSpan) nameSpan.textContent = attachmentFile.name;
      }

      // Prevent duplicate submissions by disabling the submit button
      const submitBtn = document.querySelector('#reportModal .primary');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.7';
      }

      try {
        const now = Date.now();

        // Build payload and include reporter info when not anonymous
        const payload = {
          type,
          date: date || '',
          description,
          location: location || '',
          anonymous: !!anonymous,
          created_at: now
        };

        // If there's an attachment, ensure the client is authenticated (concern_files requires auth)
        if (attachmentFile) {
          if (!(auth && auth.currentUser)) {
            // User not signed in  show inline error and require sign-in to attach files
            setInlineError('reportAttachment', 'You must be signed in to attach files. Please sign in or remove the attachment.');
            const aff = document.getElementById('reportAttachment'); if (aff) aff.focus();
            if (submitBtn) { submitBtn.disabled = false; submitBtn.style.opacity = ''; }
            return;
          }
          // reject overly large files (10MB limit)
          const MAX_ATTACHMENT = 10 * 1024 * 1024;
          if (attachmentFile.size > MAX_ATTACHMENT) {
            // Inline error for attachment size
            setInlineError('reportAttachment', 'Attachment too large  maximum allowed size is 10 MB.');
            if (submitBtn) { submitBtn.disabled = false; submitBtn.style.opacity = ''; }
            const aff = document.getElementById('reportAttachment'); if (aff) aff.focus();
            return;
          }
          try {
            // convert to data URL
            const fileToDataUrl = (file) => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = (e) => reject(e);
              reader.readAsDataURL(file);
            });
            const dataUrl = await fileToDataUrl(attachmentFile);
            // extract payload and mime
            const mimeMatch = dataUrl.match(/^data:([^;]+);base64,/);
            const mimeType = mimeMatch ? mimeMatch[1] : 'application/octet-stream';
            const base64Payload = dataUrl.split(',')[1];

            const filePayload = {
              filename: attachmentFile.name,
              size: attachmentFile.size,
              mimeType: mimeType,
              uploadDate: firebase.database.ServerValue.TIMESTAMP,
              data: base64Payload,
              category: 'Report Attachment',
              uploaded_by: (auth && auth.currentUser) ? auth.currentUser.uid : null,
              // Mark if this was uploaded by an anonymous client (no auth)
              uploadedByAnonymous: !(auth && auth.currentUser)
            };

            const fileRef = await db.ref('concern_files').push(filePayload);
            const fileKey = fileRef.key;
            // Attach to report payload
            payload.attachments = [{ fileKey, filename: attachmentFile.name, mimeType: mimeType, size: attachmentFile.size }];
          } catch (err) {
            console.error('Failed to upload attachment for report', err);
            showActionCard('<strong>Attachment upload failed</strong><br>Please try again later.');
            if (submitBtn) { submitBtn.disabled = false; submitBtn.style.opacity = ''; }
            return;
          }
        }

        if (!anonymous && auth && auth.currentUser) {
          // attach basic reporter details from loaded studentData (if available)
          const reporterName = (studentData && (studentData.first_name || studentData.last_name)) ? `${studentData.first_name || ''} ${studentData.last_name || ''}`.trim() : (auth.currentUser.email || null);
          const reporterEmail = (studentData && (studentData.email_address || studentData.email)) ? (studentData.email_address || studentData.email) : (auth.currentUser.email || null);
          const reporterMobile = studentData && (studentData.mobile || studentData.phone) ? (studentData.mobile || studentData.phone) : '';

          // submitted_by now stores an object with identifying fields (uid, name, email, mobile)
          payload.submitted_by = {
            uid: auth.currentUser.uid,
            name: reporterName,
            email: reporterEmail,
            mobile: reporterMobile
          };

          payload.reporter = {
            uid: auth.currentUser.uid,
            name: reporterName,
            email: reporterEmail,
            student_id: studentData && studentData.student_id ? studentData.student_id : (studentData && studentData.student_id_number ? studentData.student_id_number : ''),
            mobile: reporterMobile,
            campus: studentData ? (studentData.campus || '') : '',
            college: studentData ? (studentData.college || '') : ''
          };
        }

  // Diagnostic logging: auth state and payload (helps diagnose PERMISSION_DENIED)
  try { console.log('submitReport: auth.currentUser =', (auth && auth.currentUser) ? { uid: auth.currentUser.uid, email: auth.currentUser.email } : null); } catch(e) { console.warn('submitReport: failed to read auth', e); }
  try { if (auth && auth.currentUser && auth.currentUser.getIdToken) auth.currentUser.getIdToken().then(t=>console.log('submitReport: idToken (first 40 chars) =', t && t.substr(0,40))); } catch(e) { /* ignore */ }
  console.log('submitReport: payload =', payload);

  // Push to main reports node
  const ref = await db.ref('reports').push(payload);
        const reportId = ref.key;

        // Also save an index under the user's node for easy lookup (if not anonymous)
        if (!anonymous && auth && auth.currentUser) {
          await db.ref(`reports_by_user/${auth.currentUser.uid}/${reportId}`).set({ report_id: reportId, created_at: now });
        }

        closeReportModal();
        showActionCard('<strong>Report submitted</strong><br>Thank you. Our team will review your report.');
      } catch (err) {
        console.error('Failed to submit report', err);
        showActionCard('<strong>Submission failed</strong><br>Please try again later.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '';
        }
      }
    };
  });
  </script>

  <script>
    // Button loading helper
    (function(){
      function createSpinnerEl(){
        const s = document.createElement('span');
        s.className = 'btn-spinner';
        s.setAttribute('aria-hidden','true');
        return s;
      }

      function setButtonLoading(btn, isLoading){
        if(!btn) return;
        if(isLoading){
          if(!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
          btn.classList.add('btn-loading');
          // Build content: keep original text visible to assistive tech but hidden visually
          btn.innerHTML = '<span class="btn-text">'+btn.dataset.origHtml+'</span>';
          const spinner = createSpinnerEl();
          btn.appendChild(spinner);
          btn.setAttribute('disabled','disabled');
        } else {
          if(btn.dataset.origHtml) btn.innerHTML = btn.dataset.origHtml;
          btn.classList.remove('btn-loading');
          btn.removeAttribute('disabled');
        }
      }

      // expose for manual control
      window.setButtonLoading = setButtonLoading;

      // Auto-hook: any element with [data-with-loading] will show spinner on click
      document.addEventListener('click', function(e){
        const btn = e.target.closest && e.target.closest('[data-with-loading]');
        if(!btn) return;
        // if already loading, ignore
        if(btn.classList.contains('btn-loading')) return;
        setButtonLoading(btn, true);

        // fallback: if the page doesn't navigate or script keeps the button loading, auto-re-enable after 30s
        const timeoutMs = parseInt(btn.getAttribute('data-loading-timeout')||'30000',10);
        const to = setTimeout(function(){ setButtonLoading(btn, false); }, timeoutMs);

        // If button inside a form and the form submits via HTTP navigation, don't bother restoring here.
        // If a JS handler runs and wants to clear loading, it can call window.setButtonLoading(button,false).
        // Listen for a custom event 'button:loaded' on the button to clear earlier
        btn.addEventListener('button:loaded', function(){ clearTimeout(to); setButtonLoading(btn,false); }, { once: true });
      }, false);
    })();
  </script>
</body>
</html>


